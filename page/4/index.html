<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"www.cyblogs.com","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.23.1","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js" defer></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="简栈文化">
<meta property="og:url" content="http://www.cyblogs.com/page/4/index.html">
<meta property="og:site_name" content="简栈文化">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Vernon">
<meta property="article:tag" content="Java">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://www.cyblogs.com/page/4/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/4/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>简栈文化</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  






  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="简栈文化" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">简栈文化</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">Java技术人的成长之路~</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Vernon"
      src="/images/vernonchen.jpg">
  <p class="site-author-name" itemprop="name">Vernon</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">149</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">66</span>
        <span class="site-state-item-name">分类</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">87</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/chengcheng222e" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;chengcheng222e" rel="noopener me" target="_blank"><i class="github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:chengcheng222e@gmail.com" title="E-Mail → mailto:chengcheng222e@gmail.com" rel="noopener me" target="_blank"><i class="envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.cyblogs.com/2020/06/04/2020/06/%E5%9B%9B%E5%BC%A0%E5%9B%BE%E5%B8%A6%E4%BD%A0%E4%BA%86%E8%A7%A3Tomcat%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/vernonchen.jpg">
      <meta itemprop="name" content="Vernon">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简栈文化">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | 简栈文化">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/06/04/2020/06/%E5%9B%9B%E5%BC%A0%E5%9B%BE%E5%B8%A6%E4%BD%A0%E4%BA%86%E8%A7%A3Tomcat%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/" class="post-title-link" itemprop="url">四张图带你了解Tomcat系统架构</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-06-04 00:00:00" itemprop="dateCreated datePublished" datetime="2020-06-04T00:00:00+08:00">2020-06-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-06-25 09:57:14" itemprop="dateModified" datetime="2025-06-25T09:57:14+08:00">2025-06-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Tomcat/" itemprop="url" rel="index"><span itemprop="name">Tomcat</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>俗话说，站在巨人的肩膀上看世界，一般学习的时候也是先总览一下整体，然后逐个部分个个击破，最后形成思路，了解具体细节，<code>Tomcat</code>的结构很复杂，但是 <code>Tomcat</code> 非常的模块化，找到了 <code>Tomcat</code>最核心的模块，问题才可以游刃而解，了解了<code>Tomcat</code>的整体架构对以后深入了解<code>Tomcat</code>来说至关重要！</p>
<h4 id="一、Tomcat顶层架构"><a href="#一、Tomcat顶层架构" class="headerlink" title="一、Tomcat顶层架构"></a><strong>一、Tomcat顶层架构</strong></h4><p>先上一张<code>Tomcat</code>的顶层结构图（图A），如下：</p>
<p><img src="http://static.cyblogs.com/5j8j72c1yz.jpg" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;5j8j72c1yz.jpg"></p>
<p><code>Tomcat</code>中最顶层的容器是<code>Server</code>，代表着整个服务器，从上图中可以看出，一个<code>Server</code>可以包含至少一个<code>Service</code>，用于具体提供服务。</p>
<p><code>Service</code>主要包含两个部分：<code>Connector</code>和<code>Container</code>。从上图中可以看出 <code>Tomcat</code> 的心脏就是这两个组件，他们的作用如下：</p>
<p>1、<code>Connector</code>用于处理连接相关的事情，并提供<code>Socket</code>与<code>Request</code>和<code>Response</code>相关的转化; </p>
<p>2、<code>Container</code>用于封装和管理Servlet，以及具体处理<code>Request</code>请求；</p>
<p>一个<code>Tomcat</code>中只有一个<code>Server</code>，一个<code>Server</code>可以包含多个<code>Service</code>，一个<code>Service</code>只有一个<code>Container</code>，但是可以有多个<code>Connectors</code>，这是因为一个服务可以有多个连接，如同时提供<code>Http</code>和<code>Https</code>链接，也可以提供向相同协议不同端口的连接,示意图如下（<code>Engine</code>、<code>Host</code>、<code>Context</code>下边会说到）：</p>
<p><img src="http://static.cyblogs.com/q0q4dy3ioh.jpg" alt="img"></p>
<p>多个 <code>Connector</code> 和一个 <code>Container</code> 就形成了一个 <code>Service</code>，有了 <code>Service</code> 就可以对外提供服务了，但是 <code>Service</code> 还要一个生存的环境，必须要有人能够给她生命、掌握其生死大权，那就非 <code>Server</code> 莫属了！所以整个 <code>Tomcat</code> 的生命周期由 <code>Server</code> 控制。</p>
<p>另外，上述的包含关系或者说是父子关系，都可以在tomcat的conf目录下的<code>server.xml</code>配置文件中看出，下图是删除了注释内容之后的一个完整的<code>server.xml</code>配置文件（Tomcat版本为8.0）</p>
<p><img src="http://static.cyblogs.com/ruzbrbmp9e.jpg" alt="img"></p>
<p>详细的配置文件文件内容可以到<code>Tomcat</code>官网查看：<a target="_blank" rel="noopener" href="http://tomcat.apache.org/tomcat-8.0-doc/index.html">http://tomcat.apache.org/tomcat-8.0-doc/index.html</a></p>
<p>上边的配置文件，还可以通过下边的一张结构图更清楚的理解：</p>
<p><img src="http://static.cyblogs.com/pwsqbf6laq.png" alt="img"></p>
<p><code>Server</code>标签设置的端口号为<code>8005</code>，<code>shutdown=”SHUTDOWN”</code> ，表示在<code>8005</code>端口监听“<code>SHUTDOWN</code>”命令，如果接收到了就会关闭<code>Tomcat</code>。一个<code>Server</code>有一个<code>Service</code>，当然还可以进行配置，一个<code>Service</code>有多个，<code>Service</code>左边的内容都属于<code>Container</code>的，<code>Service</code>下边是<code>Connector</code>。</p>
<h4 id="二、Tomcat顶层架构小结："><a href="#二、Tomcat顶层架构小结：" class="headerlink" title="二、Tomcat顶层架构小结："></a><strong>二、Tomcat顶层架构小结：</strong></h4><p>（1）<code>Tomcat</code>中只有一个<code>Server</code>，一个<code>Server</code>可以有多个<code>Service</code>，一个<code>Service</code>可以有多个<code>Connector</code>和一个<code>Container</code>；  </p>
<p>（2） <code>Server</code>掌管着整个<code>Tomcat</code>的生死大权；  </p>
<p>（3）<code>Service</code> 是对外提供服务的；  </p>
<p>（4）<code>Connector</code>用于接受请求并将请求封装成<code>Request</code>和<code>Response</code>来具体处理；  </p>
<p>（5）<code>Container</code>用于封装和管理<code>Servlet</code>，以及具体处理<code>request</code>请求；</p>
<p>知道了整个<code>Tomcat</code>顶层的分层架构和各个组件之间的关系以及作用，对于绝大多数的开发人员来说<code>Server</code>和<code>Service</code>对我们来说确实很远，而我们开发中绝大部分进行配置的内容是属于<code>Connector</code>和<code>Container</code>的，所以接下来介绍一下<code>Connector</code>和<code>Container</code>。</p>
<h4 id="三、Connector和Container的微妙关系"><a href="#三、Connector和Container的微妙关系" class="headerlink" title="三、Connector和Container的微妙关系"></a><strong>三、Connector和Container的微妙关系</strong></h4><p>由上述内容我们大致可以知道一个请求发送到<code>Tomcat</code>之后，首先经过<code>Service</code>然后会交给我们的<code>Connector</code>，<code>Connector</code>用于接收请求并将接收的请求封装为<code>Request</code>和<code>Response</code>来具体处理，<code>Request</code>和<code>Response</code>封装完之后再交由<code>Container</code>进行处理，<code>Container</code>处理完请求之后再返回给<code>Connector</code>，最后在由<code>Connector</code>通过<code>Socket</code>将处理的结果返回给客户端，这样整个请求的就处理完了！</p>
<p><code>Connector</code>最底层使用的是<code>Socket</code>来进行连接的，<code>Request</code>和<code>Response</code>是按照HTTP协议来封装的，所以<code>Connector</code>同时需要实现<code>TCP/IP</code>协议和<code>HTTP</code>协议！</p>
<p><code>Tomcat</code>既然处理请求，那么肯定需要先接收到这个请求，接收请求这个东西我们首先就需要看一下<code>Connector</code>！</p>
<h4 id="四、Connector架构分析"><a href="#四、Connector架构分析" class="headerlink" title="四、Connector架构分析"></a><strong>四、Connector架构分析</strong></h4><p><code>Connector</code>用于接受请求并将请求封装成<code>Request</code>和<code>Response</code>，然后交给<code>Container</code>进行处理，<code>Container</code>处理完之后在交给<code>Connector</code>返回给客户端。</p>
<p>因此，我们可以把<code>Connector</code>分为四个方面进行理解：</p>
<p>（1）<code>Connector</code>如何接受请求的？ </p>
<p>（2）如何将请求封装成<code>Request</code>和<code>Response</code>的？ </p>
<p>（3）封装完之后的<code>Request</code>和<code>Response</code>如何交给<code>Container</code>进行处理的？ </p>
<p>（4）<code>Container</code>处理完之后如何交给<code>Connector</code>并返回给客户端的？</p>
<p>首先看一下<code>Connector</code>的结构图（图B），如下所示：</p>
<p><img src="http://static.cyblogs.com/b3o0gef7y5.png" alt="img"></p>
<p><code>Connector</code>就是使用<code>ProtocolHandler</code>来处理请求的，不同的<code>ProtocolHandler</code>代表不同的连接类型，比如：<code>Http11Protocol</code>使用的是普通<code>Socket</code>来连接的，<code>Http11NioProtocol</code>使用的是<code>NioSocket</code>来连接的。</p>
<p>其中<code>ProtocolHandler</code>由包含了三个部件：<code>Endpoint</code>、<code>Processor</code>、<code>Adapter</code>。</p>
<p>（1）<code>Endpoint</code>用来处理底层<code>Socket</code>的网络连接，<code>Processor</code>用于将<code>Endpoint</code>接收到的<code>Socket</code>封装成<code>Request</code>，<code>Adapter</code>用于将<code>Request</code>交给<code>Container</code>进行具体的处理。</p>
<p>（2）<code>Endpoint</code>由于是处理底层的<code>Socket</code>网络连接，因此<code>Endpoint</code>是用来实现<code>TCP/IP</code>协议的，而<code>Processor</code>用来实现<code>HTTP</code>协议的，<code>Adapter</code>将请求适配到<code>Servlet</code>容器进行具体的处理。</p>
<p>（3）<code>Endpoint</code>的抽象实现<code>AbstractEndpoint</code>里面定义的<code>Acceptor</code>和<code>AsyncTimeout</code>两个内部类和一个<code>Handler</code>接口。<code>Acceptor</code>用于监听请求，<code>AsyncTimeout</code>用于检查异步<code>Request</code>的超时，<code>Handler</code>用于处理接收到的<code>Socket</code>，在内部调用<code>Processor</code>进行处理。</p>
<p>至此，我们应该很轻松的回答（1）（2）（3）的问题了，但是（4）还是不知道，那么我们就来看一下<code>Container</code>是如何进行处理的以及处理完之后是如何将处理完的结果返回给<code>Connector</code>的？</p>
<h4 id="五、Container架构分析"><a href="#五、Container架构分析" class="headerlink" title="五、Container架构分析"></a><strong>五、Container架构分析</strong></h4><p><code>Container</code>用于封装和管理<code>Servlet</code>，以及具体处理<code>Request</code>请求，在<code>Connector</code>内部包含了4个子容器，结构图如下（图C）：</p>
<p><img src="http://static.cyblogs.com/fk1p1et9di.png" alt="img"></p>
<p>4个子容器的作用分别是：</p>
<p>（1）<code>Engine</code>：引擎，用来管理多个站点，一个<code>Service</code>最多只能有一个<code>Engine</code>； </p>
<p>（2）<code>Host</code>：代表一个站点，也可以叫虚拟主机，通过配置<code>Host</code>就可以添加站点； </p>
<p>（3）<code>Context</code>：代表一个应用程序，对应着平时开发的一套程序，或者一个<code>WEB-INF</code>目录以及下面的<code>web.xml</code>文件； </p>
<p>（4）<code>Wrapper</code>：每一<code>Wrapper</code>封装着一个<code>Servlet</code>；</p>
<p>下面找一个<code>Tomcat</code>的文件目录对照一下，如下图所示：</p>
<p><img src="http://static.cyblogs.com/w37kwebdoy.png" alt="img"></p>
<p><code>Context</code>和<code>Host</code>的区别是<code>Context</code>表示一个应用，我们的<code>Tomcat</code>中默认的配置下<code>webapps</code>下的每一个文件夹目录都是一个<code>Context</code>，其中<code>ROOT</code>目录中存放着主应用，其他目录存放着子应用，而整个<code>webapps</code>就是一个<code>Host</code>站点。</p>
<p>我们访问应用<code>Context</code>的时候，如果是<code>ROOT</code>下的则直接使用域名就可以访问，例如：<a target="_blank" rel="noopener" href="http://www.ledouit.com,如果是`host(webapps)`下的其他应用,则可以使用www.ledouit.com/docs%E8%BF%9B%E8%A1%8C%E8%AE%BF%E9%97%AE%EF%BC%8C%E5%BD%93%E7%84%B6%E9%BB%98%E8%AE%A4%E6%8C%87%E5%AE%9A%E7%9A%84%E6%A0%B9%E5%BA%94%E7%94%A8%EF%BC%88ROOT%EF%BC%89%E6%98%AF%E5%8F%AF%E4%BB%A5%E8%BF%9B%E8%A1%8C%E8%AE%BE%E5%AE%9A%E7%9A%84%EF%BC%8C%E5%8F%AA%E4%B8%8D%E8%BF%87Host%E7%AB%99%E7%82%B9%E4%B8%8B%E9%BB%98%E8%AE%A4%E7%9A%84%E4%B8%BB%E8%90%A5%E7%94%A8%E6%98%AFROOT%E7%9B%AE%E5%BD%95%E4%B8%8B%E7%9A%84%E3%80%82">www.ledouit.com,如果是`Host（webapps）`下的其他应用，则可以使用www.ledouit.com/docs进行访问，当然默认指定的根应用（ROOT）是可以进行设定的，只不过Host站点下默认的主营用是ROOT目录下的。</a></p>
<p>看到这里我们知道<code>Container</code>是什么，但是还是不知道<code>Container</code>是如何进行处理的以及处理完之后是如何将处理完的结果返回给<code>Connector</code>的？别急！下边就开始探讨一下<code>Container</code>是如何进行处理的！</p>
<h4 id="六、Container如何处理请求的"><a href="#六、Container如何处理请求的" class="headerlink" title="六、Container如何处理请求的"></a><strong>六、Container如何处理请求的</strong></h4><p><code>Container</code>处理请求是使用<code>Pipeline-Value</code>管道来处理的！</p>
<p><code>Pipeline-Value</code>是责任链模式，责任链模式是指在一个请求处理的过程中有很多处理者依次对请求进行处理，每个处理者负责做自己相应的处理，处理完之后将处理后的请求返回，再让下一个处理着继续处理。</p>
<p><img src="http://static.cyblogs.com/y6ugeww863.jpg" alt="img"></p>
<p>但是！<code>Pipeline-Value</code>使用的责任链模式和普通的责任链模式有些不同！区别主要有以下两点：</p>
<p>（1）每个<code>Pipeline</code>都有特定的<code>Value</code>，而且是在管道的最后一个执行，这个<code>Value</code>叫做<code>BaseValue</code>，<code>BaseValue</code>是不可删除的；</p>
<p>（2）在上层容器的管道的<code>BaseValue</code>中会调用下层容器的管道。</p>
<p>我们知道<code>Container</code>包含四个子容器，而这四个子容器对应的<code>BaseValue</code>分别在：<code>StandardEngineValue</code>、<code>StandardHostValue</code>、<code>StandardContextValue</code>、<code>StandardWrapperValue</code>。</p>
<p><code>Pipeline</code>的处理流程图如下（图D）：</p>
<p><img src="http://static.cyblogs.com/6bewzizid7.png" alt="img"></p>
<p>（1）<code>Connector</code>在接收到请求后会首先调用最顶层容器的<code>Pipeline</code>来处理，这里的最顶层容器的<code>Pipeline</code>就是<code>EnginePipeline</code>（<code>Engine</code>的管道）；</p>
<p>（2）在<code>Engine</code>的管道中依次会执行<code>EngineValue1</code>、<code>EngineValue2</code>等等，最后会执行<code>StandardEngineValue</code>，在<code>StandardEngineValue</code>中会调用<code>Host</code>管道，然后再依次执行<code>Host</code>的<code>HostValue1</code>、<code>HostValue2</code>等，最后在执行<code>StandardHostValue</code>，然后再依次调用<code>Context</code>的管道和<code>Wrapper</code>的管道，最后执行到<code>StandardWrapperValue</code>。</p>
<p>（3）当执行到<code>StandardWrapperValue</code>的时候，会在<code>StandardWrapperValue</code>中创建<code>FilterChain</code>，并调用其<code>doFilter</code>方法来处理请求，这个<code>FilterChain</code>包含着我们配置的与请求相匹配的<code>Filter</code>和<code>Servlet</code>，其<code>doFilter</code>方法会依次调用所有的<code>Filter</code>的<code>doFilter</code>方法和<code>Servlet</code>的<code>service</code>方法，这样请求就得到了处理！</p>
<p>（4）当所有的<code>Pipeline-Value</code>都执行完之后，并且处理完了具体的请求，这个时候就可以将返回的结果交给<code>Connector</code>了，<code>Connector</code>在通过<code>Socket</code>的方式将结果返回给客户端。</p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a><strong>总结</strong></h4><p>至此，我们已经对<code>Tomcat</code>的整体架构有了大致的了解，从图<code>A、B、C、D</code>可以看出来每一个组件的基本要素和作用。我们在脑海里应该有一个大概的轮廓了！如果你面试的时候，让你简单的聊一下<code>Tomcat</code>，上面的内容你能脱口而出吗？当你能够脱口而出的时候，这位面试官一定会对你刮目相看的！</p>
<h4 id="参考地址"><a href="#参考地址" class="headerlink" title="参考地址"></a>参考地址</h4><ul>
<li><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1181587">https://cloud.tencent.com/developer/article/1181587</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.cyblogs.com/2020/06/03/2020/06/%E7%A5%9E%E5%99%A8%E7%9A%84%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/vernonchen.jpg">
      <meta itemprop="name" content="Vernon">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简栈文化">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | 简栈文化">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/06/03/2020/06/%E7%A5%9E%E5%99%A8%E7%9A%84%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8/" class="post-title-link" itemprop="url">神器的布隆过滤器</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-06-03 00:00:00" itemprop="dateCreated datePublished" datetime="2020-06-03T00:00:00+08:00">2020-06-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-06-25 09:56:28" itemprop="dateModified" datetime="2025-06-25T09:56:28+08:00">2025-06-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8/" itemprop="url" rel="index"><span itemprop="name">布隆过滤器</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8/Redis/" itemprop="url" rel="index"><span itemprop="name">Redis</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="什么是布隆过滤器"><a href="#什么是布隆过滤器" class="headerlink" title="什么是布隆过滤器"></a><strong>什么是布隆过滤器</strong></h4><p>本质上布隆过滤器是一种数据结构，比较巧妙的概率型数据结构<code>（probabilistic data structure）</code>，特点是高效地插入和查询，可以用来告诉你 <strong>“某样东西一定不存在或者可能存在”</strong>。</p>
<p>相比于传统的 <code>List</code>、<code>Set</code>、<code>Map</code> 等数据结构，它更高效、占用空间更少，但是缺点是其返回的结果是概率性的，而不是确切的。</p>
<h4 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a><strong>实现原理</strong></h4><h5 id="HashMap-的问题"><a href="#HashMap-的问题" class="headerlink" title="HashMap 的问题"></a>HashMap 的问题</h5><p>讲述布隆过滤器的原理之前，我们先思考一下，通常你判断某个元素是否存在用的是什么？应该蛮多人回答 <code>HashMap</code> 吧，确实可以将值映射到 <code>HashMap</code> 的 <code>Key</code>，然后可以在 <code>O(1)</code> 的时间复杂度内返回结果，效率奇高。但是 <code>HashMap</code> 的实现也有缺点，例如存储容量占比高，考虑到负载因子的存在，通常空间是不能被用满的，而一旦你的值很多例如上亿的时候，那 <code>HashMap</code> 占据的内存大小就变得很可观了。</p>
<p>还比如说你的数据集存储在远程服务器上，本地服务接受输入，而数据集非常大不可能一次性读进内存构建 <code>HashMap</code> 的时候，也会存在问题。</p>
<p><strong>布隆过滤器数据结构</strong></p>
<p>布隆过滤器是一个 <code>bit</code> 向量或者说 <code>bit</code> 数组，长这样：</p>
<p><img src="http://static.cyblogs.com/QQ20200618-210117@2x.jpg" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;QQ20200618-210117@2x.jpg"></p>
<p>数组里面的值就只会存在<code>true</code>与<code>false</code>。</p>
<p>如果我们要映射一个值到布隆过滤器中，我们需要使用<strong>多个不同的哈希函数</strong>生成**多个哈希值，**并对每个生成的哈希值指向的 <code>bit</code> 位置 <code>1</code>，例如针对值 “<code>baidu</code>” 和三个不同的哈希函数分别生成了哈希值则上图转变为：</p>
<p><img src="http://static.cyblogs.com/QQ20200618-210604@2x.jpg" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;QQ20200618-210604@2x.jpg"></p>
<p>而当我们需要查询 “<code>baidu</code>” 这个值是否存在的话，那么哈希函数必然会返回图中的<code>3</code>个<code>bit</code>位，然后我们检查发现这三个 <code>bit</code> 位上的值均为 <code>1</code>，那么我们可以说 “<code>baidu</code>” <strong>存在了么？答案是不可以，只能是 “baidu” 这个值可能存在。</strong></p>
<p>这是为什么呢？答案跟简单，因为随着增加的值越来越多，被置为 <code>1</code> 的 <code>bit</code> 位也会越来越多，这样某个值 “<code>taobao</code>” 即使没有被存储过，但是万一哈希函数返回的三个 <code>bit</code> 位都被其他值置为了 <code>1</code> ，那么程序还是会判断 “<code>taobao</code>” 这个值存在。</p>
<h4 id="支持删除么"><a href="#支持删除么" class="headerlink" title="支持删除么"></a>支持删除么</h4><p>传统的布隆过滤器并不支持删除操作。但是名为 Counting Bloom filter 的变种可以用来测试元素计数个数是否绝对小于某个阈值，它支持元素删除。可以参考文章 Counting Bloom Filter 的原理和实现：<a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1136056">https://cloud.tencent.com/developer/article/1136056</a></p>
<p>Guava里的布隆过滤器：com.google.common.hash.BloomFilter</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 可能存在</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">mightContain</span><span class="params">(T object)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> strategy.mightContain(object, funnel, numHashFunctions, bits);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 放入值</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">put</span><span class="params">(T object)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> strategy.put(object, funnel, numHashFunctions, bits);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="如何选择哈希函数个数和布隆过滤器长度"><a href="#如何选择哈希函数个数和布隆过滤器长度" class="headerlink" title="如何选择哈希函数个数和布隆过滤器长度"></a>如何选择哈希函数个数和布隆过滤器长度</h4><p>很显然，过小的布隆过滤器很快所有的 <code>bit</code> 位均为 <code>1</code>，那么查询任何值都会返回“可能存在”，起不到过滤的目的了。布隆过滤器的长度会直接影响误报率，布隆过滤器越长其误报率越小。</p>
<p>另外，哈希函数的个数也需要权衡，个数越多则布隆过滤器 <code>bit</code> 位置位 <code>1</code> 的速度越快，且布隆过滤器的效率越低；但是如果太少的话，那我们的误报率会变高。</p>
<p><img src="http://static.cyblogs.com/QQ20200618-212220@2x.jpg" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;QQ20200618-212220@2x.jpg"></p>
<p>我们可以参考网站给的一个参考值：<a target="_blank" rel="noopener" href="https://krisives.github.io/bloom-calculator/">https://krisives.github.io/bloom-calculator/</a></p>
<p><img src="http://static.cyblogs.com/QQ20200618-212520@2x.jpg" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;QQ20200618-212520@2x.jpg"></p>
<p>比如：我们有<code>1000</code>的数量，误判率是<code>0.1</code>，那么需要<code>3.32</code>个<code>hash</code>函数，位的长度为<code>4793</code>。</p>
<h4 id="Redis-BloomFilter实践"><a href="#Redis-BloomFilter实践" class="headerlink" title="Redis-BloomFilter实践"></a>Redis-BloomFilter实践</h4><p><code>Redis</code>在<code>4.0</code>版本推出了 <code>module</code> 的形式，可以将 <code>module</code> 作为插件额外实现<code>Redis</code>的一些功能。官网推荐了一个 <code>RedisBloom</code> 作为 <code>Redis</code> 布隆过滤器的 <code>Module</code>。</p>
<p><code>RedisBloom</code>需要先进行安装，推荐使用<code>Docker</code>进行安装，简单方便:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker pull redislabs/rebloom:latest</span><br><span class="line">docker run -p 6379:6379 --name redis-redisbloom redislabs/rebloom:latest</span><br><span class="line">docker exec -it redis-redisbloom bash</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">redis-cli</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">127.0.0.1:6379&gt; bf.add tiancheng hello</span></span><br></pre></td></tr></table></figure>

<p>熟悉一下布隆过滤器基本指令:</p>
<ul>
<li><code>bf.add</code> 添加元素到布隆过滤器</li>
<li><code>bf.exists</code> 判断元素是否在布隆过滤器</li>
<li><code>bf.madd</code> 添加多个元素到布隆过滤器，<code>bf.add</code>只能添加一个</li>
<li><code>bf.mexists</code> 判断多个元素是否在布隆过滤器</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; bf.add tiancheng tc01</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; bf.add tiancheng tc02</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; bf.add tiancheng tc03</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; bf.exists tiancheng tc01</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; bf.exists tiancheng tc02</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; bf.exists tiancheng tc03</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; bf.exists tiancheng tc04</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; bf.madd tiancheng tc05 tc06 tc07</span><br><span class="line">1) (integer) 1</span><br><span class="line">2) (integer) 1</span><br><span class="line">3) (integer) 1</span><br><span class="line">127.0.0.1:6379&gt; bf.mexists tiancheng tc05 tc06 tc07 tc08</span><br><span class="line">1) (integer) 1</span><br><span class="line">2) (integer) 1</span><br><span class="line">3) (integer) 1</span><br><span class="line">4) (integer) 0</span><br></pre></td></tr></table></figure>

<h4 id="Redis-Bitmap实现简单的布隆过滤器"><a href="#Redis-Bitmap实现简单的布隆过滤器" class="headerlink" title="Redis Bitmap实现简单的布隆过滤器"></a>Redis Bitmap实现简单的布隆过滤器</h4><p><code>Bitmap</code>在<code>Redis</code>中并不是一个单独的数据类型，而是由字符串类型（<code>Redis</code>内部称<code>Simple Dynamic String，SDS</code>）之上定义的与比特相关的操作实现的，此时<code>SDS</code>就被当做位数组了。下面是在<code>redis-cli</code>中使用<code>getbit</code>和<code>setbit</code>指令的操作示例。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">字符串<span class="string">&quot;meow&quot;</span>的二进制表示：01101101 01100101 01101111 01110111</span></span><br><span class="line">es1:19000&gt; set bitmap_cat &quot;meow&quot;</span><br><span class="line">OK</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">最低位下标为0。取得第3位的比特（0）</span></span><br><span class="line">es1:19000&gt; getbit bitmap_cat 3</span><br><span class="line">(integer) 0</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">取得第23位的比特（1）</span></span><br><span class="line">es1:19000&gt; getbit bitmap_cat 23</span><br><span class="line">(integer) 1</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将第7位设为0</span></span><br><span class="line">es1:19000&gt; setbit bitmap_cat 7 0</span><br><span class="line">(integer) 1</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将第14位设为1</span></span><br><span class="line">es1:19000&gt; setbit bitmap_cat 14 1</span><br><span class="line">(integer) 0</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改过后的字符串变成了<span class="string">&quot;lgow&quot;</span></span></span><br><span class="line">es1:19000&gt; get bitmap_cat</span><br><span class="line">&quot;lgow&quot;</span><br></pre></td></tr></table></figure>

<p><code>Redis</code>的<code>Bitmap</code>是自动扩容的，亦即<code>get/set</code>到高位时，就会主动填充<code>0</code>。此外，还有<code>bitcount</code>指令用于计算特定字节范围内<code>1</code>的个数，<code>bitop</code>指令用来执行位运算（支持<code>and</code>、<code>or</code>、<code>xor</code>和<code>not</code>）。相应的用法可以查询<code>Redis</code>官方文档等。</p>
<h4 id="参考地址"><a href="#参考地址" class="headerlink" title="参考地址"></a>参考地址</h4><ul>
<li><a target="_blank" rel="noopener" href="https://www.jasondavies.com/bloomfilter/">https://www.jasondavies.com/bloomfilter/</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/43263751">https://zhuanlan.zhihu.com/p/43263751</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/c2defe549b40">https://www.jianshu.com/p/c2defe549b40</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.cyblogs.com/2020/06/02/2020/06/%E4%BD%A0%E6%98%AF%E5%90%A6%E7%9C%9F%E7%9A%84%E8%83%BD%E6%8A%8A%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F%E7%BB%99%E5%86%99%E5%A5%BD%EF%BC%9F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/vernonchen.jpg">
      <meta itemprop="name" content="Vernon">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简栈文化">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | 简栈文化">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/06/02/2020/06/%E4%BD%A0%E6%98%AF%E5%90%A6%E7%9C%9F%E7%9A%84%E8%83%BD%E6%8A%8A%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F%E7%BB%99%E5%86%99%E5%A5%BD%EF%BC%9F/" class="post-title-link" itemprop="url">你是否真的能把单例模式给写好？</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-06-02 00:00:00" itemprop="dateCreated datePublished" datetime="2020-06-02T00:00:00+08:00">2020-06-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-06-25 09:56:28" itemprop="dateModified" datetime="2025-06-25T09:56:28+08:00">2025-06-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>当你看到这个标题的时候，以为我是一个标题党？（其实也是…）</p>
<p>但是你真的不能小瞧这个单例模式，不信的话，你可以继续往下看。</p>
<h4 id="小白些单例模式"><a href="#小白些单例模式" class="headerlink" title="小白些单例模式"></a>小白些单例模式</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created with vernon-test</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>: 设计模式-单例模式</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: chenyuan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>: 2020/6/7</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@time</span>: 9:25 PM</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Singleton</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Singleton</span> <span class="variable">instance</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">Singleton</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="literal">null</span>) &#123;</span><br><span class="line">            instance = <span class="keyword">new</span> <span class="title class_">Singleton</span>();</span><br><span class="line">            System.out.println(<span class="string">&quot;我开始new对象了~&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这种单例估计是我们第一眼就能想到的，咋一眼看没问题，因为我们的大脑一眼反应我们的程序都是单线程的。实际上我们系统在初始化的时候就有可能存在多线程的情况。我们模拟并发写一个小程序来验证下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created with vernon-test</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>: 测试类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: chenyuan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>: 2020/6/7</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@time</span>: 9:27 PM</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestCase</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                    <span class="type">Singleton</span> <span class="variable">instance</span> <span class="operator">=</span> Singleton.getInstance();</span><br><span class="line">                    System.out.println(instance);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            thread.start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看一眼运行的结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">我开始new对象了~</span><br><span class="line">com.vernon.test.designpattern.singleton.Singleton@773d663a</span><br><span class="line">com.vernon.test.designpattern.singleton.Singleton@a963d08</span><br><span class="line">我开始new对象了~</span><br><span class="line">com.vernon.test.designpattern.singleton.Singleton@773d663a</span><br><span class="line">com.vernon.test.designpattern.singleton.Singleton@773d663a</span><br><span class="line">com.vernon.test.designpattern.singleton.Singleton@773d663a</span><br><span class="line">com.vernon.test.designpattern.singleton.Singleton@773d663a</span><br><span class="line">com.vernon.test.designpattern.singleton.Singleton@773d663a</span><br><span class="line">com.vernon.test.designpattern.singleton.Singleton@773d663a</span><br><span class="line">com.vernon.test.designpattern.singleton.Singleton@773d663a</span><br><span class="line">com.vernon.test.designpattern.singleton.Singleton@773d663a</span><br></pre></td></tr></table></figure>

<p>很明显，new了2次对象，看打印的对象地址也是不对的。</p>
<p>那我们如何去改进呢？– 加锁</p>
<h4 id="加synchronized锁"><a href="#加synchronized锁" class="headerlink" title="加synchronized锁"></a>加synchronized锁</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created with vernon-test</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>: 设计模式-单例模式</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: chenyuan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>: 2020/6/7</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@time</span>: 9:25 PM</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Singleton2</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Singleton2</span> <span class="variable">instance</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">Singleton2</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">		 </span><br><span class="line">    <span class="comment">// 加锁不就搞定了吗？</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> Singleton2 <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="literal">null</span>) &#123;</span><br><span class="line">            instance = <span class="keyword">new</span> <span class="title class_">Singleton2</span>();</span><br><span class="line">            System.out.println(<span class="string">&quot;我开始new对象了~&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个确实能解决掉问题，但是后续每次获取它的时候每次都要加锁排队，性能存在一定的问题。</p>
<h4 id="Double-Check"><a href="#Double-Check" class="headerlink" title="Double Check"></a>Double Check</h4><p>那是不是在方法里面做2次校验就能解决掉问题呢？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created with vernon-test</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>: 设计模式-单例模式</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: chenyuan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>: 2020/6/7</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@time</span>: 9:25 PM</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Singleton3</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Singleton3</span> <span class="variable">instance</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">Singleton3</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// double check</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Singleton3 <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (Singleton3.class) &#123;</span><br><span class="line">                <span class="keyword">if</span> (instance == <span class="literal">null</span>) &#123;</span><br><span class="line">                    instance = <span class="keyword">new</span> <span class="title class_">Singleton3</span>();</span><br><span class="line">                    System.out.println(<span class="string">&quot;我开始new对象了~&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从代码看上去，不管是单线程还是多线程，起码在<code>instance==null</code>的时候都能被hold住。但是表现懵逼了我们的双眼。如果这里发生了重排序，就会存在问题。</p>
<p>创建一个对象可以划分为3步：</p>
<ul>
<li>1、分配内存空间；</li>
<li>2、初始化对象；</li>
<li>3、将内存空间的地址赋值给对象的引用；</li>
</ul>
<p>如果发生重排序的话，步骤2~3有可能颠倒过来。</p>
<h4 id="防止重排序"><a href="#防止重排序" class="headerlink" title="防止重排序"></a>防止重排序</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created with vernon-test</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>: 设计模式-单例模式</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: chenyuan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>: 2020/6/7</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@time</span>: 9:25 PM</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Singleton4</span> &#123;</span><br><span class="line">	</span><br><span class="line">  	<span class="comment">// 加上volatile关键字，防止重排序</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="type">Singleton4</span> <span class="variable">instance</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">Singleton4</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// double check</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Singleton4 <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (Singleton4.class) &#123;</span><br><span class="line">                <span class="keyword">if</span> (instance == <span class="literal">null</span>) &#123;</span><br><span class="line">                    instance = <span class="keyword">new</span> <span class="title class_">Singleton4</span>();</span><br><span class="line">                    System.out.println(<span class="string">&quot;我开始new对象了~&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这里加上volatile关键字就可以很好的解决了。传送门：<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/HtMphMK8lyrieg-663q9og">https://mp.weixin.qq.com/s/HtMphMK8lyrieg-663q9og</a></p>
<h4 id="静态内部类"><a href="#静态内部类" class="headerlink" title="静态内部类"></a>静态内部类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created with vernon-test</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>: 设计模式-单例模式</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: chenyuan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>: 2020/6/7</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@time</span>: 9:25 PM</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Singleton5</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">SingletonHolder</span> &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">Singleton5</span> <span class="variable">instance</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Singleton5</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Singleton5 <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> SingletonHolder.instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该方法采用内部类来解决，加载一个类时，其内部类不会同时被加载。一个类被加载，当且仅当其某个静态成员（静态域、构造器、静态方法等）被调用时发生。 </p>
<h4 id="参考地址"><a href="#参考地址" class="headerlink" title="参考地址"></a>参考地址</h4><ul>
<li><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1DK4y1t7MY">https://www.bilibili.com/video/BV1DK4y1t7MY</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/zmx729618/article/details/69227762">https://blog.csdn.net/zmx729618/article/details/69227762</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.cyblogs.com/2020/06/01/2020/06/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E7%94%A8Redis%E8%BF%98%E6%98%AFZookeeper%EF%BC%9F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/vernonchen.jpg">
      <meta itemprop="name" content="Vernon">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简栈文化">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | 简栈文化">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/06/01/2020/06/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E7%94%A8Redis%E8%BF%98%E6%98%AFZookeeper%EF%BC%9F/" class="post-title-link" itemprop="url">分布式锁用Redis还是Zookeeper？</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-06-01 00:00:00" itemprop="dateCreated datePublished" datetime="2020-06-01T00:00:00+08:00">2020-06-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-06-25 09:56:28" itemprop="dateModified" datetime="2025-06-25T09:56:28+08:00">2025-06-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>为什么用分布式锁？在讨论这个问题之前，我们先来看一个业务场景。</p>
<h4 id="为什么用分布式锁？"><a href="#为什么用分布式锁？" class="headerlink" title="为什么用分布式锁？"></a>为什么用分布式锁？</h4><p>系统 A 是一个电商系统，目前是一台机器部署，系统中有一个用户下订单的接口，但是用户下订单之前一定要去检查一下库存，确保库存足够了才会给用户下单。</p>
<p>由于系统有一定的并发，所以会预先将商品的库存保存在 Redis 中，用户下单的时候会更新 Redis 的库存。</p>
<p>此时系统架构如下：</p>
<p><img src="https://s5.51cto.com/oss/201907/16/3e9e699864efd973960054445fbc67f4.jpg" alt="img"></p>
<p>但是这样一来会产生一个问题：假如某个时刻，Redis 里面的某个商品库存为 1。</p>
<p>此时两个请求同时到来，其中一个请求执行到上图的第 3 步，更新数据库的库存为 0，但是第 4 步还没有执行。</p>
<p>而另外一个请求执行到了第 2 步，发现库存还是 1，就继续执行第 3 步。这样的结果，是导致卖出了 2 个商品，然而其实库存只有 1 个。</p>
<p>很明显不对啊！这就是典型的库存超卖问题。此时，我们很容易想到解决方案：用锁把 2、3、4 步锁住，让他们执行完之后，另一个线程才能进来执行第 2 步。</p>
<p><img src="http://static.cyblogs.com/ce0fee95ef6880c9ac5ba670fe5be268.jpg" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;ce0fee95ef6880c9ac5ba670fe5be268.jpg"></p>
<p>按照上面的图，在执行第 2 步时，使用 Java 提供的 Synchronized 或者 ReentrantLock 来锁住，然后在第 4 步执行完之后才释放锁。</p>
<p>这样一来，2、3、4 这 3 个步骤就被“锁”住了，多个线程之间只能串行化执行。</p>
<p>但是好景不长，整个系统的并发飙升，一台机器扛不住了。现在要增加一台机器，如下图：</p>
<p><img src="http://static.cyblogs.com/99f3874bd484b4ea8000ca41023be3dc.jpg-wh_600x-s_592420448.jpg" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;99f3874bd484b4ea8000ca41023be3dc.jpg-wh_600x-s_592420448.jpg"></p>
<p>增加机器之后，系统变成上图所示，我的天！假设此时两个用户的请求同时到来，但是落在了不同的机器上，那么这两个请求是可以同时执行了，还是会出现库存超卖的问题。</p>
<p>为什么呢？因为上图中的两个 A 系统，运行在两个不同的 JVM 里面，他们加的锁只对属于自己 JVM 里面的线程有效，对于其他 JVM 的线程是无效的。</p>
<p>因此，这里的问题是：Java 提供的原生锁机制在多机部署场景下失效了，这是因为两台机器加的锁不是同一个锁（两个锁在不同的 JVM 里面）。</p>
<p>那么，我们只要保证两台机器加的锁是同一个锁，问题不就解决了吗？此时，就该分布式锁隆重登场了。</p>
<p>分布式锁的思路是：在整个系统提供一个全局、唯一的获取锁的“东西”，然后每个系统在需要加锁时，都去问这个“东西”拿到一把锁，这样不同的系统拿到的就可以认为是同一把锁。</p>
<p>至于这个“东西”，可以是 Redis、Zookeeper，也可以是数据库。文字描述不太直观，我们来看下图：</p>
<p><img src="http://static.cyblogs.com/3667d7cff8435d47f5a187ad596bdb09.jpg-wh_600x-s_1198484587.jpg" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;3667d7cff8435d47f5a187ad596bdb09.jpg-wh_600x-s_1198484587.jpg"></p>
<p>通过上面的分析，我们知道了库存超卖场景在分布式部署系统的情况下使用 Java 原生的锁机制无法保证线程安全，所以我们需要用到分布式锁的方案。</p>
<p>那么，如何实现分布式锁呢？接着往下看！</p>
<h4 id="基于-Redis-实现分布式锁"><a href="#基于-Redis-实现分布式锁" class="headerlink" title="基于 Redis 实现分布式锁"></a>基于 Redis 实现分布式锁</h4><p>上面分析为啥要使用分布式锁了，这里我们来具体看看分布式锁落地的时候应该怎么样处理。</p>
<p><strong>①常见的一种方案就是使用 Redis 做分布式锁</strong></p>
<p>使用 Redis 做分布式锁的思路大概是这样的：在 Redis 中设置一个值表示加了锁，然后释放锁的时候就把这个 Key 删除。</p>
<p>具体代码是这样的：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// 获取锁 </span><br><span class="line">// NX是指如果key不存在就成功，key存在返回<span class="literal">false</span>，PX可以指定过期时间 </span><br><span class="line">SET anyLock unique_value NX PX <span class="number">30000</span> </span><br><span class="line"> </span><br><span class="line">// 释放锁：通过执行一段lua脚本 </span><br><span class="line">// 释放锁涉及到两条指令，这两条指令不是原子性的 </span><br><span class="line">// 需要用到redis的lua脚本支持特性，redis执行lua脚本是原子性的 </span><br><span class="line"><span class="keyword">if</span> redis.call(<span class="string">&quot;get&quot;</span>,KEYS[<span class="number">1</span>]) == ARGV[<span class="number">1</span>] <span class="keyword">then</span> </span><br><span class="line"><span class="keyword">return</span> redis.call(<span class="string">&quot;del&quot;</span>,KEYS[<span class="number">1</span>]) </span><br><span class="line"><span class="keyword">else</span> </span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span> </span><br><span class="line"><span class="keyword">end</span> </span><br></pre></td></tr></table></figure>

<p>这种方式有几大要点：</p>
<ul>
<li>一定要用 SET key value NX PX milliseconds 命令。如果不用，先设置了值，再设置过期时间，这个不是原子性操作，有可能在设置过期时间之前宕机，会造成死锁(Key ***存在)</li>
<li>Value 要具有唯一性。这个是为了在解锁的时候，需要验证 Value 是和加锁的一致才删除 Key。</li>
</ul>
<p>这时避免了一种情况：假设 A 获取了锁，过期时间 30s，此时 35s 之后，锁已经自动释放了，A 去释放锁，但是此时可能 B 获取了锁。A 客户端就不能删除 B 的锁了。</p>
<p>除了要考虑客户端要怎么实现分布式锁之外，还需要考虑 Redis 的部署问题。</p>
<p>Redis 有 3 种部署方式：</p>
<ul>
<li>单机模式</li>
<li>Master-Slave+Sentinel 选举模式</li>
<li>Redis Cluster 模式</li>
</ul>
<p>使用 Redis 做分布式锁的缺点在于：如果采用单机部署模式，会存在单点问题，只要 Redis 故障了。加锁就不行了。</p>
<p>采用 Master-Slave 模式，加锁的时候只对一个节点加锁，即便通过 Sentinel 做了高可用，但是如果 Master 节点故障了，发生主从切换，此时就会有可能出现锁丢失的问题。</p>
<p>基于以上的考虑，Redis 的作者也考虑到这个问题，他提出了一个 RedLock 的算法。</p>
<p>这个算法的意思大概是这样的：假设 Redis 的部署模式是 Redis Cluster，总共有 5 个 Master 节点。</p>
<p>通过以下步骤获取一把锁：</p>
<ul>
<li>获取当前时间戳，单位是毫秒。</li>
<li>轮流尝试在每个 Master 节点上创建锁，过期时间设置较短，一般就几十毫秒。</li>
<li>尝试在大多数节点上建立一个锁，比如 5 个节点就要求是 3 个节点（n &#x2F; 2 +1）。</li>
<li>客户端计算建立好锁的时间，如果建立锁的时间小于超时时间，就算建立成功了。</li>
<li>要是锁建立失败了，那么就依次删除这个锁。</li>
<li>只要别人建立了一把分布式锁，你就得不断轮询去尝试获取锁。</li>
</ul>
<p>但是这样的这种算法还是颇具争议的，可能还会存在不少的问题，无法保证加锁的过程一定正确。</p>
<p><img src="http://static.cyblogs.com/da6b5468501519f5688e47824b56ba21.jpg-wh_600x-s_4091681668.jpg" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;da6b5468501519f5688e47824b56ba21.jpg-wh_600x-s_4091681668.jpg"></p>
<p><strong>②另一种方式：Redisson</strong></p>
<p>此外，实现 Redis 的分布式锁，除了自己基于 Redis Client 原生 API 来实现之外，还可以使用开源框架：Redission。</p>
<p>Redisson 是一个企业级的开源 Redis Client，也提供了分布式锁的支持。我也非常推荐大家使用，为什么呢？</p>
<p>回想一下上面说的，如果自己写代码来通过 Redis 设置一个值，是通过下面这个命令设置的：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SET anyLock unique_value NX PX <span class="number">30000</span> </span><br></pre></td></tr></table></figure>

<p>这里设置的超时时间是 30s，假如我超过 30s 都还没有完成业务逻辑的情况下，Key 会过期，其他线程有可能会获取到锁。</p>
<p>这样一来的话，***个线程还没执行完业务逻辑，第二个线程进来了也会出现线程安全问题。</p>
<p>所以我们还需要额外的去维护这个过期时间，太麻烦了~我们来看看 Redisson 是怎么实现的？</p>
<p>先感受一下使用 Redission 的爽：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>(); </span><br><span class="line">config.useClusterServers() </span><br><span class="line">.addNodeAddress(<span class="string">&quot;redis://192.168.31.101:7001&quot;</span>) </span><br><span class="line">.addNodeAddress(<span class="string">&quot;redis://192.168.31.101:7002&quot;</span>) </span><br><span class="line">.addNodeAddress(<span class="string">&quot;redis://192.168.31.101:7003&quot;</span>) </span><br><span class="line">.addNodeAddress(<span class="string">&quot;redis://192.168.31.102:7001&quot;</span>) </span><br><span class="line">.addNodeAddress(<span class="string">&quot;redis://192.168.31.102:7002&quot;</span>) </span><br><span class="line">.addNodeAddress(<span class="string">&quot;redis://192.168.31.102:7003&quot;</span>); </span><br><span class="line"> </span><br><span class="line"><span class="type">RedissonClient</span> <span class="variable">redisson</span> <span class="operator">=</span> Redisson.create(config); </span><br><span class="line"></span><br><span class="line"><span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> redisson.getLock(<span class="string">&quot;anyLock&quot;</span>); </span><br><span class="line">lock.lock(); </span><br><span class="line">lock.unlock(); </span><br></pre></td></tr></table></figure>

<p>就是这么简单，我们只需要通过它的 API 中的 Lock 和 Unlock 即可完成分布式锁，他帮我们考虑了很多细节：</p>
<ul>
<li>Redisson 所有指令都通过 Lua 脚本执行，Redis 支持 Lua 脚本原子性执行。</li>
<li>Redisson 设置一个 Key 的默认过期时间为 30s，如果某个客户端持有一个锁超过了 30s 怎么办？</li>
<li>Redisson 中有一个 Watchdog 的概念，翻译过来就是看门狗，它会在你获取锁之后，每隔 10s 帮你把 Key 的超时时间设为 30s。</li>
</ul>
<p>这样的话，就算一直持有锁也不会出现 Key 过期了，其他线程获取到锁的问题了。</p>
<ul>
<li>Redisson 的“看门狗”逻辑保证了没有死锁发生。(如果机器宕机了，看门狗也就没了。此时就不会延长 Key 的过期时间，到了 30s 之后就会自动过期了，其他线程可以获取到锁)</li>
</ul>
<p><img src="http://static.cyblogs.com/a7fbd80edbe1bc035e0a6e1c3c691ed7.jpg-wh_600x-s_1313345474.jpg" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;a7fbd80edbe1bc035e0a6e1c3c691ed7.jpg-wh_600x-s_1313345474.jpg"></p>
<p>这里稍微贴出来其实现代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 加锁逻辑 </span></span><br><span class="line"><span class="keyword">private</span> &lt;T&gt; RFuture&lt;Long&gt; <span class="title function_">tryAcquireAsync</span><span class="params">(<span class="type">long</span> leaseTime, TimeUnit unit, <span class="keyword">final</span> <span class="type">long</span> threadId)</span> &#123; </span><br><span class="line">    <span class="keyword">if</span> (leaseTime != -<span class="number">1</span>) &#123; </span><br><span class="line">        <span class="keyword">return</span> tryLockInnerAsync(leaseTime, unit, threadId, RedisCommands.EVAL_LONG); </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="comment">// 调用一段lua脚本，设置一些key、过期时间 </span></span><br><span class="line">    RFuture&lt;Long&gt; ttlRemainingFuture = tryLockInnerAsync(commandExecutor.getConnectionManager().getCfg().getLockWatchdogTimeout(), TimeUnit.MILLISECONDS, threadId, RedisCommands.EVAL_LONG); </span><br><span class="line">    ttlRemainingFuture.addListener(<span class="keyword">new</span> <span class="title class_">FutureListener</span>&lt;Long&gt;() &#123; </span><br><span class="line">        <span class="meta">@Override</span> </span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">operationComplete</span><span class="params">(Future&lt;Long&gt; future)</span> <span class="keyword">throws</span> Exception &#123; </span><br><span class="line">            <span class="keyword">if</span> (!future.isSuccess()) &#123; </span><br><span class="line">                <span class="keyword">return</span>; </span><br><span class="line">            &#125; </span><br><span class="line"> </span><br><span class="line">            <span class="type">Long</span> <span class="variable">ttlRemaining</span> <span class="operator">=</span> future.getNow(); </span><br><span class="line">            <span class="comment">// lock acquired </span></span><br><span class="line">            <span class="keyword">if</span> (ttlRemaining == <span class="literal">null</span>) &#123; </span><br><span class="line">                <span class="comment">// 看门狗逻辑 </span></span><br><span class="line">                scheduleExpirationRenewal(threadId); </span><br><span class="line">            &#125; </span><br><span class="line">        &#125; </span><br><span class="line">    &#125;); </span><br><span class="line">    <span class="keyword">return</span> ttlRemainingFuture; </span><br><span class="line">&#125; </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">&lt;T&gt; RFuture&lt;T&gt; <span class="title function_">tryLockInnerAsync</span><span class="params">(<span class="type">long</span> leaseTime, TimeUnit unit, <span class="type">long</span> threadId, RedisStrictCommand&lt;T&gt; command)</span> &#123; </span><br><span class="line">    internalLockLeaseTime = unit.toMillis(leaseTime); </span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> commandExecutor.evalWriteAsync(getName(), LongCodec.INSTANCE, command, </span><br><span class="line">              <span class="string">&quot;if (redis.call(&#x27;exists&#x27;, KEYS[1]) == 0) then &quot;</span> + </span><br><span class="line">                  <span class="string">&quot;redis.call(&#x27;hset&#x27;, KEYS[1], ARGV[2], 1); &quot;</span> + </span><br><span class="line">                  <span class="string">&quot;redis.call(&#x27;pexpire&#x27;, KEYS[1], ARGV[1]); &quot;</span> + </span><br><span class="line">                  <span class="string">&quot;return nil; &quot;</span> + </span><br><span class="line">              <span class="string">&quot;end; &quot;</span> + </span><br><span class="line">              <span class="string">&quot;if (redis.call(&#x27;hexists&#x27;, KEYS[1], ARGV[2]) == 1) then &quot;</span> + </span><br><span class="line">                  <span class="string">&quot;redis.call(&#x27;hincrby&#x27;, KEYS[1], ARGV[2], 1); &quot;</span> + </span><br><span class="line">                  <span class="string">&quot;redis.call(&#x27;pexpire&#x27;, KEYS[1], ARGV[1]); &quot;</span> + </span><br><span class="line">                  <span class="string">&quot;return nil; &quot;</span> + </span><br><span class="line">              <span class="string">&quot;end; &quot;</span> + </span><br><span class="line">              <span class="string">&quot;return redis.call(&#x27;pttl&#x27;, KEYS[1]);&quot;</span>, </span><br><span class="line">                Collections.&lt;Object&gt;singletonList(getName()), internalLockLeaseTime, getLockName(threadId)); </span><br><span class="line">&#125; </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment">// 看门狗最终会调用了这里 </span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">scheduleExpirationRenewal</span><span class="params">(<span class="keyword">final</span> <span class="type">long</span> threadId)</span> &#123; </span><br><span class="line">    <span class="keyword">if</span> (expirationRenewalMap.containsKey(getEntryName())) &#123; </span><br><span class="line">        <span class="keyword">return</span>; </span><br><span class="line">    &#125; </span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 这个任务会延迟10s执行 </span></span><br><span class="line">    <span class="type">Timeout</span> <span class="variable">task</span> <span class="operator">=</span> commandExecutor.getConnectionManager().newTimeout(<span class="keyword">new</span> <span class="title class_">TimerTask</span>() &#123; </span><br><span class="line">        <span class="meta">@Override</span> </span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(Timeout timeout)</span> <span class="keyword">throws</span> Exception &#123; </span><br><span class="line"> </span><br><span class="line">            <span class="comment">// 这个操作会将key的过期时间重新设置为30s </span></span><br><span class="line">            RFuture&lt;Boolean&gt; future = renewExpirationAsync(threadId); </span><br><span class="line"> </span><br><span class="line">            future.addListener(<span class="keyword">new</span> <span class="title class_">FutureListener</span>&lt;Boolean&gt;() &#123; </span><br><span class="line">                <span class="meta">@Override</span> </span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">operationComplete</span><span class="params">(Future&lt;Boolean&gt; future)</span> <span class="keyword">throws</span> Exception &#123; </span><br><span class="line">                    expirationRenewalMap.remove(getEntryName()); </span><br><span class="line">                    <span class="keyword">if</span> (!future.isSuccess()) &#123; </span><br><span class="line">                        log.error(<span class="string">&quot;Can&#x27;t update lock &quot;</span> + getName() + <span class="string">&quot; expiration&quot;</span>, future.cause()); </span><br><span class="line">                        <span class="keyword">return</span>; </span><br><span class="line">                    &#125; </span><br><span class="line"> </span><br><span class="line">                    <span class="keyword">if</span> (future.getNow()) &#123; </span><br><span class="line">                        <span class="comment">// reschedule itself </span></span><br><span class="line">                        <span class="comment">// 通过递归调用本方法，***循环延长过期时间 </span></span><br><span class="line">                        scheduleExpirationRenewal(threadId); </span><br><span class="line">                    &#125; </span><br><span class="line">                &#125; </span><br><span class="line">            &#125;); </span><br><span class="line">        &#125; </span><br><span class="line"> </span><br><span class="line">    &#125;, internalLockLeaseTime / <span class="number">3</span>, TimeUnit.MILLISECONDS); </span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (expirationRenewalMap.putIfAbsent(getEntryName(), <span class="keyword">new</span> <span class="title class_">ExpirationEntry</span>(threadId, task)) != <span class="literal">null</span>) &#123; </span><br><span class="line">        task.cancel(); </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p>另外，Redisson 还提供了对 Redlock 算法的支持，它的用法也很简单：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">RedissonClient</span> <span class="variable">redisson</span> <span class="operator">=</span> Redisson.create(config); </span><br><span class="line"><span class="type">RLock</span> <span class="variable">lock1</span> <span class="operator">=</span> redisson.getFairLock(<span class="string">&quot;lock1&quot;</span>); </span><br><span class="line"><span class="type">RLock</span> <span class="variable">lock2</span> <span class="operator">=</span> redisson.getFairLock(<span class="string">&quot;lock2&quot;</span>); </span><br><span class="line"><span class="type">RLock</span> <span class="variable">lock3</span> <span class="operator">=</span> redisson.getFairLock(<span class="string">&quot;lock3&quot;</span>); </span><br><span class="line"><span class="type">RedissonRedLock</span> <span class="variable">multiLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RedissonRedLock</span>(lock1, lock2, lock3); </span><br><span class="line">multiLock.lock(); </span><br><span class="line">multiLock.unlock(); </span><br></pre></td></tr></table></figure>

<p>小结：本节分析了使用 Redis 作为分布式锁的具体落地方案以及其一些局限性，然后介绍了一个 Redis 的客户端框架 Redisson，这也是我推荐大家使用的，比自己写代码实现会少 Care 很多细节。</p>
<h4 id="基于-Zookeeper-实现分布式锁"><a href="#基于-Zookeeper-实现分布式锁" class="headerlink" title="基于 Zookeeper 实现分布式锁"></a>基于 Zookeeper 实现分布式锁</h4><p>常见的分布式锁实现方案里面，除了使用 Redis 来实现之外，使用 Zookeeper 也可以实现分布式锁。</p>
<p>在介绍 Zookeeper(下文用 ZK 代替)实现分布式锁的机制之前，先粗略介绍一下 ZK 是什么东西：ZK 是一种提供配置管理、分布式协同以及命名的中心化服务。</p>
<p>ZK 的模型是这样的：ZK 包含一系列的节点，叫做 Znode，就好像文件系统一样，每个 Znode 表示一个目录。</p>
<p>然后 Znode 有一些特性：</p>
<ul>
<li>有序节点：假如当前有一个父节点为 &#x2F;lock，我们可以在这个父节点下面创建子节点，ZK 提供了一个可选的有序特性。</li>
</ul>
<p>例如我们可以创建子节点“&#x2F;lock&#x2F;node-”并且指明有序，那么 ZK 在生成子节点时会根据当前的子节点数量自动添加整数序号。</p>
<p>也就是说，如果是***个创建的子节点，那么生成的子节点为 &#x2F;lock&#x2F;node-0000000000，下一个节点则为 &#x2F;lock&#x2F;node-0000000001，依次类推。</p>
<ul>
<li>临时节点：客户端可以建立一个临时节点，在会话结束或者会话超时后，ZK 会自动删除该节点。</li>
<li>事件监听：在读取数据时，我们可以同时对节点设置事件监听，当节点数据或结构变化时，ZK 会通知客户端。</li>
</ul>
<p>当前 ZK 有如下四种事件：</p>
<ul>
<li>节点创建</li>
<li>节点删除</li>
<li>节点数据修改</li>
<li>子节点变更</li>
</ul>
<p>基于以上的一些 ZK 的特性，我们很容易得出使用 ZK 实现分布式锁的落地方案：</p>
<ul>
<li>使用 ZK 的临时节点和有序节点，每个线程获取锁就是在 ZK 创建一个临时有序的节点，比如在 &#x2F;lock&#x2F; 目录下。</li>
<li>创建节点成功后，获取 &#x2F;lock 目录下的所有临时节点，再判断当前线程创建的节点是否是所有的节点的序号最小的节点。</li>
<li>如果当前线程创建的节点是所有节点序号最小的节点，则认为获取锁成功。</li>
<li>如果当前线程创建的节点不是所有节点序号最小的节点，则对节点序号的前一个节点添加一个事件监听。</li>
</ul>
<p>比如当前线程获取到的节点序号为 &#x2F;lock&#x2F;003，然后所有的节点列表为[&#x2F;lock&#x2F;001，&#x2F;lock&#x2F;002，&#x2F;lock&#x2F;003]，则对 &#x2F;lock&#x2F;002 这个节点添加一个事件监听器。</p>
<p>如果锁释放了，会唤醒下一个序号的节点，然后重新执行第 3 步，判断是否自己的节点序号是最小。</p>
<p>比如 &#x2F;lock&#x2F;001 释放了，&#x2F;lock&#x2F;002 监听到时间，此时节点集合为[&#x2F;lock&#x2F;002，&#x2F;lock&#x2F;003]，则 &#x2F;lock&#x2F;002 为最小序号节点，获取到锁。</p>
<p>整个过程如下：</p>
<p><img src="http://static.cyblogs.com/fb6c27bb22de93cbeb965718156f578f.jpg" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;fb6c27bb22de93cbeb965718156f578f.jpg"></p>
<p>具体的实现思路就是这样，至于代码怎么写，这里比较复杂就不贴出来了。</p>
<p><strong>Curator 介绍</strong></p>
<p>Curator 是一个 ZK 的开源客户端，也提供了分布式锁的实现。它的使用方式也比较简单：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">InterProcessMutex</span> <span class="variable">interProcessMutex</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InterProcessMutex</span>(client,<span class="string">&quot;/anyLock&quot;</span>); </span><br><span class="line">interProcessMutex.acquire(); </span><br><span class="line">interProcessMutex.release(); </span><br></pre></td></tr></table></figure>

<p>其实现分布式锁的核心源码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">internalLockLoop</span><span class="params">(<span class="type">long</span> startMillis, Long millisToWait, String ourPath)</span> <span class="keyword">throws</span> Exception </span><br><span class="line">&#123; </span><br><span class="line">    <span class="type">boolean</span>  <span class="variable">haveTheLock</span> <span class="operator">=</span> <span class="literal">false</span>; </span><br><span class="line">    <span class="type">boolean</span>  <span class="variable">doDelete</span> <span class="operator">=</span> <span class="literal">false</span>; </span><br><span class="line">    <span class="keyword">try</span> &#123; </span><br><span class="line">        <span class="keyword">if</span> ( revocable.get() != <span class="literal">null</span> ) &#123; </span><br><span class="line">            client.getData().usingWatcher(revocableWatcher).forPath(ourPath); </span><br><span class="line">        &#125; </span><br><span class="line"> </span><br><span class="line">        <span class="keyword">while</span> ( (client.getState() == CuratorFrameworkState.STARTED) &amp;&amp; !haveTheLock ) &#123; </span><br><span class="line">            <span class="comment">// 获取当前所有节点排序后的集合 </span></span><br><span class="line">            List&lt;String&gt;        children = getSortedChildren(); </span><br><span class="line">            <span class="comment">// 获取当前节点的名称 </span></span><br><span class="line">            <span class="type">String</span>              <span class="variable">sequenceNodeName</span> <span class="operator">=</span> ourPath.substring(basePath.length() + <span class="number">1</span>); <span class="comment">// +1 to include the slash </span></span><br><span class="line">            <span class="comment">// 判断当前节点是否是最小的节点 </span></span><br><span class="line">            <span class="type">PredicateResults</span>    <span class="variable">predicateResults</span> <span class="operator">=</span> driver.getsTheLock(client, children, sequenceNodeName, maxLeases); </span><br><span class="line">            <span class="keyword">if</span> ( predicateResults.getsTheLock() ) &#123; </span><br><span class="line">                <span class="comment">// 获取到锁 </span></span><br><span class="line">                haveTheLock = <span class="literal">true</span>; </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">                <span class="comment">// 没获取到锁，对当前节点的上一个节点注册一个监听器 </span></span><br><span class="line">                <span class="type">String</span>  <span class="variable">previousSequencePath</span> <span class="operator">=</span> basePath + <span class="string">&quot;/&quot;</span> + predicateResults.getPathToWatch(); </span><br><span class="line">                <span class="keyword">synchronized</span>(<span class="built_in">this</span>)&#123; </span><br><span class="line">                    <span class="type">Stat</span> <span class="variable">stat</span> <span class="operator">=</span> client.checkExists().usingWatcher(watcher).forPath(previousSequencePath); </span><br><span class="line">                    <span class="keyword">if</span> ( stat != <span class="literal">null</span> )&#123; </span><br><span class="line">                        <span class="keyword">if</span> ( millisToWait != <span class="literal">null</span> )&#123; </span><br><span class="line">                            millisToWait -= (System.currentTimeMillis() - startMillis); </span><br><span class="line">                            startMillis = System.currentTimeMillis(); </span><br><span class="line">                            <span class="keyword">if</span> ( millisToWait &lt;= <span class="number">0</span> )&#123; </span><br><span class="line">                                doDelete = <span class="literal">true</span>;    <span class="comment">// timed out - delete our node </span></span><br><span class="line">                                <span class="keyword">break</span>; </span><br><span class="line">                            &#125; </span><br><span class="line">                            wait(millisToWait); </span><br><span class="line">                        &#125;<span class="keyword">else</span>&#123; </span><br><span class="line">                            wait(); </span><br><span class="line">                        &#125; </span><br><span class="line">                    &#125; </span><br><span class="line">                &#125; </span><br><span class="line">                <span class="comment">// else it may have been deleted (i.e. lock released). Try to acquire again </span></span><br><span class="line">            &#125; </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">catch</span> ( Exception e ) &#123; </span><br><span class="line">        doDelete = <span class="literal">true</span>; </span><br><span class="line">        <span class="keyword">throw</span> e; </span><br><span class="line">    &#125; <span class="keyword">finally</span>&#123; </span><br><span class="line">        <span class="keyword">if</span> ( doDelete )&#123; </span><br><span class="line">            deleteOurPath(ourPath); </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">return</span> haveTheLock; </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p>其实 Curator 实现分布式锁的底层原理和上面分析的是差不多的。这里我们用一张图详细描述其原理：</p>
<p><img src="https://s5.51cto.com/oss/201907/16/84636c96585ff2611ff55e284a57c6ab.jpg-wh_600x-s_3685227374.jpg" alt="https:&#x2F;&#x2F;s5.51cto.com&#x2F;oss&#x2F;201907&#x2F;16&#x2F;84636c96585ff2611ff55e284a57c6ab.jpg-wh_600x-s_3685227374.jpg"></p>
<p>小结：本节介绍了 ZK 实现分布式锁的方案以及 ZK 的开源客户端的基本使用，简要的介绍了其实现原理。</p>
<h4 id="两种方案的优缺点比较"><a href="#两种方案的优缺点比较" class="headerlink" title="两种方案的优缺点比较"></a>两种方案的优缺点比较</h4><p>学完了两种分布式锁的实现方案之后，本节需要讨论的是 Redis 和 ZK 的实现方案中各自的优缺点。</p>
<p>对于 Redis 的分布式锁而言，它有以下缺点：</p>
<ul>
<li>它获取锁的方式简单粗暴，获取不到锁直接不断尝试获取锁，比较消耗性能。</li>
<li>另外来说的话，Redis 的设计定位决定了它的数据并不是强一致性的，在某些极端情况下，可能会出现问题。锁的模型不够健壮。</li>
<li>即便使用 Redlock 算法来实现，在某些复杂场景下，也无法保证其实现 100% 没有问题，关于 Redlock 的讨论可以看 How to do distributed locking。</li>
<li>Redis 分布式锁，其实需要自己不断去尝试获取锁，比较消耗性能。</li>
</ul>
<p>但是另一方面使用 Redis 实现分布式锁在很多企业中非常常见，而且大部分情况下都不会遇到所谓的“极端复杂场景”。</p>
<p>所以使用 Redis 作为分布式锁也不失为一种好的方案，最重要的一点是 Redis 的性能很高，可以支撑高并发的获取、释放锁操作。</p>
<p>对于 ZK 分布式锁而言:</p>
<ul>
<li>ZK 天生设计定位就是分布式协调，强一致性。锁的模型健壮、简单易用、适合做分布式锁。</li>
<li>如果获取不到锁，只需要添加一个监听器就可以了，不用一直轮询，性能消耗较小。</li>
</ul>
<p>但是 ZK 也有其缺点：如果有较多的客户端频繁的申请加锁、释放锁，对于 ZK 集群的压力会比较大。</p>
<p>小结：综上所述，Redis 和 ZK 都有其优缺点。我们在做技术选型的时候可以根据这些问题作为参考因素。</p>
<h4 id="一些建议"><a href="#一些建议" class="headerlink" title="一些建议"></a>一些建议</h4><p>通过前面的分析，实现分布式锁的两种常见方案：Redis 和 ZK，他们各有千秋。应该如何选型呢？</p>
<p>就个人而言的话，我比较推崇 ZK 实现的锁：因为 Redis 是有可能存在隐患的，可能会导致数据不对的情况。但是，怎么选用要看具体在公司的场景了。</p>
<p>如果公司里面有 ZK 集群条件，优先选用 ZK 实现，但是如果说公司里面只有 Redis 集群，没有条件搭建 ZK 集群。</p>
<p>那么其实用 Redis 来实现也可以，另外还可能是系统设计者考虑到了系统已经有 Redis，但是又不希望再次引入一些外部依赖的情况下，可以选用 Redis。这个是要系统设计者基于架构来考虑了。</p>
<h4 id="参考地址"><a href="#参考地址" class="headerlink" title="参考地址"></a>参考地址</h4><ul>
<li><a target="_blank" rel="noopener" href="https://developer.51cto.com/art/201907/599642.htm">https://developer.51cto.com/art/201907/599642.htm</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.cyblogs.com/2020/05/15/2020/05/Linux%20Rsync%20%E5%A2%9E%E9%87%8F%E5%90%8C%E6%AD%A5%E4%B8%8E%E5%BF%AB%E9%80%9F%E5%88%A0%E9%99%A4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/vernonchen.jpg">
      <meta itemprop="name" content="Vernon">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简栈文化">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | 简栈文化">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/05/15/2020/05/Linux%20Rsync%20%E5%A2%9E%E9%87%8F%E5%90%8C%E6%AD%A5%E4%B8%8E%E5%BF%AB%E9%80%9F%E5%88%A0%E9%99%A4/" class="post-title-link" itemprop="url">Linux Rsync 增量同步与快速删除</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-05-15 00:00:00" itemprop="dateCreated datePublished" datetime="2020-05-15T00:00:00+08:00">2020-05-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-06-25 09:56:28" itemprop="dateModified" datetime="2025-06-25T09:56:28+08:00">2025-06-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="增量同步"><a href="#增量同步" class="headerlink" title="增量同步"></a>增量同步</h4><p><code>rsync [args] SRC [DEST]</code><br>情形：同时维护着两份不同的<code>data_center</code>，但以<code>old_data_center</code>为标准。因为权限的缘故没有开启rsync自动同步，只是每隔一段时间手动同步一下。<code>SRC</code>和<code>DEST</code>都是采用mount形式，如果每一次都完整地<code>copy</code>，耗时很长，这时候就想到采用增量同步的方法，因为两份<code>data_center</code>同时由不同人维护，所以内容略有不同，<code>data_center</code>同步的时候不光要完全同步<code>old_data_center</code>的所有内容，而且要删除自身多余的内容，保持完全一致。</p>
<p><img src="http://static.cyblogs.com/1559267-20190509170938551-832776092.png" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;1559267-20190509170938551-832776092.png"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rsync -a </span><br><span class="line">--delete </span><br><span class="line">--progress /old_vip_data_center/test_envs/trainer/resource /vip_data_center/test_envs/trainer/resource/</span><br></pre></td></tr></table></figure>

<p>–delete: 删除<code>DEST</code>端存在但是<code>SRC</code>端不存在的文件，如果不使用此参数，则DEST端会同步SRC端的文件，但DEST端已有的文件不受影响。</p>
<h4 id="快速删除大量文件"><a href="#快速删除大量文件" class="headerlink" title="快速删除大量文件"></a>快速删除大量文件</h4><ol>
<li><p>先建一个空目录，随便位置</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir /local/empty_dir</span><br></pre></td></tr></table></figure>
</li>
<li><p>用rsync删除目标目录</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rsync --delete-before -avH --progress /local/empty_dir/ /local/trainer_test/</span><br></pre></td></tr></table></figure></li>
</ol>
<p><code>trainer_test</code>清空之后可以再用<code>rm -rf trainer_test</code>删除</p>
<p>注意不要忘了文件夹最后的<code>/</code></p>
<p><code>rsync</code>提供了一些跟删除相关的参数</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rsync --help | grep delete</span><br><span class="line">--del an alias for --delete-during</span><br><span class="line">--delete-before receiver deletes before transfer (default)</span><br></pre></td></tr></table></figure>

<p>选项说明：<br>-a 递归方式传输文件，并保持文件属性<br>–delete-before 接收者在传输之前进行删除操作<br>–progress 在传输时显示传输过程<br>– 归档模式，表示以递归方式传输文件，并保持所有文件属性<br>-H 保持硬连接的文件<br>-v 详细输出模式<br>-stats 给出某些文件的传输状态</p>
<p>不过在使用上面的命令进行清理时，存在一个问题，清空后，目标目录的权限会和源目录的权限一样。如：<code>/tmp/empty</code>是<code>root：root</code>，而<code>maildrop</code>之前是<code>postfix：postdrop</code> ，执行之后也会<code>maildrop</code>目录的权限也会变成<code>root：root</code> 。由于-a权限是-rlptogD几个参数的集合，所以可以将og（owner:group）两个参数去掉。清空时自动保持之前的目录权限，如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rsync --delete -rlptD /tmp/empty/ /var/spool/postfix/maildrop/</span><br></pre></td></tr></table></figure>

<h4 id="为什么rsync这么快呢？"><a href="#为什么rsync这么快呢？" class="headerlink" title="为什么rsync这么快呢？"></a>为什么rsync这么快呢？</h4><p>rm删除内容时，将目录的每一个条目逐个删除(unlink)，需要循环重复操作很多次；</p>
<p>rsync删除内容时，建立好新的空目录，替换掉老目录，基本没开销。</p>
<blockquote>
<p>If you want to conquer fear, don’t sit home and think about it. Go out and get busy.</p>
</blockquote>
<h4 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h4><p>今天因为用代码生成SQL脚本的时候，本来是说100W的数据生成一个的，结果因为一个运算符的问题导致了生成上百万的小文件。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> ((line = br.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (count &lt; skipHeadCount) &#123;</span><br><span class="line">        count++;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 每MAX_SIZE就会生成一个,MAX_SIZE=1000000</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">fileExtName</span> <span class="operator">=</span> (count - skipHeadCount) / MAX_SIZE; <span class="comment">// 当时种类count - skipHeadCount忘记打括号了</span></span><br><span class="line">    <span class="keyword">if</span> (fileExtName &gt; currentFileExtName) &#123;</span><br><span class="line">        bw.flush();</span><br><span class="line">        currentFileExtName = fileExtName;</span><br><span class="line">        bw = <span class="keyword">new</span> <span class="title class_">BufferedWriter</span>(<span class="keyword">new</span> <span class="title class_">OutputStreamWriter</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="keyword">new</span> <span class="title class_">File</span>(String.format(fileOutputPath, currentFileExtName)))));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">String</span> <span class="variable">formatStr</span> <span class="operator">=</span> genService.format(line);</span><br><span class="line">    bw.write(formatStr);</span><br><span class="line">    bw.newLine();</span><br><span class="line">    log.info(<span class="string">&quot;count:&#123;&#125;&quot;</span>, count);</span><br><span class="line">    count++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>删除的时候会报错</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Argument list too long</span><br></pre></td></tr></table></figure>

<p>实战后发现效率贵高的一种方式：</p>
<p><img src="http://static.cyblogs.com/WechatIMG461.png" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;WechatIMG461.png"></p>
<h4 id="参考地址"><a href="#参考地址" class="headerlink" title="参考地址"></a>参考地址</h4><ul>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/sayiqiu/p/10816572.html">https://www.cnblogs.com/sayiqiu/p/10816572.html</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.cyblogs.com/2020/05/14/2020/05/JVM%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-%E5%86%85%E5%AD%98%E8%B0%83%E4%BC%98%E4%B8%8EGC%E6%97%A5%E5%BF%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/vernonchen.jpg">
      <meta itemprop="name" content="Vernon">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简栈文化">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | 简栈文化">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/05/14/2020/05/JVM%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-%E5%86%85%E5%AD%98%E8%B0%83%E4%BC%98%E4%B8%8EGC%E6%97%A5%E5%BF%97/" class="post-title-link" itemprop="url">JVM深入理解-内存调优与GC日志</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-05-14 00:00:00" itemprop="dateCreated datePublished" datetime="2020-05-14T00:00:00+08:00">2020-05-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-06-25 09:56:28" itemprop="dateModified" datetime="2025-06-25T09:56:28+08:00">2025-06-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h6 id="CPU飚高分析"><a href="#CPU飚高分析" class="headerlink" title="CPU飚高分析"></a>CPU飚高分析</h6><p>一般可以使用</p>
<ul>
<li>ps -Lfp pid</li>
<li>ps -mp pid -o THREAD, tid, time</li>
<li>top -Hp pid</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@redis webapps]# top -Hp 22272</span><br><span class="line">top - 10:09:30 up 9 days, 22:10,  1 user,  load average: 0.00, 0.00, 0.00</span><br><span class="line">Tasks:  30 total,   0 running,  30 sleeping,   0 stopped,   0 zombie</span><br><span class="line">Cpu(s):  0.0%us,  0.0%sy,  0.0%ni,100.0%id,  0.0%wa,  0.0%hi,  0.0%si,  0.0%st</span><br><span class="line">Mem:   3923196k total,  3795588k used,   127608k free,   153056k buffers</span><br><span class="line">Swap:  6160376k total,        0k used,  6160376k free,  3079244k cached</span><br><span class="line"></span><br><span class="line">  PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND                                                                                </span><br><span class="line">22272 root      20   0 2286m 122m  11m S  0.0  3.2   0:00.00 java                                                                                                                                                    </span><br><span class="line">22278 root      20   0 2286m 122m  11m S  0.0  3.2   0:00.00 java                                                                                    </span><br></pre></td></tr></table></figure>

<p>TIME列就是各个Java线程耗费的CPU时间，CPU时间最长的是线程ID为22283 的线程。</p>
<p>用 <code>printf &quot;%x\n&quot; 22283</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@redis webapps]# printf ‘%x\n’ 22283</span><br><span class="line">570b得到22283 的十六进制值为570b。</span><br></pre></td></tr></table></figure>

<p>下一步轮到jstack上场了，它用来输出进程22272 的堆栈信息，然后根据线程ID的十六进制值grep，如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@redis webapps]# jstack 22272 | grep 570b</span><br><span class="line">“SchedulerThread” prio=10 tid=0x00007f950043e000 nid=0x54ee in Object.wait()</span><br></pre></td></tr></table></figure>

<p>可以看到CPU消耗在SchedulerThread这个类的Object.wait()，定位到下面的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Idle wait</span></span><br><span class="line"><span class="keyword">synchronized</span>(sigLock) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(!halted.get()) &#123;</span><br><span class="line">      sigLock.wait(timeUntilContinue);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; </span><br><span class="line">  <span class="keyword">catch</span> (InterruptedException ignore) &#123;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>它是轮询任务的空闲等待代码，上面的sigLock.wait(timeUntilContinue)就对应了前面的Object.wait()。</p>
<p>总结：可以通过PID找到对应的的线程，然后通过JVM的jstack找到栈里对应的线程信息。通过找到对应的代码一般就能分析出CPU占用高的原因。</p>
<h4 id="利用JVM命令分析"><a href="#利用JVM命令分析" class="headerlink" title="利用JVM命令分析"></a>利用JVM命令分析</h4><h5 id="jstat-gcutil"><a href="#jstat-gcutil" class="headerlink" title="jstat -gcutil"></a>jstat -gcutil</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@xxxx-nccz8-b57dd64fc-nt9dj logs]# jstat -gcutil 1 2000 20</span><br><span class="line">S0     S1     E      O      M     CCS    YGC     YGCT    FGC    FGCT     GCT   </span><br><span class="line">  0.00   8.64   2.62  27.32  80.59  73.86   1350   22.705     5    1.449   24.154</span><br><span class="line">  0.00   8.64   2.81  27.32  80.59  73.86   1350   22.705     5    1.449   24.154</span><br><span class="line">  0.00   8.64   2.81  27.32  80.59  73.86   1350   22.705     5    1.449   24.154</span><br><span class="line">  0.00   8.64   2.81  27.32  80.59  73.86   1350   22.705     5    1.449   24.154</span><br><span class="line">  0.00   8.64   3.06  27.32  80.59  73.86   1350   22.705     5    1.449   24.154</span><br><span class="line">  0.00   8.64   3.10  27.32  80.59  73.86   1350   22.705     5    1.449   24.154</span><br><span class="line">  0.00   8.64   3.10  27.32  80.59  73.86   1350   22.705     5    1.449   24.154</span><br><span class="line">  0.00   8.64   3.21  27.32  80.59  73.86   1350   22.705     5    1.449   24.154</span><br><span class="line">  0.00   8.64   3.22  27.32  80.59  73.86   1350   22.705     5    1.449   24.154</span><br><span class="line">  0.00   8.64   3.61  27.32  80.59  73.86   1350   22.705     5    1.449   24.154</span><br><span class="line">  0.00   8.64   6.47  27.32  80.59  73.86   1350   22.705     5    1.449   24.154</span><br><span class="line">  0.00   8.64   6.76  27.32  80.59  73.86   1350   22.705     5    1.449   24.154</span><br><span class="line">  0.00   8.64   6.81  27.32  80.59  73.86   1350   22.705     5    1.449   24.154</span><br><span class="line">  0.00   8.64   7.07  27.32  80.59  73.86   1350   22.705     5    1.449   24.154</span><br><span class="line">  0.00   8.64   7.08  27.32  80.59  73.86   1350   22.705     5    1.449   24.154</span><br><span class="line">  0.00   8.64   7.38  27.32  80.59  73.86   1350   22.705     5    1.449   24.154</span><br><span class="line">  0.00   8.64   7.38  27.32  80.59  73.86   1350   22.705     5    1.449   24.154</span><br><span class="line">  0.00   8.64   7.62  27.32  80.59  73.86   1350   22.705     5    1.449   24.154</span><br><span class="line">  0.00   8.64   7.62  27.32  80.59  73.86   1350   22.705     5    1.449   24.154</span><br><span class="line">  0.00   8.64   7.76  27.32  80.59  73.86   1350   22.705     5    1.449   24.154</span><br></pre></td></tr></table></figure>

<p>S0：Heap上的 Survivor space 0 区已使用空间的百分比<br>S1：Heap上的 Survivor space 1 区已使用空间的百分比<br>E：Heap上的 Eden space 区已使用空间的百分比<br>O：Heap上的 Old space 区已使用空间的百分比<br>M：Metaspace 区已使用空间的百分比<br>YGC：从应用程序启动到采样时发生 Young GC 的次数<br>YGCT：从应用程序启动到采样时 Young GC 所用的时间(单位秒)<br>FGC：从应用程序启动到采样时发生 Full GC 的次数<br>FGCT：从应用程序启动到采样时 Full GC 所用的时间(单位秒)<br>GCT：从应用程序启动到采样时用于垃圾回收的总时间(单位秒)</p>
<h5 id="jmap-heap"><a href="#jmap-heap" class="headerlink" title="jmap -heap"></a>jmap -heap</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">[root@xxxx-nccz8-b57dd64fc-nt9dj startup]# jmap -heap 1</span><br><span class="line">Attaching to process ID 1, please wait...</span><br><span class="line">Debugger attached successfully.</span><br><span class="line">Server compiler detected.</span><br><span class="line">JVM version is 25.191-b12</span><br><span class="line"></span><br><span class="line">using parallel threads in the new generation.</span><br><span class="line">using thread-local object allocation.</span><br><span class="line">Concurrent Mark-Sweep GC</span><br><span class="line"></span><br><span class="line">Heap Configuration:</span><br><span class="line">   MinHeapFreeRatio         = 40</span><br><span class="line">   MaxHeapFreeRatio         = 70</span><br><span class="line">   MaxHeapSize              = 2147483648 (2048.0MB)</span><br><span class="line">   NewSize                  = 805306368 (768.0MB)</span><br><span class="line">   MaxNewSize               = 805306368 (768.0MB)</span><br><span class="line">   OldSize                  = 1342177280 (1280.0MB)</span><br><span class="line">   NewRatio                 = 2</span><br><span class="line">   SurvivorRatio            = 8</span><br><span class="line">   MetaspaceSize            = 268435456 (256.0MB)</span><br><span class="line">   CompressedClassSpaceSize = 260046848 (248.0MB)</span><br><span class="line">   MaxMetaspaceSize         = 268435456 (256.0MB)</span><br><span class="line">   G1HeapRegionSize         = 0 (0.0MB)</span><br><span class="line"></span><br><span class="line">Heap Usage:</span><br><span class="line">New Generation (Eden + 1 Survivor Space):</span><br><span class="line">   capacity = 724828160 (691.25MB)</span><br><span class="line">   used     = 284988360 (271.7860794067383MB)</span><br><span class="line">   free     = 439839800 (419.4639205932617MB)</span><br><span class="line">   39.318058503687276% used</span><br><span class="line">Eden Space:</span><br><span class="line">   capacity = 644349952 (614.5MB)</span><br><span class="line">   used     = 275398000 (262.63999938964844MB)</span><br><span class="line">   free     = 368951952 (351.86000061035156MB)</span><br><span class="line">   42.74043928228616% used</span><br><span class="line">From Space:</span><br><span class="line">   capacity = 80478208 (76.75MB)</span><br><span class="line">   used     = 9590360 (9.146080017089844MB)</span><br><span class="line">   free     = 70887848 (67.60391998291016MB)</span><br><span class="line">   11.916716634644748% used</span><br><span class="line">To Space:</span><br><span class="line">   capacity = 80478208 (76.75MB)</span><br><span class="line">   used     = 0 (0.0MB)</span><br><span class="line">   free     = 80478208 (76.75MB)</span><br><span class="line">   0.0% used</span><br><span class="line">concurrent mark-sweep generation:</span><br><span class="line">   capacity = 1342177280 (1280.0MB)</span><br></pre></td></tr></table></figure>

<p>通过heap命令能看出当前整个堆的一个使用情况，used与free的一个实际占用比。</p>
<h5 id="jmap-dump"><a href="#jmap-dump" class="headerlink" title="jmap -dump"></a>jmap -dump</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jmap -dump:live,format=b,file=xxxxxx.20200707.hprof 1</span><br></pre></td></tr></table></figure>

<p>我们一般会在Dockerfile里面配置好如果出现OOM的情况，保留一下现场。<code>-XX:HeapDumpPath=/alidata1/admin/xxxxx/logs</code></p>
<h4 id="利用JProfiler分析"><a href="#利用JProfiler分析" class="headerlink" title="利用JProfiler分析"></a>利用JProfiler分析</h4><p>发现大对象，这里是因为我们用了Jeager链路跟踪，但是用过多线程导致ThreadLocal没有释放掉。</p>
<p><img src="http://static.cyblogs.com/QQ20200507-183901@2x.jpg" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;QQ20200507-183901@2x.jpg"></p>
<p>发现char[]占用比较多，并且找出是从哪儿产生的？</p>
<p><img src="http://static.cyblogs.com/QQ20200507-194442@2x.jpg" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;QQ20200507-194442@2x.jpg"></p>
<p>通过Outgoing references找到具体的实例情况。</p>
<p><img src="http://static.cyblogs.com/QQ20200507-194529@2x.jpg" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;QQ20200507-194529@2x.jpg"></p>
<p>什么是outgoing references与incoming references？让我们通过示例来了解有关 Incoming references 和 Outgoing references 的更多知识。例如，一个应用程序的源代码如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">A</span> &#123;     </span><br><span class="line">  <span class="keyword">private</span> <span class="type">C</span> <span class="variable">c1</span> <span class="operator">=</span> C.getInstance();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">B</span> &#123;     </span><br><span class="line">	<span class="keyword">private</span> <span class="type">C</span> <span class="variable">c2</span> <span class="operator">=</span> C.getInstance();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">C</span> &#123;     </span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="type">C</span> <span class="variable">myC</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">C</span>();     </span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> C <span class="title function_">getInstance</span><span class="params">()</span> &#123;             </span><br><span class="line">	<span class="keyword">return</span> myC;     </span><br><span class="line">	&#125;   </span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="type">D</span> <span class="variable">d1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">D</span>();     </span><br><span class="line">	<span class="keyword">private</span> <span class="type">E</span> <span class="variable">e1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">E</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">D</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">E</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SimpleExample</span> &#123;     </span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span> <span class="params">(String argsp[])</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">           <span class="type">A</span> <span class="variable">a</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">A</span>();</span><br><span class="line">           <span class="type">B</span> <span class="variable">b</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">B</span>();     </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>对象 A 和对象 B 持有对象 C 的引用</li>
<li>对象 C 持有对象 D 和对象 E 的引用</li>
</ul>
<p>在这个示例项目中，让我们具体分析下对象 C 的 Incoming references 和 Outgoing references 。</p>
<p><strong>对象 C 的 Incoming References</strong></p>
<p>拥有对象 C 的引用的所有对象都称为 Incoming references。在此示例中，对象 C 的“Incoming references”是对象 A、对象 B 和 C 的类对象 。</p>
<p><strong>对象 C 的 Outgoing References</strong></p>
<p>对象 C 引用的所有对象都称为 Outgoing References。在此示例中，对象 C 的“outgoing references”是对象 D、对象 E 和 C 的类对象。</p>
<p>然后通过<code>Show in graph</code>的菜单，一层一层的点击。直到你看到你最熟悉的类。</p>
<p><img src="http://static.cyblogs.com/WechatIMG459.png" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;WechatIMG459.png"></p>
<p><img src="http://static.cyblogs.com/WechatIMG460.png" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;WechatIMG460.png"></p>
<h4 id="如何看GC日志"><a href="#如何看GC日志" class="headerlink" title="如何看GC日志"></a>如何看GC日志</h4><p>设置gc日志配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">-XX:+PrintGC 输出简要GC日志 </span><br><span class="line">-XX:+PrintGCDetails 输出详细GC日志 </span><br><span class="line">-Xloggc:gc.log  输出GC日志到文件</span><br><span class="line">-XX:+PrintGCTimeStamps 输出GC的时间戳（以JVM启动到当期的总时长的时间戳形式） </span><br><span class="line">-XX:+PrintGCDateStamps 输出GC的时间戳（以日期的形式，如 <span class="number">2013</span>-<span class="number">05</span>-04T21:<span class="number">53</span>:<span class="number">59.234</span>+0800） </span><br><span class="line">-XX:+PrintHeapAtGC 在进行GC的前后打印出堆的信息</span><br><span class="line">-verbose:gc</span><br><span class="line">-XX:+PrintReferenceGC 打印年轻代各个引用的数量以及时长</span><br></pre></td></tr></table></figure>

<h5 id="XX-PrintGC"><a href="#XX-PrintGC" class="headerlink" title="-XX:+PrintGC"></a>-XX:+PrintGC</h5><p>如果只设置<code>-XX:+PrintGC</code>那么打印的日志如下所示：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[GC (Allocation Failure)  61805K-&gt;9849K(256000K), 0.0041139 secs]</span><br><span class="line"></span><br><span class="line">1、GC 表示是一次YGC（Young GC）</span><br><span class="line">2、Allocation Failure 表示是失败的类型</span><br><span class="line">3、61805K-&gt;9849K 表示年轻代从61805K降为9849K</span><br><span class="line">4、256000K表示整个堆的大小</span><br><span class="line">5、0.0041139 secs表示这次GC总计所用的时间</span><br><span class="line">在JDK 8中，-verbose:gc是-XX:+PrintGC一个别称，日志格式等价与：-XX:+PrintGC，。</span><br></pre></td></tr></table></figure>

<h5 id="XX-PrintGCDetails"><a href="#XX-PrintGCDetails" class="headerlink" title="-XX:+PrintGCDetails"></a>-XX:+PrintGCDetails</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[GC (Allocation Failure) [PSYoungGen: 53248K-&gt;2176K(59392K)] 58161K-&gt;7161K(256000K), 0.0039189 secs] [Times: user=0.02 sys=0.01, real=0.00 secs]</span><br><span class="line">1、GC 表示是一次YGC（Young GC）</span><br><span class="line">2、Allocation Failure 表示是失败的类型</span><br><span class="line">3、PSYoungGen 表示年轻代大小</span><br><span class="line">4、53248K-&gt;2176K 表示年轻代占用从53248K降为2176K</span><br><span class="line">5、59392K表示年轻带的大小</span><br><span class="line">6、58161K-&gt;7161K 表示整个堆占用从53248K降为2176K</span><br><span class="line">7、256000K表示整个堆的大小</span><br><span class="line">8、 0.0039189 secs 表示这次GC总计所用的时间</span><br><span class="line">9、[Times: user=0.02 sys=0.01, real=0.00 secs]  分别表示，用户态占用时长，内核用时，真实用时。</span><br><span class="line">时间保留两位小数，四舍五入。</span><br></pre></td></tr></table></figure>

<h5 id="XX-PrintGCTimeStamps"><a href="#XX-PrintGCTimeStamps" class="headerlink" title="-XX:+PrintGCTimeStamps"></a>-XX:+PrintGCTimeStamps</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1.963: [GC (Allocation Failure)  61805K-&gt;9849K(256000K), 0.0041139 secs]</span><br></pre></td></tr></table></figure>

<p>如果加上<code>-XX:+PrintGCTimeStamps</code>那么日志仅仅比1.1介绍的最前面多了一个时间戳： <code>1.963</code>， 表示从JVM启动到打印GC时刻用了1.963秒。</p>
<h5 id="XX-PrintGCDateStamps"><a href="#XX-PrintGCDateStamps" class="headerlink" title="-XX:+PrintGCDateStamps"></a>-XX:+PrintGCDateStamps</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2019-03-05T16:56:15.108+0800: [GC (Allocation Failure)  61805K-&gt;9849K(256000K), 0.0041139 secs]</span><br></pre></td></tr></table></figure>

<p>如果加上<code>-XX:+PrintGCDateStamps</code>那么日志仅仅比1.1介绍的最前面多了一个日期时间： <code>2019-03-05T16:56:15.108+0800</code>， 表示打印GC的时刻的时间是<code>2019-03-05T16:56:15.108+0800</code>。+0800表示是东8区。</p>
<h5 id="CMS-GC日志详细分析"><a href="#CMS-GC日志详细分析" class="headerlink" title="CMS GC日志详细分析"></a>CMS GC日志详细分析</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[GC (CMS Initial Mark) [1 CMS-initial-mark: 19498K(32768K)] 36184K(62272K), 0.0018083 secs] [Times: user=0.01 sys=0.00, real=0.01 secs] </span><br><span class="line">[CMS-concurrent-mark-start]</span><br><span class="line">[CMS-concurrent-mark: 0.011/0.011 secs] [Times: user=0.02 sys=0.00, real=0.00 secs] </span><br><span class="line">[CMS-concurrent-preclean-start]</span><br><span class="line">[CMS-concurrent-preclean: 0.001/0.001 secs] [Times: user=0.00 sys=0.00, real=0.01 secs] </span><br><span class="line">[CMS-concurrent-abortable-preclean-start]</span><br><span class="line"> CMS: abort preclean due to time [CMS-concurrent-abortable-preclean: 0.558/5.093 secs] [Times: user=0.57 sys=0.00, real=5.09 secs] </span><br><span class="line">[GC (CMS Final Remark) [YG occupancy: 16817 K (29504 K)][Rescan (parallel) , 0.0021918 secs][weak refs processing, 0.0000245 secs][class unloading, 0.0044098 secs][scrub symbol table, 0.0029752 secs][scrub string table, 0.0006820 secs][1 CMS-remark: 19498K(32768K)] 36316K(62272K), 0.0104997 secs] [Times: user=0.02 sys=0.00, real=0.01 secs] </span><br><span class="line">[CMS-concurrent-sweep-start]</span><br><span class="line">[CMS-concurrent-sweep: 0.007/0.007 secs] [Times: user=0.01 sys=0.00, real=0.01 secs] </span><br><span class="line">[CMS-concurrent-reset-start]</span><br><span class="line">[CMS-concurrent-reset: 0.000/0.000 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] </span><br></pre></td></tr></table></figure>

<p>CMS日志分为两个STW(stop the world)</p>
<p>分别是<code>init remark</code>（1） 与 <code>remark</code>（7）两个阶段。一般耗时比YGC长约10倍（个人经验）。</p>
<p>（1）、<code>[GC (CMS Initial Mark) [1 CMS-initial-mark: 19498K(32768K)] 36184K(62272K), 0.0018083 secs][Times: user=0.01 sys=0.00, real=0.01 secs]</code></p>
<p>会STW(Stop The World)，这时候的老年代容量为 32768K， 在使用到 19498K 时开始初始化标记。耗时短。</p>
<p>（2）、<code>[CMS-concurrent-mark-start]</code></p>
<p>并发标记阶段开始</p>
<p>（3）、<code>[CMS-concurrent-mark: 0.011/0.011 secs] [Times: user=0.02 sys=0.00, real=0.00 secs]</code></p>
<p>并发标记阶段花费时间。</p>
<p>（4）、<code>[CMS-concurrent-preclean-start]</code></p>
<p>并发预清理阶段，也是与用户线程并发执行。虚拟机查找在执行并发标记阶段新进入老年代的对象(可能会有一些对象从<a target="_blank" rel="noopener" href="https://www.baidu.com/s?wd=%E6%96%B0%E7%94%9F%E4%BB%A3&tn=24004469_oem_dg&rsv_dl=gh_pl_sl_csd">新生代</a>晋升到老年代， 或者有一些对象被分配到老年代)。通过重新扫描，减少下一个阶段”重新标记”的工作，因为下一个阶段会Stop The World。</p>
<p>（5）、<code>[CMS-concurrent-preclean: 0.001/0.001 secs] [Times: user=0.00 sys=0.00, real=0.01 secs]</code></p>
<p>并发预清理阶段花费时间。</p>
<p>（6）、<code>[CMS-concurrent-abortable-preclean-start] CMS: abort preclean due to time [CMS-concurrent-abortable-preclean: 0.558/5.093 secs][Times: user=0.57 sys=0.00, real=5.09 secs]</code></p>
<p>并发可中止预清理阶段，运行在并行预清理和重新标记之间，直到获得所期望的eden空间占用率。增加这个阶段是为了避免在重新标记阶段后紧跟着发生一次垃圾清除</p>
<p>（7）、<code>[GC (CMS Final Remark) [YG occupancy: 16817 K (29504 K)][Rescan (parallel) , 0.0021918 secs][weak refs processing, 0.0000245 secs][class unloading, 0.0044098 secs][scrub symbol table, 0.0029752 secs][scrub string table, 0.0006820 secs][1 CMS-remark: 19498K(32768K)] 36316K(62272K), 0.0104997 secs] [Times: user=0.02 sys=0.00, real=0.01 secs]</code></p>
<p>会STW(Stop The World)，收集阶段，这个阶段会标记老年代全部的存活对象，包括那些在并发标记阶段更改的或者新创建的引用对象</p>
<p>（8）、<code>[CMS-concurrent-sweep-start]</code></p>
<p>并发清理阶段开始，与用户线程并发执行。</p>
<p>（9）、<code>[CMS-concurrent-sweep: 0.007/0.007 secs] [Times: user=0.01 sys=0.00, real=0.01 secs]</code></p>
<p>并发清理阶段结束，所用的时间。</p>
<p>（10）、<code>[CMS-concurrent-reset-start]</code></p>
<p>开始并发重置。在这个阶段，与CMS相关数据结构被重新初始化，这样下一个周期可以正常进行。</p>
<p>（11）、<code>[CMS-concurrent-reset: 0.000/0.000 secs] [Times: user=0.00 sys=0.00, real=0.00 secs]</code></p>
<p>并发重置所用结束，所用的时间。</p>
<h4 id="参考地址"><a href="#参考地址" class="headerlink" title="参考地址"></a>参考地址</h4><ul>
<li><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/bSv2YDqOJsWYj6ZjAnf1ew">https://mp.weixin.qq.com/s/bSv2YDqOJsWYj6ZjAnf1ew</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/preterhuman_peak/article/details/43674037">https://blog.csdn.net/preterhuman_peak/article/details/43674037</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.im/post/5c80b0f451882532cd57b541">https://juejin.im/post/5c80b0f451882532cd57b541</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.cyblogs.com/2020/05/13/2020/05/JSR269%E6%8F%92%E4%BB%B6%E5%8C%96%E6%B3%A8%E8%A7%A3API/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/vernonchen.jpg">
      <meta itemprop="name" content="Vernon">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简栈文化">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | 简栈文化">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/05/13/2020/05/JSR269%E6%8F%92%E4%BB%B6%E5%8C%96%E6%B3%A8%E8%A7%A3API/" class="post-title-link" itemprop="url">JSR269插件化注解API</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-05-13 00:00:00" itemprop="dateCreated datePublished" datetime="2020-05-13T00:00:00+08:00">2020-05-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-06-25 09:56:28" itemprop="dateModified" datetime="2025-06-25T09:56:28+08:00">2025-06-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h4><p>一直在使用<code>Lombok</code>以及<code>MapStruct</code>，但是对于它们能够在编译阶段直接生成实例代码却没有仔细了解过。最近刚好在部门内做了一次分享，也在这里对具体原理做一个详细阐述。</p>
<h4 id="Lombok以及MapStruct实现大体思路"><a href="#Lombok以及MapStruct实现大体思路" class="headerlink" title="Lombok以及MapStruct实现大体思路"></a>Lombok以及MapStruct实现大体思路</h4><p><code>Lombok</code>以及<code>MapStruct</code>都是通过在目标代码上标记注解，编译器能够根据注解生成对应的实现代码。比如<code>Lombok</code>在属性上标记<code>@Getter</code>，那么在这个<code>Java Bean</code>内就会生成对应属性的<code>get</code>方法。</p>
<p>本质上来说，不管是<code>Lombok</code>或者<code>MapStruct</code>，都是通过<code>Java</code>的一个标准<code>API</code>来实现的；这个<code>API</code>即为<code>Pluggable Annotation Processing API</code>，简称为<code>JSR269</code>。</p>
<h4 id="JSR269"><a href="#JSR269" class="headerlink" title="JSR269"></a>JSR269</h4><p>借用JSR269官方原文定义（附带原文地址：<a target="_blank" rel="noopener" href="https://jcp.org/en/jsr/detail?id=269%EF%BC%89%EF%BC%9A">https://jcp.org/en/jsr/detail?id=269）：</a></p>
<blockquote>
<p>J2SE 1.5 added a new Java language mechanism “annotations” that allows annotation types to be used to annotate classes, fields, and methods. These annotations are typically processed either by build-time tools or by run-time libraries to achieve new semantic effects. In order to support annotation processing at build-time, this JSR will define APIs to allow annotation processors to be created using a standard pluggable API. This will simplify the task of creating annotation processors and will also allow automation of the discovery of appropriate annotation processors for a given source file.<br>The specification will include at least two sections, a section of API modeling the Java programming language and a distinct section for declaring annotation processors and controlling how they are run. Since annotations are placed on program elements, an annotation processing framework needs to reflect program structure. Annotation processors will be able to specify what annotations they process and multiple processors will be able to run cooperatively.<br>The processors and program structure api can be accessed at build-time; i.e. this functionality supplements core reflection support for reading annotations.</p>
</blockquote>
<p>译文如下：</p>
<blockquote>
<p>J2SE 1.5 增加了一种新的Java语言机制”annotations“，它允许注解被用于类、字段以及方法上。这些注解由 <code>build-time</code> 工具以及 <code>run-time</code> 库处理，来达到新的语义效果。为了支持在 <code>build-time</code> 时处理注解，这个JSR定义了通用的插入式API用于创建标准的注解处理器。这将简化创建注解处理器的任务，并且还能够根据源文件自动匹配响应的注解处理器。<br>该规范将至少包含两个部分，一部分用于建模Java编程语言的API，另一部分用于声明注解处理器以及他们的运作机制。由于注解被用于程序元素上，一个注解处理框架需要反映程序结构。注解处理器将能指定哪些注解是它们可以处理的，以及多个注解处理器如何协同工作。<br>注解处理器以及程序框架api可以在 <code>build-time</code> 时访问；举个例子，此功能提供了核心反射支持用于读取注解（注：一般指从源码内读取注解或者只读取标注为<code>source-only</code>的注解）。</p>
</blockquote>
<p>即，在J2SE 1.6版本加入的JSR269的主要点如下：</p>
<ul>
<li>专门用于支持 <code>J2SE 1.5</code> 无法处理的 <code>build-time</code> 注解处理场景，并定义通用注解处理API</li>
<li>引入程序框架api</li>
</ul>
<h4 id="JSR269运行机制"><a href="#JSR269运行机制" class="headerlink" title="JSR269运行机制"></a>JSR269运行机制</h4><p><code>javac/Mainmain/Mainmain/JavaCompilerprocessing/JavaProcessingEnvironmentprocessing/Roundprocessing/DiscoveredProcessorsnew main.Main(&quot;javac)</code>编译参数传递<code>Javac</code>上下文创建<code>JavaFileManager.preRegister</code>预注册执行<code>compile</code>，并传递编译参数以及上下文参数有误显示帮助信息参数解析(获取<code>class</code>以及<code>files</code>并初始化注解处理器路径)无<code>source.files.classesJavaCompiler</code>实例创建传递源文件列表以及类列表不初始化初始化注解设置<code>Processors</code>从参数获取<code>processorsprocessors</code>初始化并赋值给<code>discoveredProcsalt</code>[ PROC为none值 ][ PROC非none值 ]处理注解将需要的<code>package</code>注解以及<code>class</code>注解加入待处理列表传递上下文、待处理的包类注解列表构造<code>Round</code>构造<code>JavacRoundEnvironment</code>，传递包类通过顶层的包类找到所有支持的注解通过变量<code>annotationsPresent</code>判断这个注解是否支持加入待处理列表；</p>
<p><code>matchedNames</code>添加支持的注解名不做处理，继续下一步alt[ 注解支持 ][ 注解不支持 ]调用注解处理器的<code>process</code>方法标记注解处理器已被执行<code>unmatchedAnnotations</code>移除<code>matchedNames</code>内所有匹配的项不做处理，继续下一步alt[ 执行结果是为true ][ 执行结果为false ]不做处理，继续下一步</p>
<ul>
<li>alt[ matchedNames是否不为空且处理器是否已被执行 ]</li>
<li>loop[ 循环discoveredProcs ]</li>
</ul>
<p>一次<code>round</code>循环完成构建下一个<code>roundloop</code>[ 循环直到没有新文件产生(moreToDo方法) ]执行最后一次run方法所有执行过的<code>processor</code>会带上空注解集合参数再次执行一遍完成执行完成最后一次<code>round</code>判断本次是否存在错误，存在则标记<code>errorStatus</code>清理所有包类构建为最终编译使用的<code>JavaCompiler</code>错误数不为0返回编译器错误数为0日志记录无错误+1enterTreesalt[ errorStatus状态为true ][ erroStatus状态为false ]返回编译器执行编译完成执行错误执行正确alt[ 错误数大于0 ][ 为空 ]alt[ 解析的文件为空且含有注解处理参数 ][ 存在文件或者无注解处理参数 ]<code>javac/Mainmain/Mainmain/JavaCompilerprocessing/JavaProcessingEnvironmentprocessing/Roundprocessing/DiscoveredProcessors</code></p>
<h4 id="样例"><a href="#样例" class="headerlink" title="样例"></a>样例</h4><p>构建三个模块：</p>
<ol>
<li>注解处理类以及目标注解类</li>
<li>注解注册为服务</li>
<li>调用方</li>
</ol>
<h5 id="注解类以及处理类"><a href="#注解类以及处理类" class="headerlink" title="注解类以及处理类"></a>注解类以及处理类</h5><p>注解类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;ElementType.METHOD, ElementType.TYPE&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.SOURCE)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Test &#123;</span><br><span class="line">    String <span class="title function_">value</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注解处理类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SupportedAnnotationTypes(value = &#123;&quot;com.whatakitty.learn.jsr269.Test&quot;&#125;)</span></span><br><span class="line"><span class="meta">@SupportedSourceVersion(value = SourceVersion.RELEASE_8)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AnnotationProcessor</span> <span class="keyword">extends</span> <span class="title class_">AbstractProcessor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Messager messager;</span><br><span class="line">    <span class="keyword">private</span> AtomicInteger atomicInteger;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(ProcessingEnvironment env)</span> &#123;</span><br><span class="line">        messager = env.getMessager();</span><br><span class="line">        atomicInteger = <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">0</span>);</span><br><span class="line">        <span class="built_in">super</span>.init(env);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">process</span><span class="params">(Set&lt;? extends TypeElement&gt; annotations, RoundEnvironment roundEnv)</span> &#123;</span><br><span class="line">        messager.printMessage(Diagnostic.Kind.NOTE, <span class="string">&quot;Hello World!&quot;</span> + atomicInteger.incrementAndGet());</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="注册服务"><a href="#注册服务" class="headerlink" title="注册服务"></a>注册服务</h5><p>在文件夹<code>resources/META-INF/services</code>下创建文件<code>javax.annotation.processing.Processor</code>，内容如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">com.whatakitty.learn.jsr269.AnnotationProcessor</span><br></pre></td></tr></table></figure>

<h5 id="调用方"><a href="#调用方" class="headerlink" title="调用方"></a>调用方</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test1</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;success&quot;</span>);</span><br><span class="line">        test();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test(&quot;method is test&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="运行结果"><a href="#运行结果" class="headerlink" title="运行结果"></a>运行结果</h5><p><img src="http://static.cyblogs.com/191455.jpg" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;191455.jpg"></p>
<p>可以看到，上图中已经输出两次<strong>Hello World!</strong>。至于为什么会输出两次，是由于第一次是本身注解的处理调用；最后一次是，jdk会在所有注解处理完成后，将所有处理过的注解全部传入空注解再次执行一遍，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * Run all remaining processors on the procStateList that</span></span><br><span class="line"><span class="comment">  * have not already run this round with an empty set of</span></span><br><span class="line"><span class="comment">  * annotations.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">runContributingProcs</span><span class="params">(RoundEnvironment re)</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (!onProcInterator) &#123;</span><br><span class="line">    <span class="comment">// 构造空的注解元素集合</span></span><br><span class="line">    Set&lt;TypeElement&gt; emptyTypeElements = Collections.emptySet();</span><br><span class="line">    <span class="comment">// 遍历所有注册的注解处理器</span></span><br><span class="line">    <span class="keyword">while</span>(innerIter.hasNext()) &#123;</span><br><span class="line">        <span class="type">ProcessorState</span> <span class="variable">ps</span> <span class="operator">=</span> innerIter.next();</span><br><span class="line">        <span class="comment">// 判断该注解处理器是否在之前处理过注解，未参与过的不会调用</span></span><br><span class="line">        <span class="keyword">if</span> (ps.contributed)</span><br><span class="line">          <span class="comment">// 传入空的注解元素集合，重新调用一次注解处理器</span></span><br><span class="line">          callProcessor(ps.processor, emptyTypeElements, re);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Lombok原理"><a href="#Lombok原理" class="headerlink" title="Lombok原理"></a>Lombok原理</h4><p><code>Lombok</code>基于<code>JSR269 API</code>实现了通过特定注解生成对应代码的功能。</p>
<p><code>Lombok</code>主要在类<code>LombokProcessor</code>处理了自己的注解通过<code>AST</code>生成代码。如下，主要看两个重写方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 初始化本次处理的一些变量等</span></span><br><span class="line"><span class="meta">@Override</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(ProcessingEnvironment procEnv)</span> &#123;</span><br><span class="line">  <span class="built_in">super</span>.init(procEnv);</span><br><span class="line">  <span class="comment">// 判断lombok是否被禁用</span></span><br><span class="line">  <span class="keyword">if</span> (System.getProperty(<span class="string">&quot;lombok.disable&quot;</span>) != <span class="literal">null</span>) &#123;</span><br><span class="line">    lombokDisabled = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">this</span>.processingEnv = procEnv;</span><br><span class="line">  <span class="built_in">this</span>.javacProcessingEnv = getJavacProcessingEnvironment(procEnv);</span><br><span class="line">  <span class="built_in">this</span>.javacFiler = getJavacFiler(procEnv.getFiler());</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 替换类加载器、对netbeans IDE相关hook处理、替换JavaFileManager</span></span><br><span class="line">  placePostCompileAndDontMakeForceRoundDummiesHook();</span><br><span class="line">  trees = Trees.instance(javacProcessingEnv);</span><br><span class="line">  transformer = <span class="keyword">new</span> <span class="title class_">JavacTransformer</span>(procEnv.getMessager(), trees);</span><br><span class="line">  <span class="comment">// 获取标记HandlerPriority注解的所有优先级</span></span><br><span class="line">  SortedSet&lt;Long&gt; p = transformer.getPriorities();</span><br><span class="line">  <span class="keyword">if</span> (p.isEmpty()) &#123;</span><br><span class="line">    <span class="built_in">this</span>.priorityLevels = <span class="keyword">new</span> <span class="title class_">long</span>[] &#123;<span class="number">0L</span>&#125;;</span><br><span class="line">    <span class="built_in">this</span>.priorityLevelsRequiringResolutionReset = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;Long&gt;();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.priorityLevels = <span class="keyword">new</span> <span class="title class_">long</span>[p.size()];</span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 循环所有获取到的注释或者visit处理优先级</span></span><br><span class="line">    <span class="keyword">for</span> (Long prio : p) <span class="built_in">this</span>.priorityLevels[i++] = prio;</span><br><span class="line">    <span class="built_in">this</span>.priorityLevelsRequiringResolutionReset = transformer.getPrioritiesRequiringResolutionReset();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** &#123;<span class="doctag">@inheritDoc</span>&#125; */</span></span><br><span class="line"><span class="meta">@Override</span> <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">process</span><span class="params">(Set&lt;? extends TypeElement&gt; annotations, RoundEnvironment roundEnv)</span> &#123;</span><br><span class="line">  <span class="comment">// 如果禁用，则不处理lombok注解</span></span><br><span class="line">  <span class="keyword">if</span> (lombokDisabled) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  <span class="comment">// 是否已经处理结束</span></span><br><span class="line">  <span class="keyword">if</span> (roundEnv.processingOver()) &#123;</span><br><span class="line">    cleanup.run();</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// We have: A sorted set of all priority levels: &#x27;priorityLevels&#x27;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// Step 1: Take all CUs which aren&#x27;t already in the map. Give them the first priority level.</span></span><br><span class="line">  </span><br><span class="line">  <span class="type">String</span> <span class="variable">randomModuleName</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 标记所有编译单元的优先级</span></span><br><span class="line">  <span class="comment">// 如果是第二次循环，因为roots已经包含了这个编译单元，所以会忽略</span></span><br><span class="line">  <span class="keyword">for</span> (Element element : roundEnv.getRootElements()) &#123;</span><br><span class="line">    <span class="keyword">if</span> (randomModuleName == <span class="literal">null</span>) randomModuleName = getModuleNameFor(element);</span><br><span class="line">    <span class="type">JCCompilationUnit</span> <span class="variable">unit</span> <span class="operator">=</span> toUnit(element);</span><br><span class="line">    <span class="keyword">if</span> (unit == <span class="literal">null</span>) <span class="keyword">continue</span>;</span><br><span class="line">    <span class="keyword">if</span> (roots.containsKey(unit)) <span class="keyword">continue</span>;</span><br><span class="line">    roots.put(unit, priorityLevels[<span class="number">0</span>]);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="comment">// Step 2: For all CUs (in the map, not the roundEnv!), run them across all handlers at their current prio level.</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 循环优先级列表</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">long</span> prio : priorityLevels) &#123;</span><br><span class="line">      List&lt;JCCompilationUnit&gt; cusForThisRound = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;JCCompilationUnit&gt;();</span><br><span class="line">      <span class="comment">// 获取在该优先级下的所有编译单元并加入该优先级下需要处理的编译单元列表内</span></span><br><span class="line">      <span class="keyword">for</span> (Map.Entry&lt;JCCompilationUnit, Long&gt; entry : roots.entrySet()) &#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">prioOfCu</span> <span class="operator">=</span> entry.getValue();</span><br><span class="line">        <span class="keyword">if</span> (prioOfCu == <span class="literal">null</span> || prioOfCu != prio) <span class="keyword">continue</span>;</span><br><span class="line">        cusForThisRound.add(entry.getKey());</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 按照优先级顺序执行编译单元</span></span><br><span class="line">      <span class="comment">// 访问AST树并编译目标注解</span></span><br><span class="line">      transformer.transform(prio, javacProcessingEnv.getContext(), cusForThisRound, cleanup);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Step 3: Push up all CUs to the next level. Set level to null if there is no next level.</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 排除掉列表第一个优先级准备执行下一次循环</span></span><br><span class="line">    Set&lt;Long&gt; newLevels = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;Long&gt;();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> priorityLevels.length - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">      <span class="type">Long</span> <span class="variable">curLevel</span> <span class="operator">=</span> priorityLevels[i];</span><br><span class="line">      <span class="type">Long</span> <span class="variable">nextLevel</span> <span class="operator">=</span> (i == priorityLevels.length - <span class="number">1</span>) ? <span class="literal">null</span> : priorityLevels[i + <span class="number">1</span>];</span><br><span class="line">      List&lt;JCCompilationUnit&gt; cusToAdvance = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;JCCompilationUnit&gt;();</span><br><span class="line">      <span class="keyword">for</span> (Map.Entry&lt;JCCompilationUnit, Long&gt; entry : roots.entrySet()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (curLevel.equals(entry.getValue())) &#123;</span><br><span class="line">          cusToAdvance.add(entry.getKey());</span><br><span class="line">          newLevels.add(nextLevel);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">for</span> (JCCompilationUnit unit : cusToAdvance) &#123;</span><br><span class="line">        roots.put(unit, nextLevel);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    newLevels.remove(<span class="literal">null</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Step 4: If ALL values are null, quit. Else, either do another loop right now or force a resolution reset by forcing a new round in the annotation processor.</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 判断是否将所有优先级排除，优先级列表为空，则结束</span></span><br><span class="line">    <span class="keyword">if</span> (newLevels.isEmpty()) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    newLevels.retainAll(priorityLevelsRequiringResolutionReset);</span><br><span class="line">    <span class="keyword">if</span> (!newLevels.isEmpty()) &#123;</span><br><span class="line">      <span class="comment">// Force a new round to reset resolution. The next round will cause this method (process) to be called again.</span></span><br><span class="line">      forceNewRound(randomModuleName, javacFiler);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// None of the new levels need resolution, so just keep going.</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>init</code>方法主要是做一些初始化；</p>
<p><code>process</code>方法内主要是将注解以及visitor处理器的按照优先级划分，然后每次执行完成后，排除最开始的一个优先级后，重新开始下一轮编译。知道所有优先级排除完毕。这么做的原因，应该是为了在高优先级处理器处理完成生成文件后，能够让低优先级处理器根据高优先级处理器生成的文件重新执行一遍防止遗漏生成的新的代码</p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><ul>
<li>详细了解了JSR269内部的执行逻辑</li>
<li>了解了JAVAC的编译过程</li>
<li>了解了Lombok内部的执行原理，可以依托现有Lombok处理器，自定义注解</li>
</ul>
<h4 id="参考地址"><a href="#参考地址" class="headerlink" title="参考地址"></a>参考地址</h4><ul>
<li><a target="_blank" rel="noopener" href="https://juejin.im/post/5a6eceb8f265da3e467555fe">https://juejin.im/post/5a6eceb8f265da3e467555fe</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.cyblogs.com/2020/05/12/2020/05/Hello%20World%E8%B0%83%E8%AF%95Hotspot/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/vernonchen.jpg">
      <meta itemprop="name" content="Vernon">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简栈文化">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | 简栈文化">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/05/12/2020/05/Hello%20World%E8%B0%83%E8%AF%95Hotspot/" class="post-title-link" itemprop="url">Hello World调试Hotspot</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-05-12 00:00:00" itemprop="dateCreated datePublished" datetime="2020-05-12T00:00:00+08:00">2020-05-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-06-25 09:56:28" itemprop="dateModified" datetime="2025-06-25T09:56:28+08:00">2025-06-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/JDK/" itemprop="url" rel="index"><span itemprop="name">JDK</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="本地安装GDB"><a href="#本地安装GDB" class="headerlink" title="本地安装GDB"></a>本地安装GDB</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">brew install gdb</span><br><span class="line"></span><br><span class="line">➜  ~  gdb --version</span><br><span class="line">GNU gdb (GDB) 9.1</span><br><span class="line">Copyright (C) 2020 Free Software Foundation, Inc.</span><br><span class="line">License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;</span><br><span class="line">This is free software: you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.</span><br></pre></td></tr></table></figure>

<p>除了这个，在Mac系统系统里面还要配置证书相关的操作。</p>
<p>按入下步骤创建代码签名的证书：</p>
<ol>
<li>打开 Keychain Access 应用程序（&#x2F;Applications&#x2F;Utilities&#x2F;Keychain Access.app）</li>
<li>执行菜单 <strong>钥匙串访问</strong> -&gt; <strong>证书助理</strong> -&gt; <strong>创建证书</strong></li>
<li>填写如下信息：<ul>
<li>名称：gdb_codesign</li>
<li>身份类型：自签名根证书</li>
<li>证书类型：代码签名</li>
<li>钩选：<strong>让我覆盖这些默认设置</strong><br><img src="http://static.cyblogs.com/QQ20200524-221553@2x.jpg" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;QQ20200524-221553@2x.jpg"></li>
</ul>
</li>
<li>一路确定，直到<strong>指定证书位置</strong>的步骤，选择<strong>系统</strong><br><img src="http://static.cyblogs.com/QQ20200524-221644@2x.jpg" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;QQ20200524-221644@2x.jpg"></li>
<li>点击“创建”，会提示用输入系统登录密码，创建完成</li>
<li>在<strong>钥匙串访问程序</strong>中，选择左侧栏的<strong>系统</strong>和<strong>我的证书</strong>，找到你刚刚创建的<strong>gdb_codesign</strong>证书并双击打开证书信息窗口，展开<strong>信任</strong>项，设置<strong>使用此证书时：<strong>为</strong>始终信任</strong>。</li>
<li>关闭<strong>证书信息</strong>窗口，系统会再次要求输入系统登录密码。</li>
</ol>
<p>因为我现在的系统是MacOS Catania，是在 Mojave (10.14) 之后的系统。所以还需要创建一个配置文件<code>gdb-entitlement.xml</code>，其内容如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">plist</span> <span class="keyword">PUBLIC</span> <span class="string">&quot;-//Apple//DTD PLIST 1.0//EN&quot;</span> <span class="string">&quot;http://www.apple.com/DTDs/PropertyList-1.0.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">plist</span> <span class="attr">version</span>=<span class="string">&quot;1.0&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dict</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">key</span>&gt;</span>com.apple.security.cs.debugger<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">true</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dict</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plist</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">pre</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>最后执行命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜  Desktop  codesign --entitlements gdb-entitlement.xml -fs gdb_codesign $(which gdb)</span><br></pre></td></tr></table></figure>

<h4 id="终端中-gdb-断点进入源码调试-hotspot"><a href="#终端中-gdb-断点进入源码调试-hotspot" class="headerlink" title="终端中 gdb 断点进入源码调试 hotspot"></a>终端中 gdb 断点进入源码调试 hotspot</h4><h5 id="编译class"><a href="#编译class" class="headerlink" title="编译class"></a>编译class</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 在我的桌面创建一个Test.java文件</span><br><span class="line">vim Test.java</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;hello world !&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>找到我对应的openjdk8的build地址</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/Users/chenyuan/Workspaces/Openjdk/openjdk8/build/macosx-x86_64-normal-server-release/jdk</span><br></pre></td></tr></table></figure>

<p>利用<code>javac</code>、<code>java</code>命令运行Test.java文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">➜  Desktop  /Users/chenyuan/Workspaces/Openjdk/openjdk8/build/macosx-x86_64-normal-server-release/jdk/bin/javac Test.java</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># A fatal error has been detected by the Java Runtime Environment:</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment">#  SIGILL (0x4) at pc=0x000000010267c7eb, pid=89116, tid=0x0000000000004f03</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># JRE version: OpenJDK Runtime Environment (8.0) (build 1.8.0-internal-chenyuan_2020_05_24_03_17-b00)</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Java VM: OpenJDK 64-Bit Server VM (25.71-b00 mixed mode bsd-amd64 compressed oops)</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Problematic frame:</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">V  [libjvm.dylib+0x47c7eb]  PerfDataManager::destroy()+0xab</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># Failed to write core dump. Core dumps have been disabled. To enable core dumping, try &quot;ulimit -c unlimited&quot; before starting Java again</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># An error report file with more information is saved as:</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">/Users/chenyuan/Desktop/hs_err_pid89116.<span class="built_in">log</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># If you would like to submit a bug report, please visit:</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">  http://bugreport.java.com/bugreport/crash.jsp</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"></span></span><br><span class="line">[error occurred during error reporting , id 0x4]</span><br><span class="line"></span><br><span class="line">[1]    89116 abort       Test.java</span><br><span class="line">➜  Desktop  ll</span><br><span class="line">total 112</span><br><span class="line">-rw-r--r--  1 chenyuan  staff   415B May 24 21:33 Test.class</span><br><span class="line">-rw-r--r--  1 chenyuan  staff   116B May 24 21:31 Test.java</span><br><span class="line">-rw-r--r--  1 chenyuan  staff    46K May 24 21:33 hs_err_pid89116.log</span><br><span class="line">➜  Desktop  /Users/chenyuan/Workspaces/Openjdk/openjdk8/build/macosx-x86_64-normal-server-release/jdk/bin/java Test</span><br><span class="line">hello world !  ------- 牛逼的打印，无敌的HelloWorkd</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># A fatal error has been detected by the Java Runtime Environment:</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment">#  SIGILL (0x4) at pc=0x000000010be7c7eb, pid=89512, tid=0x0000000000002403</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># JRE version: OpenJDK Runtime Environment (8.0) (build 1.8.0-internal-chenyuan_2020_05_24_03_17-b00)</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Java VM: OpenJDK 64-Bit Server VM (25.71-b00 mixed mode bsd-amd64 compressed oops)</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Problematic frame:</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">V  [libjvm.dylib+0x47c7eb]  PerfDataManager::destroy()+0xab</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># Failed to write core dump. Core dumps have been disabled. To enable core dumping, try &quot;ulimit -c unlimited&quot; before starting Java again</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># An error report file with more information is saved as:</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">/Users/chenyuan/Desktop/hs_err_pid89512.<span class="built_in">log</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># If you would like to submit a bug report, please visit:</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">  http://bugreport.java.com/bugreport/crash.jsp</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"></span></span><br><span class="line">[error occurred during error reporting , id 0x4]</span><br><span class="line"></span><br><span class="line">[1]    89512 abort       Test</span><br></pre></td></tr></table></figure>

<h5 id="gdb测试"><a href="#gdb测试" class="headerlink" title="gdb测试"></a>gdb测试</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">➜  Desktop  gdb --args /Users/chenyuan/Workspaces/Openjdk/openjdk8/build/macosx-x86_64-normal-server-release/jdk/bin/java Test</span><br><span class="line">GNU gdb (GDB) 9.1</span><br><span class="line">Copyright (C) 2020 Free Software Foundation, Inc.</span><br><span class="line">License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;</span><br><span class="line">This is free software: you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.</span><br><span class="line">Type &quot;show copying&quot; and &quot;show warranty&quot; for details.</span><br><span class="line">This GDB was configured as &quot;x86_64-apple-darwin19.3.0&quot;.</span><br><span class="line">Type &quot;show configuration&quot; for configuration details.</span><br><span class="line">For bug reporting instructions, please see:</span><br><span class="line">&lt;http://www.gnu.org/software/gdb/bugs/&gt;.</span><br><span class="line">Find the GDB manual and other documentation resources online at:</span><br><span class="line">    &lt;http://www.gnu.org/software/gdb/documentation/&gt;.</span><br><span class="line"></span><br><span class="line">For help, type &quot;help&quot;.</span><br><span class="line">Type &quot;apropos word&quot; to search for commands related to &quot;word&quot;...</span><br><span class="line">Reading symbols from /Users/chenyuan/Workspaces/Openjdk/openjdk8/build/macosx-x86_64-normal-server-release/jdk/bin/java...</span><br><span class="line">(gdb) break init.cpp:95</span><br><span class="line">No source file named init.cpp.</span><br><span class="line">Make breakpoint pending on future shared library load? (y or [n]) y</span><br><span class="line">Breakpoint 1 (init.cpp:95) pending.</span><br><span class="line">(gdb) run</span><br><span class="line">Starting program: /Users/chenyuan/Workspaces/Openjdk/openjdk8/build/macosx-x86_64-normal-server-release/jdk/bin/java Test</span><br><span class="line">[New Thread 0x1803 of process 22052]</span><br><span class="line">[New Thread 0x2503 of process 22052]</span><br><span class="line">[New Thread 0x2403 of process 22052]</span><br><span class="line">warning: unhandled dyld version (16)</span><br><span class="line">[New Thread 0x180f of process 22052]</span><br><span class="line">[New Thread 0x2303 of process 22052]</span><br><span class="line"></span><br><span class="line">Thread 4 received signal SIGSEGV, Segmentation fault.</span><br><span class="line">[Switching to Thread 0x180f of process 22052]</span><br><span class="line">0x00000001040002b4 in ?? ()</span><br><span class="line">(gdb) l</span><br><span class="line">111	    // add one more to mark the end</span><br><span class="line">112	    margv = (char **)JLI_MemAlloc((margc + 1) * (sizeof(char *)));</span><br><span class="line">113	    &#123;</span><br><span class="line">114	        int i = 0;</span><br><span class="line">115	        StdArg *stdargs = JLI_GetStdArgs();</span><br><span class="line">116	        for (i = 0 ; i &lt; margc ; i++) &#123;</span><br><span class="line">117	            margv[i] = stdargs[i].arg;</span><br><span class="line">118	        &#125;</span><br><span class="line">119	        margv[i] = NULL;</span><br><span class="line">120	    &#125;</span><br><span class="line">(gdb) quit</span><br><span class="line">A debugging session is active.</span><br><span class="line"></span><br><span class="line">	Inferior 1 [process 22052] will be killed.</span><br><span class="line"></span><br><span class="line">Quit anyway? (y or n) y</span><br></pre></td></tr></table></figure>

<p>我在这里发现l这里查看代码跟我debug的地方并不同，我就看看日志发现日志中当时有一个提示：<code>No source file named init.cpp.</code>  然后又找了一翻文章，找到这个时候当时编译的时候没有添加g参数。详细请看：<a target="_blank" rel="noopener" href="https://blog.csdn.net/wenceng9/article/details/21372265">https://blog.csdn.net/wenceng9/article/details/21372265</a> （我是在不想再重新编译一次了，因为想早点睡觉。哈哈~）</p>
<h4 id="Clion中调试不香吗？"><a href="#Clion中调试不香吗？" class="headerlink" title="Clion中调试不香吗？"></a>Clion中调试不香吗？</h4><p>打开 clion，选择 <code>File-&gt;ImportProject</code>，选择到 <code>/Users/chenyuan/Workspaces/Openjdk/openjdk8/hotspot</code> 作为 jvm 源码的根目录，这里导入的过程无脑点击 <code>next</code> 即可</p>
<p>对于可能遇到的头文件不包含问题，解决如下：</p>
<p>clion 导入源码之后遇到头文件找不到的问题，而实际上这些头文件在源码里面是存在的，只不过在某些源文件里面是以相对路径的方式来搜索，可以在 <code>CMakeLists.txt</code> 里面添加一些根路径。</p>
<p><img src="http://static.cyblogs.com/QQ20200524-223658@2x.jpg" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;QQ20200524-223658@2x.jpg"></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">include_directories</span>(./src/share/vm)</span><br><span class="line"><span class="built_in">include_directories</span>(./src/cpu/x86/vm)</span><br><span class="line"><span class="built_in">include_directories</span>(./src/share/vm/precompiled)</span><br><span class="line"><span class="built_in">include_directories</span>(./src/share/vm/utilities)</span><br></pre></td></tr></table></figure>

<p>另外，如果某些头文件依然找不到，可以手工导入，然后把导入的头文件加到<br><code>hotspot/src/share/vm/precompiled/precompiled.hpp</code> 里，因为大多数源文件都会包含这个源文件</p>
<p><img src="http://static.cyblogs.com/QQ20200524-223840@2x.jpg" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;QQ20200524-223840@2x.jpg"></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># <span class="keyword">include</span> <span class="string">&lt;cstdlib&gt;</span></span></span><br><span class="line"><span class="meta"># <span class="keyword">include</span> <span class="string">&lt;cstdint&gt;</span></span></span><br><span class="line"><span class="meta"># <span class="keyword">include</span> <span class="string">&quot;register_x86.hpp&quot;</span></span></span><br><span class="line"><span class="meta"># <span class="keyword">include</span> <span class="string">&quot;assembler_x86.hpp&quot;</span></span></span><br><span class="line"><span class="meta"># <span class="keyword">include</span> <span class="string">&quot;globalDefinitions.hpp&quot;</span></span></span><br><span class="line"><span class="meta"># <span class="keyword">include</span> <span class="string">&quot;globalDefinitions_x86.hpp&quot;</span></span></span><br><span class="line"><span class="meta"># <span class="keyword">include</span> <span class="string">&quot;assembler_x86.hpp&quot;</span></span></span><br><span class="line"><span class="meta"># <span class="keyword">include</span> <span class="string">&lt;stubRoutines_x86.hpp&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>进入如下界面，添加 <code>Application：openjdk8</code>，<code>Execuable</code> 中选择<code>/Users/chenyuan/Workspaces/Openjdk/openjdk8/build/macosx-x86_64-normal-server-release/jdk/bin</code></p>
<p><img src="http://static.cyblogs.com/QQ20200524-224033@2x.jpg" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;QQ20200524-224033@2x.jpg"></p>
<p>配置完成后，就可以执行openjdk8了。</p>
<p><img src="http://static.cyblogs.com/QQ20200524-224305@2x.jpg" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;QQ20200524-224305@2x.jpg"></p>
<h4 id="参考地址"><a href="#参考地址" class="headerlink" title="参考地址"></a>参考地址</h4><ul>
<li><a target="_blank" rel="noopener" href="https://segmentfault.com/q/1010000004136334">https://segmentfault.com/q/1010000004136334</a></li>
<li><a target="_blank" rel="noopener" href="https://rqsir.github.io/2019/04/19/openjdk-8-%E4%BD%BF%E7%94%A8Clion%E8%B0%83%E8%AF%95%E6%BA%90%E7%A0%81/">https://rqsir.github.io/2019/04/19/openjdk-8-使用Clion调试源码/</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.cyblogs.com/2020/05/11/2020/05/%E4%B8%80%E6%AC%A1%E6%80%A7%E6%8A%8A%E5%A4%9A%E7%BA%BF%E7%A8%8B%E6%90%9E%E5%90%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/vernonchen.jpg">
      <meta itemprop="name" content="Vernon">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简栈文化">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | 简栈文化">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/05/11/2020/05/%E4%B8%80%E6%AC%A1%E6%80%A7%E6%8A%8A%E5%A4%9A%E7%BA%BF%E7%A8%8B%E6%90%9E%E5%90%90/" class="post-title-link" itemprop="url">一次性把多线程搞吐</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-05-11 00:00:00" itemprop="dateCreated datePublished" datetime="2020-05-11T00:00:00+08:00">2020-05-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-06-25 09:56:28" itemprop="dateModified" datetime="2025-06-25T09:56:28+08:00">2025-06-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="1-什么是进程"><a href="#1-什么是进程" class="headerlink" title="1.什么是进程?"></a>1.什么是进程?</h4><p>进程是系统中正在运行的一个程序，程序一旦运行就是进程。</p>
<p>进程可以看成程序执行的一个实例。进程是系统资源分配的独立实体，每个进程都拥有独立的地址空间。一个进程无法访问另一个进程的变量和数据结构，如果想让一个进程访问另一个进程的资源，需要使用进程间通信，比如管道，文件，套接字等。</p>
<h4 id="2-什么是线程？"><a href="#2-什么是线程？" class="headerlink" title="2.什么是线程？"></a>2.什么是线程？</h4><p>是操作系统能够进行运算调度的最小单位。它被包含在进程之中，是进程中的实际运作单位。一条线程指的是进程中一个单一顺序的控制流，一个进程中可以并发多个线程，每条线程并行执行不同的任务。</p>
<h4 id="3-线程的实现方式"><a href="#3-线程的实现方式" class="headerlink" title="3.线程的实现方式?"></a>3.线程的实现方式?</h4><p>1.继承Thread类</p>
<p>2.实现Runnable接口</p>
<p>3.使用Callable和Future</p>
<h4 id="4-Thread-类中的start-和-run-方法有什么区别"><a href="#4-Thread-类中的start-和-run-方法有什么区别" class="headerlink" title="4.Thread 类中的start() 和 run() 方法有什么区别?"></a>4.<strong>Thread 类中的start() 和 run() 方法有什么区别</strong>?</h4><p>1.start（）方法来启动线程，真正实现了多线程运行。这时无需等待run方法体代码执行完毕，可以直接继续执行下面的代码；通过调用Thread类的start()方法来启动一个线程， 这时此线程是处于就绪状态， 并没有运行。 然后通过此Thread类调用方法run()来完成其运行操作的， 这里方法run()称为线程体，它包含了要执行的这个线程的内容， Run方法运行结束， 此线程终止。然后CPU再调度其它线程。 2.run（）方法当作普通方法的方式调用。程序还是要顺序执行，要等待run方法体执行完毕后，才可继续执行下面的代码； 程序中只有主线程——这一个线程， 其程序执行路径还是只有一条， 这样就没有达到写线程的目的。</p>
<h4 id="5-线程NEW状态"><a href="#5-线程NEW状态" class="headerlink" title="5.线程NEW状态"></a>5.线程NEW状态</h4><p>new创建一个Thread对象时，并没处于执行状态，因为没有调用start方法启动改线程，那么此时的状态就是新建状态。</p>
<h4 id="6-线程RUNNABLE状态"><a href="#6-线程RUNNABLE状态" class="headerlink" title="6.线程RUNNABLE状态"></a>6.线程RUNNABLE状态</h4><p>线程对象通过start方法进入runnable状态，启动的线程不一定会立即得到执行，线程的运行与否要看cpu的调度，我们把这个中间状态叫可执行状态（RUNNABLE)。</p>
<h4 id="7-线程的RUNNING状态"><a href="#7-线程的RUNNING状态" class="headerlink" title="7.线程的RUNNING状态"></a>7.线程的RUNNING状态</h4><p>一旦cpu通过轮询货其他方式从任务可以执行队列中选中了线程，此时它才能真正的执行自己的逻辑代码。</p>
<h4 id="8-线程的BLOCKED状态"><a href="#8-线程的BLOCKED状态" class="headerlink" title="8.线程的BLOCKED状态"></a>8.线程的BLOCKED状态</h4><p>线程正在等待获取锁。</p>
<ul>
<li>进入BLOCKED状态，比如调用了sleep,或者wait方法</li>
<li>进行某个阻塞的io操作，比如因网络数据的读写进入BLOCKED状态</li>
<li>获取某个锁资源，从而加入到该锁的阻塞队列中而进入BLOCKED状态</li>
</ul>
<h4 id="9-线程的TERMINATED状态"><a href="#9-线程的TERMINATED状态" class="headerlink" title="9.线程的TERMINATED状态"></a>9.线程的TERMINATED状态</h4><p>TERMINATED是一个线程的最终状态，在该状态下线程不会再切换到其他任何状态了，代表整个生命周期都结束了。</p>
<p>下面几种情况会进入TERMINATED状态:</p>
<ul>
<li>线程运行正常结束，结束生命周期</li>
<li>线程运行出错意外结束</li>
<li>JVM Crash 导致所有的线程都结束</li>
</ul>
<h4 id="10-线程状态转化图"><a href="#10-线程状态转化图" class="headerlink" title="10.线程状态转化图"></a>10.线程状态转化图</h4><p><img src="http://static.cyblogs.com/171dad791bf589b8.png" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;171dad791bf589b8.png"></p>
<h4 id="11-i–与System-out-println-的异常"><a href="#11-i–与System-out-println-的异常" class="headerlink" title="11.i–与System.out.println()的异常"></a>11.i–与System.out.println()的异常</h4><p>示例代码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">XkThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">       System.out.println(<span class="string">&quot;i=&quot;</span> + (i——) + <span class="string">&quot; threadName=&quot;</span> + Thread.currentThread().getName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">XkThread</span> <span class="variable">xk</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XkThread</span>();</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(xk);</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(xk);</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(xk);</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t4</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(xk);</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t5</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(xk);</span><br><span class="line"></span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">        t3.start();</span><br><span class="line">        t4.start();</span><br><span class="line">        t5.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">i=5 threadName=Thread-1</span><br><span class="line">i=2 threadName=Thread-5</span><br><span class="line">i=5 threadName=Thread-2</span><br><span class="line">i=4 threadName=Thread-3</span><br><span class="line">i=3 threadName=Thread-4</span><br></pre></td></tr></table></figure>

<p>虽然println()方法在内部是同步的，但i–的操作却是在进入println()之前发生的，所以有发生非线程安全的概率。</p>
<p>println()源码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">println</span><span class="params">(String x)</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">        print(x);</span><br><span class="line">        newLine();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="12-如何知道代码段被哪个线程调用？"><a href="#12-如何知道代码段被哪个线程调用？" class="headerlink" title="12.如何知道代码段被哪个线程调用？"></a>12.如何知道代码段被哪个线程调用？</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">System.out.println(Thread.currentThread().getName());</span><br></pre></td></tr></table></figure>

<h4 id="13-线程活动状态？"><a href="#13-线程活动状态？" class="headerlink" title="13.线程活动状态？"></a>13.线程活动状态？</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">XKThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;run run run is &quot;</span>  + <span class="built_in">this</span>.isAlive() );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">XKThread</span> <span class="variable">xk</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XKThread</span>();</span><br><span class="line">        System.out.println(<span class="string">&quot;begin ——— &quot;</span> + xk.isAlive());</span><br><span class="line">        xk.start();</span><br><span class="line">        System.out.println(<span class="string">&quot;end ————— &quot;</span> + xk.isAlive());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="14-sleep-方法"><a href="#14-sleep-方法" class="headerlink" title="14.sleep()方法"></a>14.sleep()方法</h4><p>方法sleep()的作用是在指定的毫秒数内让当前的“正在执行的线程”休眠（暂停执行）。</p>
<h4 id="15-如何优雅的设置睡眠时间"><a href="#15-如何优雅的设置睡眠时间" class="headerlink" title="15.如何优雅的设置睡眠时间?"></a>15.如何优雅的设置睡眠时间?</h4><p>jdk1.5 后，引入了一个枚举TimeUnit,对sleep方法提供了很好的封装。</p>
<p>比如要表达2小时22分55秒899毫秒。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Thread.sleep(<span class="number">8575899L</span>);</span><br><span class="line">TimeUnit.HOURS.sleep(<span class="number">3</span>);</span><br><span class="line">TimeUnit.MINUTES.sleep(<span class="number">22</span>);</span><br><span class="line">TimeUnit.SECONDS.sleep(<span class="number">55</span>);</span><br><span class="line">TimeUnit.MILLISECONDS.sleep(<span class="number">899</span>);</span><br></pre></td></tr></table></figure>

<p>可以看到表达的含义更清晰，更优雅。</p>
<h4 id="16-停止线程"><a href="#16-停止线程" class="headerlink" title="16.停止线程"></a>16.停止线程</h4><p>run方法执行完成，自然终止。</p>
<p>stop()方法，suspend()以及resume()都是过期作废方法，使用它们结果不可预期。</p>
<p>大多数停止一个线程的操作使用<code>Thread.interrupt()</code>等于说给线程打一个停止的标记, 此方法不回去终止一个正在运行的线程，需要加入一个判断才能可以完成线程的停止。</p>
<h4 id="17-interrupted-和-isInterrupted"><a href="#17-interrupted-和-isInterrupted" class="headerlink" title="17.interrupted 和 isInterrupted"></a>17.interrupted 和 isInterrupted</h4><p>interrupted :  判断当前线程是否已经中断,会清除状态。</p>
<p>isInterrupted ：判断线程是否已经中断，不会清除状态。</p>
<h4 id="18-yield"><a href="#18-yield" class="headerlink" title="18.yield"></a>18.yield</h4><p>放弃当前cpu资源，将它让给其他的任务占用cpu执行时间。但放弃的时间不确定，有可能刚刚放弃，马上又获得cpu时间片。</p>
<p>测试代码:(cpu独占时间片)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">XKThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">beginTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">50000000</span>; i++) &#123;</span><br><span class="line">            count = count + (i + <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">long</span> <span class="variable">endTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        System.out.println(<span class="string">&quot;用时 = &quot;</span> + (endTime - beginTime) + <span class="string">&quot; 毫秒! &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">XKThread</span> <span class="variable">xkThread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XKThread</span>();</span><br><span class="line">        xkThread.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">用时 = <span class="number">20</span> 毫秒! </span><br></pre></td></tr></table></figure>

<p>加入yield，再来测试。(cpu让给其他资源导致速度变慢)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">XKThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">beginTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">50000000</span>; i++) &#123;</span><br><span class="line">            Thread.<span class="keyword">yield</span>();</span><br><span class="line">            count = count + (i + <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">long</span> <span class="variable">endTime</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        System.out.println(<span class="string">&quot;用时 = &quot;</span> + (endTime - beginTime) + <span class="string">&quot; 毫秒! &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">XKThread</span> <span class="variable">xkThread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XKThread</span>();</span><br><span class="line">        xkThread.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">用时 = <span class="number">38424</span> 毫秒! </span><br></pre></td></tr></table></figure>

<h4 id="19-线程的优先级"><a href="#19-线程的优先级" class="headerlink" title="19.线程的优先级"></a>19.线程的优先级</h4><p>在操作系统中，线程可以划分优先级，优先级较高的线程得到cpu资源比较多，也就是cpu有限执行优先级较高的线程对象中的任务，但是不能保证一定优先级高，就先执行。</p>
<p>Java的优先级分为1～10个等级，数字越大优先级越高，默认优先级大小为5。超出范围则抛出：java.lang.IllegalArgumentException。</p>
<h4 id="20-优先级继承特性"><a href="#20-优先级继承特性" class="headerlink" title="20.优先级继承特性"></a>20.优先级继承特性</h4><p>线程的优先级具有继承性，比如a线程启动b线程，b线程与a优先级是一样的。</p>
<h4 id="21-谁跑的更快？"><a href="#21-谁跑的更快？" class="headerlink" title="21.谁跑的更快？"></a>21.谁跑的更快？</h4><p>设置优先级高低两个线程，累加数字，看谁跑的快，上代码。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Run</span> <span class="keyword">extends</span> <span class="title class_">Thread</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ThreadLow</span> <span class="variable">low</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadLow</span>();</span><br><span class="line">            low.setPriority(<span class="number">2</span>);</span><br><span class="line">            low.start();</span><br><span class="line"></span><br><span class="line">            <span class="type">ThreadHigh</span> <span class="variable">high</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadHigh</span>();</span><br><span class="line">            high.setPriority(<span class="number">8</span>);</span><br><span class="line">            high.start();</span><br><span class="line"></span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">            low.stop();</span><br><span class="line">            high.stop();</span><br><span class="line">            System.out.println(<span class="string">&quot;low  = &quot;</span> + low.getCount());</span><br><span class="line">            System.out.println(<span class="string">&quot;high = &quot;</span> + high.getCount());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ThreadHigh</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getCount</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> count;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            count++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ThreadLow</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getCount</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> count;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            count++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">low  = 1193854568</span><br><span class="line">high = 1204372373</span><br></pre></td></tr></table></figure>

<h4 id="22-线程种类"><a href="#22-线程种类" class="headerlink" title="22.线程种类"></a>22.线程种类</h4><p>Java线程有两种，一种是用户线程，一种是守护线程。</p>
<h4 id="23-守护线程的特点"><a href="#23-守护线程的特点" class="headerlink" title="23.守护线程的特点"></a>23.守护线程的特点</h4><p>守护线程是一个比较特殊的线程，主要被用做程序中后台调度以及支持性工作。当Java虚拟机中不存在非守护线程时，守护线程才会随着JVM一同结束工作。</p>
<h4 id="24-Java中典型的守护线程"><a href="#24-Java中典型的守护线程" class="headerlink" title="24.Java中典型的守护线程"></a>24.Java中典型的守护线程</h4><p>GC（垃圾回收器）</p>
<h4 id="25-如何设置守护线程"><a href="#25-如何设置守护线程" class="headerlink" title="25.如何设置守护线程"></a>25.如何设置守护线程</h4><p>Thread.setDaemon(true)</p>
<p>PS:Daemon属性需要再启动线程之前设置，不能再启动后设置。</p>
<h4 id="25-Java虚拟机退出时Daemon线程中的finally块一定会执行？"><a href="#25-Java虚拟机退出时Daemon线程中的finally块一定会执行？" class="headerlink" title="25.Java虚拟机退出时Daemon线程中的finally块一定会执行？"></a>25.Java虚拟机退出时Daemon线程中的finally块一定会执行？</h4><p>Java虚拟机退出时Daemon线程中的finally块并不一定会执行。</p>
<p>代码示例:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">public class XKDaemon &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        Thread thread = new Thread(new DaemonRunner(),&quot;xkDaemonRunner&quot;);</span><br><span class="line">        thread.setDaemon(true);</span><br><span class="line">        thread.start();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    static class DaemonRunner implements Runnable &#123;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void run() &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                SleepUtils.sleep(10);</span><br><span class="line">            &#125; finally &#123;</span><br><span class="line">                System.out.println(&quot;Java小咖秀 daemonThread finally run …&quot;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>

<p>没有任何的输出，说明没有执行finally。</p>
<h4 id="26-设置线程上下文类加载器"><a href="#26-设置线程上下文类加载器" class="headerlink" title="26.设置线程上下文类加载器"></a>26.设置线程上下文类加载器</h4><p>​    获取线程上下文类加载器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ClassLoader <span class="title function_">getContextClassLoader</span><span class="params">()</span> </span><br></pre></td></tr></table></figure>

<p>​    设置线程类加载器（可以打破Java类加载器的父类委托机制）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setContextClassLoader</span><span class="params">(ClassLoader cl)</span></span><br></pre></td></tr></table></figure>

<h4 id="27-join"><a href="#27-join" class="headerlink" title="27.join"></a>27.join</h4><p>join是指把指定的线程加入到当前线程，比如join某个线程a,会让当前线程b进入等待,直到a的生命周期结束，此期间b线程是处于blocked状态。</p>
<h4 id="28-什么是synchronized"><a href="#28-什么是synchronized" class="headerlink" title="28.什么是synchronized?"></a>28.什么是synchronized?</h4><p>synchronized关键字可以时间一个简单的策略来防止线程干扰和内存一致性错误，如果一个对象是对多个线程可见的，那么对该对想的所有读写都将通过同步的方式来进行。</p>
<h4 id="29-synchronized包括哪两个jvm重要的指令？"><a href="#29-synchronized包括哪两个jvm重要的指令？" class="headerlink" title="29.synchronized包括哪两个jvm重要的指令？"></a>29.synchronized包括哪两个jvm重要的指令？</h4><p>monitor enter 和 monitor exit</p>
<h4 id="30-synchronized关键字用法"><a href="#30-synchronized关键字用法" class="headerlink" title="30.synchronized关键字用法?"></a>30.synchronized关键字用法?</h4><p>可以用于对代码块或方法的修饰</p>
<h4 id="31-synchronized锁的是什么"><a href="#31-synchronized锁的是什么" class="headerlink" title="31.synchronized锁的是什么?"></a>31.synchronized锁的是什么?</h4><p>普通同步方法 —————&gt; 锁的是当前实力对象。</p>
<p>静态同步方法—————&gt; 锁的是当前类的Class对象。</p>
<p>同步方法快 —————&gt; 锁的是synchonized括号里配置的对象。</p>
<h4 id="32-Java对象头"><a href="#32-Java对象头" class="headerlink" title="32.Java对象头"></a>32.Java对象头</h4><p>synchronized用的锁是存在Java对象头里的。对象如果是数组类型，虚拟机用3个字宽(Word)存储对象头，如果对象是非数组类型，用2字宽存储对象头。</p>
<p>Tips:32位虚拟机中一个字宽等于4字节。</p>
<h4 id="33-Java对象头长度"><a href="#33-Java对象头长度" class="headerlink" title="33.Java对象头长度"></a>33.Java对象头长度</h4><p><img src="http://static.cyblogs.com/QQ20200506-230203@2x.jpg" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;QQ20200506-230203@2x.jpg"></p>
<h4 id="34-Java对象头的存储结构"><a href="#34-Java对象头的存储结构" class="headerlink" title="34.Java对象头的存储结构"></a>34.Java对象头的存储结构</h4><p>32位JVM的Mark Word 默认存储结构</p>
<p><img src="http://static.cyblogs.com/QQ20200506-230326@2x.jpg" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;QQ20200506-230326@2x.jpg"></p>
<h4 id="35-Mark-Word的状态变化"><a href="#35-Mark-Word的状态变化" class="headerlink" title="35.Mark Word的状态变化"></a>35.Mark Word的状态变化</h4><p>Mark Word 存储的数据会随着锁标志为的变化而变化。</p>
<p><img src="http://static.cyblogs.com/QQ20200506-230421@2x.jpg" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;QQ20200506-230421@2x.jpg"></p>
<p>64位虚拟机下，Mark Word是64bit大小的</p>
<p><img src="http://static.cyblogs.com/QQ20200506-230503@2x.jpg" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;QQ20200506-230503@2x.jpg"></p>
<h4 id="36-锁的升降级规则"><a href="#36-锁的升降级规则" class="headerlink" title="36.锁的升降级规则"></a>36.锁的升降级规则</h4><p>Java SE 1.6 为了提高锁的性能。引入了“偏向锁”和轻量级锁“。</p>
<p>Java SE 1.6 中锁有4种状态。级别从低到高依次是：无锁状态、偏向锁状态、轻量级锁状态、重量级锁状态。</p>
<p>锁只能升级不能降级。</p>
<h4 id="37-偏向锁"><a href="#37-偏向锁" class="headerlink" title="37.偏向锁"></a>37.偏向锁</h4><p>大多数情况，锁不仅不存在多线程竞争，而且总由同一线程多次获得。当一个线程访问同步块并获取锁时，会在对象头和栈帧中记录存储锁偏向的线程ID,以后该线程在进入和退出同步块时不需要进行 cas操作来加锁和解锁，只需测试一下对象头 Mark Word里是否存储着指向当前线程的偏向锁。如果测试成功，表示线程已经获得了锁，如果失败，则需要测试下Mark Word中偏向锁的标示是否已经设置成1（表示当前时偏向锁),如果没有设置，则使用cas竞争锁，如果设置了，则尝试使用cas将对象头的偏向锁只想当前线程。</p>
<h4 id="38-关闭偏向锁延迟"><a href="#38-关闭偏向锁延迟" class="headerlink" title="38.关闭偏向锁延迟"></a>38.关闭偏向锁延迟</h4><p>java6和7中默认启用，但是会在程序启动几秒后才激活，如果需要关闭延迟，</p>
<p>-XX:BiasedLockingStartupDelay&#x3D;0。</p>
<h4 id="39-如何关闭偏向锁"><a href="#39-如何关闭偏向锁" class="headerlink" title="39.如何关闭偏向锁"></a>39.如何关闭偏向锁</h4><p>JVM参数关闭偏向锁:-XX:-UseBiasedLocking&#x3D;false,那么程序默认会进入轻量级锁状态。</p>
<p>Tips:如果你可以确定程序的所有锁通常情况处于竞态，则可以选择关闭。</p>
<h4 id="40-轻量级锁"><a href="#40-轻量级锁" class="headerlink" title="40.轻量级锁"></a>40.轻量级锁</h4><p>线程在执行同步块，jvm会现在当前线程的栈帧中创建用于储存锁记录的空间。并将对象头中的Mark Word复制到锁记录中。然后线程尝试使用cas将对象头中的Mark Word替换为之乡锁记录的指针。如果成功，当前线程获得锁，如果失败，表示其他线程竞争锁，当前线程便尝试使用自旋来获取锁。</p>
<h4 id="41-轻量锁的解锁"><a href="#41-轻量锁的解锁" class="headerlink" title="41.轻量锁的解锁"></a>41.轻量锁的解锁</h4><p>轻量锁解锁时，会使原子操作cas将 displaced Mark Word 替换回对象头，如果成功则表示没有竞争发生，如果失败，表示存在竞争，此时锁就会膨胀为重量级锁。</p>
<h4 id="42-锁的优缺点对比"><a href="#42-锁的优缺点对比" class="headerlink" title="42.锁的优缺点对比"></a>42.锁的优缺点对比</h4><p><img src="http://static.cyblogs.com/QQ20200506-230547@2x.jpg" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;QQ20200506-230547@2x.jpg"></p>
<h4 id="43-什么是原子操作"><a href="#43-什么是原子操作" class="headerlink" title="43.什么是原子操作"></a>43.什么是原子操作</h4><p>不可被中断的一个或一系列操作</p>
<h4 id="44-Java如何实现原子操作"><a href="#44-Java如何实现原子操作" class="headerlink" title="44.Java如何实现原子操作"></a>44.Java如何实现原子操作</h4><p>Java中通过锁和循环cas的方式来实现原子操作，JVM的CAS操作利用了处理器提供的CMPXCHG指令来实现的。自旋CAS实现的基本思路就是循环进行CAS操作直到成功为止。</p>
<h4 id="45-CAS实现原子操作的3大问题"><a href="#45-CAS实现原子操作的3大问题" class="headerlink" title="45.CAS实现原子操作的3大问题"></a>45.CAS实现原子操作的3大问题</h4><p>ABA问题，循环时间长消耗资源大，只能保证一个共享变量的原子操作</p>
<h4 id="46-什么是ABA问题"><a href="#46-什么是ABA问题" class="headerlink" title="46.什么是ABA问题"></a>46.什么是ABA问题</h4><p>问题：</p>
<p>因为cas需要在操作值的时候，检查值有没有变化，如果没有变化则更新，如果一个值原来是A,变成了B,又变成了A,那么使用cas进行检测时会发现发的值没有发生变化，其实是变过的。</p>
<p>解决：</p>
<p>添加版本号，每次更新的时候追加版本号，A-B-A —&gt; 1A-2B-3A。</p>
<p>从jdk1.5开始,Atomic包提供了一个类AtomicStampedReference来解决ABA的问题。</p>
<h4 id="47-CAS循环时间长占用资源大问题"><a href="#47-CAS循环时间长占用资源大问题" class="headerlink" title="47.CAS循环时间长占用资源大问题"></a>47.CAS循环时间长占用资源大问题</h4><p>如果jvm能支持处理器提供的pause指令，那么效率会有一定的提升。</p>
<p>一、它可以延迟流水线执行指令(de-pipeline),使cpu不会消耗过多的执行资源，延迟的时间取决于具体实现的版本，有些处理器延迟时间是0。</p>
<p>二、它可以避免在退出循环的时候因内存顺序冲突而引起的cpu流水线被清空，从而提高cpu执行效率。</p>
<h4 id="48-CAS只能保证一个共享变量原子操作"><a href="#48-CAS只能保证一个共享变量原子操作" class="headerlink" title="48.CAS只能保证一个共享变量原子操作"></a>48.CAS只能保证一个共享变量原子操作</h4><p>一、对多个共享变量操作时，可以用锁。</p>
<p>二、可以把多个共享变量合并成一个共享变量来操作。比如,x&#x3D;1,k&#x3D;a,合并xk&#x3D;1a，然后用cas操作xk。</p>
<p>Tips:java 1.5开始,jdk提供了AtomicReference类来保证饮用对象之间的原子性，就可以把多个变量放在一个对象来进行cas操作。</p>
<h4 id="49-volatile关键字"><a href="#49-volatile关键字" class="headerlink" title="49.volatile关键字"></a>49.volatile关键字</h4><p>volatile 是轻量级的synchronized,它在多处理器开发中保证了共享变量的“可见性“。</p>
<p>Java语言规范第3版对volatile定义如下，Java允许线程访问共享变量，为了保证共享变量能准确和一致的更新，线程应该确保排它锁单独获得这个变量。如果一个字段被声明为volatile,Java线程内存模型所有线程看到这个变量的值是一致的。</p>
<h4 id="50-等待-通知机制"><a href="#50-等待-通知机制" class="headerlink" title="50.等待&#x2F;通知机制"></a>50.等待&#x2F;通知机制</h4><p>一个线程修改了一个对象的值，而另一个线程感知到了变化，然后进行相应的操作。</p>
<h4 id="51-wait"><a href="#51-wait" class="headerlink" title="51.wait"></a>51.wait</h4><p>方法wait()的作用是使当前执行代码的线程进行等待，wait()是Object类通用的方法，该方法用来将当前线程置入“预执行队列”中，并在 wait()所在的代码处停止执行，直到接到通知或中断为止。</p>
<p>在调用wait之前线程需要获得该对象的对象级别的锁。代码体现上，即只能是同步方法或同步代码块内。调用wait()后当前线程释放锁。</p>
<h4 id="52-notify"><a href="#52-notify" class="headerlink" title="52.notify"></a>52.notify</h4><p>notify()也是Object类的通用方法，也要在同步方法或同步代码块内调用，该方法用来通知哪些可能灯光该对象的对象锁的其他线程，如果有多个线程等待，则随机挑选出其中一个呈wait状态的线程，对其发出 通知 notify，并让它等待获取该对象的对象锁。</p>
<h4 id="53-notify-notifyAll"><a href="#53-notify-notifyAll" class="headerlink" title="53.notify&#x2F;notifyAll"></a>53.notify&#x2F;notifyAll</h4><p>notify等于说将等待队列中的一个线程移动到同步队列中，而notifyAll是将等待队列中的所有线程全部移动到同步队列中。</p>
<h4 id="54-等待-通知经典范式"><a href="#54-等待-通知经典范式" class="headerlink" title="54.等待&#x2F;通知经典范式"></a>54.等待&#x2F;通知经典范式</h4><p>等待</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">synchronized</span>(obj) &#123;</span><br><span class="line">		<span class="keyword">while</span>(条件不满足) &#123;</span><br><span class="line">				obj.wait();</span><br><span class="line">		&#125;</span><br><span class="line">		执行对应逻辑</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通知</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">synchronized</span>(obj) &#123;</span><br><span class="line">	  改变条件</span><br><span class="line">		obj.notifyAll();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="55-ThreadLocal"><a href="#55-ThreadLocal" class="headerlink" title="55.ThreadLocal"></a>55.ThreadLocal</h4><p>主要解决每一个线程想绑定自己的值，存放线程的私有数据。</p>
<h4 id="56-ThreadLocal使用"><a href="#56-ThreadLocal使用" class="headerlink" title="56.ThreadLocal使用"></a>56.ThreadLocal使用</h4><p>获取当前的线程的值通过get(),设置set(T) 方式来设置值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">XKThreadLocal</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">ThreadLocal</span> <span class="variable">threadLocal</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (threadLocal.get() == <span class="literal">null</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;未设置过值&quot;</span>);</span><br><span class="line">            threadLocal.set(<span class="string">&quot;Java小咖秀&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(threadLocal.get());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">未设置过值</span><br><span class="line">Java小咖秀</span><br></pre></td></tr></table></figure>

<p>Tips:默认值为null</p>
<h4 id="57-解决get-返回null问题"><a href="#57-解决get-返回null问题" class="headerlink" title="57.解决get()返回null问题"></a>57.解决get()返回null问题</h4><p>通过继承重写initialValue()方法即可。</p>
<p>代码实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadLocalExt</span> <span class="keyword">extends</span> <span class="title class_">ThreadLocal</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="type">ThreadLocalExt</span> <span class="variable">threadLocalExt</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadLocalExt</span>();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Object <span class="title function_">initialValue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Java小咖秀&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        System.out.println(threadLocalExt.get());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出结果:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Java小咖秀</span><br></pre></td></tr></table></figure>

<h4 id="58-Lock接口"><a href="#58-Lock接口" class="headerlink" title="58.Lock接口"></a>58.Lock接口</h4><p>锁可以防止多个线程同时共享资源。Java5前程序是靠synchronized实现锁功能。Java5之后，并发包新增Lock接口来实现锁功能。</p>
<h4 id="59-Lock接口提供-synchronized不具备的主要特性"><a href="#59-Lock接口提供-synchronized不具备的主要特性" class="headerlink" title="59.Lock接口提供 synchronized不具备的主要特性"></a>59.Lock接口提供 synchronized不具备的主要特性</h4><p><img src="http://static.cyblogs.com/QQ20200506-230803@2x.jpg" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;QQ20200506-230803@2x.jpg"></p>
<h4 id="60-重入锁-ReentrantLock"><a href="#60-重入锁-ReentrantLock" class="headerlink" title="60.重入锁 ReentrantLock"></a>60.重入锁 ReentrantLock</h4><p>支持重进入的锁，它表示该锁能够支持一个线程对资源的重复加锁。除此之外，该锁的还支持获取锁时的公平和非公平性选择。</p>
<h4 id="61-重进入是什么意思？"><a href="#61-重进入是什么意思？" class="headerlink" title="61.重进入是什么意思？"></a>61.重进入是什么意思？</h4><p>重进入是指任意线程在获取到锁之后能够再次获锁而不被锁阻塞。</p>
<p>该特性主要解决以下两个问题：</p>
<p>一、锁需要去识别获取锁的线程是否为当前占据锁的线程，如果是则再次成功获取。</p>
<p>二、所得最终释放。线程重复n次是获取了锁，随后在第n次释放该锁后，其他线程能够获取到该锁。</p>
<h4 id="62-ReentrantLock默认锁？"><a href="#62-ReentrantLock默认锁？" class="headerlink" title="62.ReentrantLock默认锁？"></a>62.ReentrantLock默认锁？</h4><p>默认非公平锁</p>
<p>代码为证:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">nonfairTryAcquire</span><span class="params">(<span class="type">int</span> acquires)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Thread</span> <span class="variable">current</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">    <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState();</span><br><span class="line">    <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, acquires)) &#123;</span><br><span class="line">            setExclusiveOwnerThread(current);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (current == getExclusiveOwnerThread()) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">nextc</span> <span class="operator">=</span> c + acquires;</span><br><span class="line">        <span class="keyword">if</span> (nextc &lt; <span class="number">0</span>) <span class="comment">// overflow</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;Maximum lock count exceeded&quot;</span>);</span><br><span class="line">        setState(nextc);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="63-公平锁和非公平锁的区别"><a href="#63-公平锁和非公平锁的区别" class="headerlink" title="63.公平锁和非公平锁的区别"></a>63.公平锁和非公平锁的区别</h4><p>公平性与否针对获取锁来说的，如果一个锁是公平的，那么锁的获取顺序就应该符合请求的绝对时间顺序，也就是FIFO。</p>
<h4 id="64-读写锁"><a href="#64-读写锁" class="headerlink" title="64.读写锁"></a>64.读写锁</h4><h4 id="读写锁允许同一时刻多个读线程访问，但是写线程和其他写线程均被阻塞。读写锁维护一个读锁一个写锁，读写分离，并发性得到了提升。"><a href="#读写锁允许同一时刻多个读线程访问，但是写线程和其他写线程均被阻塞。读写锁维护一个读锁一个写锁，读写分离，并发性得到了提升。" class="headerlink" title="读写锁允许同一时刻多个读线程访问，但是写线程和其他写线程均被阻塞。读写锁维护一个读锁一个写锁，读写分离，并发性得到了提升。"></a>读写锁允许同一时刻多个读线程访问，但是写线程和其他写线程均被阻塞。读写锁维护一个读锁一个写锁，读写分离，并发性得到了提升。</h4><p>Java中提供读写锁的实现类是ReentrantReadWriteLock。</p>
<h4 id="65-LockSupport工具"><a href="#65-LockSupport工具" class="headerlink" title="65.LockSupport工具"></a>65.LockSupport工具</h4><p>定义了一组公共静态方法，提供了最基本的线程阻塞和唤醒功能。</p>
<p><img src="http://static.cyblogs.com/QQ20200506-230912@2x.jpg" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;QQ20200506-230912@2x.jpg"></p>
<h4 id="66-Condition接口"><a href="#66-Condition接口" class="headerlink" title="66.Condition接口"></a>66.Condition接口</h4><p>提供了类似Object监视器方法，与 Lock配合使用实现等待&#x2F;通知模式。</p>
<h4 id="67-Condition使用"><a href="#67-Condition使用" class="headerlink" title="67.Condition使用"></a>67.Condition使用</h4><p>代码示例:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">XKCondition</span> &#123;</span><br><span class="line">    <span class="type">Lock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line">    <span class="type">Condition</span> <span class="variable">cd</span> <span class="operator">=</span> lock.newCondition();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">await</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            cd.await();<span class="comment">//相当于Object 方法中的wait()</span></span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">signal</span><span class="params">()</span> &#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            cd.signal(); <span class="comment">//相当于Object 方法中的notify()</span></span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="68-ArrayBlockingQueue"><a href="#68-ArrayBlockingQueue" class="headerlink" title="68.ArrayBlockingQueue?"></a>68.ArrayBlockingQueue?</h4><p>一个由数据支持的有界阻塞队列，此队列FIFO原则对元素进行排序。队列头部在队列中存在的时间最长，队列尾部存在时间最短。</p>
<h4 id="69-PriorityBlockingQueue"><a href="#69-PriorityBlockingQueue" class="headerlink" title="69.PriorityBlockingQueue?"></a>69.PriorityBlockingQueue?</h4><p>一个支持优先级排序的无界阻塞队列，但它不会阻塞数据生产者，而只会在没有可消费的数据时，阻塞数据的消费者。</p>
<h4 id="70-DelayQueue"><a href="#70-DelayQueue" class="headerlink" title="70.DelayQueue?"></a>70.DelayQueue?</h4><p>是一个支持延时获取元素的使用优先级队列的实现的无界阻塞队列。队列中的元素必须实现Delayed接口和 Comparable接口，在创建元素时可以指定多久才能从队列中获取当前元素。</p>
<h4 id="71-Java并发容器，你知道几个？"><a href="#71-Java并发容器，你知道几个？" class="headerlink" title="71.Java并发容器，你知道几个？"></a>71.Java并发容器，你知道几个？</h4><p>ConcurrentHashMap、CopyOnWriteArrayList 、CopyOnWriteArraySet 、ConcurrentLinkedQueue、</p>
<p>ConcurrentLinkedDeque、ConcurrentSkipListMap、ConcurrentSkipListSet、ArrayBlockingQueue、</p>
<p>LinkedBlockingQueue、LinkedBlockingDeque、PriorityBlockingQueue、SynchronousQueue、</p>
<p>LinkedTransferQueue、DelayQueue</p>
<h4 id="72-ConcurrentHashMap"><a href="#72-ConcurrentHashMap" class="headerlink" title="72.ConcurrentHashMap"></a>72.ConcurrentHashMap</h4><p>并发安全版HashMap,java7中采用分段锁技术来提高并发效率，默认分16段。Java8放弃了分段锁，采用CAS，同时当哈希冲突时，当链表的长度到8时，会转化成红黑树。（如需了解细节，见jdk中代码）</p>
<h4 id="73-ConcurrentLinkedQueue"><a href="#73-ConcurrentLinkedQueue" class="headerlink" title="73.ConcurrentLinkedQueue"></a>73.ConcurrentLinkedQueue</h4><p>基于链接节点的无界线程安全队列，它采用先进先出的规则对节点进行排序，当我们添加一个元素的时候，它会添加到队列的尾部，当我们获取一个元素时，它会返回队列头部的元素。它采用cas算法来实现。（如需了解细节，见jdk中代码）</p>
<h4 id="74-什么是阻塞队列？"><a href="#74-什么是阻塞队列？" class="headerlink" title="74.什么是阻塞队列？"></a>74.什么是阻塞队列？</h4><p>阻塞队列是一个支持两个附加操作的队列，这两个附加操作支持阻塞的插入和移除方法。</p>
<p>1、支持阻塞的插入方法：当队列满时，队列会阻塞插入元素的线程，直到队列不满。</p>
<p>2、支持阻塞的移除方法：当队列空时，获取元素的线程会等待队列变为非空。</p>
<h4 id="75-阻塞队列常用的应用场景？"><a href="#75-阻塞队列常用的应用场景？" class="headerlink" title="75.阻塞队列常用的应用场景？"></a>75.阻塞队列常用的应用场景？</h4><p>常用于生产者和消费者场景，生产者是往队列里添加元素的线程，消费者是从队列里取元素的线程。阻塞队列正好是生产者存放、消费者来获取的容器。</p>
<h4 id="76-Java里的阻塞的队列"><a href="#76-Java里的阻塞的队列" class="headerlink" title="76.Java里的阻塞的队列"></a>76.Java里的阻塞的队列</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ArrayBlockingQueue：    数组结构组成的 |有界阻塞队列</span><br><span class="line">LinkedBlockingQueue：   链表结构组成的|有界阻塞队列</span><br><span class="line">PriorityBlockingQueue:  支持优先级排序|无界阻塞队列</span><br><span class="line">DelayQueue：            优先级队列实现|无界阻塞队列</span><br><span class="line">SynchronousQueue：      不存储元素| 阻塞队列</span><br><span class="line">LinkedTransferQueue：   链表结构组成|无界阻塞队列</span><br><span class="line">LinkedBlockingDeque：   链表结构组成|双向阻塞队列</span><br></pre></td></tr></table></figure>

<h4 id="77-Fork-Join"><a href="#77-Fork-Join" class="headerlink" title="77.Fork&#x2F;Join"></a>77.Fork&#x2F;Join</h4><p>java7提供的一个用于并行执行任务的框架，把一个大任务分割成若干个小任务，最终汇总每个小任务结果的后得到大任务结果的框架。</p>
<h4 id="78-工作窃取算法"><a href="#78-工作窃取算法" class="headerlink" title="78.工作窃取算法"></a>78.工作窃取算法</h4><p>是指某个线程从其他队列里窃取任务来执行。当大任务被分割成小任务时，有的线程可能提前完成任务，此时闲着不如去帮其他没完成工作线程。此时可以去其他队列窃取任务，为了减少竞争，通常使用双端队列，被窃取的线程从头部拿，窃取的线程从尾部拿任务执行。</p>
<h4 id="79-工作窃取算法的有缺点"><a href="#79-工作窃取算法的有缺点" class="headerlink" title="79.工作窃取算法的有缺点"></a>79.工作窃取算法的有缺点</h4><p>优点：充分利用线程进行并行计算，减少了线程间的竞争。</p>
<p>缺点：有些情况下还是存在竞争，比如双端队列中只有一个任务。这样就消耗了更多资源。</p>
<h4 id="80-Java中原子操作更新基本类型，Atomic包提供了哪几个类"><a href="#80-Java中原子操作更新基本类型，Atomic包提供了哪几个类" class="headerlink" title="80.Java中原子操作更新基本类型，Atomic包提供了哪几个类?"></a>80.Java中原子操作更新基本类型，Atomic包提供了哪几个类?</h4><p>AtomicBoolean:原子更新布尔类型</p>
<p>AtomicInteger:原子更新整形</p>
<p>AtomicLong:原子更新长整形</p>
<h4 id="81-Java中原子操作更新数组，Atomic包提供了哪几个类"><a href="#81-Java中原子操作更新数组，Atomic包提供了哪几个类" class="headerlink" title="81.Java中原子操作更新数组，Atomic包提供了哪几个类?"></a>81.Java中原子操作更新数组，Atomic包提供了哪几个类?</h4><p>AtomicIntegerArray:       原子更新整形数据里的元素</p>
<p>AtomicLongArray:          原子更新长整形数组里的元素</p>
<p>AtomicReferenceArray:  原子更新饮用类型数组里的元素</p>
<p>AtomicIntegerArray:      主要提供原子方式更新数组里的整形</p>
<h4 id="82-Java中原子操作更新引用类型，Atomic包提供了哪几个类"><a href="#82-Java中原子操作更新引用类型，Atomic包提供了哪几个类" class="headerlink" title="82.Java中原子操作更新引用类型，Atomic包提供了哪几个类?"></a>82.Java中原子操作更新引用类型，Atomic包提供了哪几个类?</h4><p>如果原子需要更新多个变量，就需要用引用类型了。</p>
<p>AtomicReference :  原子更新引用类型</p>
<p>AtomicReferenceFieldUpdater: 原子更新引用类型里的字段。</p>
<p>AtomicMarkableReference: 原子更新带有标记位的引用类型。标记位用boolean类型表示，构造方法时AtomicMarkableReference(V initialRef,boolean initialMark)</p>
<h4 id="83-Java中原子操作更新字段类，Atomic包提供了哪几个类"><a href="#83-Java中原子操作更新字段类，Atomic包提供了哪几个类" class="headerlink" title="83.Java中原子操作更新字段类，Atomic包提供了哪几个类?"></a>83.Java中原子操作更新字段类，Atomic包提供了哪几个类?</h4><p>AtomiceIntegerFieldUpdater:  	原子更新整形字段的更新器</p>
<p>AtomiceLongFieldUpdater:     	原子更新长整形字段的更新器</p>
<p>AtomiceStampedFieldUpdater:   原子更新带有版本号的引用类型，将整数值</p>
<h4 id="84-JDK并发包中提供了哪几个比较常见的处理并发的工具类？"><a href="#84-JDK并发包中提供了哪几个比较常见的处理并发的工具类？" class="headerlink" title="84.JDK并发包中提供了哪几个比较常见的处理并发的工具类？"></a>84.JDK并发包中提供了哪几个比较常见的处理并发的工具类？</h4><p>提供并发控制手段: CountDownLatch、CyclicBarrier、Semaphore</p>
<p>线程间数据交换:     Exchanger</p>
<h4 id="85-CountDownLatch"><a href="#85-CountDownLatch" class="headerlink" title="85.CountDownLatch"></a>85.CountDownLatch</h4><p>允许一个或多个线程等待其他线程完成操作。</p>
<p>CountDownLatch的构造函数接受一个int类型的参数作为计数器，你想等待n个点完成，就传入n。</p>
<p>两个重要的方法:</p>
<p>countDown() : 调用时，n会减1。</p>
<p>await() : 调用会阻塞当前线程，直到n变成0。</p>
<p>await(long time,TimeUnit unit) : 等待特定时间后，就不会继续阻塞当前线程。</p>
<p>tips:计数器必须大于等于0，当为0时，await就不会阻塞当前线程。</p>
<p>不提供重新初始化或修改内部计数器的值的功能。</p>
<h4 id="86-CyclicBarrier"><a href="#86-CyclicBarrier" class="headerlink" title="86.CyclicBarrier"></a>86.CyclicBarrier</h4><p>可循环使用的屏障。</p>
<p>让一组线程到达一个屏障（也可以叫同步点）时被阻塞，直到最后一个线程到达屏障时，屏障才会开门，所有被屏障拦截的线程才会继续运行。</p>
<p>CyclicBarrier默认构造放时CyclicBarrier(int parities) ,其参数表示屏障拦截的线程数量，每个线程调用await方法告诉CyclicBarrier我已经到达屏障，然后当前线程被阻塞。</p>
<h4 id="87-CountDownLatch与CyclicBarrier区别"><a href="#87-CountDownLatch与CyclicBarrier区别" class="headerlink" title="87.CountDownLatch与CyclicBarrier区别"></a>87.CountDownLatch与CyclicBarrier区别</h4><p>CountDownLatch：</p>
<p>计数器：计数器只能使用一次。</p>
<p>等待： 一个线程或多个等待另外n个线程完成之后才能执行。</p>
<p>CyclicBarrier：</p>
<p>计数器：计数器可以重置（通过reset()方法)。</p>
<p>等待： n个线程相互等待，任何一个线程完成之前，所有的线程都必须等待。</p>
<h4 id="88-Semaphore"><a href="#88-Semaphore" class="headerlink" title="88.Semaphore"></a>88.Semaphore</h4><p>用来控制同时访问资源的线程数量，通过协调各个线程，来保证合理的公共资源的访问。</p>
<p>应用场景：流量控制，特别是公共资源有限的应用场景，比如数据链接，限流等。</p>
<h4 id="89-Exchanger"><a href="#89-Exchanger" class="headerlink" title="89.Exchanger"></a>89.Exchanger</h4><p>Exchanger是一个用于线程间协作的工具类，它提供一个同步点，在这个同步点上，两个线程可以交换彼此的数据。比如第一个线程执行exchange()方法，它会一直等待第二个线程也执行exchange，当两个线程都到同步点，就可以交换数据了。</p>
<p>一般来说为了避免一直等待的情况，可以使用exchange(V x,long timeout,TimeUnit unit),设置最大等待时间。</p>
<p>Exchanger可以用于遗传算法。</p>
<h4 id="90-为什么使用线程池"><a href="#90-为什么使用线程池" class="headerlink" title="90.为什么使用线程池"></a>90.为什么使用线程池</h4><p>几乎所有需要异步或者并发执行任务的程序都可以使用线程池。合理使用会给我们带来以下好处。</p>
<ul>
<li>降低系统消耗：重复利用已经创建的线程降低线程创建和销毁造成的资源消耗。</li>
<li>提高响应速度： 当任务到达时，任务不需要等到线程创建就可以立即执行。</li>
<li>提供线程可以管理性： 可以通过设置合理分配、调优、监控。</li>
</ul>
<h4 id="91-线程池工作流程"><a href="#91-线程池工作流程" class="headerlink" title="91.线程池工作流程"></a>91.线程池工作流程</h4><p>1、判断核心线程池里的线程是否都有在执行任务，否-&gt;创建一个新工作线程来执行任务。是-&gt;走下个流程。</p>
<p>2、判断工作队列是否已满，否-&gt;新任务存储在这个工作队列里，是-&gt;走下个流程。</p>
<p>3、判断线程池里的线程是否都在工作状态，否-&gt;创建一个新的工作线程来执行任务，</p>
<p>是-&gt;走下个流程。</p>
<p>4、按照设置的策略来处理无法执行的任务。</p>
<h4 id="92-创建线程池参数有哪些，作用？"><a href="#92-创建线程池参数有哪些，作用？" class="headerlink" title="92.创建线程池参数有哪些，作用？"></a>92.创建线程池参数有哪些，作用？</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ThreadPoolExecutor</span><span class="params">(   <span class="type">int</span> corePoolSize,</span></span><br><span class="line"><span class="params">                             <span class="type">int</span> maximumPoolSize,</span></span><br><span class="line"><span class="params">                             <span class="type">long</span> keepAliveTime,</span></span><br><span class="line"><span class="params">                             TimeUnit unit,</span></span><br><span class="line"><span class="params">                             BlockingQueue&lt;Runnable&gt; workQueue,</span></span><br><span class="line"><span class="params">                             ThreadFactory threadFactory,</span></span><br><span class="line"><span class="params">                             RejectedExecutionHandler handler)</span></span><br></pre></td></tr></table></figure>

<p>1.corePoolSize:核心线程池大小，当提交一个任务时，线程池会创建一个线程来执行任务，即使其他空闲的核心线程能够执行新任务也会创建，等待需要执行的任务数大于线程核心大小就不会继续创建。</p>
<p>2.maximumPoolSize:线程池最大数，允许创建的最大线程数，如果队列满了，并且已经创建的线程数小于最大线程数，则会创建新的线程执行任务。如果是无界队列，这个参数基本没用。</p>
<p>3.keepAliveTime: 线程保持活动时间，线程池工作线程空闲后，保持存活的时间，所以如果任务很多，并且每个任务执行时间较短，可以调大时间，提高线程利用率。</p>
<p>4.unit: 线程保持活动时间单位，天（DAYS)、小时(HOURS)、分钟(MINUTES、毫秒MILLISECONDS)、微秒(MICROSECONDS)、纳秒(NANOSECONDS)</p>
<p>5.workQueue: 任务队列，保存等待执行的任务的阻塞队列。</p>
<p>一般来说可以选择如下阻塞队列：</p>
<p>ArrayBlockingQueue:基于数组的有界阻塞队列。</p>
<p>LinkedBlockingQueue:基于链表的阻塞队列。</p>
<p>SynchronizedQueue:一个不存储元素的阻塞队列。</p>
<p>PriorityBlockingQueue:一个具有优先级的阻塞队列。</p>
<p>6.threadFactory：设置创建线程的工厂，可以通过线程工厂给每个创建出来的线程设置更有意义的名字。</p>
<ol>
<li><p>handler: 饱和策略也叫拒绝策略。当队列和线程池都满了，即达到饱和状态。所以需要采取策略来处理新的任务。默认策略是AbortPolicy。</p>
<p>AbortPolicy:直接抛出异常。</p>
<p>CallerRunsPolicy: 调用者所在的线程来运行任务。</p>
<p>DiscardOldestPolicy:丢弃队列里最近的一个任务，并执行当前任务。</p>
<p>DiscardPolicy:不处理，直接丢掉。</p>
<p>当然可以根据自己的应用场景，实现RejectedExecutionHandler接口自定义策略。</p>
</li>
</ol>
<h4 id="93-向线程池提交任务"><a href="#93-向线程池提交任务" class="headerlink" title="93.向线程池提交任务"></a>93.向线程池提交任务</h4><p>可以使用execute()和submit() 两种方式提交任务。</p>
<p>execute():无返回值，所以无法判断任务是否被执行成功。</p>
<p>submit():用于提交需要有返回值的任务。线程池返回一个future类型的对象，通过这个future对象可以判断任务是否执行成功，并且可以通过future的get()来获取返回值，get()方法会阻塞当前线程知道任务完成。get(long timeout,TimeUnit unit)可以设置超市时间。</p>
<h4 id="94-关闭线程池"><a href="#94-关闭线程池" class="headerlink" title="94.关闭线程池"></a>94.关闭线程池</h4><p>可以通过shutdown()或shutdownNow()来关闭线程池。它们的原理是遍历线程池中的工作线程，然后逐个调用线程的interrupt来中断线程，所以无法响应终端的任务可以能永远无法停止。</p>
<p>shutdownNow首先将线程池状态设置成STOP,然后尝试停止所有的正在执行或者暂停的线程，并返回等待执行任务的列表。</p>
<p>shutdown只是将线程池的状态设置成shutdown状态，然后中断所有没有正在执行任务的线程。</p>
<p>只要调用两者之一，isShutdown就会返回true,当所有任务都已关闭，isTerminaed就会返回true。</p>
<p>一般来说调用shutdown方法来关闭线程池，如果任务不一定要执行完，可以直接调用shutdownNow方法。</p>
<h4 id="95-线程池如何合理设置"><a href="#95-线程池如何合理设置" class="headerlink" title="95.线程池如何合理设置"></a>95.线程池如何合理设置</h4><p>配置线程池可以从以下几个方面考虑。</p>
<ul>
<li><p>任务是cpu密集型、IO密集型或者混合型</p>
</li>
<li><p>任务优先级，高中低。</p>
</li>
<li><p>任务时间执行长短。</p>
</li>
<li><p>任务依赖性：是否依赖其他系统资源。</p>
<p>cpu密集型可以配置可能小的线程,比如 n + 1个线程。</p>
<p>io密集型可以配置较多的线程，如 2n个线程。</p>
<p>混合型可以拆成io密集型任务和cpu密集型任务，</p>
<p>如果两个任务执行时间相差大，否-&gt;分解后执行吞吐量将高于串行执行吞吐量。</p>
<p>否-&gt;没必要分解。</p>
<p>可以通过Runtime.getRuntime().availableProcessors()来获取cpu个数。</p>
<p>建议使用有界队列，增加系统的预警能力和稳定性。</p>
</li>
</ul>
<h4 id="96-Executor"><a href="#96-Executor" class="headerlink" title="96.Executor"></a>96.Executor</h4><p>从JDK5开始，把工作单元和执行机制分开。工作单元包括Runnable和Callable,而执行机制由Executor框架提供。</p>
<h4 id="97-Executor框架的主要成员"><a href="#97-Executor框架的主要成员" class="headerlink" title="97.Executor框架的主要成员"></a>97.Executor框架的主要成员</h4><p>ThreadPoolExecutor  :可以通过工厂类Executors来创建。</p>
<p>可以创建3种类型的ThreadPoolExecutor：SingleThreadExecutor、FixedThreadPool、CachedThreadPool。</p>
<p>ScheduledThreadPoolExecutor ：可以通过工厂类Executors来创建。</p>
<p>可以创建2中类型的ScheduledThreadPoolExecutor：ScheduledThreadPoolExecutor、SingleThreadScheduledExecutor</p>
<p>Future接口:Future和实现Future接口的FutureTask类来表示异步计算的结果。</p>
<p>Runnable和Callable:它们的接口实现类都可以被ThreadPoolExecutor或ScheduledThreadPoolExecutor执行。Runnable不能返回结果，Callable可以返回结果。</p>
<h4 id="98-FixedThreadPool"><a href="#98-FixedThreadPool" class="headerlink" title="98.FixedThreadPool"></a>98.FixedThreadPool</h4><p>可重用固定线程数的线程池。</p>
<p>查看源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title function_">newFixedThreadPool</span><span class="params">(<span class="type">int</span> nThreads)</span> &#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(nThreads, nThreads,</span><br><span class="line">                                 <span class="number">0L</span>, TimeUnit.MILLISECONDS,</span><br><span class="line">                                <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;Runnable&gt;());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>corePoolSize 和maxPoolSize都被设置成我们设置的nThreads。</p>
<p>当线程池中的线程数大于corePoolSize ,keepAliveTime为多余的空闲线程等待新任务的最长时间，超过这个时间后多余的线程将被终止，如果设为0，表示多余的空闲线程会立即终止。</p>
<p>工作流程：</p>
<p>1.当前线程少于corePoolSize,创建新线程执行任务。</p>
<p>2.当前运行线程等于corePoolSize,将任务加入LinkedBlockingQueue。</p>
<p>3.线程执行完1中的任务，会循环反复从LinkedBlockingQueue获取任务来执行。</p>
<p>LinkedBlockingQueue作为线程池工作队列（默认容量Integer.MAX_VALUE)。因此可能会造成如下赢下。</p>
<p>1.当线程数等于corePoolSize时，新任务将在队列中等待，因为线程池中的线程不会超过corePoolSize。</p>
<p>2.maxnumPoolSize等于说是一个无效参数。</p>
<p>3.keepAliveTime等于说也是一个无效参数。</p>
<p>4.运行中的FixedThreadPool(未执行shundown或shundownNow))则不会调用拒绝策略。</p>
<p>5.由于任务可以不停的加到队列，当任务越来越多时很容易造成OOM。</p>
<h4 id="99-SingleThreadExecutor"><a href="#99-SingleThreadExecutor" class="headerlink" title="99.SingleThreadExecutor"></a>99.SingleThreadExecutor</h4><p>是使用单个worker线程的Executor。</p>
<p>查看源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title function_">newSingleThreadExecutor</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FinalizableDelegatedExecutorService</span></span><br><span class="line">        (<span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(<span class="number">1</span>, <span class="number">1</span>,</span><br><span class="line">                                <span class="number">0L</span>, TimeUnit.MILLISECONDS,</span><br><span class="line">                                <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;Runnable&gt;()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>corePoolSize和maxnumPoolSize被设置为1。其他参数和FixedThreadPool相同。</p>
<p>执行流程以及造成的影响同FixedThreadPool.</p>
<h4 id="100-CachedThreadPool"><a href="#100-CachedThreadPool" class="headerlink" title="100.CachedThreadPool"></a>100.CachedThreadPool</h4><p>根据需要创建新线程的线程池。</p>
<p>查看源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title function_">newCachedThreadPool</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(<span class="number">0</span>, Integer.MAX_VALUE,</span><br><span class="line">                                      <span class="number">60L</span>, TimeUnit.SECONDS,</span><br><span class="line">                                      <span class="keyword">new</span> <span class="title class_">SynchronousQueue</span>&lt;Runnable&gt;());</span><br></pre></td></tr></table></figure>

<p>corePoolSize设置为0，maxmumPoolSize为Integer.MAX_VALUE。keepAliveTime为60秒。</p>
<p>工作流程：</p>
<p>1.首先执行SynchronousQueue.offer (Runnable task)。如果当前maximumPool 中有空闲线程正在执行S ynchronousQueue.poll(keepAliveTIme,TimeUnit.NANOSECONDS)，那么主线程执行offer操作与空闲线程执行的poll操作配对成功，主线程把任务交给空闲线程执行,execute方 法执行完成;否则执行下面的步骤2。</p>
<ol>
<li>当初始maximumPool为空或者maximumPool中当前没有空闲线程时，将没有线程执行 SynchronousQueue.poll (keepAliveTime，TimeUnit.NANOSECONDS)。这种情况下，步骤 1将失 败。此时CachedThreadPool会创建一个新线程执行任务，execute()方法执行完成。</li>
</ol>
<p>3.在步骤2中新创建的线程将任务执行完后，会执行SynchronousQueue.poll (keepAliveTime，TimeUnit.NANOSECONDS)。这个poll操作会让空闲线程最多在SynchronousQueue中等待60秒钟。如果60秒钟内主线程提交了一个新任务(主线程执行步骤1)，那么这个空闲线程将执行主线程提交的新任务;否则，这个空闲线程将终止。由于空闲60秒的空闲线程会被终止,因此长时间保持空闲的CachedThreadPool不会使用任何资源。</p>
<p>一般来说它适合处理时间短、大量的任务。</p>
<h4 id="参考地址"><a href="#参考地址" class="headerlink" title="参考地址"></a>参考地址</h4><ul>
<li><a target="_blank" rel="noopener" href="https://juejin.im/post/5eaecf326fb9a043856f33d5">https://juejin.im/post/5eaecf326fb9a043856f33d5</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.cyblogs.com/2020/05/10/2020/05/%E6%B7%B1%E5%A4%9C%E9%87%8C%E5%AE%89%E9%9D%99%E7%9A%84%E7%BC%96%E8%AF%91%E4%B8%80%E4%B8%AAOpenJDK8%EF%BC%8C%E5%9D%91%E5%A4%AA%E5%A4%9A/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/vernonchen.jpg">
      <meta itemprop="name" content="Vernon">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简栈文化">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | 简栈文化">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/05/10/2020/05/%E6%B7%B1%E5%A4%9C%E9%87%8C%E5%AE%89%E9%9D%99%E7%9A%84%E7%BC%96%E8%AF%91%E4%B8%80%E4%B8%AAOpenJDK8%EF%BC%8C%E5%9D%91%E5%A4%AA%E5%A4%9A/" class="post-title-link" itemprop="url">深夜里安静的编译一个OpenJDK8，坑太多</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-05-10 00:00:00" itemprop="dateCreated datePublished" datetime="2020-05-10T00:00:00+08:00">2020-05-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-06-25 09:56:28" itemprop="dateModified" datetime="2025-06-25T09:56:28+08:00">2025-06-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="Mac系统安装"><a href="#Mac系统安装" class="headerlink" title="Mac系统安装"></a>Mac系统安装</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">利用brew search查找mercurial</span><br><span class="line">➜  ~  brew search mercurial</span><br><span class="line">安装</span><br><span class="line">➜  ~  brew install mercuria</span><br></pre></td></tr></table></figure>

<h4 id="Linux系统安装"><a href="#Linux系统安装" class="headerlink" title="Linux系统安装"></a>Linux系统安装</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install mercurial</span><br></pre></td></tr></table></figure>

<h4 id="安装openjdk8"><a href="#安装openjdk8" class="headerlink" title="安装openjdk8"></a>安装openjdk8</h4><h5 id="添加代理"><a href="#添加代理" class="headerlink" title="添加代理"></a>添加代理</h5><p>一般在下载代码的时候都会很慢，故先配置好代理。我这里是V2Ray。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/etc/mercurial/hgrc</span><br><span class="line"></span><br><span class="line">[http_proxy]</span><br><span class="line">host=127.0.0.1:8001</span><br><span class="line">[https_proxy]</span><br><span class="line">host=127.0.0.1:8001</span><br></pre></td></tr></table></figure>

<h5 id="下载jdk8u的代码"><a href="#下载jdk8u的代码" class="headerlink" title="下载jdk8u的代码"></a>下载jdk8u的代码</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">hg clone https://hg.openjdk.java.net/jdk8u/jdk8u openjdk8</span><br><span class="line">chmod u+x get_source.sh</span><br><span class="line">chmod u+x configure</span><br><span class="line">./get_source.sh  # 下载全部源代码  </span><br><span class="line">./configure  --with-freetype-include=/usr/local/include/freetype2 --with-freetype-lib=/usr/local/lib/      # configure 编译环境，若编译报错，需要添加 `--disable-warnings-as-errors`</span><br><span class="line">make all  </span><br></pre></td></tr></table></figure>

<h4 id="漫长的等待，终于等到你"><a href="#漫长的等待，终于等到你" class="headerlink" title="漫长的等待，终于等到你"></a>漫长的等待，终于等到你</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># Finished docs (build time 00:01:52)</span></span></span><br><span class="line"></span><br><span class="line">----- Build times -------</span><br><span class="line">Start 2020-05-24 03:18:37</span><br><span class="line">End   2020-05-24 03:30:07</span><br><span class="line">00:00:19 corba</span><br><span class="line">00:00:46 demos</span><br><span class="line">00:01:52 docs</span><br><span class="line">00:02:53 hotspot</span><br><span class="line">00:01:28 images</span><br><span class="line">00:00:12 jaxp</span><br><span class="line">00:00:18 jaxws</span><br><span class="line">00:03:07 jdk</span><br><span class="line">00:00:26 langtools</span><br><span class="line">00:00:09 nashorn</span><br><span class="line">00:11:30 TOTAL</span><br><span class="line">-------------------------</span><br><span class="line">Finished building OpenJDK for target &#x27;all&#x27;</span><br></pre></td></tr></table></figure>

<p><img src="http://static.cyblogs.com/QQ20200524-035223@2x.jpg" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;QQ20200524-035223@2x.jpg"></p>
<p>如何在CLion里面做调试，后面我再详细的写一篇。敬请期待~</p>
<h4 id="遇到的坑"><a href="#遇到的坑" class="headerlink" title="遇到的坑"></a>遇到的坑</h4><h5 id="问题一：Xcode-4-is-required-to-build-JDK-8"><a href="#问题一：Xcode-4-is-required-to-build-JDK-8" class="headerlink" title="问题一：Xcode 4 is required to build JDK 8"></a>问题一：Xcode 4 is required to build JDK 8</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">configure: error: Xcode 4 is required to build JDK 8, the version found was 11.4.1. Use --with-xcode-path to specify the location of Xcode 4 or make Xcode 4 active by using xcode-select.</span><br><span class="line">configure exiting with result code 1</span><br></pre></td></tr></table></figure>

<p>解决方案：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">➜  openjdk8  vim common/autoconf/generated-configure.sh</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Fail-fast: verify we<span class="string">&#x27;re building on Xcode 4, we cannot build with Xcode 5 or later</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string">XCODE_VERSION=`$XCODEBUILD -version | grep &#x27;</span>^Xcode <span class="string">&#x27; | sed &#x27;</span>s/Xcode //<span class="string">&#x27;`</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string">XC_VERSION_PARTS=( $&#123;XCODE_VERSION//./ &#125; )</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string">if test ! &quot;$&#123;XC_VERSION_PARTS[0]&#125;&quot; = &quot;4&quot;; then</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string"> as_fn_error $? &quot;Xcode 4 is required to build JDK 8, the version found was $XCODE_VERSION. Use --with-xcode-path to specify the l      ocation of Xcode 4 or make Xcode 4 active by using xcode-select.&quot; &quot;$LINENO&quot; 5</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="string">fi</span></span></span><br></pre></td></tr></table></figure>

<h5 id="问题二：A-gcc-compiler-is-required"><a href="#问题二：A-gcc-compiler-is-required" class="headerlink" title="问题二：A gcc compiler is required"></a>问题二：A gcc compiler is required</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">configure: error: A gcc compiler is required. Try setting --with-tools-dir.</span><br><span class="line">configure exiting with result code</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">第一处代码 <span class="keyword">elif</span> <span class="built_in">test</span>  <span class="string">&quot;x<span class="variable">$TOOLCHAIN_TYPE</span>&quot;</span> = xgcc; <span class="keyword">then</span></span></span><br><span class="line">    # gcc --version output typically looks like</span><br><span class="line">    #     gcc (Ubuntu/Linaro 4.8.1-10ubuntu9) 4.8.1</span><br><span class="line">    #     Copyright (C) 2013 Free Software Foundation, Inc.</span><br><span class="line">    #     This is free software; see the source for copying conditions.  There is NO</span><br><span class="line">    #     warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</span><br><span class="line">    COMPILER_VERSION_OUTPUT=`$COMPILER --version 2&gt;&amp;1`</span><br><span class="line">    # Check that this is likely to be GCC.</span><br><span class="line">    $ECHO &quot;$COMPILER_VERSION_OUTPUT&quot; | $GREP &quot;Free Software Foundation&quot; &gt; /dev/null</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">条件语句注释掉</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">    <span class="keyword">if</span> <span class="built_in">test</span> $? -ne 0; <span class="keyword">then</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">      &#123; <span class="variable">$as_echo</span> <span class="string">&quot;<span class="variable">$as_me</span>:<span class="variable">$&#123;as_lineno-$LINENO&#125;</span>: The <span class="variable">$COMPILER_NAME</span> compiler (located as <span class="variable">$COMPILER</span>) does not seem to be the required <span class="variable">$TOOLCHAIN_TYPE</span> compiler.&quot;</span> &gt;&amp;5</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="variable">$as_echo</span> <span class="string">&quot;<span class="variable">$as_me</span>: The <span class="variable">$COMPILER_NAME</span> compiler (located as <span class="variable">$COMPILER</span>) does not seem to be the required <span class="variable">$TOOLCHAIN_TYPE</span> compiler.&quot;</span> &gt;&amp;6;&#125;</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">      &#123; <span class="variable">$as_echo</span> <span class="string">&quot;<span class="variable">$as_me</span>:<span class="variable">$&#123;as_lineno-$LINENO&#125;</span>: The result from running with --version was: \&quot;<span class="variable">$COMPILER_VERSION</span>\&quot;&quot;</span> &gt;&amp;5</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="variable">$as_echo</span> <span class="string">&quot;<span class="variable">$as_me</span>: The result from running with --version was: \&quot;<span class="variable">$COMPILER_VERSION</span>\&quot;&quot;</span> &gt;&amp;6;&#125;</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">      as_fn_error $? <span class="string">&quot;A <span class="variable">$TOOLCHAIN_TYPE</span> compiler is required. Try setting --with-tools-dir.&quot;</span> <span class="string">&quot;<span class="variable">$LINENO</span>&quot;</span> 5</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">    <span class="keyword">fi</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">第二处代码，</span></span><br><span class="line">  elif test  &quot;x$TOOLCHAIN_TYPE&quot; = xgcc; then</span><br><span class="line">    # gcc --version output typically looks like</span><br><span class="line">    #     gcc (Ubuntu/Linaro 4.8.1-10ubuntu9) 4.8.1</span><br><span class="line">    #     Copyright (C) 2013 Free Software Foundation, Inc.</span><br><span class="line">    #     This is free software; see the source for copying conditions.  There is NO</span><br><span class="line">    #     warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</span><br><span class="line">    COMPILER_VERSION_OUTPUT=`$COMPILER --version 2&gt;&amp;1`</span><br><span class="line">    # Check that this is likely to be GCC.</span><br><span class="line">    $ECHO &quot;$COMPILER_VERSION_OUTPUT&quot; | $GREP &quot;Free Software Foundation&quot; &gt; /dev/null</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">条件语句注释掉</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">    <span class="keyword">if</span> <span class="built_in">test</span> $? -ne 0; <span class="keyword">then</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">      &#123; <span class="variable">$as_echo</span> <span class="string">&quot;<span class="variable">$as_me</span>:<span class="variable">$&#123;as_lineno-$LINENO&#125;</span>: The <span class="variable">$COMPILER_NAME</span> compiler (located as <span class="variable">$COMPILER</span>) does not seem to be the required <span class="variable">$TOOLCHAIN_TYPE</span> compiler.&quot;</span> &gt;&amp;5</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="variable">$as_echo</span> <span class="string">&quot;<span class="variable">$as_me</span>: The <span class="variable">$COMPILER_NAME</span> compiler (located as <span class="variable">$COMPILER</span>) does not seem to be the required <span class="variable">$TOOLCHAIN_TYPE</span> compiler.&quot;</span> &gt;&amp;6;&#125;</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">      &#123; <span class="variable">$as_echo</span> <span class="string">&quot;<span class="variable">$as_me</span>:<span class="variable">$&#123;as_lineno-$LINENO&#125;</span>: The result from running with --version was: \&quot;<span class="variable">$COMPILER_VERSION</span>\&quot;&quot;</span> &gt;&amp;5</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="variable">$as_echo</span> <span class="string">&quot;<span class="variable">$as_me</span>: The result from running with --version was: \&quot;<span class="variable">$COMPILER_VERSION</span>\&quot;&quot;</span> &gt;&amp;6;&#125;</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">      as_fn_error $? <span class="string">&quot;A <span class="variable">$TOOLCHAIN_TYPE</span> compiler is required. Try setting --with-tools-dir.&quot;</span> <span class="string">&quot;<span class="variable">$LINENO</span>&quot;</span> 5</span></span><br></pre></td></tr></table></figure>

<p>最后执行<code>sh configure</code>终于成功： </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">====================================================</span><br><span class="line">A new configuration has been successfully created in</span><br><span class="line">/Users/chenyuan/Workspaces/Openjdk/openjdk8/build/macosx-x86_64-normal-server-release</span><br><span class="line">using default settings.</span><br><span class="line"></span><br><span class="line">Configuration summary:</span><br><span class="line">* Debug level:    release</span><br><span class="line">* JDK variant:    normal</span><br><span class="line">* JVM variants:   server</span><br><span class="line">* OpenJDK target: OS: macosx, CPU architecture: x86, address length: 64</span><br><span class="line"></span><br><span class="line">Tools summary:</span><br><span class="line">* Boot JDK:       java version &quot;1.8.0_162&quot; Java(TM) SE Runtime Environment (build 1.8.0_162-b12) Java HotSpot(TM) 64-Bit Server VM (build 25.162-b12, mixed mode)  (at /Library/Java/JavaVirtualMachines/jdk1.8.0_162.jdk/Contents/Home)</span><br><span class="line">* Toolchain:      gcc (GNU Compiler Collection)</span><br><span class="line">* C Compiler:     Version 11.0.3 (at /usr/bin/gcc)</span><br><span class="line">* C++ Compiler:   Version 11.0.3 (at /usr/bin/g++)</span><br><span class="line"></span><br><span class="line">Build performance summary:</span><br><span class="line">* Cores to use:   4</span><br><span class="line">* Memory limit:   16384 MB</span><br></pre></td></tr></table></figure>

<h5 id="问题三：include-path-for-libstdc-headers-not-found"><a href="#问题三：include-path-for-libstdc-headers-not-found" class="headerlink" title="问题三：include path for libstdc++ headers not found"></a>问题三：include path for libstdc++ headers not found</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">clang: clangerror: include path for libstdc++ headers not found; pass &#x27;-stdlib=libc++&#x27; on the command line to use the libc++ standard library instead [-Werror,-Wstdlibcxx-not-found]</span><br><span class="line">: error: include path for libstdc++ headers not found; pass &#x27;-stdlib=libc++&#x27; on the command line to use the libc++ standard library instead [-Werror,-Wstdlibcxx-not-found]</span><br><span class="line">make[6]: *** [../generated/adfiles/archDesc.o] Error 1</span><br><span class="line">make[6]: *** Waiting for unfinished jobs....</span><br><span class="line">make[6]: *** [../generated/adfiles/adlparse.o] Error 1</span><br><span class="line">clang: error: include path for libstdc++ headers not found; pass &#x27;-stdlib=libc++&#x27; on the command line to use the libc++ standard library instead [-Werror,-Wstdlibcxx-not-found]</span><br><span class="line">make[6]: *** [../generated/adfiles/arena.o] Error 1</span><br><span class="line">make[5]: *** [ad_stuff] Error 2</span><br><span class="line">make[4]: *** [product] Error 2</span><br><span class="line">make[3]: *** [generic_build2] Error 2</span><br><span class="line">make[2]: *** [product] Error 2</span><br><span class="line">make[1]: *** [/Users/chenyuan/Workspaces/Openjdk/openjdk8/build/macosx-x86_64-normal-server-release/hotspot/_hotspot.timestamp] Error 2</span><br><span class="line">make: *** [hotspot-only] Error 2</span><br></pre></td></tr></table></figure>

<p>解决方法</p>
<p>原因：这个原因是Xcode升级到10以后就没有包含lstdc++库了。而 hotspot 居然还一直用着这个，于是编译器找不到 libstdc++ 的头文件就罢工了<br>解决办法：<br>打开:<a target="_blank" rel="noopener" href="https://github.com/imkiwa/xcode-missing-libstdc-">https://github.com/imkiwa/xcode-missing-libstdc-</a> , clone 到本地，参考 install.sh 将文件链接或者复制到对应位置（慎重直接执行，请一定事先核对路径是否正确)！</p>
<h5 id="问题四：fatal-error-‘iostream’-file-not-found"><a href="#问题四：fatal-error-‘iostream’-file-not-found" class="headerlink" title="问题四：fatal error: ‘iostream’ file not found"></a>问题四：fatal error: ‘iostream’ file not found</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">/Users/chenyuan/Workspaces/Openjdk/openjdk8/hotspot/src/share/vm/adlc/archDesc.cpp:#include &lt;iostream&gt;/Users/chenyuan/Workspaces/Openjdk/openjdk8/hotspot/src/share/vm/adlc/adlc.hpp</span><br><span class="line">:         ^~~~~~~~~~35:10:27</span><br><span class="line">:</span><br><span class="line"> fatal error/Users/chenyuan/Workspaces/Openjdk/openjdk8/hotspot/src/share/vm/adlc/adlc.hpp: :35&#x27;iostream&#x27; file not found:</span><br><span class="line">10: fatal error: &#x27;iostream&#x27; file not found</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">include &lt;iostream&gt;</span></span><br><span class="line">         ^~~~~~~~~~</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">include &lt;iostream&gt;</span></span><br><span class="line">         ^~~~~~~~~~</span><br><span class="line">In file included from /Users/chenyuan/Workspaces/Openjdk/openjdk8/hotspot/src/share/vm/adlc/adlparse.cpp:27:</span><br><span class="line">/Users/chenyuan/Workspaces/Openjdk/openjdk8/hotspot/src/share/vm/adlc/adlc.hpp:35:10: fatal error: &#x27;iostream&#x27; file not found</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">include &lt;iostream&gt;</span></span><br><span class="line">         ^~~~~~~~~~</span><br><span class="line">1 error generated.</span><br><span class="line">make[6]: *** [../generated/adfiles/arena.o] Error 1</span><br><span class="line">make[6]: *** Waiting for unfinished jobs....</span><br></pre></td></tr></table></figure>

<p>解决方案</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xcode-select --install</span><br></pre></td></tr></table></figure>

<h5 id="问题五：unknown-argument-‘-fpch-deps’"><a href="#问题五：unknown-argument-‘-fpch-deps’" class="headerlink" title="问题五：unknown argument: ‘-fpch-deps’"></a>问题五：unknown argument: ‘-fpch-deps’</h5><p>解决方案：</p>
<p>hotspot&#x2F;make&#x2F;bsd&#x2F;makefiles&#x2F;gcc.make</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># <span class="function">Compiler warnings are treated as errors</span></span><br><span class="line"><span class="function"><span class="title">ifneq</span> <span class="params">($(COMPILER_WARNINGS_FATAL),<span class="literal">false</span>)</span></span></span><br><span class="line"><span class="function">  WARNINGS_ARE_ERRORS </span>= -Werror</span><br><span class="line">endif</span><br></pre></td></tr></table></figure>

<p>这一段也要干掉，否则在后续编译中可能会出现<code>clang: error: unknown argument: &#39;-fpch-deps&#39;</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ifeq ($(USE_CLANG),)</span><br><span class="line">  ifneq ($(CC_VER_MAJOR), <span class="number">2</span>)</span><br><span class="line">    DEPFLAGS += -fpch-deps</span><br><span class="line">  endif</span><br><span class="line">endif</span><br></pre></td></tr></table></figure>

<h5 id="问题六：invalid-argument-‘-std-gnu-98’-not-allowed-with-‘C’"><a href="#问题六：invalid-argument-‘-std-gnu-98’-not-allowed-with-‘C’" class="headerlink" title="问题六：invalid argument ‘-std&#x3D;gnu++98’ not allowed with ‘C’"></a>问题六：invalid argument ‘-std&#x3D;gnu++98’ not allowed with ‘C’</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Making signal interposition lib...</span><br><span class="line">error: invalid argument &#x27;-std=gnu++98&#x27; not allowed with &#x27;C&#x27;</span><br><span class="line">make[6]: *** [libjsig.dylib] Error 1</span><br></pre></td></tr></table></figure>

<p>解决方案</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> test <span class="string">&quot;x$TOOLCHAIN_TYPE&quot;</span> = xsolstudio; then</span><br><span class="line">    <span class="keyword">if</span> test <span class="string">&quot;x$OPENJDK_TARGET_CPU_ARCH&quot;</span> = <span class="string">&quot;xsparc&quot;</span>; then</span><br><span class="line">      CFLAGS_JDKLIB_EXTRA=<span class="string">&quot;$&#123;CFLAGS_JDKLIB_EXTRA&#125; -xregs=no%appl&quot;</span></span><br><span class="line">      CXXFLAGS_JDKLIB_EXTRA=<span class="string">&quot;$&#123;CXXFLAGS_JDKLIB_EXTRA&#125; -xregs=no%appl&quot;</span></span><br><span class="line">    fi</span><br><span class="line">  elif test <span class="string">&quot;x$TOOLCHAIN_TYPE&quot;</span> = xxlc; then</span><br><span class="line">    LDFLAGS_JDK=<span class="string">&quot;$&#123;LDFLAGS_JDK&#125; -q64 -brtl -bnolibpath -liconv -bexpall&quot;</span></span><br><span class="line">    CFLAGS_JDK=<span class="string">&quot;$&#123;CFLAGS_JDK&#125; -qchars=signed -q64 -qfullpath -qsaveopt&quot;</span></span><br><span class="line">    CXXFLAGS_JDK=<span class="string">&quot;$&#123;CXXFLAGS_JDK&#125; -qchars=signed -q64 -qfullpath -qsaveopt&quot;</span></span><br><span class="line">  elif test <span class="string">&quot;x$TOOLCHAIN_TYPE&quot;</span> = xgcc; then</span><br><span class="line">    LEGACY_EXTRA_CFLAGS=<span class="string">&quot;$LEGACY_EXTRA_CFLAGS -fstack-protector&quot;</span></span><br><span class="line">    LEGACY_EXTRA_CXXFLAGS=<span class="string">&quot;$LEGACY_EXTRA_CXXFLAGS -fstack-protector&quot;</span></span><br><span class="line">    <span class="keyword">if</span> test <span class="string">&quot;x$OPENJDK_TARGET_OS&quot;</span> != xmacosx; then</span><br><span class="line">      LDFLAGS_JDK=<span class="string">&quot;$LDFLAGS_JDK -Wl,-z,relro&quot;</span></span><br><span class="line">      LEGACY_EXTRA_LDFLAGS=<span class="string">&quot;$LEGACY_EXTRA_LDFLAGS -Wl,-z,relro&quot;</span></span><br><span class="line">    fi</span><br><span class="line">#    CXXSTD_CXXFLAG=<span class="string">&quot;-std=gnu++98&quot;</span> # 注释掉这行</span><br></pre></td></tr></table></figure>

<h4 id="参考地址"><a href="#参考地址" class="headerlink" title="参考地址"></a>参考地址</h4><ul>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/50220757">https://zhuanlan.zhihu.com/p/50220757</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/d9a1e1072f37">https://www.jianshu.com/p/d9a1e1072f37</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/zhengshuangxi/p/11063938.html">https://www.cnblogs.com/zhengshuangxi/p/11063938.html</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.im/entry/5a6c36af6fb9a01cb64f05b8">https://juejin.im/entry/5a6c36af6fb9a01cb64f05b8</a></li>
<li><a target="_blank" rel="noopener" href="https://www.zhoujunwen.com/2019/building-openjdk-8-on-mac-osx-catalina-10-15">https://www.zhoujunwen.com/2019/building-openjdk-8-on-mac-osx-catalina-10-15</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/micrari/p/7018474.html">https://www.cnblogs.com/micrari/p/7018474.html</a></li>
<li><a target="_blank" rel="noopener" href="https://rqsir.github.io/2019/04/19/openjdk-8-%E4%BD%BF%E7%94%A8Clion%E8%B0%83%E8%AF%95%E6%BA%90%E7%A0%81/">https://rqsir.github.io/2019/04/19/openjdk-8-使用Clion调试源码/</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="上一页" aria-label="上一页" href="/page/3/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/15/">15</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/page/5/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Vernon</span>
  </div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
    <a target="_blank" href="https://beian.miit.gov.cn">粤ICP备2025433887号</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
