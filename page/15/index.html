<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"www.cyblogs.com","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.23.1","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js" defer></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="简栈文化">
<meta property="og:url" content="http://www.cyblogs.com/page/15/index.html">
<meta property="og:site_name" content="简栈文化">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Vernon">
<meta property="article:tag" content="Java">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://www.cyblogs.com/page/15/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/15/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>简栈文化</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  






  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="简栈文化" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">简栈文化</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">Java技术人的成长之路~</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Vernon"
      src="/images/vernonchen.jpg">
  <p class="site-author-name" itemprop="name">Vernon</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">149</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">66</span>
        <span class="site-state-item-name">分类</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">87</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/chengcheng222e" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;chengcheng222e" rel="noopener me" target="_blank"><i class="github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:chengcheng222e@gmail.com" title="E-Mail → mailto:chengcheng222e@gmail.com" rel="noopener me" target="_blank"><i class="envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.cyblogs.com/2019/10/26/2019/10/CentOS7%E7%B3%BB%E7%BB%9F%E4%B8%8AKubernetes%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/vernonchen.jpg">
      <meta itemprop="name" content="Vernon">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简栈文化">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | 简栈文化">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/10/26/2019/10/CentOS7%E7%B3%BB%E7%BB%9F%E4%B8%8AKubernetes%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/" class="post-title-link" itemprop="url">CentOS7系统上Kubernetes集群搭建</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-10-26 00:00:00" itemprop="dateCreated datePublished" datetime="2019-10-26T00:00:00+08:00">2019-10-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-06-25 09:57:28" itemprop="dateModified" datetime="2025-06-25T09:57:28+08:00">2025-06-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Kubernetes/" itemprop="url" rel="index"><span itemprop="name">Kubernetes</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="虚拟机创建"><a href="#虚拟机创建" class="headerlink" title="虚拟机创建"></a>虚拟机创建</h4><p>在自己的Mac系统里面利用<code>Parallels Desktop</code>创建3台虚拟机，具体信息如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">CentOS7-Node1:</span><br><span class="line">  10.211.55.7 </span><br><span class="line">  parallels/centos-test</span><br><span class="line"></span><br><span class="line">CentOS7-Node2:</span><br><span class="line">  10.211.55.8</span><br><span class="line">  parallels/centos-test</span><br><span class="line"></span><br><span class="line">CentOS7-Node3:</span><br><span class="line">  10.211.55.9</span><br><span class="line">  parallels/centos-test</span><br></pre></td></tr></table></figure>

<h4 id="Master安装"><a href="#Master安装" class="headerlink" title="Master安装"></a>Master安装</h4><p>选择<code>CentOS7-Node1</code>机器作为Master节点。</p>
<h5 id="配置yum"><a href="#配置yum" class="headerlink" title="配置yum"></a>配置yum</h5><p>更新yum源：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[parallels@CentOS7-Node1 yum.repos.d]$ cd /etc/yum.repos.d</span><br><span class="line">[parallels@CentOS7-Node1 yum.repos.d]$ sudo touch kubernetes.repo</span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line">repo_gpgcheck=0</span><br></pre></td></tr></table></figure>

<h5 id="安装Kubernetes环境"><a href="#安装Kubernetes环境" class="headerlink" title="安装Kubernetes环境"></a>安装Kubernetes环境</h5><p>评估下来，利用kubeadm来搭建是大家比较推荐的，而且公司的集群也是。所以毫不忧虑就用kubeadm。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[parallels@CentOS7-Node1 yum.repos.d]$ yum install -y kubelet kubeadm kubectl --disableexcludes=kubernetes</span><br><span class="line">Loaded plugins: fastestmirror, langpacks</span><br><span class="line">You need to be root to perform this command.</span><br><span class="line">[parallels@CentOS7-Node1 yum.repos.d]$ sudo yum install -y kubelet kubeadm kubectl --disableexcludes=kubernetes</span><br><span class="line">Loaded plugins: fastestmirror, langpacks</span><br><span class="line">Loading mirror speeds from cached hostfile</span><br><span class="line"> * base: mirrors.aliyun.com</span><br><span class="line"> * extras: mirrors.aliyun.com</span><br><span class="line"> * updates: mirrors.aliyun.com</span><br><span class="line">kubernetes                                                                                                                                                         | 1.4 kB  00:00:00     </span><br><span class="line">kubernetes/primary                                                                                                                                                 |  58 kB  00:00:00     </span><br><span class="line">kubernetes                                                                                                                                                                        421/421</span><br><span class="line">Resolving Dependencies</span><br><span class="line"><span class="meta prompt_">--&gt; </span><span class="language-bash">Running transaction check</span></span><br><span class="line">...... # 省略一堆无意义的日志</span><br><span class="line">Dependency Installed:</span><br><span class="line">  conntrack-tools.x86_64 0:1.4.4-5.el7_7.2             cri-tools.x86_64 0:1.13.0-0                    kubernetes-cni.x86_64 0:0.7.5-0      libnetfilter_cthelper.x86_64 0:1.0.0-10.el7_7.1     </span><br><span class="line">  libnetfilter_cttimeout.x86_64 0:1.0.0-6.el7_7.1      libnetfilter_queue.x86_64 0:1.0.2-2.el7_2      socat.x86_64 0:1.7.3.2-2.el7        </span><br><span class="line"></span><br><span class="line">Complete!</span><br></pre></td></tr></table></figure>

<h5 id="关于yum的配置与升级"><a href="#关于yum的配置与升级" class="headerlink" title="关于yum的配置与升级"></a>关于yum的配置与升级</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install -y yum-utils device-mapper-persistent-data lvm2</span><br><span class="line">yum update</span><br></pre></td></tr></table></figure>

<h5 id="启动docker"><a href="#启动docker" class="headerlink" title="启动docker"></a>启动docker</h5><p>启动Docker，加入开启机动项：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[parallels@CentOS7-Node1 ~]$ sudo systemctl enable docker &amp;&amp; systemctl start docker</span><br><span class="line">[sudo] password for parallels: </span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/docker.service to /usr/lib/systemd/system/docker.service.</span><br></pre></td></tr></table></figure>

<h5 id="启动kubelet"><a href="#启动kubelet" class="headerlink" title="启动kubelet"></a>启动kubelet</h5><p>启动kubelet，加入开机启动项：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl enable kubelet &amp;&amp; systemctl start kubelet</span><br><span class="line">[parallels@CentOS7-Node1 ~]$ sudo systemctl enable kubelet &amp;&amp; systemctl start kubelet</span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/kubelet.service to /usr/lib/systemd/system/kubelet.service.</span><br><span class="line">==== AUTHENTICATING FOR org.freedesktop.systemd1.manage-units ===</span><br><span class="line">Authentication is required to manage system services or units.</span><br><span class="line">Authenticating as: Parallels (parallels)</span><br><span class="line">Password: </span><br><span class="line">==== AUTHENTICATION COMPLETE ===</span><br></pre></td></tr></table></figure>

<p>kubeadm config</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">[parallels@CentOS7-Node1 Workspace]$ kubeadm config print init-defaults</span><br><span class="line">apiVersion: kubeadm.k8s.io/v1beta2</span><br><span class="line">bootstrapTokens:</span><br><span class="line">- groups:</span><br><span class="line">  - system:bootstrappers:kubeadm:default-node-token</span><br><span class="line">  token: abcdef.0123456789abcdef</span><br><span class="line">  ttl: 24h0m0s</span><br><span class="line">  usages:</span><br><span class="line">  - signing</span><br><span class="line">  - authentication</span><br><span class="line">kind: InitConfiguration</span><br><span class="line">localAPIEndpoint:</span><br><span class="line">  advertiseAddress: 1.2.3.4</span><br><span class="line">  bindPort: 6443</span><br><span class="line">nodeRegistration:</span><br><span class="line">  criSocket: /var/run/dockershim.sock</span><br><span class="line">  name: centos7-node1</span><br><span class="line">  taints:</span><br><span class="line">  - effect: NoSchedule</span><br><span class="line">    key: node-role.kubernetes.io/master</span><br><span class="line">---</span><br><span class="line">apiServer:</span><br><span class="line">  timeoutForControlPlane: 4m0s</span><br><span class="line">apiVersion: kubeadm.k8s.io/v1beta2</span><br><span class="line">certificatesDir: /etc/kubernetes/pki</span><br><span class="line">clusterName: kubernetes</span><br><span class="line">controllerManager: &#123;&#125;</span><br><span class="line">dns:</span><br><span class="line">  type: CoreDNS</span><br><span class="line">etcd:</span><br><span class="line">  local:</span><br><span class="line">    dataDir: /var/lib/etcd</span><br><span class="line">imageRepository: k8s.gcr.io</span><br><span class="line">kind: ClusterConfiguration</span><br><span class="line">kubernetesVersion: v1.16.0</span><br><span class="line">networking:</span><br><span class="line">  dnsDomain: cluster.local</span><br><span class="line">  serviceSubnet: 10.96.0.0/12</span><br><span class="line">scheduler: &#123;&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm config print init-defaults &gt; /home/parallels/Workspace/init.default.yaml</span><br></pre></td></tr></table></figure>

<h4 id="配置Docker"><a href="#配置Docker" class="headerlink" title="配置Docker"></a>配置Docker</h4><p>首先要安装好Docker环境，请参考之前的 <a href="http://www.cyblogs.com/centos7shang-an-zhuang-docker/">http://www.cyblogs.com/centos7shang-an-zhuang-docker/</a></p>
<p>Docker的一些相关命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">yum install docker-ce-18.09.9-3.el7 # 指定版本为18.09.9-3.el7</span><br><span class="line"></span><br><span class="line">systemctl status docker</span><br><span class="line">systemctl restart docker</span><br><span class="line">systemctl daemon-reload</span><br></pre></td></tr></table></figure>
<h4 id="下载kubernetes的相关镜像"><a href="#下载kubernetes的相关镜像" class="headerlink" title="下载kubernetes的相关镜像"></a>下载kubernetes的相关镜像</h4><p>配置镜像地址，但没什么用。后面还是需要用到国内的镜像：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo &#x27;&#123;&quot;registry-mirrors&quot;:[&quot;https://docker.mirrors.ustc.edu.cn&quot;]&#125;&#x27; &gt; /etc/docker/daemon.json</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果提示没有权限，就手动vim添加进去。然后重启docker服务</span></span><br></pre></td></tr></table></figure>

<p>查看一下kubernetes依赖的镜像名称以及版本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[parallels@CentOS7-Node1 Workspace]$ kubeadm config images list</span><br><span class="line">W1022 13:51:12.550171   19704 version.go:101] could not fetch a Kubernetes version from the internet: unable to get URL &quot;https://dl.k8s.io/release/stable-1.txt&quot;: Get https://dl.k8s.io/release/stable-1.txt: net/http: request canceled while waiting for connection (Client.Timeout exceeded while awaiting headers)</span><br><span class="line">W1022 13:51:12.550458   19704 version.go:102] falling back to the local client version: v1.16.2</span><br><span class="line">k8s.gcr.io/kube-apiserver:v1.16.2</span><br><span class="line">k8s.gcr.io/kube-controller-manager:v1.16.2</span><br><span class="line">k8s.gcr.io/kube-scheduler:v1.16.2</span><br><span class="line">k8s.gcr.io/kube-proxy:v1.16.2</span><br><span class="line">k8s.gcr.io/pause:3.1</span><br><span class="line">k8s.gcr.io/etcd:3.3.15-0</span><br><span class="line">k8s.gcr.io/coredns:1.6.2</span><br></pre></td></tr></table></figure>

<p>如果网络OK，应该直接执行这个命令即可，但实际会报错误。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[parallels@CentOS7-Node1 Workspace]$ sudo kubeadm config images pull --config=/home/parallels/Workspace/init.default.yaml</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这里由于网络拉取镜像的问题，基本无法操作，只能先去aliyun获取回来后再修改tag的方式,错误如下。</span></span><br><span class="line">[parallels@CentOS7-Node1 Workspace]$ sudo kubeadm config images pull --config=/home/parallels/Workspace/init.default.yaml</span><br><span class="line">[sudo] password for parallels: </span><br><span class="line">failed to pull image &quot;k8s.gcr.io/kube-apiserver:v1.16.0&quot;: output: Error response from daemon: Get https://k8s.gcr.io/v2/: net/http: request canceled while waiting for connection (Client.Timeout exceeded while awaiting headers)</span><br><span class="line">, error: exit status 1</span><br><span class="line">To see the stack trace of this error execute with --v=5 or higher</span><br></pre></td></tr></table></figure>
<h5 id="获取镜像"><a href="#获取镜像" class="headerlink" title="获取镜像"></a>获取镜像</h5><p>通过另外一种方式来获取镜像：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">touch kubeadm.sh</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">KUBE_VERSION=v1.16.0</span><br><span class="line">KUBE_PAUSE_VERSION=3.1</span><br><span class="line">ETCD_VERSION=3.3.15-0</span><br><span class="line">CORE_DNS_VERSION=1.6.2</span><br><span class="line"></span><br><span class="line">GCR_URL=k8s.gcr.io</span><br><span class="line">ALIYUN_URL=registry.cn-hangzhou.aliyuncs.com/google_containers</span><br><span class="line"></span><br><span class="line">images=(</span><br><span class="line">	kube-apiserver:$&#123;KUBE_VERSION&#125;</span><br><span class="line">	kube-controller-manager:$&#123;KUBE_VERSION&#125;</span><br><span class="line">	kube-scheduler:$&#123;KUBE_VERSION&#125;</span><br><span class="line">	kube-proxy:$&#123;KUBE_VERSION&#125;</span><br><span class="line">	pause:$&#123;KUBE_PAUSE_VERSION&#125;</span><br><span class="line">	etcd:$&#123;ETCD_VERSION&#125;</span><br><span class="line">	coredns:$&#123;CORE_DNS_VERSION&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">for imageName in $&#123;images[@]&#125; ; do</span><br><span class="line">  docker pull $ALIYUN_URL/$imageName</span><br><span class="line">  docker tag  $ALIYUN_URL/$imageName $GCR_URL/$imageName</span><br><span class="line">  docker rmi  $ALIYUN_URL/$imageName</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<p>拉取镜像</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chmod u+x kubeadm.sh # 添加权限</span><br><span class="line">sudo ./kubeadm.sh</span><br></pre></td></tr></table></figure>

<p>剩下的就是耐心等待……</p>
<p>查看最终本地的镜像</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS7-Node1 Workspace]# docker images</span><br><span class="line">REPOSITORY                           TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">k8s.gcr.io/kube-apiserver            v1.16.0             b305571ca60a        4 weeks ago         217MB</span><br><span class="line">k8s.gcr.io/kube-proxy                v1.16.0             c21b0c7400f9        4 weeks ago         86.1MB</span><br><span class="line">k8s.gcr.io/kube-controller-manager   v1.16.0             06a629a7e51c        4 weeks ago         163MB</span><br><span class="line">k8s.gcr.io/kube-scheduler            v1.16.0             301ddc62b80b        4 weeks ago         87.3MB</span><br><span class="line">k8s.gcr.io/etcd                      3.3.15-0            b2756210eeab        6 weeks ago         247MB</span><br><span class="line">k8s.gcr.io/coredns                   1.6.2               bf261d157914        2 months ago        44.1MB</span><br><span class="line">k8s.gcr.io/pause                     3.1                 da86e6ba6ca1        22 months ago       742kB</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[parallels@CentOS7-Node1 Workspace]$ sudo kubeadm init --config=init.default.yaml </span><br><span class="line">[init] Using Kubernetes version: v1.16.0</span><br><span class="line">[preflight] Running pre-flight checks</span><br><span class="line">        [WARNING Firewalld]: firewalld is active, please ensure ports [6443 10250] are open or your cluster may not function correctly</span><br><span class="line">        [WARNING IsDockerSystemdCheck]: detected &quot;cgroupfs&quot; as the Docker cgroup driver. The recommended driver is &quot;systemd&quot;. Please follow the guide at https://kubernetes.io/docs/setup/cri/</span><br><span class="line">        [WARNING SystemVerification]: this Docker version is not on the list of validated versions: 19.03.4. Latest validated version: 18.09</span><br><span class="line">error execution phase preflight: [preflight] Some fatal errors occurred:</span><br><span class="line">        [ERROR Swap]: running with swap on is not supported. Please disable swap</span><br><span class="line">[preflight] If you know what you are doing, you can make a check non-fatal with `--ignore-preflight-errors=...`</span><br><span class="line">To see the stack trace of this error execute with --v=5 or higher</span><br></pre></td></tr></table></figure>
<h5 id="关闭防火墙"><a href="#关闭防火墙" class="headerlink" title="关闭防火墙"></a>关闭防火墙</h5><p>解决掉防火墙的问题，请参阅：<a href="http://www.cyblogs.com/centos7cha-kan-he-guan-bi-fang-huo-qiang/">http://www.cyblogs.com/centos7cha-kan-he-guan-bi-fang-huo-qiang/</a> </p>
<h5 id="cgroupfs错误"><a href="#cgroupfs错误" class="headerlink" title="cgroupfs错误"></a>cgroupfs错误</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">detected &quot;cgroupfs&quot; as the Docker cgroup driver</span><br></pre></td></tr></table></figure>

<p>新增：&#x2F;etc&#x2F;docker&#x2F;daemon.json</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;registry-mirrors&quot;: [</span><br><span class="line">    &quot;https://registry.docker-cn.com&quot;</span><br><span class="line">  ],</span><br><span class="line">  &quot;live-restore&quot;: true,</span><br><span class="line">  &quot;exec-opts&quot;: [</span><br><span class="line">    &quot;native.cgroupdriver=systemd&quot; # 修改用户</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重新启动Docker</span></span><br><span class="line">systemctl restart docker</span><br><span class="line">systemctl status docker</span><br></pre></td></tr></table></figure>

<h5 id="禁止swap"><a href="#禁止swap" class="headerlink" title="禁止swap"></a>禁止swap</h5><p>还是发现需要禁止掉<code>swap</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Oct 22 16:35:36 CentOS7-Node1 kubelet[1395]: F1022 16:35:36.065168    1395 server.go:271] failed to run Kubelet: running with swap on is not supported, please disable swap! or set --fail-swap-on flag to false. /proc/swaps contained: [Filename                                Type                Size        Used        Priority /dev/dm-1                               partition        2097148        29952        -1]</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">swapoff -a</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">要永久禁掉swap分区，打开如下文件注释掉swap那一行</span></span><br><span class="line">sudo vi /etc/fstab</span><br></pre></td></tr></table></figure>


<p>再次启动<code>kubeadm init</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">kubeadm init --config=init.default.yaml</span><br><span class="line"></span><br><span class="line">[init] Using Kubernetes version: v1.16.2</span><br><span class="line">...</span><br><span class="line">[preflight] Pulling images required for setting up a Kubernetes cluster</span><br><span class="line">...</span><br><span class="line">[kubelet-start] Writing kubelet environment file with flags to file &quot;/var/lib/kubelet/kubeadm-flags.env&quot;</span><br><span class="line">...</span><br><span class="line">[certs] Using certificateDir folder &quot;/etc/kubernetes/pki&quot;</span><br><span class="line">...</span><br><span class="line">[kubeconfig] Using kubeconfig folder &quot;/etc/kubernetes&quot;</span><br><span class="line">...</span><br><span class="line">[kubelet-check] Initial timeout of 40s passed.</span><br><span class="line">[kubelet-check] It seems like the kubelet isn&#x27;t running or healthy.</span><br><span class="line">[kubelet-check] The HTTP call equal to &#x27;curl -sSL http://localhost:10248/healthz&#x27; failed with error: Get http://localhost:10248/healthz: dial tcp [::1]:10248: connect: connection refused.</span><br><span class="line">[kubelet-check] It seems like the kubelet isn&#x27;t running or healthy.</span><br><span class="line">[kubelet-check] The HTTP call equal to &#x27;curl -sSL http://localhost:10248/healthz&#x27; failed with error: Get http://localhost:10248/healthz: dial tcp [::1]:10248: connect: connection refused.</span><br><span class="line">[kubelet-check] It seems like the kubelet isn&#x27;t running or healthy.</span><br><span class="line">[kubelet-check] The HTTP call equal to &#x27;curl -sSL http://localhost:10248/healthz&#x27; failed with error: Get http://localhost:10248/healthz: dial tcp [::1]:10248: connect: connection refused.</span><br><span class="line">[kubelet-check] It seems like the kubelet isn&#x27;t running or healthy.</span><br><span class="line">[kubelet-check] The HTTP call equal to &#x27;curl -sSL http://localhost:10248/healthz&#x27; failed with error: Get http://localhost:10248/healthz: dial tcp [::1]:10248: connect: connection refused.</span><br><span class="line">[kubelet-check] It seems like the kubelet isn&#x27;t running or healthy.</span><br><span class="line">[kubelet-check] The HTTP call equal to &#x27;curl -sSL http://localhost:10248/healthz&#x27; failed with error: Get http://localhost:10248/healthz: dial tcp [::1]:10248: connect: connection refused.</span><br></pre></td></tr></table></figure>
<p>出现错误了,变更Docker的版本后，继续执行，还是会报错误。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[ERROR FileAvailable--etc-kubernetes-manifests-kube-apiserver.yaml]: /etc/kubernetes/manifests/kube-apiserver.yaml already exists</span><br><span class="line">       [ERROR FileAvailable--etc-kubernetes-manifests-kube-controller-manager.yaml]: /etc/kubernetes/manifests/kube-controller-manager.yaml already exists</span><br></pre></td></tr></table></figure>
<h5 id="重设kubeadm"><a href="#重设kubeadm" class="headerlink" title="重设kubeadm"></a>重设kubeadm</h5><p>这里需要重设<code>kubeadm</code>了。具体操作如下:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubeadm reset</span><br><span class="line">echo &#x27;1&#x27; &gt; /proc/sys/net/bridge/bridge-nf-call-iptables </span><br><span class="line">echo &#x27;1&#x27; &gt; /proc/sys/net/ipv4/ip_forward</span><br></pre></td></tr></table></figure>
<h5 id="journalctl查看日志"><a href="#journalctl查看日志" class="headerlink" title="journalctl查看日志"></a>journalctl查看日志</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">journalctl -xefu kubelet</span><br></pre></td></tr></table></figure>
<p>这里还是会报错，因为之前的</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: kubeadm.k8s.io/v1beta2</span><br><span class="line">kind: ClusterConfiguration</span><br><span class="line">imageRepository: k8s.gcr.io</span><br><span class="line">kubernetesVersion: v1.16.0</span><br><span class="line">networking:</span><br><span class="line">  dnsDomain: cluster.local</span><br><span class="line">  serviceSubnet: &quot;10.96.0.0/16&quot;</span><br></pre></td></tr></table></figure>
<p>继续执行init的过程，<code>kubeadm init --config=/home/parallels/Workspace/init.default.yaml</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[addons] Applied essential addon: CoreDNS</span><br><span class="line">[addons] Applied essential addon: kube-proxy</span><br><span class="line"></span><br><span class="line">Your Kubernetes control-plane has initialized successfully!</span><br><span class="line"></span><br><span class="line">To start using your cluster, you need to run the following as a regular user:</span><br><span class="line"></span><br><span class="line">  mkdir -p $HOME/.kube</span><br><span class="line">  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">  sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br><span class="line">  You should now deploy a pod network to the cluster.</span><br><span class="line">Run &quot;kubectl apply -f [podnetwork].yaml&quot; with one of the options listed at:</span><br><span class="line">  https://kubernetes.io/docs/concepts/cluster-administration/addons/</span><br><span class="line"></span><br><span class="line">Then you can join any number of worker nodes by running the following on each as root:</span><br><span class="line"></span><br><span class="line">kubeadm join 10.211.55.7:6443 --token imwj34.ksfiwzj5ga80du0r \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:7ffef85880ed43dd539afa045715f9ad5bef15e904cede96213d6cfd4adb0795 </span><br></pre></td></tr></table></figure>
<p>真心不容易，这里一直反反复复执行。只要是<code>images</code>的版本问题以及<code>init</code>的过程容易出错。</p>
<h5 id="验证configmap"><a href="#验证configmap" class="headerlink" title="验证configmap"></a>验证configmap</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS7-Node1 ~]# kubectl get -n kube-system configmap   </span><br><span class="line">NAME                                 DATA   AGE</span><br><span class="line">coredns                              1      5m49s</span><br><span class="line">extension-apiserver-authentication   6      5m53s</span><br><span class="line">kube-proxy                           2      5m49s</span><br><span class="line">kubeadm-config                       2      5m50s</span><br><span class="line">kubelet-config-1.16                  1      5m50s</span><br></pre></td></tr></table></figure>
<h4 id="安装Node，加入集群"><a href="#安装Node，加入集群" class="headerlink" title="安装Node，加入集群"></a>安装Node，加入集群</h4><p>安装跟Master一直的基本环境，包括docker，kubelet，kubeadm等，重复上面的动作。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">scp root@10.211.55.7:/home/parallels/Workspace/init.default.yaml .</span><br><span class="line">scp root@10.211.55.7:/home/parallels/Workspace/kubeadm.sh .</span><br><span class="line">yum install docker-ce-18.06.3.ce-3.el7</span><br></pre></td></tr></table></figure>
<p>为<code>kubeadm</code>命令生成配置文件，创建<code>join-config.yaml</code>，内容如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: kubeadm.k8s.io/v1beta2</span><br><span class="line">kind: JoinConfiguration</span><br><span class="line">discovery:</span><br><span class="line">  bootstrapToken:</span><br><span class="line">    apiServerEndpoint: 10.211.55.7:6443</span><br><span class="line">    token: imwj34.ksfiwzj5ga80du0r</span><br><span class="line">    unsafeSkipCAVerification: true</span><br><span class="line">  tlsBootstrapToken: imwj34.ksfiwzj5ga80du0r</span><br></pre></td></tr></table></figure>
<p>其中，apiServerEndpoint的值来自于Master的服务器地址，这里就是<code>10.211.55.7</code>。<code>token</code>和<code>tlsBootstrapToken</code>的值就来自于<code>kubeadm init</code>安装<code>Master</code>的最后一行提示信息。这里一定要注意yaml文件的格式，否则执行会报错误。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS7-Node2 Workspace]# kubeadm join  --config=join-config.yaml</span><br><span class="line">[preflight] Running pre-flight checks</span><br><span class="line">error execution phase preflight: [preflight] Some fatal errors occurred:</span><br><span class="line">        [ERROR Swap]: running with swap on is not supported. Please disable swap</span><br><span class="line">[preflight] If you know what you are doing, you can make a check non-fatal with `--ignore-preflight-errors=...`</span><br><span class="line">To see the stack trace of this error execute with --v=5 or higher</span><br><span class="line">[root@CentOS7-Node2 Workspace]# swapoff -a</span><br><span class="line">[root@CentOS7-Node2 Workspace]# kubeadm join  --config=join-config.yaml</span><br><span class="line">[preflight] Running pre-flight checks</span><br><span class="line">[preflight] Reading configuration from the cluster...</span><br><span class="line">[preflight] FYI: You can look at this config file with &#x27;kubectl -n kube-system get cm kubeadm-config -oyaml&#x27;</span><br><span class="line">[kubelet-start] Downloading configuration for the kubelet from the &quot;kubelet-config-1.16&quot; ConfigMap in the kube-system namespace</span><br><span class="line">[kubelet-start] Writing kubelet configuration to file &quot;/var/lib/kubelet/config.yaml&quot;</span><br><span class="line">[kubelet-start] Writing kubelet environment file with flags to file &quot;/var/lib/kubelet/kubeadm-flags.env&quot;</span><br><span class="line">[kubelet-start] Activating the kubelet service</span><br><span class="line">[kubelet-start] Waiting for the kubelet to perform the TLS Bootstrap...</span><br><span class="line"></span><br><span class="line">This node has joined the cluster:</span><br><span class="line">* Certificate signing request was sent to apiserver and a response was received.</span><br><span class="line">* The Kubelet was informed of the new secure connection details.</span><br><span class="line"></span><br><span class="line">Run &#x27;kubectl get nodes&#x27; on the control-plane to see this node join the cluster.</span><br></pre></td></tr></table></figure>
<h5 id="安装网络插件"><a href="#安装网络插件" class="headerlink" title="安装网络插件"></a>安装网络插件</h5><p>去Master机器，执行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS7-Node1 Workspace]# kubectl get nodes</span><br><span class="line">NAME            STATUS     ROLES    AGE     VERSION</span><br><span class="line">centos7-node1   NotReady   master   154m    v1.16.2</span><br><span class="line">centos7-node2   NotReady   &lt;none&gt;   2m49s   v1.16.2</span><br></pre></td></tr></table></figure>
<p>这里显示的是<code>NotReady</code>状态，是因为还没有安装<code>CNI</code>网络插件。我们选择<code>weave</code>插件来安装。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS7-Node1 Workspace]# kubectl apply -f &quot;https://cloud.weave.works/k8s/net?k8s-version=$(kubectl version | base64 | tr -d &#x27;\n&#x27;)&quot;</span><br><span class="line">serviceaccount/weave-net created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/weave-net created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/weave-net created</span><br><span class="line">role.rbac.authorization.k8s.io/weave-net created</span><br><span class="line">rolebinding.rbac.authorization.k8s.io/weave-net created</span><br><span class="line">daemonset.apps/weave-net created</span><br></pre></td></tr></table></figure>

<h4 id="验证集群是否安装完成"><a href="#验证集群是否安装完成" class="headerlink" title="验证集群是否安装完成"></a>验证集群是否安装完成</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS7-Node1 Workspace]# kubectl get pods -n kube-system</span><br><span class="line">NAME                                    READY   STATUS              RESTARTS   AGE</span><br><span class="line">coredns-5644d7b6d9-9fr9p                0/1     ContainerCreating   0          172m</span><br><span class="line">coredns-5644d7b6d9-pmpkq                0/1     ContainerCreating   0          172m</span><br><span class="line">etcd-centos7-node1                      1/1     Running             0          171m</span><br><span class="line">kube-apiserver-centos7-node1            1/1     Running             0          171m</span><br><span class="line">kube-controller-manager-centos7-node1   1/1     Running             0          171m</span><br><span class="line">kube-proxy-ccnht                        1/1     Running             0          21m</span><br><span class="line">kube-proxy-rdq9l                        1/1     Running             0          172m</span><br><span class="line">kube-scheduler-centos7-node1            1/1     Running             0          171m</span><br><span class="line">weave-net-6hw26                         2/2     Running             0          8m7s</span><br><span class="line">weave-net-qv8vz                         2/2     Running             0          8m7s</span><br></pre></td></tr></table></figure>

<p>发现coredns一直处于ContainerCreating的状态。具体的看一下错误信息。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS7-Node1 Workspace]# kubectl describe pod coredns-5644d7b6d9-9fr9p -n kube-system</span><br><span class="line">Name:                 coredns-5644d7b6d9-9fr9p</span><br><span class="line">Namespace:            kube-system</span><br><span class="line">Priority:             2000000000</span><br><span class="line">Priority Class Name:  system-cluster-critical</span><br><span class="line">Node:                 centos7-node2/10.211.55.8</span><br><span class="line">Start Time:           Tue, 22 Oct 2019 20:49:47 +0800</span><br><span class="line">Labels:               k8s-app=kube-dns</span><br><span class="line">                      pod-template-hash=5644d7b6d9</span><br><span class="line">.... # 此处省略一些</span><br><span class="line">Events:</span><br><span class="line">  Type     Reason                  Age        From                    Message</span><br><span class="line">  ----     ------                  ----       ----                    -------</span><br><span class="line">  Warning  FailedScheduling        &lt;unknown&gt;  default-scheduler       0/1 nodes are available: 1 node(s) had taints that the pod didn&#x27;t tolerate.</span><br><span class="line">  Warning  FailedScheduling        &lt;unknown&gt;  default-scheduler       0/2 nodes are available: 2 node(s) had taints that the pod didn&#x27;t tolerate.</span><br><span class="line">  Normal   Scheduled               &lt;unknown&gt;  default-scheduler       Successfully assigned kube-system/coredns-5644d7b6d9-9fr9p to centos7-node2</span><br><span class="line">  Warning  FailedCreatePodSandBox  2m         kubelet, centos7-node2  Failed create pod sandbox: rpc error: code = DeadlineExceeded desc = context deadline exceeded</span><br><span class="line">  Normal   SandboxChanged          119s       kubelet, centos7-node2  Pod sandbox changed, it will be killed and re-created.</span><br></pre></td></tr></table></figure>

<p>这里可以看出一些错误：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Oct 22 10:50:15 CentOS7-Node1 kubelet[7649]: F1022 10:50:15.170550    7649 server.go:196] failed to load Kubelet config file /var/lib/kubelet/config.yaml, error failed to read kubelet config file &quot;/var/lib/kubelet/config.yaml&quot;, </span><br><span class="line">Oct 22 10:50:15 CentOS7-Node1 systemd[1]: kubelet.service: main process exited, code=exited, status=255/n/a</span><br></pre></td></tr></table></figure>

<p>可以删除掉一个pod的方式让它重新启动：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS7-Node1 ~]# kubectl delete pod coredns-5644d7b6d9-9fr9p -n kube-system</span><br><span class="line">pod &quot;coredns-5644d7b6d9-9fr9p&quot; deleted</span><br></pre></td></tr></table></figure>

<p>看了太多的文章与博客，发现没有几个写的太完全的，都是写的成功的经验，实际上中间不知道有各种奇怪问题。说句实话，k8s很方便，但是门槛很高，依赖的东西真的太多太多了。特别是版本问题导致的问题，很难解决掉。</p>
<p>最后看一下成功的图片吧</p>
<p><img src="http://static.cyblogs.com/WX20191023-164029@2x.png" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;WX20191023-164029@2x.png"></p>
<h4 id="常用命令汇总"><a href="#常用命令汇总" class="headerlink" title="常用命令汇总"></a>常用命令汇总</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line"></span><br><span class="line">systemctl restart kubelet</span><br><span class="line"></span><br><span class="line">kubectl get pods -n kube-system</span><br><span class="line"></span><br><span class="line">kubectl describe pod coredns-5644d7b6d9-lqtks -n kube-system</span><br><span class="line"></span><br><span class="line">kubectl delete pod coredns-5644d7b6d9-qh4bc -n kube-system</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">允许master节点部署pod</span></span><br><span class="line">kubectl taint nodes --all node-role.kubernetes.io/master-</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">禁止master部署pod</span></span><br><span class="line">kubectl taint nodes k8s node-role.kubernetes.io/master=true:NoSchedule</span><br><span class="line"></span><br><span class="line">kubeadm reset</span><br><span class="line"></span><br><span class="line">systemctl enable docker &amp;&amp; systemctl start docker</span><br><span class="line"></span><br><span class="line">systemctl enable kubelet &amp;&amp; systemctl start kubelet</span><br><span class="line"></span><br><span class="line">journalctl -xefu kubelet</span><br></pre></td></tr></table></figure>

<h4 id="参考地址"><a href="#参考地址" class="headerlink" title="参考地址"></a>参考地址</h4><ul>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/yufeng218/p/8370670.html">https://www.cnblogs.com/yufeng218/p/8370670.html</a></li>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/55531834/kubeadm-fails-to-initialize-when-kubeadm-init-is-called">https://stackoverflow.com/questions/55531834/kubeadm-fails-to-initialize-when-kubeadm-init-is-called</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/31398416">https://zhuanlan.zhihu.com/p/31398416</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/M82_A1/article/details/97626309">https://blog.csdn.net/M82_A1/article/details/97626309</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/liumiaocn/article/details/99608323">https://blog.csdn.net/liumiaocn/article/details/99608323</a></li>
<li><a target="_blank" rel="noopener" href="https://www.hi-linux.com/posts/54191.html">https://www.hi-linux.com/posts/54191.html</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/BigData_Mining/article/details/88683459">https://blog.csdn.net/BigData_Mining/article/details/88683459</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.cyblogs.com/2019/10/25/2019/10/CentOS7%E4%B8%8A%E5%AE%89%E8%A3%85Docker/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/vernonchen.jpg">
      <meta itemprop="name" content="Vernon">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简栈文化">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | 简栈文化">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/10/25/2019/10/CentOS7%E4%B8%8A%E5%AE%89%E8%A3%85Docker/" class="post-title-link" itemprop="url">CentOS7上安装Docker</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-10-25 00:00:00" itemprop="dateCreated datePublished" datetime="2019-10-25T00:00:00+08:00">2019-10-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-06-25 09:57:28" itemprop="dateModified" datetime="2025-06-25T09:57:28+08:00">2025-06-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Docker/" itemprop="url" rel="index"><span itemprop="name">Docker</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Docker/CentOS/" itemprop="url" rel="index"><span itemprop="name">CentOS</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="设置yum源"><a href="#设置yum源" class="headerlink" title="设置yum源"></a>设置yum源</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure>

<h4 id="让yum更新到最新"><a href="#让yum更新到最新" class="headerlink" title="让yum更新到最新"></a>让yum更新到最新</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum update</span><br></pre></td></tr></table></figure>

<h4 id="查看仓库中所有docker的版本"><a href="#查看仓库中所有docker的版本" class="headerlink" title="查看仓库中所有docker的版本"></a>查看仓库中所有docker的版本</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">[parallels@CentOS7-Node1 ~]$ yum list docker-ce --showduplicates | sort -r</span><br><span class="line"> * updates: mirrors.njupt.edu.cn</span><br><span class="line">Loaded plugins: fastestmirror, langpacks</span><br><span class="line"> * extras: mirrors.njupt.edu.cn</span><br><span class="line">docker-ce.x86_64            3:19.03.4-3.el7                     docker-ce-stable</span><br><span class="line">docker-ce.x86_64            3:19.03.3-3.el7                     docker-ce-stable</span><br><span class="line">docker-ce.x86_64            3:19.03.2-3.el7                     docker-ce-stable</span><br><span class="line">docker-ce.x86_64            3:19.03.1-3.el7                     docker-ce-stable</span><br><span class="line">docker-ce.x86_64            3:19.03.0-3.el7                     docker-ce-stable</span><br><span class="line">docker-ce.x86_64            3:18.09.9-3.el7                     docker-ce-stable</span><br><span class="line">docker-ce.x86_64            3:18.09.8-3.el7                     docker-ce-stable</span><br><span class="line">docker-ce.x86_64            3:18.09.7-3.el7                     docker-ce-stable</span><br><span class="line">docker-ce.x86_64            3:18.09.6-3.el7                     docker-ce-stable</span><br><span class="line">docker-ce.x86_64            3:18.09.5-3.el7                     docker-ce-stable</span><br><span class="line">docker-ce.x86_64            3:18.09.4-3.el7                     docker-ce-stable</span><br><span class="line">docker-ce.x86_64            3:18.09.3-3.el7                     docker-ce-stable</span><br><span class="line">docker-ce.x86_64            3:18.09.2-3.el7                     docker-ce-stable</span><br><span class="line">docker-ce.x86_64            3:18.09.1-3.el7                     docker-ce-stable</span><br><span class="line">docker-ce.x86_64            3:18.09.0-3.el7                     docker-ce-stable</span><br><span class="line">docker-ce.x86_64            18.06.3.ce-3.el7                    docker-ce-stable</span><br><span class="line">docker-ce.x86_64            18.06.2.ce-3.el7                    docker-ce-stable</span><br><span class="line">docker-ce.x86_64            18.06.1.ce-3.el7                    docker-ce-stable</span><br><span class="line">docker-ce.x86_64            18.06.0.ce-3.el7                    docker-ce-stable</span><br><span class="line">docker-ce.x86_64            18.03.1.ce-1.el7.centos             docker-ce-stable</span><br><span class="line">docker-ce.x86_64            18.03.0.ce-1.el7.centos             docker-ce-stable</span><br><span class="line">docker-ce.x86_64            17.12.1.ce-1.el7.centos             docker-ce-stable</span><br><span class="line">docker-ce.x86_64            17.12.0.ce-1.el7.centos             docker-ce-stable</span><br><span class="line">docker-ce.x86_64            17.09.1.ce-1.el7.centos             docker-ce-stable</span><br><span class="line">docker-ce.x86_64            17.09.0.ce-1.el7.centos             docker-ce-stable</span><br><span class="line">docker-ce.x86_64            17.06.2.ce-1.el7.centos             docker-ce-stable</span><br><span class="line">docker-ce.x86_64            17.06.1.ce-1.el7.centos             docker-ce-stable</span><br><span class="line">docker-ce.x86_64            17.06.0.ce-1.el7.centos             docker-ce-stable</span><br><span class="line">docker-ce.x86_64            17.03.3.ce-1.el7                    docker-ce-stable</span><br><span class="line">docker-ce.x86_64            17.03.2.ce-1.el7.centos             docker-ce-stable</span><br><span class="line">docker-ce.x86_64            17.03.1.ce-1.el7.centos             docker-ce-stable</span><br><span class="line">docker-ce.x86_64            17.03.0.ce-1.el7.centos             docker-ce-stable</span><br><span class="line">Determining fastest mirrors</span><br><span class="line"> * base: mirrors.aliyun.com</span><br><span class="line">Available Packages</span><br></pre></td></tr></table></figure>

<h4 id="安装docker"><a href="#安装docker" class="headerlink" title="安装docker"></a>安装docker</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install docker-ce #由于repo中默认只开启stable仓库</span><br><span class="line">sudo yum install &lt;FQPN&gt;  # 例如：sudo yum install docker-ce-18.09.9-3.el7</span><br></pre></td></tr></table></figure>

<h4 id="启动并加入开机启动项"><a href="#启动并加入开机启动项" class="headerlink" title="启动并加入开机启动项"></a>启动并加入开机启动项</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl start docker</span><br><span class="line">sudo systemctl enable docker</span><br></pre></td></tr></table></figure>

<h4 id="删除当前的Docker"><a href="#删除当前的Docker" class="headerlink" title="删除当前的Docker"></a>删除当前的Docker</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum remove docker docker-client docker-client-latest docker-common docker-latest docker-latest-logrotate docker-logrotate docker-selinux docker-engine-selinux docker-engine</span><br></pre></td></tr></table></figure>

<h4 id="参考地址："><a href="#参考地址：" class="headerlink" title="参考地址："></a>参考地址：</h4><ul>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/yufeng218/p/8370670.html">https://www.cnblogs.com/yufeng218/p/8370670.html</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.cyblogs.com/2019/10/24/2019/10/CentOS7%E6%9F%A5%E7%9C%8B%E5%92%8C%E5%85%B3%E9%97%AD%E9%98%B2%E7%81%AB%E5%A2%99/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/vernonchen.jpg">
      <meta itemprop="name" content="Vernon">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简栈文化">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | 简栈文化">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/10/24/2019/10/CentOS7%E6%9F%A5%E7%9C%8B%E5%92%8C%E5%85%B3%E9%97%AD%E9%98%B2%E7%81%AB%E5%A2%99/" class="post-title-link" itemprop="url">CentOS7查看和关闭防火墙</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-10-24 00:00:00" itemprop="dateCreated datePublished" datetime="2019-10-24T00:00:00+08:00">2019-10-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-06-25 09:57:28" itemprop="dateModified" datetime="2025-06-25T09:57:28+08:00">2025-06-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/CentOS/" itemprop="url" rel="index"><span itemprop="name">CentOS</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>在搭建Kubernetes环境的时候报了一个错误，顺便温习一下防火墙的知识。</p>
<h4 id="查看防火墙状态"><a href="#查看防火墙状态" class="headerlink" title="查看防火墙状态"></a>查看防火墙状态</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[parallels@CentOS7-Node1 Workspace]$ sudo firewall-cmd --state</span><br><span class="line">running</span><br></pre></td></tr></table></figure>

<h4 id="停止防火墙"><a href="#停止防火墙" class="headerlink" title="停止防火墙"></a>停止防火墙</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[parallels@CentOS7-Node1 Workspace]$ sudo systemctl stop firewalld.service </span><br><span class="line">[sudo] password for parallels: </span><br><span class="line">[parallels@CentOS7-Node1 Workspace]$ sudo firewall-cmd --state</span><br><span class="line">not running</span><br></pre></td></tr></table></figure>

<h4 id="禁止firewall开机启动"><a href="#禁止firewall开机启动" class="headerlink" title="禁止firewall开机启动"></a>禁止firewall开机启动</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl disable firewalld.service</span><br></pre></td></tr></table></figure>




      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.cyblogs.com/2019/10/15/2019/10/%E8%87%AA%E5%B7%B1%E6%90%AD%E5%BB%BAGitlab%E6%9C%8D%E5%8A%A1%E5%99%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/vernonchen.jpg">
      <meta itemprop="name" content="Vernon">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简栈文化">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | 简栈文化">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/10/15/2019/10/%E8%87%AA%E5%B7%B1%E6%90%AD%E5%BB%BAGitlab%E6%9C%8D%E5%8A%A1%E5%99%A8/" class="post-title-link" itemprop="url">自己搭建Gitlab服务器</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-10-15 00:00:00" itemprop="dateCreated datePublished" datetime="2019-10-15T00:00:00+08:00">2019-10-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-06-25 09:57:28" itemprop="dateModified" datetime="2025-06-25T09:57:28+08:00">2025-06-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Gitlab/" itemprop="url" rel="index"><span itemprop="name">Gitlab</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Gitlab/%E5%9F%BA%E7%A1%80%E6%9C%8D%E5%8A%A1/" itemprop="url" rel="index"><span itemprop="name">基础服务</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="更换yum源"><a href="#更换yum源" class="headerlink" title="更换yum源"></a>更换yum源</h3><p>为了加快速度，首先可以更换<code>yum</code>的源</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ94tq694y3Z ghost]#touch /etc/yum.repos.d/gitlab_gitlab-ce.repo</span><br></pre></td></tr></table></figure>

<p>替换内容为：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[gitlab-ce]</span><br><span class="line">name=Gitlab CE Repository</span><br><span class="line">baseurl=https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el$releasever/</span><br><span class="line">gpgcheck=0</span><br><span class="line">enabled=1</span><br></pre></td></tr></table></figure>

<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>用root用户安装：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">yum install curl openssh-server openssh-clients postfix cronie</span><br><span class="line">service postfix start</span><br><span class="line">chkconfig postfix on</span><br><span class="line"></span><br><span class="line">yum makecache</span><br><span class="line">yum install gitlab-ce</span><br><span class="line">gitlab-ctl reconfigure</span><br></pre></td></tr></table></figure>

<p>由于自己的阿里云服务器太渣渣了，所以在这里一直卡主了。看了一下阿里云的服务监控。内存已经爆满了，不得不去花钱升级了一下配置。现在是<code>1CPU</code> and <code>2GB</code>内存。</p>
<p>继续执行，还是报错了。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Running handlers:</span><br><span class="line">There was an error running gitlab-ctl reconfigure:</span><br><span class="line"></span><br><span class="line">execute[semodule -i /opt/gitlab/embedded/selinux/rhel/7/gitlab-7.2.0-ssh-keygen.pp] (gitlab::selinux line 20) had an error: Errno::ENOMEM: execute[Guard resource] (dynamically defined) had an error: Errno::ENOMEM: Cannot allocate memory - fork(2)</span><br></pre></td></tr></table></figure>

<p>查看内存</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ94tq694y3Z ghost]# free  -m</span><br><span class="line">             total       used       free     shared    buffers     cached</span><br><span class="line">Mem:          1841       1760         80         52          5         76</span><br><span class="line">-/+ buffers/cache:       1678        162</span><br><span class="line">Swap:            0          0          0</span><br></pre></td></tr></table></figure>

<p>解决<code>Cannot allocate memory - fork</code>问题。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ94tq694y3Z swapfile]# mkdir /swapfile</span><br><span class="line">[root@iZ94tq694y3Z swapfile]# cd /swapfile</span><br><span class="line">[root@iZ94tq694y3Z swapfile]# dd if=/dev/zero of=swap bs=1024 count=2000000</span><br><span class="line">2000000+0 records in</span><br><span class="line">2000000+0 records out</span><br><span class="line">2048000000 bytes (2.0 GB) copied, 12.8547 s, 159 MB/s</span><br><span class="line">[root@iZ94tq694y3Z swapfile]# mkswap -f  swap</span><br><span class="line">Setting up swapspace version 1, size = 1999996 KiB</span><br><span class="line">no label, UUID=da70ea74-4bac-484a-9c14-2c20e265c267</span><br><span class="line">[root@iZ94tq694y3Z swapfile]# swapon swap</span><br><span class="line">swapon: /swapfile/swap: insecure permissions 0644, 0600 suggested.</span><br><span class="line">[root@iZ94tq694y3Z swapfile]# free -h</span><br><span class="line">             total       used       free     shared    buffers     cached</span><br><span class="line">Mem:          1.8G       1.7G        68M        52M       1.2M        85M</span><br><span class="line">-/+ buffers/cache:       1.6G       155M</span><br><span class="line">Swap:         1.9G         0B       1.9G</span><br></pre></td></tr></table></figure>

<p>再重新执行<code>gitlab-ctl reconfigure</code>成功</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Running handlers:</span><br><span class="line">Running handlers complete</span><br><span class="line">Chef Client finished, 35/743 resources updated in 01 minutes 31 seconds</span><br><span class="line">gitlab Reconfigured!</span><br></pre></td></tr></table></figure>

<p>继续配置：<code>gitlab-rails console production</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ94tq694y3Z swapfile]# gitlab-rails console production</span><br><span class="line">DEPRECATION WARNING: Passing the environment&#x27;s name as a regular argument is deprecated and will be removed in the next Rails version. Please, use the -e option instead. (called from require at bin/rails:4)</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line"> GitLab:       12.3.5 (2417d5becc7)</span><br><span class="line"> GitLab Shell: 10.0.0</span><br><span class="line"> PostgreSQL:   10.9</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">Loading production environment (Rails 5.2.3)</span><br><span class="line">irb(main):001:0&gt; </span><br><span class="line">irb(main):002:0&gt; user = User.where(id:1).first</span><br><span class="line">=&gt; #&lt;User id:1 @root&gt;</span><br><span class="line">irb(main):003:0&gt; &#x27;chg&#x27;&#x27;xxxxxx&#x27;</span><br><span class="line">=&gt; &quot;xxxxxx&quot;</span><br><span class="line">irb(main):004:0&gt; user.save!</span><br><span class="line">Enqueued ActionMailer::DeliveryJob (Job ID: c9f8831f-25c1-429c-bc3a-073a2a1e5fb8) to Sidekiq(mailers) with arguments: &quot;DeviseMailer&quot;, &quot;password_change&quot;, &quot;deliver_now&quot;, #&lt;GlobalID:0x00007fa89b887368 @uri=#&lt;URI::GID gid://gitlab/User/1&gt;&gt;</span><br><span class="line">=&gt; true</span><br><span class="line">irb(main):005:0&gt; </span><br></pre></td></tr></table></figure>

<h3 id="配置域名"><a href="#配置域名" class="headerlink" title="配置域名"></a>配置域名</h3><p>所有gitlab的配置都在<code>/etc/gitlab/gitlab.rb</code>了里面。我这里只修改了其中的几项：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">web_server[&#x27;external_users&#x27;] = [&#x27;root&#x27;] #支持的用户</span><br><span class="line"></span><br><span class="line">nginx[&#x27;enable&#x27;] = false # 不用自带的nginx，用自己安装的</span><br><span class="line"></span><br><span class="line">external_url &#x27;https://gitlab.cyblogs.com&#x27; # 配置域名</span><br><span class="line"></span><br><span class="line">unicorn[&#x27;port&#x27;] = 8081 # 服务端口号</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置邮箱</span></span><br><span class="line">gitlab_rails[&#x27;smtp_enable&#x27;] = true</span><br><span class="line">gitlab_rails[&#x27;smtp_address&#x27;] = &quot;smtp.sina.com&quot;</span><br><span class="line">gitlab_rails[&#x27;smtp_port&#x27;] = 465</span><br><span class="line">gitlab_rails[&#x27;smtp_user_name&#x27;] = &quot;chengcheng222e@sina.com&quot;</span><br><span class="line">gitlab_rails[&#x27;smtp_password&#x27;] = &quot;xxxxxx&quot;</span><br><span class="line">gitlab_rails[&#x27;smtp_domain&#x27;] = &quot;sina.com&quot;</span><br><span class="line">gitlab_rails[&#x27;smtp_authentication&#x27;] = &quot;plain&quot;</span><br><span class="line">gitlab_rails[&#x27;smtp_enable_starttls_auto&#x27;] = true</span><br><span class="line">gitlab_rails[&#x27;smtp_tls&#x27;] = false</span><br></pre></td></tr></table></figure>

<p>配置nginx：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="attribute">iZ94tq694y3Z</span> conf.d]<span class="comment"># cat gitlab.cyblogs.com.conf </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 这里需要通过域名解析到这里来，大家自己去搜索相关的教程</span></span><br><span class="line">upstream gitlab.cyblogs.com &#123;</span><br><span class="line">  <span class="attribute">server</span> <span class="number">127.0.0.1:8081</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span>  gitlab.cyblogs.com ;</span><br><span class="line"></span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">root</span>   html;</span><br><span class="line">        <span class="attribute">index</span>  index.html index.htm;</span><br><span class="line">        <span class="attribute">proxy_pass</span>  http://gitlab.cyblogs.com;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">        <span class="attribute">proxy_redirect</span> HOST default;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">        <span class="section">location</span> /assets &#123;</span><br><span class="line">          <span class="attribute">root</span>  /opt/gitlab/embedded/service/gitlab-rails/public;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">error_page</span> <span class="number">404</span> /<span class="number">404</span>.html;</span><br><span class="line">        <span class="attribute">error_page</span> <span class="number">500</span> /<span class="number">500</span>.html;</span><br><span class="line">        <span class="attribute">error_page</span> <span class="number">502</span> /<span class="number">502</span>.html;</span><br><span class="line"></span><br><span class="line">        <span class="section">location</span> <span class="regexp">~ ^/(404|500|502)(-custom)?\.html$</span> &#123;</span><br><span class="line">          <span class="attribute">root</span> /opt/gitlab/embedded/service/gitlab-rails/public;</span><br><span class="line">          internal;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="GitLab备份和恢复"><a href="#GitLab备份和恢复" class="headerlink" title="GitLab备份和恢复"></a>GitLab备份和恢复</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">可以将此命令写入crontab，以实现定时备份</span></span><br><span class="line">/usr/bin/gitlab-rake gitlab:backup:create</span><br></pre></td></tr></table></figure>

<h3 id="Gitlab完全卸载"><a href="#Gitlab完全卸载" class="headerlink" title="Gitlab完全卸载"></a>Gitlab完全卸载</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">停止gitlab</span></span><br><span class="line">gitlab-ctl stop</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除</span></span><br><span class="line">rpm -e gitlab-ee</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">彻底删除</span></span><br><span class="line">find / -name gitlab | xargs rm -rf</span><br></pre></td></tr></table></figure>

<h3 id="GitLab常用命令"><a href="#GitLab常用命令" class="headerlink" title="GitLab常用命令"></a>GitLab常用命令</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">gitlab-ctl start    # 启动所有 gitlab 组件；</span><br><span class="line">gitlab-ctl stop        # 停止所有 gitlab 组件；</span><br><span class="line">gitlab-ctl restart        # 重启所有 gitlab 组件；</span><br><span class="line">gitlab-ctl status        # 查看服务状态；</span><br><span class="line">vim /etc/gitlab/gitlab.rb        # 修改gitlab配置文件；</span><br><span class="line">gitlab-ctl reconfigure        # 重新编译gitlab的配置；</span><br><span class="line">gitlab-rake gitlab:check SANITIZE=true --trace    # 检查gitlab；</span><br><span class="line">gitlab-ctl tail        # 查看日志；</span><br><span class="line">gitlab-ctl tail nginx/gitlab_access.log</span><br></pre></td></tr></table></figure>

<h3 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h3><p>浏览器输入：<a target="_blank" rel="noopener" href="http://gitlab.cyblogs.com/users/sign_in">http://gitlab.cyblogs.com/users/sign_in</a></p>
<p><img src="http://static.cyblogs.com/WX20191014-222324@2x.png" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;WX20191014-222324@2x.png"></p>
<p>还有很多的配置还未配置，有待慢慢研究~</p>
<h3 id="参考地址："><a href="#参考地址：" class="headerlink" title="参考地址："></a>参考地址：</h3><ul>
<li><a target="_blank" rel="noopener" href="http://blog.gqylpy.com/gqy/25446/">http://blog.gqylpy.com/gqy/25446/</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.gitlab.com/omnibus/settings/nginx.html">https://docs.gitlab.com/omnibus/settings/nginx.html</a> </li>
<li><a target="_blank" rel="noopener" href="https://gitlab.com/gitlab-org/gitlab-workhorse/issues/26">https://gitlab.com/gitlab-org/gitlab-workhorse/issues/26</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.cyblogs.com/2019/10/10/2019/10/%E4%B8%80%E6%AC%A1tddl-sequence%E9%97%AE%E9%A2%98%E7%9A%84%E6%8E%92%E6%9F%A5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/vernonchen.jpg">
      <meta itemprop="name" content="Vernon">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简栈文化">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | 简栈文化">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/10/10/2019/10/%E4%B8%80%E6%AC%A1tddl-sequence%E9%97%AE%E9%A2%98%E7%9A%84%E6%8E%92%E6%9F%A5/" class="post-title-link" itemprop="url">一次tddl-sequence问题的排查</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-10-10 00:00:00" itemprop="dateCreated datePublished" datetime="2019-10-10T00:00:00+08:00">2019-10-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-06-25 09:57:28" itemprop="dateModified" datetime="2025-06-25T09:57:28+08:00">2025-06-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/MySQL/%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">数据库</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>在测试环境，有个同事发现了一个<code>ID</code>插入的时候报了主键冲突。这是一件很奇怪的事情，在大家的理解中，使用了<code>Sequence</code>功能，每个节点的内存拿的<code>ID段</code>应该都是不同的，不可能会出现这个问题。不然这又要颠覆认知了~ </p>
<h3 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h3><ul>
<li>是否有人手动插入了一条数据，然后出入的时候手动设置了<code>ID</code>呢？</li>
<li>是否有人手动调整了<code>Sequence</code>的<code>value</code>呢?</li>
<li>为什么数据库还存在了<code>ID</code>相同，但在不同表的数据呢？是不是多线程写的有毛病啊？</li>
</ul>
<h3 id="初步排查"><a href="#初步排查" class="headerlink" title="初步排查"></a>初步排查</h3><ul>
<li>确认没有人手动插入<code>ID</code>，都是用程序获取的方式；</li>
<li>那有时间与精力去手动设置<code>Sequence</code>的<code>value</code>啊，确实谁去没事儿管这个；</li>
<li>数据<code>ID</code>相同数据在不同表，明显是2台不同的项目<code>Node</code>导致的。</li>
</ul>
<p>总结：确定问题出现了2台机器获取的<code>Sequence</code>的<code>value</code>范围冲突了。</p>
<p>问题表现出来的确实如此，难道真的要颠覆我们的认知吗？因为问题算比较严重，所以非常的重视。一定要找到问题的原因所在！</p>
<h3 id="具体排查"><a href="#具体排查" class="headerlink" title="具体排查"></a>具体排查</h3><p>此时，我们发现代码有一处调整过，就是配置<code>TDDL</code>的<code>Sequence</code>的<code>innerStep</code>（内部步长），由原来的<code>1000</code>调整为<code>5000</code>。为什么调整大了，是因为在数据迁移的时候，数据量很大，减少由于<code>ID</code>扩容对数据库操作的时间（其实在这里，可以看出这位开发同学已经非常优秀了，其他地方也一定会非常的注意性能的设计）。</p>
<p>这里我的认知也是，就算我修改内部步长跟其他人不一样，也不会影响Sequence冲突的问题啊，这个Sequence应该会自己保证。不知道大家是不是跟我的想法也一样？</p>
<p>抱着半怀疑<code>Sequence</code>的<code>Bug</code>问题与一定要解决掉问题的思绪，大家来开始撸源代码了。这才是解决问题的王道~</p>
<p>这里参考的版本是：<code>tddl-sequence-3.2.jar</code>，用的是<code>GroupSequence</code>。</p>
<h4 id="找出问题的根源点"><a href="#找出问题的根源点" class="headerlink" title="找出问题的根源点"></a>找出问题的根源点</h4><p>第一步会撸<code>nextValue()</code>方法，下面贴一下核心代码。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">newValue = oldValue + outStep; <span class="comment">// 新的值就是数据库中老的值 + 外部步长的求和</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="variable">affectedRows</span> <span class="operator">=</span> stmt.executeUpdate();<span class="comment">// 把新的值再更新到数据库中去</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SequenceRange</span>(newValue + <span class="number">1</span>, newValue + innerStep);<span class="comment">// 该结点的范围就是[newValue + 1, newValue + innerStep]</span></span><br></pre></td></tr></table></figure>

<p>在这里就初步判断，这里有大坑。如果2个项目的内部步长不一致，范围就会存在交集，问题确实是这个问题导致的，但是这不符合常理，为什么设计者要这么设计？此时的心情就是必须要<code>tddl-sequence</code>撸清楚。</p>
<p>下面把看源码时候不太理解的部分解答清楚。</p>
<h4 id="内部步长与外部步长的关系"><a href="#内部步长与外部步长的关系" class="headerlink" title="内部步长与外部步长的关系"></a>内部步长与外部步长的关系</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">outStep = innerStep * dscount; <span class="comment">// 外部步长 = 内部步长 * sequence所在的数据源个数</span></span><br></pre></td></tr></table></figure>

<p>这应该算是tddl-sequence里面的一个约定了吧，<code>outStep</code>算是每次修改的<code>sequence</code>里value的步长或者说单元。</p>
<p>一般大家的<code>dscount</code>配置的是<code>1</code>，也就是<code>00</code>库。</p>
<h4 id="步长有调整怎么办？"><a href="#步长有调整怎么办？" class="headerlink" title="步长有调整怎么办？"></a>步长有调整怎么办？</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">check</span><span class="params">(<span class="type">int</span> index, <span class="type">long</span> value)</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> (value % outStep) == (index * innerStep); <span class="comment">// 这里不相等，就意味着outStep有调整过</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 如果说我们只有一个dscount，这里的index=0，理论上value就要是outStep的整数倍</span></span><br><span class="line"></span><br><span class="line">adjust = <span class="literal">true</span>; <span class="comment">// 这里儿我们要配置为true,当发现调整了步长，就会自动调节sequence表了</span></span><br><span class="line"><span class="comment">// 具体如何调整的</span></span><br><span class="line">newValue = (newValue - newValue % outStep) + outStep + index * innerStep; </span><br><span class="line"><span class="comment">// newValue - newValue % outStep 就是把数据缩减到最近一个可以整除outStep的值，然后再加上一个outStep。</span></span><br></pre></td></tr></table></figure>

<h4 id="回顾问题"><a href="#回顾问题" class="headerlink" title="回顾问题"></a>回顾问题</h4><p>回顾到事情上来，具体例子说明：</p>
<p>用我们组的小伙伴画的神图</p>
<p><img src="http://static.cyblogs.com/7ba2efab-2797-4bda-a62c-21a3a3d6b4eb.jpg" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;7ba2efab-2797-4bda-a62c-21a3a3d6b4eb.jpg"></p>
<p>解释一下，2个不同的应用一个步长是<code>5000</code>，一个步长是<code>1000</code>。步长大的会覆盖步长小的节点；</p>
<p>数据库的<code>value=1000</code>时候；</p>
<p><strong>projectA</strong>：<code>outStep=5000</code>拿到的范围是：<code>[6000, 11000]</code>，先获取<code>sequence</code>；</p>
<p><strong>projectB</strong>：<code>outStep=1000</code>拿到的范围是：<code>[7000, 8000]</code>，后获取<code>sequence</code>；</p>
<p>那如果步长大的节点先插入了数据并且使用了步长小的节点还未使用的<code>ID</code>值，那后面步长小的结点过来插入的时候就报主键冲突了。</p>
<h3 id="疑问点？"><a href="#疑问点？" class="headerlink" title="疑问点？"></a>疑问点？</h3><p>为什么数据库的值是<code>1000</code>，步长是<code>5000</code>的时候。获取的范围是<code>[6000,11000]</code>呢？浪费了<code>5000</code>啊。</p>
<p>这个问题就是由于步长调整导致的，因为sequence要让数据库的值是outStep的整数倍。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.cyblogs.com/2019/10/05/2019/10/%E8%AF%A6%E7%BB%86%E5%88%86%E6%9E%90%E7%94%A8Kubeconfig%E6%88%96%E8%80%85Token%E7%99%BB%E5%BD%95%E7%9A%84%E6%96%B9%E5%BC%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/vernonchen.jpg">
      <meta itemprop="name" content="Vernon">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简栈文化">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | 简栈文化">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/10/05/2019/10/%E8%AF%A6%E7%BB%86%E5%88%86%E6%9E%90%E7%94%A8Kubeconfig%E6%88%96%E8%80%85Token%E7%99%BB%E5%BD%95%E7%9A%84%E6%96%B9%E5%BC%8F/" class="post-title-link" itemprop="url">详细分析用Kubeconfig或者Token登录的方式</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-10-05 00:00:00" itemprop="dateCreated datePublished" datetime="2019-10-05T00:00:00+08:00">2019-10-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-06-25 09:57:28" itemprop="dateModified" datetime="2025-06-25T09:57:28+08:00">2025-06-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Spring/" itemprop="url" rel="index"><span itemprop="name">Spring</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="创建管理员用户"><a href="#创建管理员用户" class="headerlink" title="创建管理员用户"></a>创建管理员用户</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">➜  kubernetes  kubectl patch svc -n kube-system kubernetes-dashboard -p &#x27;&#123;&quot;spec&quot;:&#123;&quot;type&quot;:&quot;NodePort&quot;&#125;&#125;&#x27;</span><br><span class="line">service/kubernetes-dashboard patched</span><br><span class="line">➜  kubernetes  kubectl create serviceaccount dashboard-admin -n kube-system</span><br><span class="line">serviceaccount/dashboard-admin created</span><br><span class="line">➜  kubernetes  kubectl create clusterrolebinding dashboard-cluster-admin --clusterrole=cluster-admin --serviceaccount=kube-system:dashboard-admin</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/dashboard-cluster-admin created</span><br></pre></td></tr></table></figure>

<h4 id="确定NAME"><a href="#确定NAME" class="headerlink" title="确定NAME"></a>确定NAME</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">➜  kubernetes  kubectl get secret -n=kube-system</span><br><span class="line">NAME                                             TYPE                                  DATA   AGE</span><br><span class="line">attachdetach-controller-token-jxx56              kubernetes.io/service-account-token   3      5d3h</span><br><span class="line">bootstrap-signer-token-9hb7w                     kubernetes.io/service-account-token   3      5d3h</span><br><span class="line">certificate-controller-token-m8mpc               kubernetes.io/service-account-token   3      5d3h</span><br><span class="line">clusterrole-aggregation-controller-token-sb7dv   kubernetes.io/service-account-token   3      5d3h</span><br><span class="line">coredns-token-tdchv                              kubernetes.io/service-account-token   3      5d3h</span><br><span class="line">cronjob-controller-token-2f79z                   kubernetes.io/service-account-token   3      5d3h</span><br><span class="line">daemon-set-controller-token-svzw7                kubernetes.io/service-account-token   3      5d3h</span><br><span class="line">dashboard-admin-token-mwjwf                      kubernetes.io/service-account-token   3      61s</span><br><span class="line">default-token-sznp4                              kubernetes.io/service-account-token   3      5d3h</span><br><span class="line">deployment-controller-token-qdh74                kubernetes.io/service-account-token   3      5d3h</span><br><span class="line">disruption-controller-token-hd7sb                kubernetes.io/service-account-token   3      5d3h</span><br><span class="line">endpoint-controller-token-wnnrr                  kubernetes.io/service-account-token   3      5d3h</span><br><span class="line">expand-controller-token-jc8ls                    kubernetes.io/service-account-token   3      5d3h</span><br><span class="line">generic-garbage-collector-token-x2p5z            kubernetes.io/service-account-token   3      5d3h</span><br><span class="line">horizontal-pod-autoscaler-token-vf4kn            kubernetes.io/service-account-token   3      5d3h</span><br><span class="line">job-controller-token-mtz64                       kubernetes.io/service-account-token   3      5d3h</span><br><span class="line">kube-proxy-token-6xgld                           kubernetes.io/service-account-token   3      5d3h</span><br><span class="line">kubernetes-dashboard-certs                       Opaque                                0      5d3h</span><br><span class="line">kubernetes-dashboard-key-holder                  Opaque                                2      5d3h</span><br><span class="line">kubernetes-dashboard-token-lx9kx                 kubernetes.io/service-account-token   3      5d3h</span><br><span class="line">namespace-controller-token-8scnl                 kubernetes.io/service-account-token   3      5d3h</span><br><span class="line">node-controller-token-rh4fk                      kubernetes.io/service-account-token   3      5d3h</span><br><span class="line">persistent-volume-binder-token-xhwzv             kubernetes.io/service-account-token   3      5d3h</span><br><span class="line">pod-garbage-collector-token-7wtzh                kubernetes.io/service-account-token   3      5d3h</span><br><span class="line">pv-protection-controller-token-9nqsb             kubernetes.io/service-account-token   3      5d3h</span><br><span class="line">pvc-protection-controller-token-59kcr            kubernetes.io/service-account-token   3      5d3h</span><br><span class="line">replicaset-controller-token-pq8q9                kubernetes.io/service-account-token   3      5d3h</span><br><span class="line">replication-controller-token-tp9zd               kubernetes.io/service-account-token   3      5d3h</span><br><span class="line">resourcequota-controller-token-wm4j6             kubernetes.io/service-account-token   3      5d3h</span><br><span class="line">service-account-controller-token-g2h2r           kubernetes.io/service-account-token   3      5d3h</span><br><span class="line">service-controller-token-7qrks                   kubernetes.io/service-account-token   3      5d3h</span><br><span class="line">statefulset-controller-token-gcrtq               kubernetes.io/service-account-token   3      5d3h</span><br><span class="line">token-cleaner-token-swg2m                        kubernetes.io/service-account-token   3      5d3h</span><br><span class="line">ttl-controller-token-tgwnf                       kubernetes.io/service-account-token   3      5d3h</span><br></pre></td></tr></table></figure>

<h4 id="获取TOKEN"><a href="#获取TOKEN" class="headerlink" title="获取TOKEN"></a>获取TOKEN</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">➜  kubernetes  kubectl describe secret -n=kube-system dashboard-admin-token-mwjwf</span><br><span class="line">Name:         dashboard-admin-token-mwjwf</span><br><span class="line">Namespace:    kube-system</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  kubernetes.io/service-account.name: dashboard-admin</span><br><span class="line">              kubernetes.io/service-account.uid: 0c547a29-f000-11e9-a91a-025000000001</span><br><span class="line"></span><br><span class="line">Type:  kubernetes.io/service-account-token</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">ca.crt:     1025 bytes</span><br><span class="line">namespace:  11 bytes</span><br><span class="line">token:      eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJkYXNoYm9hcmQtYWRtaW4tdG9rZW4tbXdqd2YiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoiZGFzaGJvYXJkLWFkbWluIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQudWlkIjoiMGM1NDdhMjktZjAwMC0xMWU5LWE5MWEtMDI1MDAwMDAwMDAxIiwic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50Omt1YmUtc3lzdGVtOmRhc2hib2FyZC1hZG1pbiJ9.cvbCJYR98zNWQeRjW4QmEqVPKD4CxL5EpR7bwEfCZqU_hJiNIKJubIGYWAkbB47waEBFOgIU9Aj98BGqtIAki-eL_kZFVYDIrQGzYQHZVngmCcUwG0u_PKazH9bgU_sfsw9t2_FZv-pD8aiVpGXtbS9EFWpf-VTIrZS-CSlTp0LEgPZLir8Jp_T3X4sbBfgtMbHTzkbz8WCvL_SeWxRIf7o-hLY703KNU4hkbNUxhC2ur73Irp3dSpgyANrS3G3cQjM1Uinh7pJl1ay-gRd0jPCwcZxUW3XKfLqS2-vwIpnYZ_j26Dj9oqDChAIxhK2T6VfBOdpp93AlXzT3_0VSYQ</span><br></pre></td></tr></table></figure>

<h4 id="生成Kubeconfig文件"><a href="#生成Kubeconfig文件" class="headerlink" title="生成Kubeconfig文件"></a>生成<code>Kubeconfig</code>文件</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">➜  kubernetes  DASH_TOCKEN=$(kubectl get secret -n kube-system dashboard-admin-token-mwjwf -o jsonpath=&#123;.data.token&#125;|base64 -D)</span><br><span class="line">➜  kubernetes  kubectl config set-cluster kubernetes --server=https://kubernetes.docker.internal:6443 --kubeconfig=/Users/chenyuan/Tools/Docker/kubernetes/dashbord-admin.conf</span><br><span class="line">Cluster &quot;kubernetes&quot; set.</span><br><span class="line">➜  kubernetes  kubectl config set-credentials dashboard-admin --token=$DASH_TOCKEN --kubeconfig=/Users/chenyuan/Tools/Docker/kubernetes/dashbord-admin.conf</span><br><span class="line">User &quot;dashboard-admin&quot; set.</span><br><span class="line">➜  kubernetes  kubectl config set-context dashboard-admin@kubernetes --cluster=kubernetes --user=dashboard-admin --kubeconfig=/Users/chenyuan/Tools/Docker/kubernetes/dashbord-admin.conf</span><br><span class="line">Context &quot;dashboard-admin@kubernetes&quot; created.</span><br><span class="line">➜  kubernetes  kubectl config use-context dashboard-admin@kubernetes --kubeconfig=/Users/chenyuan/Tools/Docker/kubernetes/dashbord-admin.conf</span><br><span class="line">Switched to context &quot;dashboard-admin@kubernetes&quot;.</span><br></pre></td></tr></table></figure>

<h4 id="启动服务验证"><a href="#启动服务验证" class="headerlink" title="启动服务验证"></a>启动服务验证</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl proxy --address=&#x27;0.0.0.0&#x27;  --accept-hosts=&#x27;^*$&#x27;  </span><br><span class="line"></span><br><span class="line">访问：http://localhost:8001/api/v1/namespaces/kube-system/services/https:kubernetes-dashboard:/proxy/ </span><br></pre></td></tr></table></figure>

<p><img src="http://static.cyblogs.com/WX20191016-190028@2x.png" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;WX20191016-190028@2x.png"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.cyblogs.com/2019/06/20/2019/06/Git%20%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86%E4%B8%8E%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/vernonchen.jpg">
      <meta itemprop="name" content="Vernon">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简栈文化">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | 简栈文化">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/06/20/2019/06/Git%20%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86%E4%B8%8E%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/" class="post-title-link" itemprop="url">Git 基本原理与常用命令</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-06-20 00:00:00" itemprop="dateCreated datePublished" datetime="2019-06-20T00:00:00+08:00">2019-06-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-06-25 09:57:28" itemprop="dateModified" datetime="2025-06-25T09:57:28+08:00">2025-06-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Git/" itemprop="url" rel="index"><span itemprop="name">Git</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="Git-基本原理与常用命令"><a href="#Git-基本原理与常用命令" class="headerlink" title="Git 基本原理与常用命令"></a>Git 基本原理与常用命令</h3><h4 id="1、设置与帮助"><a href="#1、设置与帮助" class="headerlink" title="1、设置与帮助"></a>1、设置与帮助</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1. git help &lt;command&gt;          # 显示指定命令的help  </span><br><span class="line">2. git config --global user.name &quot;your name&quot;  </span><br><span class="line">3. git config --global user.email &quot;your email&quot; </span><br></pre></td></tr></table></figure>

<h4 id="2、修改与提交"><a href="#2、修改与提交" class="headerlink" title="2、修改与提交"></a>2、修改与提交</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">1. git status                   # 查看工作区状态  </span><br><span class="line">2. git add &lt;file&gt;               # 将指定文件修改提交到本地暂存区  </span><br><span class="line">3. git add .                    # 将所有修改过的文件提都交暂存区，不包括删除，&quot;.&quot;即表示正则匹配所有字符  </span><br><span class="line">4. git add --all                # 将所有工作区修改提交到暂存区，包括 delete 掉的文件  </span><br><span class="line">5. git add -A                   # 同上  </span><br><span class="line">6. git commit -m&quot;comments&quot;      # 将暂存区的内容提交到本地库，并加上备注  </span><br><span class="line">7. git commit &lt;file&gt;            # 提交暂存区指定文件  </span><br><span class="line">8. git commit .                 # 提交暂存区所有文件  </span><br><span class="line">9. git commit -a                # 将git add, git rm和git commit等操作都合并在一起做，不包括新建文件  </span><br><span class="line">10. git commit -am &quot;comments&quot;    # 同上+添加备注</span><br></pre></td></tr></table></figure>

<h4 id="3、撤销与恢复"><a href="#3、撤销与恢复" class="headerlink" title="3、撤销与恢复"></a>3、撤销与恢复</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1. git checkout  -- &lt;file&gt;     # 抛弃工作区指定文件的修改  </span><br><span class="line">2. git checkoout .             # 抛弃工作区所有的修改  </span><br><span class="line">3. git reset &lt;file&gt;            # 将指定文件从暂存区恢复到工作区  </span><br><span class="line">4. git reset -- .              # 将所有文件从暂存区恢复到工作区  </span><br><span class="line">5. git reset --hard            # 恢复最近一次提交过的状态，工作区所有修改被放弃 </span><br></pre></td></tr></table></figure>

<h4 id="4、查看提交"><a href="#4、查看提交" class="headerlink" title="4、查看提交"></a>4、查看提交</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1. git show            # 显示某次提交的内容  </span><br><span class="line">2. git show $id  </span><br><span class="line">3. git log  </span><br><span class="line">4. git log &lt;file&gt;      # 查看该文件每次提交记录  </span><br><span class="line">5. git log -p &lt;file&gt;   # 查看每次详细修改内容的diff  </span><br><span class="line">6. git log -p -2       # 查看最近两次详细修改内容的diff  </span><br><span class="line">7. git log --stat      # 查看提交统计信息  </span><br></pre></td></tr></table></figure>

<h4 id="5、差异对比"><a href="#5、差异对比" class="headerlink" title="5、差异对比"></a>5、差异对比</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1. git diff &lt;file&gt;                     # 比较当前文件和暂存区文件差异  </span><br><span class="line">2. git diff &lt;$id1&gt; &lt;$id2&gt;              # 比较两次提交之间的差异  </span><br><span class="line">3. git diff &lt;branch1&gt;..&lt;branch2&gt;       # 在两个分支之间比较  </span><br><span class="line">4. git diff --staged                   # 比较暂存区和版本库差异  </span><br><span class="line">5. git diff --stat                     # 仅仅比较统计信息  </span><br></pre></td></tr></table></figure>

<h4 id="6、关于版本"><a href="#6、关于版本" class="headerlink" title="6、关于版本"></a>6、关于版本</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1. git tag                              #查看版本  </span><br><span class="line">2. git tag [name]                       #创建版本  </span><br><span class="line">3. git tag -d [name]                    #删除版本  </span><br><span class="line">4. git tag -r                           #查看远程版本  </span><br><span class="line">5. git push origin [name]               #创建远程版本(本地版本push到远程)</span><br></pre></td></tr></table></figure>

<h4 id="7、关于分支"><a href="#7、关于分支" class="headerlink" title="7、关于分支"></a>7、关于分支</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">1. git branch &lt;new_branch&gt;             # 创建新的分支  </span><br><span class="line">2. git checkout &lt;branch&gt;               # 切换到某个分支  </span><br><span class="line">3. git checkout -b &lt;new_branch&gt;        # 创建新的分支，并且切换过去  </span><br><span class="line">4. git branch -v                       # 查看各个分支最后提交信息  </span><br><span class="line">5. git branch -r                       # 查看远程分支  </span><br><span class="line">6. git branch --merged                 # 查看已经被合并到当前分支的分支  </span><br><span class="line">7. git branch --no-merged              # 查看尚未被合并到当前分支分支  </span><br><span class="line">8. git checkout $id                    # 把某历史提交checkout出来，无分支信息，切换到其他分支会自动删除  </span><br><span class="line">9. git checkout $id -b &lt;new_branch&gt;    # 把某历史提交checkout出来，创建成一个分支  </span><br><span class="line">10. git branch -d &lt;branch&gt;              # 删除某个分支  </span><br><span class="line">11. git branch -D &lt;branch&gt;              # 强制删除某个分支 (未被合并的分支被删除的时候需要强制)  </span><br></pre></td></tr></table></figure>

<h4 id="8、关于远程仓库"><a href="#8、关于远程仓库" class="headerlink" title="8、关于远程仓库"></a>8、关于远程仓库</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1. git remote add origin &lt;remote&gt;       # 添加远程库  </span><br><span class="line">2. git remote -v                        # 查看远程服务器地址和仓库名称  </span><br><span class="line">3. git remote show origin               # 查看远程服务器仓库状态  </span><br><span class="line">4. git remote rm &lt;repository&gt;           # 删除远程仓库  </span><br><span class="line">5. git push -u origin master            # 客户端首次提交  </span><br><span class="line">6. git push -u origin develop           # 首次将本地develop分支提交到远程develop分支，并且track</span><br></pre></td></tr></table></figure>

<h4 id="9、跟踪远程库和本地库"><a href="#9、跟踪远程库和本地库" class="headerlink" title="9、跟踪远程库和本地库"></a>9、跟踪远程库和本地库</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1. git branch --set-upstream master origin/master  </span><br><span class="line">2. git branch --set-upstream develop origin/develop </span><br></pre></td></tr></table></figure>

<h4 id="10、本地支持多个Git服务"><a href="#10、本地支持多个Git服务" class="headerlink" title="10、本地支持多个Git服务"></a>10、本地支持多个Git服务</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">cd /Users/chenyuan/.ssh</span><br><span class="line">lrwxr-xr-x  1 chenyuan  staff    42B May 23  2018 config -&gt; /Users/chenyuan/Dropbox/Mackup/.ssh/config # 这里配置多个git对应关系</span><br><span class="line"></span><br><span class="line">➜  .ssh  cat config</span><br><span class="line"></span><br><span class="line">Host git.coding.net # host</span><br><span class="line">HostName git.coding.net</span><br><span class="line">Port 22</span><br><span class="line">User chengcheng222e</span><br><span class="line">IdentityFile ~/.ssh/chengcheng222e_coding # 这里是coding.net的私钥路径</span><br><span class="line"></span><br><span class="line">Host github.com # host</span><br><span class="line">HostName github.com</span><br><span class="line">Port 22</span><br><span class="line">User chenyuan</span><br><span class="line">IdentityFile ~/.ssh/github_rsa # 这里是github.com的私钥路径</span><br></pre></td></tr></table></figure>

<h4 id="11、推荐一个特别好玩的Git游戏-Githug"><a href="#11、推荐一个特别好玩的Git游戏-Githug" class="headerlink" title="11、推荐一个特别好玩的Git游戏~ Githug"></a>11、推荐一个特别好玩的Git游戏~ Githug</h4><p><a target="_blank" rel="noopener" href="https://wiki.jikexueyuan.com/project/githug-walkthrough/install.html">Githug 安装和使用方法</a>，一共有55关。</p>
<p>How to install</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo gem install githug</span><br></pre></td></tr></table></figure>

<h5 id="关卡列表"><a href="#关卡列表" class="headerlink" title="关卡列表"></a>关卡列表</h5><table>
<thead>
<tr>
<th align="left">关卡名称</th>
<th align="left">学习内容</th>
<th align="left">Git 命令</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><a target="_blank" rel="noopener" href="http://wiki.jikexueyuan.com/project/githug-walkthrough/level-1.html">第1关 init</a></td>
<td align="left">初始化仓库</td>
<td align="left">git init</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://wiki.jikexueyuan.com/project/githug-walkthrough/level-2.html">第2关 config</a></td>
<td align="left">设置用户名和电子邮箱地址</td>
<td align="left">git config</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://wiki.jikexueyuan.com/project/githug-walkthrough/level-3.html">第3关 add</a></td>
<td align="left">把文件添加到暂存区</td>
<td align="left">git add</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://wiki.jikexueyuan.com/project/githug-walkthrough/level-4.html">第4关 commit</a></td>
<td align="left">提交</td>
<td align="left">git commit</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://wiki.jikexueyuan.com/project/githug-walkthrough/level-5.html">第5关 clone</a></td>
<td align="left">克隆远程仓库</td>
<td align="left">git clone</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://wiki.jikexueyuan.com/project/githug-walkthrough/level-6.html">第6关 clone_to_folder</a></td>
<td align="left">克隆远程仓库，并指定本地目录名</td>
<td align="left">git clone</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://wiki.jikexueyuan.com/project/githug-walkthrough/level-7.html">第7关 ignore</a></td>
<td align="left">配置不被 Git 管理的文件</td>
<td align="left">vim .gitignore</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://wiki.jikexueyuan.com/project/githug-walkthrough/level-8.html">第8关 include</a></td>
<td align="left">配置不被 Git 管理的文件</td>
<td align="left">vim .gitignore</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://wiki.jikexueyuan.com/project/githug-walkthrough/level-9.html">第9关 status</a></td>
<td align="left">查看仓库状态</td>
<td align="left">git status</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://wiki.jikexueyuan.com/project/githug-walkthrough/level-10.html">第10关 number_of_files_committed</a></td>
<td align="left">查看仓库状态</td>
<td align="left">git status</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://wiki.jikexueyuan.com/project/githug-walkthrough/level-11.html">第11关 rm</a></td>
<td align="left">删除文件</td>
<td align="left">git rm</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://wiki.jikexueyuan.com/project/githug-walkthrough/level-12.html">第12关 rm_cached</a></td>
<td align="left">从暂存区中移除文件，系 git add 的逆操作</td>
<td align="left">git rm –cached</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://wiki.jikexueyuan.com/project/githug-walkthrough/level-13.html">第13关 stash</a></td>
<td align="left">保存而不提交</td>
<td align="left">git stash</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://wiki.jikexueyuan.com/project/githug-walkthrough/level-14.html">第14关 rename</a></td>
<td align="left">文件改名</td>
<td align="left">git mv</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://wiki.jikexueyuan.com/project/githug-walkthrough/level-15.html">第15关 restructure</a></td>
<td align="left">整理目录结构</td>
<td align="left"></td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://wiki.jikexueyuan.com/project/githug-walkthrough/level-16.html">第16关 log</a></td>
<td align="left">查询日志</td>
<td align="left">git log</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://wiki.jikexueyuan.com/project/githug-walkthrough/level-17.html">第17关 tag</a></td>
<td align="left">打标签</td>
<td align="left">git tag</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://wiki.jikexueyuan.com/project/githug-walkthrough/level-18.html">第18关 push_tags</a></td>
<td align="left">把标签推送到远程仓库</td>
<td align="left">git push –tags</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://wiki.jikexueyuan.com/project/githug-walkthrough/level-19.html">第19关 commit_amend</a></td>
<td align="left">修改最后一次提交</td>
<td align="left">git commit –amend</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://wiki.jikexueyuan.com/project/githug-walkthrough/level-20.html">第20关 commit_in_future</a></td>
<td align="left">指定提交的日期</td>
<td align="left">git commit –date</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://wiki.jikexueyuan.com/project/githug-walkthrough/level-21.html">第21关 reset</a></td>
<td align="left">从暂存区中移除文件，系 git add 的逆操作</td>
<td align="left">git reset</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://wiki.jikexueyuan.com/project/githug-walkthrough/level-22.html">第22关 reset_soft</a></td>
<td align="left">撤销提交，系 git commit 的逆操作</td>
<td align="left">git reset –soft</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://wiki.jikexueyuan.com/project/githug-walkthrough/level-23.html">第23关 checkout_file</a></td>
<td align="left">撤销对一个文件的修改</td>
<td align="left">git checkout</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://wiki.jikexueyuan.com/project/githug-walkthrough/level-24.html">第24关 remote</a></td>
<td align="left">查询远程仓库</td>
<td align="left">git remote</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://wiki.jikexueyuan.com/project/githug-walkthrough/level-25.html">第25关 remote_url</a></td>
<td align="left">查询远程仓库的 URL</td>
<td align="left">git remote -v</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://wiki.jikexueyuan.com/project/githug-walkthrough/level-26.html">第26关 pull</a></td>
<td align="left">从远程仓库拉取更新</td>
<td align="left">git pull</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://wiki.jikexueyuan.com/project/githug-walkthrough/level-27.html">第27关 remote_add</a></td>
<td align="left">添加远程仓库</td>
<td align="left">git remote</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://wiki.jikexueyuan.com/project/githug-walkthrough/level-28.html">第28关 push</a></td>
<td align="left">把提交推送到远程仓库</td>
<td align="left">git push</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://wiki.jikexueyuan.com/project/githug-walkthrough/level-29.html">第29关 diff</a></td>
<td align="left">查看文件被修改的细节</td>
<td align="left">git diff</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://wiki.jikexueyuan.com/project/githug-walkthrough/level-30.html">第30关 blame</a></td>
<td align="left">查询每一行代码被谁编辑过</td>
<td align="left">git blame</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://wiki.jikexueyuan.com/project/githug-walkthrough/level-31.html">第31关 branch</a></td>
<td align="left">创建分支</td>
<td align="left">git branch</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://wiki.jikexueyuan.com/project/githug-walkthrough/level-32.html">第32关 checkout</a></td>
<td align="left">切换分支</td>
<td align="left">git checkout</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://wiki.jikexueyuan.com/project/githug-walkthrough/level-33.html">第33关 checkout_tag</a></td>
<td align="left">切换到标签</td>
<td align="left">git checkout</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://wiki.jikexueyuan.com/project/githug-walkthrough/level-34.html">第34关 checkout_tag_over_branch</a></td>
<td align="left">切换到标签</td>
<td align="left">git checkout</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://wiki.jikexueyuan.com/project/githug-walkthrough/level-35.html">第35关 branch_at</a></td>
<td align="left">在指定的提交处创建分支</td>
<td align="left">git branch</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://wiki.jikexueyuan.com/project/githug-walkthrough/level-36.html">第36关 delete_branch</a></td>
<td align="left">删除分支</td>
<td align="left">git branch -d</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://wiki.jikexueyuan.com/project/githug-walkthrough/level-37.html">第37关 push_branch</a></td>
<td align="left">推送分支到远程仓库</td>
<td align="left">git push</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://wiki.jikexueyuan.com/project/githug-walkthrough/level-38.html">第38关 merge</a></td>
<td align="left">合并分支</td>
<td align="left">git merge</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://wiki.jikexueyuan.com/project/githug-walkthrough/level-39.html">第39关 fetch</a></td>
<td align="left">从远程仓库抓取数据</td>
<td align="left">git fetch</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://wiki.jikexueyuan.com/project/githug-walkthrough/level-40.html">第40关 rebase</a></td>
<td align="left">变基合并</td>
<td align="left">git rebase</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://wiki.jikexueyuan.com/project/githug-walkthrough/level-41.html">第41关 repack</a></td>
<td align="left">重新打包</td>
<td align="left">git repack</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://wiki.jikexueyuan.com/project/githug-walkthrough/level-42.html">第42关 cherry-pick</a></td>
<td align="left">合并分支上指定的提交</td>
<td align="left">git cherry-pick</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://wiki.jikexueyuan.com/project/githug-walkthrough/level-43.html">第43关 grep</a></td>
<td align="left">搜索文本</td>
<td align="left">git grep</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://wiki.jikexueyuan.com/project/githug-walkthrough/level-44.html">第44关 rename_commit</a></td>
<td align="left">修改历史提交的说明</td>
<td align="left">git rebase -i</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://wiki.jikexueyuan.com/project/githug-walkthrough/level-45.html">第45关 squash</a></td>
<td align="left">把多次提交合并成一次提交</td>
<td align="left">git rebase -i</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://wiki.jikexueyuan.com/project/githug-walkthrough/level-46.html">第46关 merge_squash</a></td>
<td align="left">合并分支时把多次提交合并成一次提交</td>
<td align="left">git merge –squash</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://wiki.jikexueyuan.com/project/githug-walkthrough/level-47.html">第47关 reorder</a></td>
<td align="left">调整提交顺序</td>
<td align="left">git rebase -i</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://wiki.jikexueyuan.com/project/githug-walkthrough/level-48.html">第48关 bisect</a></td>
<td align="left">用二分法定位 bug</td>
<td align="left">git bisect</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://wiki.jikexueyuan.com/project/githug-walkthrough/level-49.html">第49关 stage_lines</a></td>
<td align="left">添加文件的部分行到暂存区</td>
<td align="left">git add –edit</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://wiki.jikexueyuan.com/project/githug-walkthrough/level-50.html">第50关 file_old_branch</a></td>
<td align="left">查看 Git 上的操作历史</td>
<td align="left">git reflog</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://wiki.jikexueyuan.com/project/githug-walkthrough/level-51.html">第51关 revert</a></td>
<td align="left">取消已推送到远程仓库的提交</td>
<td align="left">git revert</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://wiki.jikexueyuan.com/project/githug-walkthrough/level-52.html">第52关 restore</a></td>
<td align="left">恢复被删除的提交</td>
<td align="left">git reset –hard</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://wiki.jikexueyuan.com/project/githug-walkthrough/level-53.html">第53关 conflict</a></td>
<td align="left">解决冲突</td>
<td align="left"></td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://wiki.jikexueyuan.com/project/githug-walkthrough/level-54.html">第54关 submodule</a></td>
<td align="left">把第三方库当作子模块</td>
<td align="left">git submodule</td>
</tr>
<tr>
<td align="left"><a target="_blank" rel="noopener" href="http://wiki.jikexueyuan.com/project/githug-walkthrough/level-55.html">第55关 contribute</a></td>
<td align="left">捐献</td>
<td align="left"></td>
</tr>
</tbody></table>
<p>把这个游戏全部通关，你的操作绝对又上N个台阶~</p>
<h4 id="参考地址："><a href="#参考地址：" class="headerlink" title="参考地址："></a>参考地址：</h4><ul>
<li><p><a target="_blank" rel="noopener" href="https://www.jikexueyuan.com/wiki/githug-walkthrough">https://www.jikexueyuan.com/wiki/githug-walkthrough</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.open-open.com/lib/view/open1453249884901.html">https://www.open-open.com/lib/view/open1453249884901.html</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/y2888886/article/details/50499168">https://blog.csdn.net/y2888886/article/details/50499168</a></p>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.cyblogs.com/2019/06/10/2019/06/%E6%88%91%E4%BB%AC%E5%A6%82%E4%BD%95%E7%9C%8BSpringBoot%E7%9A%84%E6%BA%90%E4%BB%A3%E7%A0%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/vernonchen.jpg">
      <meta itemprop="name" content="Vernon">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简栈文化">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | 简栈文化">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/06/10/2019/06/%E6%88%91%E4%BB%AC%E5%A6%82%E4%BD%95%E7%9C%8BSpringBoot%E7%9A%84%E6%BA%90%E4%BB%A3%E7%A0%81/" class="post-title-link" itemprop="url">我们如何看SpringBoot的源代码</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-06-10 00:00:00" itemprop="dateCreated datePublished" datetime="2019-06-10T00:00:00+08:00">2019-06-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-06-25 09:57:28" itemprop="dateModified" datetime="2025-06-25T09:57:28+08:00">2025-06-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Spring/" itemprop="url" rel="index"><span itemprop="name">Spring</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Spring/SpringBoot/" itemprop="url" rel="index"><span itemprop="name">SpringBoot</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="我们如何看SpringBoot的源代码"><a href="#我们如何看SpringBoot的源代码" class="headerlink" title="我们如何看SpringBoot的源代码"></a>我们如何看SpringBoot的源代码</h4><h5 id="1、快速生成一个简单的SpringBoot项目"><a href="#1、快速生成一个简单的SpringBoot项目" class="headerlink" title="1、快速生成一个简单的SpringBoot项目"></a>1、快速生成一个简单的SpringBoot项目</h5><p>进入地址：<a target="_blank" rel="noopener" href="https://start.spring.io/">https://start.spring.io/</a> ，点击生成代码即可。</p>
<p><img src="http://static.cyblogs.com/QQ20190612-155510@2x.jpg" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;QQ20190612-155510@2x.jpg"></p>
<h5 id="2、注解：-SpringBootApplication"><a href="#2、注解：-SpringBootApplication" class="headerlink" title="2、注解：@SpringBootApplication"></a>2、注解：@SpringBootApplication</h5><p>一个Web项目，只需要这一行注解。有这么厉害吗？我们一起看看它究竟做了什么？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringBootDemoApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">		SpringApplication.run(SpringBootDemoApplication.class, args);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The <code>@SpringBootApplication</code> annotation is equivalent to using <code>@Configuration</code>, <code>@EnableAutoConfiguration</code>, and <code>@ComponentScan</code> with their default attributes</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootConfiguration</span></span><br><span class="line"><span class="meta">@EnableAutoConfiguration</span></span><br><span class="line"><span class="meta">@ComponentScan(excludeFilters = &#123;</span></span><br><span class="line"><span class="meta">		@Filter(type = FilterType.CUSTOM, classes = TypeExcludeFilter.class),</span></span><br><span class="line"><span class="meta">		@Filter(type = FilterType.CUSTOM, classes = AutoConfigurationExcludeFilter.class) &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> SpringBootApplication &#123;</span><br></pre></td></tr></table></figure>

<p>看代码，明明是<code>@SpringBootConfiguration</code>呢，怎么说是<code>@Configuration</code>呢？</p>
<h6 id="2-1、注解：-SpringBootConfiguration"><a href="#2-1、注解：-SpringBootConfiguration" class="headerlink" title="2.1、注解：@SpringBootConfiguration"></a>2.1、注解：@SpringBootConfiguration</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> SpringBootConfiguration &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后再进入到里面去，发现竟然是<code>Component</code>注解？是不是非常熟悉呢？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Configuration &#123;</span><br></pre></td></tr></table></figure>

<p>Spring provides further stereotype annotations: <code>@Component</code>, <code>@Service</code>, and <code>@Controller</code>. <code>@Component</code> is a generic stereotype for any Spring-managed component. <code>@Repository</code>, <code>@Service</code>, and <code>@Controller</code> are specializations of <code>@Component</code> for more specific use cases (in the persistence, service, and presentation layers, respectively)。</p>
<h6 id="2-2、注解：-ComponentScan"><a href="#2-2、注解：-ComponentScan" class="headerlink" title="2.2、注解：@ComponentScan"></a>2.2、注解：@ComponentScan</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.boot.SpringApplication</span><br><span class="line"><span class="comment">// 第1步</span></span><br><span class="line"><span class="keyword">public</span> ConfigurableApplicationContext <span class="title function_">run</span><span class="params">(String... args)</span> &#123;</span><br><span class="line">	refreshContext(context);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 第2步</span></span><br><span class="line"><span class="keyword">public</span> ConfigurableApplicationContext <span class="title function_">run</span><span class="params">(String... args)</span> &#123;</span><br><span class="line">    <span class="type">ConfigurableApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    Collection&lt;SpringBootExceptionReporter&gt; exceptionReporters = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    configureHeadlessProperty();</span><br><span class="line">    <span class="type">SpringApplicationRunListeners</span> <span class="variable">listeners</span> <span class="operator">=</span> getRunListeners(args);</span><br><span class="line">    listeners.starting();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">ConfigurableEnvironment</span> <span class="variable">environment</span> <span class="operator">=</span> prepareEnvironment(listeners,</span><br><span class="line">                applicationArguments);</span><br><span class="line">        configureIgnoreBeanInfo(environment);</span><br><span class="line">        <span class="type">Banner</span> <span class="variable">printedBanner</span> <span class="operator">=</span> printBanner(environment);</span><br><span class="line">        context = createApplicationContext();</span><br><span class="line">        exceptionReporters = getSpringFactoriesInstances(</span><br><span class="line">                SpringBootExceptionReporter.class,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; ConfigurableApplicationContext.class &#125;, context);</span><br><span class="line">        prepareContext(context, environment, listeners, applicationArguments,</span><br><span class="line">                printedBanner);</span><br><span class="line">        refreshContext(context);</span><br><span class="line">        afterRefresh(context, applicationArguments);</span><br><span class="line">        listeners.started(context);</span><br><span class="line">        <span class="comment">// Called after the context has been refreshed.</span></span><br><span class="line">        callRunners(context, applicationArguments);</span><br><span class="line">    &#125;</span><br><span class="line">    listeners.running(context);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> context;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 第3步</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">refresh</span><span class="params">(ApplicationContext applicationContext)</span> &#123;</span><br><span class="line">		Assert.isInstanceOf(AbstractApplicationContext.class, applicationContext);</span><br><span class="line">		((AbstractApplicationContext) applicationContext).refresh();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 第4步</span></span><br><span class="line">org.springframework.context.support.AbstractApplicationContext</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">refresh</span><span class="params">()</span> <span class="keyword">throws</span> BeansException, IllegalStateException &#123;</span><br><span class="line">	<span class="comment">// Invoke factory processors registered as beans in the context.</span></span><br><span class="line">	invokeBeanFactoryPostProcessors(beanFactory);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 第5步</span></span><br><span class="line">org.springframework.context.support.PostProcessorRegistrationDelegate</span><br><span class="line"><span class="title function_">for</span> <span class="params">(BeanFactoryPostProcessor postProcessor : beanFactoryPostProcessors)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (postProcessor <span class="keyword">instanceof</span> BeanDefinitionRegistryPostProcessor) &#123;</span><br><span class="line">        registryProcessor.postProcessBeanDefinitionRegistry(registry);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 第6步</span></span><br><span class="line">org.springframework.context.annotation.ConfigurationClassPostProcessor</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postProcessBeanDefinitionRegistry</span><span class="params">(BeanDefinitionRegistry registry)</span> &#123;</span><br><span class="line">    processConfigBeanDefinitions(registry);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 第7步</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processConfigBeanDefinitions</span><span class="params">(BeanDefinitionRegistry registry)</span> &#123;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        parser.parse(candidates);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 第8步</span></span><br><span class="line">org.springframework.context.annotation.ConfigurationClassParser</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">processConfigurationClass</span><span class="params">(ConfigurationClass configClass)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        sourceClass = doProcessConfigurationClass(configClass, sourceClass);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 第9步</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> SourceClass <span class="title function_">doProcessConfigurationClass</span><span class="params">(ConfigurationClass configClass, SourceClass sourceClass)</span></span><br><span class="line">        <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">// Process any @PropertySource annotations</span></span><br><span class="line">    <span class="keyword">for</span> (AnnotationAttributes propertySource : AnnotationConfigUtils.attributesForRepeatable(</span><br><span class="line">            sourceClass.getMetadata(), PropertySources.class,</span><br><span class="line">            org.springframework.context.annotation.PropertySource.class)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.environment <span class="keyword">instanceof</span> ConfigurableEnvironment) &#123;</span><br><span class="line">            processPropertySource(propertySource);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            logger.info(<span class="string">&quot;Ignoring @PropertySource annotation on [&quot;</span> + sourceClass.getMetadata().getClassName() +</span><br><span class="line">                    <span class="string">&quot;]. Reason: Environment must implement ConfigurableEnvironment&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Process any @ComponentScan annotations</span></span><br><span class="line">    Set&lt;AnnotationAttributes&gt; componentScans = AnnotationConfigUtils.attributesForRepeatable(</span><br><span class="line">            sourceClass.getMetadata(), ComponentScans.class, ComponentScan.class);</span><br><span class="line">    <span class="keyword">if</span> (!componentScans.isEmpty() &amp;&amp;</span><br><span class="line">            !<span class="built_in">this</span>.conditionEvaluator.shouldSkip(sourceClass.getMetadata(), ConfigurationPhase.REGISTER_BEAN)) &#123;</span><br><span class="line">        <span class="keyword">for</span> (AnnotationAttributes componentScan : componentScans) &#123;</span><br><span class="line">            <span class="comment">// The config class is annotated with @ComponentScan -&gt; perform the scan immediately</span></span><br><span class="line">            Set&lt;BeanDefinitionHolder&gt; scannedBeanDefinitions =</span><br><span class="line">                    <span class="built_in">this</span>.componentScanParser.parse(componentScan, sourceClass.getMetadata().getClassName());</span><br><span class="line">            <span class="comment">// Check the set of scanned definitions for any further config classes and parse recursively if needed</span></span><br><span class="line">            <span class="keyword">for</span> (BeanDefinitionHolder holder : scannedBeanDefinitions) &#123;</span><br><span class="line">                <span class="type">BeanDefinition</span> <span class="variable">bdCand</span> <span class="operator">=</span> holder.getBeanDefinition().getOriginatingBeanDefinition();</span><br><span class="line">                <span class="keyword">if</span> (bdCand == <span class="literal">null</span>) &#123;</span><br><span class="line">                    bdCand = holder.getBeanDefinition();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (ConfigurationClassUtils.checkConfigurationClassCandidate(bdCand, <span class="built_in">this</span>.metadataReaderFactory)) &#123;</span><br><span class="line">                    parse(bdCand.getBeanClassName(), holder.getBeanName());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Process any @Import annotations</span></span><br><span class="line">    processImports(configClass, sourceClass, getImports(sourceClass), <span class="literal">true</span>);</span><br><span class="line">    <span class="comment">// Process any @ImportResource annotations</span></span><br><span class="line">    <span class="type">AnnotationAttributes</span> <span class="variable">importResource</span> <span class="operator">=</span></span><br><span class="line">            AnnotationConfigUtils.attributesFor(sourceClass.getMetadata(), ImportResource.class);</span><br><span class="line">    <span class="keyword">if</span> (importResource != <span class="literal">null</span>) &#123;</span><br><span class="line">        String[] resources = importResource.getStringArray(<span class="string">&quot;locations&quot;</span>);</span><br><span class="line">        Class&lt;? <span class="keyword">extends</span> <span class="title class_">BeanDefinitionReader</span>&gt; readerClass = importResource.getClass(<span class="string">&quot;reader&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (String resource : resources) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">resolvedResource</span> <span class="operator">=</span> <span class="built_in">this</span>.environment.resolveRequiredPlaceholders(resource);</span><br><span class="line">            configClass.addImportedResource(resolvedResource, readerClass);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 第10步</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">processImports</span><span class="params">(ConfigurationClass configClass, SourceClass currentSourceClass,</span></span><br><span class="line"><span class="params">        Collection&lt;SourceClass&gt; importCandidates, <span class="type">boolean</span> checkForCircularImports)</span> &#123;</span><br><span class="line">    String[] importClassNames = selector.selectImports(currentSourceClass.getMetadata());</span><br><span class="line">    Collection&lt;SourceClass&gt; importSourceClasses = asSourceClasses(importClassNames);</span><br><span class="line">    processImports(configClass, currentSourceClass, importSourceClasses, <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 第11步</span></span><br><span class="line">org.springframework.boot.autoconfigure.AutoConfigurationImportSelector</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> String[] selectImports(AnnotationMetadata annotationMetadata) &#123;</span><br><span class="line">    <span class="type">AutoConfigurationEntry</span> <span class="variable">autoConfigurationEntry</span> <span class="operator">=</span> getAutoConfigurationEntry(</span><br><span class="line">            autoConfigurationMetadata, annotationMetadata);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 第12步</span></span><br><span class="line"><span class="keyword">private</span> List&lt;String&gt; <span class="title function_">filter</span><span class="params">(List&lt;String&gt; configurations,</span></span><br><span class="line"><span class="params">        AutoConfigurationMetadata autoConfigurationMetadata)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (AutoConfigurationImportFilter filter : getAutoConfigurationImportFilters()) &#123;</span><br><span class="line">        invokeAwareMethods(filter);</span><br><span class="line">        <span class="type">boolean</span>[] match = filter.match(candidates, autoConfigurationMetadata);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; match.length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!match[i]) &#123;</span><br><span class="line">                skip[i] = <span class="literal">true</span>;</span><br><span class="line">                candidates[i] = <span class="literal">null</span>;</span><br><span class="line">                skipped = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(result);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 第13步</span></span><br><span class="line"><span class="keyword">protected</span> List&lt;AutoConfigurationImportFilter&gt; <span class="title function_">getAutoConfigurationImportFilters</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> SpringFactoriesLoader.loadFactories(AutoConfigurationImportFilter.class,</span><br><span class="line">		<span class="built_in">this</span>.beanClassLoader);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 第14步</span></span><br><span class="line">org.springframework.core.io.support.SpringFactoriesLoader</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; List&lt;T&gt; <span class="title function_">loadFactories</span><span class="params">(Class&lt;T&gt; factoryClass, <span class="meta">@Nullable</span> ClassLoader classLoader)</span> &#123;</span><br><span class="line">    List&lt;String&gt; factoryNames = loadFactoryNames(factoryClass, classLoaderToUse);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 第15步</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, List&lt;String&gt;&gt; <span class="title function_">loadSpringFactories</span><span class="params">(<span class="meta">@Nullable</span> ClassLoader classLoader)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Enumeration&lt;URL&gt; urls = (classLoader != <span class="literal">null</span> ?</span><br><span class="line">                classLoader.getResources(FACTORIES_RESOURCE_LOCATION) :</span><br><span class="line">                ClassLoader.getSystemResources(FACTORIES_RESOURCE_LOCATION));</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FACTORIES_RESOURCE_LOCATION</span> <span class="operator">=</span> <span class="string">&quot;META-INF/spring.factories&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>也就是说，其实<code>spring.factories</code>是<code>spring-core</code>的功能。</p>
<p>看一下<code>spring-boot-autoconfigure</code>项目里面的<code>spring.factories</code>。</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Initializers</span></span><br><span class="line"><span class="attr">org.springframework.context.ApplicationContextInitializer</span>=<span class="string">\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.SharedMetadataReaderFactoryContextInitializer,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.logging.ConditionEvaluationReportLoggingListener</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># Application Listeners</span></span><br><span class="line"><span class="attr">org.springframework.context.ApplicationListener</span>=<span class="string">\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.BackgroundPreinitializer</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># Auto Configuration Import Listeners</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.AutoConfigurationImportListener</span>=<span class="string">\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.condition.ConditionEvaluationReportAutoConfigurationImportListener</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># Auto Configuration Import Filters</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.AutoConfigurationImportFilter</span>=<span class="string">\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.condition.OnBeanCondition,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.condition.OnClassCondition,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.condition.OnWebApplicationCondition</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># Auto Configure</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.EnableAutoConfiguration</span>=<span class="string">\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.admin.SpringApplicationAdminJmxAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.aop.AopAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.amqp.RabbitAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.batch.BatchAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.cache.CacheAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.cassandra.CassandraAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.cloud.CloudServiceConnectorsAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.context.ConfigurationPropertiesAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.context.MessageSourceAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.context.PropertyPlaceholderAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.couchbase.CouchbaseAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.dao.PersistenceExceptionTranslationAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.data.cassandra.CassandraDataAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.data.cassandra.CassandraReactiveDataAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.data.cassandra.CassandraReactiveRepositoriesAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.data.cassandra.CassandraRepositoriesAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.data.couchbase.CouchbaseDataAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.data.couchbase.CouchbaseReactiveDataAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.data.couchbase.CouchbaseReactiveRepositoriesAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.data.couchbase.CouchbaseRepositoriesAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.data.elasticsearch.ElasticsearchAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.data.elasticsearch.ElasticsearchDataAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.data.elasticsearch.ElasticsearchRepositoriesAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.data.jdbc.JdbcRepositoriesAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.data.jpa.JpaRepositoriesAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.data.ldap.LdapRepositoriesAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.data.mongo.MongoDataAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.data.mongo.MongoReactiveDataAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.data.mongo.MongoReactiveRepositoriesAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.data.mongo.MongoRepositoriesAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.data.neo4j.Neo4jDataAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.data.neo4j.Neo4jRepositoriesAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.data.solr.SolrRepositoriesAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.data.redis.RedisAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.data.redis.RedisReactiveAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.data.redis.RedisRepositoriesAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.data.rest.RepositoryRestMvcAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.data.web.SpringDataWebAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.elasticsearch.jest.JestAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.elasticsearch.rest.RestClientAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.flyway.FlywayAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.freemarker.FreeMarkerAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.gson.GsonAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.h2.H2ConsoleAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.hateoas.HypermediaAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.hazelcast.HazelcastAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.hazelcast.HazelcastJpaDependencyAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.http.HttpMessageConvertersAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.http.codec.CodecsAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.influx.InfluxDbAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.info.ProjectInfoAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.integration.IntegrationAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.jackson.JacksonAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.jdbc.JdbcTemplateAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.jdbc.JndiDataSourceAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.jdbc.XADataSourceAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.jdbc.DataSourceTransactionManagerAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.jms.JmsAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.jmx.JmxAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.jms.JndiConnectionFactoryAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.jms.activemq.ActiveMQAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.jms.artemis.ArtemisAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.groovy.template.GroovyTemplateAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.jersey.JerseyAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.jooq.JooqAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.jsonb.JsonbAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.kafka.KafkaAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.ldap.embedded.EmbeddedLdapAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.ldap.LdapAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.liquibase.LiquibaseAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.mail.MailSenderAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.mail.MailSenderValidatorAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.mongo.embedded.EmbeddedMongoAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.mongo.MongoAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.mongo.MongoReactiveAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.mustache.MustacheAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.orm.jpa.HibernateJpaAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.quartz.QuartzAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.reactor.core.ReactorCoreAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.security.servlet.SecurityAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.security.servlet.SecurityRequestMatcherProviderAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.security.servlet.UserDetailsServiceAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.security.servlet.SecurityFilterAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.security.reactive.ReactiveSecurityAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.security.reactive.ReactiveUserDetailsServiceAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.sendgrid.SendGridAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.session.SessionAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.security.oauth2.client.servlet.OAuth2ClientAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.security.oauth2.client.reactive.ReactiveOAuth2ClientAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.security.oauth2.resource.servlet.OAuth2ResourceServerAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.security.oauth2.resource.reactive.ReactiveOAuth2ResourceServerAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.solr.SolrAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.task.TaskExecutionAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.task.TaskSchedulingAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.thymeleaf.ThymeleafAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.transaction.TransactionAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.transaction.jta.JtaAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.validation.ValidationAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.web.client.RestTemplateAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.web.embedded.EmbeddedWebServerFactoryCustomizerAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.web.reactive.HttpHandlerAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.web.reactive.ReactiveWebServerFactoryAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.web.reactive.WebFluxAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.web.reactive.error.ErrorWebFluxAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.web.reactive.function.client.ClientHttpConnectorAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.web.reactive.function.client.WebClientAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.web.servlet.DispatcherServletAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.web.servlet.ServletWebServerFactoryAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.web.servlet.error.ErrorMvcAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.web.servlet.HttpEncodingAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.web.servlet.MultipartAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.web.servlet.WebMvcAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.websocket.reactive.WebSocketReactiveAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.websocket.servlet.WebSocketServletAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.websocket.servlet.WebSocketMessagingAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.webservices.WebServicesAutoConfiguration,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.webservices.client.WebServiceTemplateAutoConfiguration</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># Failure analyzers</span></span><br><span class="line"><span class="attr">org.springframework.boot.diagnostics.FailureAnalyzer</span>=<span class="string">\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.diagnostics.analyzer.NoSuchBeanDefinitionFailureAnalyzer,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.jdbc.DataSourceBeanCreationFailureAnalyzer,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.jdbc.HikariDriverConfigurationFailureAnalyzer,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.session.NonUniqueSessionRepositoryFailureAnalyzer</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># Template availability providers</span></span><br><span class="line"><span class="attr">org.springframework.boot.autoconfigure.template.TemplateAvailabilityProvider</span>=<span class="string">\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.freemarker.FreeMarkerTemplateAvailabilityProvider,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.mustache.MustacheTemplateAvailabilityProvider,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.groovy.template.GroovyTemplateAvailabilityProvider,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.thymeleaf.ThymeleafTemplateAvailabilityProvider,\</span></span><br><span class="line"><span class="string">org.springframework.boot.autoconfigure.web.servlet.JspTemplateAvailabilityProvider</span></span><br></pre></td></tr></table></figure>

<p>看到这里，是不是有一点解惑了，为什么我们什么都没有干，它就已经具备了那么多的功能。因为在项目启动的时候，已经就给我们内置了这么多的服务。</p>
<h5 id="3、容器在哪儿启动的？"><a href="#3、容器在哪儿启动的？" class="headerlink" title="3、容器在哪儿启动的？"></a>3、容器在哪儿启动的？</h5><h6 id="3-1-为什么是Tomcat默认启动？"><a href="#3-1-为什么是Tomcat默认启动？" class="headerlink" title="3.1 为什么是Tomcat默认启动？"></a>3.1 为什么是Tomcat默认启动？</h6><p>我们再回到开始的时候，为什么启动的时候看到了<code>Tomcat</code>的日志呢？</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">Connected to the target VM, address: &#x27;127.0.0.1:56945&#x27;, transport: &#x27;socket&#x27;</span><br><span class="line"></span><br><span class="line">  .   ____          _            __ _ _</span><br><span class="line"> /\\ / ___&#x27;_ __ _ _(_)_ __  __ _ \ \ \ \</span><br><span class="line">( ( )\___ | &#x27;_ | &#x27;_| | &#x27;_ \/ _` | \ \ \ \</span><br><span class="line"> \\/  ___)| |_)| | | | | || (_| |  ) ) ) )</span><br><span class="line">  &#x27;  |____| .__|_| |_|_| |_\__, | / / / /</span><br><span class="line"> =========|_|==============|___/=/_/_/_/</span><br><span class="line"> :: Spring Boot ::                        </span><br><span class="line"></span><br><span class="line">2019-06-13 09:15:11.818  INFO 16978 --- [           main] c.e.s.SpringBootDemoApplication          : Starting SpringBootDemoApplication on bogon with PID 16978 (/Users/chenyuan/Dropbox/Workspaces/IdeaProjects/spring-boot-demo/target/classes started by chenyuan in /Users/chenyuan/Dropbox/Workspaces/IdeaProjects/spring-src-leaning)</span><br><span class="line">2019-06-13 09:15:11.823  INFO 16978 --- [           main] c.e.s.SpringBootDemoApplication          : No active profile set, falling back to default profiles: default</span><br><span class="line"></span><br><span class="line">// 这里日志显示，有一个embedded的tomcat启动了8080端口</span><br><span class="line">2019-06-13 09:15:13.597  INFO 16978 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat initialized with port(s): 8080 (http)</span><br><span class="line">2019-06-13 09:15:13.644  INFO 16978 --- [           main] o.apache.catalina.core.StandardService   : Starting service [Tomcat]</span><br><span class="line">2019-06-13 09:15:13.645  INFO 16978 --- [           main] org.apache.catalina.core.StandardEngine  : Starting Servlet engine: [Apache Tomcat/9.0.14]</span><br><span class="line">2019-06-13 09:15:13.653  INFO 16978 --- [           main] o.a.catalina.core.AprLifecycleListener   : The APR based Apache Tomcat Native library which allows optimal performance in production environments was not found on the java.library.path: [/Users/chenyuan/Library/Java/Extensions:/Library/Java/Extensions:/Network/Library/Java/Extensions:/System/Library/Java/Extensions:/usr/lib/java:.]</span><br><span class="line">2019-06-13 09:15:13.752  INFO 16978 --- [           main] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring embedded WebApplicationContext</span><br><span class="line">2019-06-13 09:15:13.752  INFO 16978 --- [           main] o.s.web.context.ContextLoader            : Root WebApplicationContext: initialization completed in 1862 ms</span><br><span class="line">2019-06-13 09:15:14.018  INFO 16978 --- [           main] o.s.s.concurrent.ThreadPoolTaskExecutor  : Initializing ExecutorService &#x27;applicationTaskExecutor&#x27;</span><br><span class="line">2019-06-13 09:15:14.226  INFO 16978 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on port(s): 8080 (http) with context path &#x27;&#x27;</span><br><span class="line">2019-06-13 09:15:14.231  INFO 16978 --- [           main] c.e.s.SpringBootDemoApplication          : Started SpringBootDemoApplication in 3.007 seconds (JVM running for 3.924)</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># Auto Configure</span><br><span class="line">org.springframework.boot.autoconfigure.EnableAutoConfiguration=\</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.boot.autoconfigure.web.servlet.ServletWebServerFactoryAutoConfiguration</span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line">	<span class="meta">@ConditionalOnClass(name = &quot;org.apache.catalina.startup.Tomcat&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> TomcatServletWebServerFactoryCustomizer <span class="title function_">tomcatServletWebServerFactoryCustomizer</span><span class="params">(</span></span><br><span class="line"><span class="params">			ServerProperties serverProperties)</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TomcatServletWebServerFactoryCustomizer</span>(serverProperties);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p><img src="http://static.cyblogs.com/QQ20190614-085006@2x.jpg" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;QQ20190614-085006@2x.jpg"></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- spring-boot-demo/pom.xml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- spring-boot-starter-web/pom.xml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-tomcat<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- spring-boot-starters/spring-boot-starter-tomcat/pom.xml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat.embed<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat-embed-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat-annotations-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h6 id="3-2-如果要指定其他的容器呢？"><a href="#3-2-如果要指定其他的容器呢？" class="headerlink" title="3.2 如果要指定其他的容器呢？"></a>3.2 如果要指定其他的容器呢？</h6><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-tomcat<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-jetty<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>把项目中Tomca的starter注释掉，引入Jetty容器即可。</p>
<p>这么更换后，为什么就又能引入了呢？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.boot.autoconfigure.web.servlet.ServletWebServerFactoryConfiguration</span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(&#123; Servlet.class, Server.class, Loader.class,WebAppContext.class &#125;)</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean(value = ServletWebServerFactory.class, search = SearchStrategy.CURRENT)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">EmbeddedJetty</span> &#123;</span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="keyword">public</span> JettyServletWebServerFactory <span class="title function_">JettyServletWebServerFactory</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JettyServletWebServerFactory</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The <code>@ConditionalOnClass</code> and <code>@ConditionalOnMissingClass</code> annotations let <code>@Configuration</code> classes be included based on the presence or absence of specific classes. </p>
<p>这里的<code>Servlet.class, Server.class, Loader.class,WebAppContext.class</code> 就是Jetty里面的包。</p>
<p>这里还设计了一个工厂模式，获取一个WebServer。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ServletWebServerFactory</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Gets a new fully configured but paused &#123;<span class="doctag">@link</span> WebServer&#125; instance. Clients should</span></span><br><span class="line"><span class="comment">	 * not be able to connect to the returned server until &#123;<span class="doctag">@link</span> WebServer#start()&#125; is</span></span><br><span class="line"><span class="comment">	 * called (which happens when the &#123;<span class="doctag">@link</span> ApplicationContext&#125; has been fully</span></span><br><span class="line"><span class="comment">	 * refreshed).</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> initializers &#123;<span class="doctag">@link</span> ServletContextInitializer&#125;s that should be applied as</span></span><br><span class="line"><span class="comment">	 * the server starts</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> a fully configured and started &#123;<span class="doctag">@link</span> WebServer&#125;</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@see</span> WebServer#stop()</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	WebServer <span class="title function_">getWebServer</span><span class="params">(ServletContextInitializer... initializers)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="3-3-那是在什么时候初始化容器的呢？"><a href="#3-3-那是在什么时候初始化容器的呢？" class="headerlink" title="3.3 那是在什么时候初始化容器的呢？"></a>3.3 那是在什么时候初始化容器的呢？</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 第1步</span></span><br><span class="line">org.springframework.context.support.AbstractApplicationContext</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">refresh</span><span class="params">()</span> <span class="keyword">throws</span> BeansException, IllegalStateException &#123;</span><br><span class="line">  <span class="keyword">synchronized</span> (<span class="built_in">this</span>.startupShutdownMonitor) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// Initialize other special beans in specific context subclasses.</span></span><br><span class="line">      onRefresh();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 第2步</span></span><br><span class="line">org.springframework.boot.web.servlet.context.ServletWebServerApplicationContext</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onRefresh</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="built_in">super</span>.onRefresh();</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		createWebServer();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ApplicationContextException</span>(<span class="string">&quot;Unable to start web server&quot;</span>, ex);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 第3步</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">createWebServer</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="type">WebServer</span> <span class="variable">webServer</span> <span class="operator">=</span> <span class="built_in">this</span>.webServer;</span><br><span class="line">	<span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> getServletContext();</span><br><span class="line">	<span class="keyword">if</span> (webServer == <span class="literal">null</span> &amp;&amp; servletContext == <span class="literal">null</span>) &#123;</span><br><span class="line">		<span class="type">ServletWebServerFactory</span> <span class="variable">factory</span> <span class="operator">=</span> getWebServerFactory();</span><br><span class="line">		<span class="built_in">this</span>.webServer = factory.getWebServer(getSelfInitializer());</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (servletContext != <span class="literal">null</span>) &#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			getSelfInitializer().onStartup(servletContext);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (ServletException ex) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ApplicationContextException</span>(<span class="string">&quot;Cannot initialize servlet context&quot;</span>,</span><br><span class="line">					ex);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	initPropertySources();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在看到<code>factory.getWebServer</code>，是不是就全部都串联起来了？</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.cyblogs.com/2019/06/05/2019/06/%E7%BB%99%E4%B8%80%E4%B8%AA%E5%8D%B3%E5%B0%86%E5%A4%A7%E5%AD%A6%E6%AF%95%E4%B8%9A%E5%90%8C%E5%AD%A6%E7%9A%84%E5%9B%9E%E5%A4%8D/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/vernonchen.jpg">
      <meta itemprop="name" content="Vernon">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简栈文化">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | 简栈文化">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/06/05/2019/06/%E7%BB%99%E4%B8%80%E4%B8%AA%E5%8D%B3%E5%B0%86%E5%A4%A7%E5%AD%A6%E6%AF%95%E4%B8%9A%E5%90%8C%E5%AD%A6%E7%9A%84%E5%9B%9E%E5%A4%8D/" class="post-title-link" itemprop="url">给一个即将大学毕业同学的回复</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-06-05 00:00:00" itemprop="dateCreated datePublished" datetime="2019-06-05T00:00:00+08:00">2019-06-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-06-25 09:57:28" itemprop="dateModified" datetime="2025-06-25T09:57:28+08:00">2025-06-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%80%9D%E8%80%83/" itemprop="url" rel="index"><span itemprop="name">思考</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="1、问："><a href="#1、问：" class="headerlink" title="1、问："></a>1、问：</h4><h5 id="1-1、开发岗与算法岗的选择"><a href="#1-1、开发岗与算法岗的选择" class="headerlink" title="1.1、开发岗与算法岗的选择"></a>1.1、开发岗与算法岗的选择</h5><p>听同学说，开发岗相对于算法岗没有那么看重学历，更看重技术。而学习开发不如不读研，工作三年在公司的学习肯定比读研学习三年要好。算法的话，一般本科生是不会接触的，至少要研究生，这就可以发挥读研的优势，但是竞争也会更激烈，岗位相对较少，要求更高。</p>
<p>我自己对于算法，只看过一些最基础的机器学习视频。对于开发，本科学过<code>Java</code>，<code>C</code>,<code>C++</code>,有一定的编程能力。但是因为没有做过项目，没有过实习经验，对于一些业务，框架，设计模式，优化等几乎没有概念，也不知道在公司工作具体是要做些什么，对开发人员的要求是什么。</p>
<p>因为对这两者，都没有进行过深入的学习，所以也谈不上喜欢和不喜欢。所以也有人问，你喜欢哪个方向就可以尝试着去学，但我就是觉得在对一个东西不了解的情况下，谈不上好恶。</p>
<h5 id="1-2、前端后台的学习方法"><a href="#1-2、前端后台的学习方法" class="headerlink" title="1.2、前端后台的学习方法"></a>1.2、前端后台的学习方法</h5><p>因为一直以来受到的教育就是从0一步步学起，包括高考和考研，那是一种教科书式的学习。一直以来我也是用的这一套学习方法来学习开发，发现四处碰壁。比如我在完全不会前端的情况下，就从最基础的<code>HTML</code>，<code>CSS</code>学起，发现这些知识很简单，但是又特别多，特别杂乱，没办法坚持学下去。学完以后还要学<code>JS</code>，<code>ES6</code>语法，然后学习<code>React</code>框架这些。这样一步步学起了，已经不可能有那么多时间弄别的了，而且学习效率也是极低。</p>
<p>后来要同学告诉我要转变这些学习方法，要根据需求来学习，需要什么就学什么，要我好好利用<code>Github</code>，各大博客，好好学习别人的代码，和源码，然后自己尝试做一些项目，边做边学习，边总结。但是在这过程中也是困难重重，比如<code>Github</code>上看别人代码也看不太懂，自己做项目，也不知道拍脑袋做个什么项目出来，脑子是空白的。</p>
<p>之所以说前端，是因为好像看到很多做开发的同学，他们都是前端后台通吃，他们说都需要了解，竞争力会强一点，做全栈。如果倾向于做后台的话，前端大概要学习到什么程度。</p>
<p>我们实验室听说还有人去了华为的数据库组，完全不知道专门的数据库组是做什么的。</p>
<h5 id="1-3-对于acm和leetcode刷题"><a href="#1-3-对于acm和leetcode刷题" class="headerlink" title="1.3. 对于acm和leetcode刷题"></a>1.3. 对于acm和leetcode刷题</h5><p>本科唯一学过一段时间的，就是刷这些算法题。这些究竟对于公司做项目有没有用，还是说只是锻炼了逻辑思维，是能力的一种体现。如果为以后准备面试笔试，需不需要从现在开始每天刷几道题保持手感。</p>
<h5 id="1-4-开发岗的行情"><a href="#1-4-开发岗的行情" class="headerlink" title="1.4. 开发岗的行情"></a>1.4. 开发岗的行情</h5><p>这个差不多是问题1的详细。师兄的公司或者互联网公司，大多数真的是996这样的工作时间吗。另外它的工资水平和发展前景是什么样的，据说有按等级划分。还有同学说过程序员吃青春饭这一套，没有晋升到管理层，就容易被裁掉一说。做开发真的很辛苦吗。</p>
<p>总结下来，就是想向师兄了解一下，两种岗位的选择，开发岗的行情，开发的学习方法。</p>
<h4 id="2、答"><a href="#2、答" class="headerlink" title="2、答"></a>2、答</h4><p>首先值得肯定，写的很棒，是带思考的。</p>
<p>“思想比行动重要”这点是我最近几年才想明白的，以前我都觉得行动比思想重要，不喜欢天马行空。我们都是工科思维，讲行动、讲落地。但忽略一个前提，我们需要一个好的思想去引导。如果养成一个独立思考的能力，总能从不同的视角去看待问题，抛开其他不说，你就已经走在了所有人去前列。</p>
<p>回到你的问题，我站在我个人的角度谈谈，但最终你自己来判断。</p>
<h5 id="2-1、关于开发岗与算法岗"><a href="#2-1、关于开发岗与算法岗" class="headerlink" title="2.1、关于开发岗与算法岗"></a>2.1、关于开发岗与算法岗</h5><p>看了描述里面应该算是2个问题，一个是开发工程师与算法工程师的门槛。另外一个是读研与直接参加工作带来的效益谁好？</p>
<p>首先开发与算法工程师做的事情是不同的。不得不是说，算法工程师对于学历、专业深度会更深入。</p>
<p>**算法工程师：**可能更多偏向于数学、物理、生物等，只是他用计算机语言来实现。</p>
<p>**开发工程师：**需要理解业务、产品、以及架构能力，还有对于框架的应用，考虑更多的时候如何利用更多的工具造出更大、更高的建筑；</p>
<h5 id="2-2、前端与后端的学习"><a href="#2-2、前端与后端的学习" class="headerlink" title="2.2、前端与后端的学习"></a>2.2、前端与后端的学习</h5><p>在几年前，我们还在说前端没有什么搞头，还是后端的路子多一些，确实如此，后端才是这课树下面的根。但随着计算机技术的发展，现在前端也变得越来越强、越来越多样化。包括在写法与语法上都已经跟后端相似了。</p>
<p>**后端：**注重系统的并发、高可用、稳定、安全、业务的分割、问题的定位、大数据分析等等；</p>
<p>**前端：**注重渲染、交互、动画等等（前端我不是很专业，所以说不出太多所以然）</p>
<p>如果说按照薪水来划分，现在前端反而优势更明显，但是后面会稍微的遇到一些屏障，但不会太大。</p>
<p>再谈你说好多东西需要学习，那是肯定的。后端需要掌握的东西更多，你到后面会有一种感觉那就是：知识永远学习不完，了解底层的东西才是重要的。而且要知其然还要知其所以然。还有你会觉得知道的越多，越觉得自己了解的少。</p>
<p>在现在的行情里面，前后通吃是有必要的，因为前后是需要相互配合的。只有了解前端或者后端是如何做的，在沟通上或者设计上才会考虑的更全面。哪天真的如果自己要创业或者需要前后都自己上，那也显得很从容嘛！</p>
<h5 id="2-3、关于刷题"><a href="#2-3、关于刷题" class="headerlink" title="2.3、关于刷题"></a>2.3、关于刷题</h5><p>对于刚刚毕业的同学，这个是很重要的。因为缺少社会经验与项目经验，那么在一些原理、理论上的知识显得格外重要。刷题跟做试卷类似，做的越多，知道的也就越多。而且面试官也很看重这些东西，如果去BAT或者TMD这些公司，这些是必然的过关内容。</p>
<h5 id="2-4、职业生涯的发展"><a href="#2-4、职业生涯的发展" class="headerlink" title="2.4、职业生涯的发展"></a>2.4、职业生涯的发展</h5><p>如果是走技术，前期基本都是一样的，后期就会因人而异。</p>
<p>**基本的一个成长历程：**初级开发→中级开发→高级开发→资深&#x2F;专家开发→架构师→技术总监→CTO。</p>
<p>在高级或者资深这里，就会有分歧，这个也要看性格。</p>
<p>**纯技术：**有的人就喜欢钻研技术、喜欢算法等，想下沉到最底层去，那就走纯技术路线，但道路会非常的孤独，如果真的是有所突破，那就是一下子出人头地。</p>
<p>**偏管理：**首先是自己有一定的技术沉淀，后面就开始带领团队做事情了，更多的是跟人打交道，如何合理的分配、拆分需求等。对公司技术发展的整体规划，包括：技术、业务、人力等。</p>
<p>对于薪水，我觉得你完全不用担心，每个岗位都有他的平均水平。而且薪水与能力直接挂钩，与年纪没有必然的关系。然而，我觉得出来工作或者自己创业，都非常辛苦。天上不会掉馅饼，拿一份不辛苦还能那很多的钱的差事儿理论上不应该有，除非是富二代。但是，后期我们如果能做一些理财，我们的收入不完全靠一份薪水，我们也许不会那么累。</p>
<p>关于996，这个话题我也不好说。加班是很辛苦，确实也会带来一些成长，但我们不都会要求强制加班，相对还是比较自由。部分公司，加班是有加班费用或者补贴的。没结婚之前，估计对996没有那么介意，如果有家庭后，需要平衡家庭与工作的关系，可能会介意。</p>
<h5 id="2-5、总结"><a href="#2-5、总结" class="headerlink" title="2.5、总结"></a>2.5、总结</h5><p>上面说了这些，都是针对你的问题做的一个回复。但任何东西都会存在一些方法，我把我觉得参加工作后的一些心得分享给你，希望对你有一定的帮助，还是那句话：我瞎说，你自己来判断。</p>
<p>1、无论在哪儿，我们最终一定都是解决一个问题，避免不了跟人打交道，所以认识人是到一个新环境里面最先要做的事情，后面做的就是如何让人认识你了；</p>
<p>2、要逐步逐步的认识自己，这点很难却很重要。因为，自己大多的不开心或者郁闷，都是对于自己不认识造成的，比如：自己找不到目标；做的事情开始喜欢后面就不喜欢了；为什么做事情不够洒脱，顾着顾拿。总之就是让自己不盲目、越快的做事情；</p>
<p>3、人生是分阶段的，每个阶段做好每个阶段的事情就好了。但每个阶段时间长短是可以控制的，看如何突破自己的认知，一般可以找一个偶像作为目标，或者通过阅读来突破自己；</p>
<p>4、专业知识要成体系，不能是零零碎碎的，串联不起来。有的人是广度优先，后面找出一个喜欢的，在深度进去；还有人是深度优先，在某一个专业先扎根，然后再在周边扩展自己的广度。这个我觉得都行，看每个人的性格或者看当前你是否找到了喜好。</p>
<p>5、要学习的东西真的很多，但底层的东西并没有那么多。但很难说一开始就扎入到底层去，因为是有门槛的。大多数人都是先学会使用，知道一个API是如何如何的~ 后面才会去阅读源代码，跟其他同类型的做对比。看源代码是一个非常有意思的事情，看的越多越觉得简单。不过，刚刚开始肯定是相当痛苦的。</p>
<p>6、实践是检验真理的唯一标准！没错啊，很多东西没有捷径，那就是多做。对于开发来说，那就是多写代码，看一遍与敲一遍，完全不是同一个概念。</p>
<p>7、时间管理，到后面每个人的时间都是零碎的，被打断的。如何留给自己足够的时间是一门学门，可以多学习一些时间管理的方法；</p>
<p>8、保持一些原则性的东西会让自己活得简单些，符合的我就要，不符合的就不碰他。比如：</p>
<ul>
<li>尊重每一个人的意见；</li>
<li>拥有开放的心态，不要先排斥；</li>
<li>拥有较强的业务，技术的专业度；</li>
<li>拆分与总结能力；</li>
<li>良好的沟通能力；</li>
<li>一定的创新能力；</li>
</ul>
<p>每个人的人生道路轨迹都一样，自己走的路自己来把握。希望你可以走出一条星光大道出来。</p>
<p>仅供你参考。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="上一页" aria-label="上一页" href="/page/14/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/14/">14</a><span class="page-number current">15</span>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Vernon</span>
  </div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
    <a target="_blank" href="https://beian.miit.gov.cn">粤ICP备2025433887号</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
