<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"www.cyblogs.com","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.23.1","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js" defer></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="简栈文化">
<meta property="og:url" content="http://www.cyblogs.com/page/9/index.html">
<meta property="og:site_name" content="简栈文化">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Vernon">
<meta property="article:tag" content="Java">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://www.cyblogs.com/page/9/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/9/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>简栈文化</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  






  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="简栈文化" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">简栈文化</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">Java技术人的成长之路~</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Vernon"
      src="/images/vernonchen.jpg">
  <p class="site-author-name" itemprop="name">Vernon</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">149</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">66</span>
        <span class="site-state-item-name">分类</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">87</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/chengcheng222e" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;chengcheng222e" rel="noopener me" target="_blank"><i class="github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:chengcheng222e@gmail.com" title="E-Mail → mailto:chengcheng222e@gmail.com" rel="noopener me" target="_blank"><i class="envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.cyblogs.com/2020/02/28/2020/02/Netty%20%E7%B3%BB%E5%88%97%E4%B9%8B%20Netty%20%E9%AB%98%E6%80%A7%E8%83%BD%E4%B9%8B%E9%81%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/vernonchen.jpg">
      <meta itemprop="name" content="Vernon">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简栈文化">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | 简栈文化">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/02/28/2020/02/Netty%20%E7%B3%BB%E5%88%97%E4%B9%8B%20Netty%20%E9%AB%98%E6%80%A7%E8%83%BD%E4%B9%8B%E9%81%93/" class="post-title-link" itemprop="url">Netty 系列之 Netty 高性能之道</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-02-28 00:00:00" itemprop="dateCreated datePublished" datetime="2020-02-28T00:00:00+08:00">2020-02-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-06-25 09:56:28" itemprop="dateModified" datetime="2025-06-25T09:56:28+08:00">2025-06-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Netty/" itemprop="url" rel="index"><span itemprop="name">Netty</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="1-背景"><a href="#1-背景" class="headerlink" title="1. 背景"></a>1. 背景</h2><h3 id="1-1-惊人的性能数据"><a href="#1-1-惊人的性能数据" class="headerlink" title="1.1. 惊人的性能数据"></a>1.1. 惊人的性能数据</h3><p>最近一个圈内朋友通过私信告诉我，通过使用 Netty4 + Thrift 压缩二进制编解码技术，他们实现了 10W TPS（1K 的复杂 POJO 对象）的跨节点远程服务调用。相比于传统基于 Java 序列化 +BIO（同步阻塞 IO）的通信框架，性能提升了 8 倍多。</p>
<p>事实上，我对这个数据并不感到惊讶，根据我 5 年多的 NIO 编程经验，通过选择合适的 NIO 框架，加上高性能的压缩二进制编解码技术，精心的设计 Reactor 线程模型，达到上述性能指标是完全有可能的。</p>
<p>下面我们就一起来看下 Netty 是如何支持 10W TPS 的跨节点远程服务调用的，在正式开始讲解之前，我们先简单介绍下 Netty。</p>
<h3 id="1-2-Netty-基础入门"><a href="#1-2-Netty-基础入门" class="headerlink" title="1.2. Netty 基础入门"></a>1.2. Netty 基础入门</h3><p>Netty 是一个高性能、异步事件驱动的 NIO 框架，它提供了对 TCP、UDP 和文件传输的支持，作为一个异步 NIO 框架，Netty 的所有 IO 操作都是异步非阻塞的，通过 Future-Listener 机制，用户可以方便的主动获取或者通过通知机制获得 IO 操作结果。</p>
<p>作为当前最流行的 NIO 框架，Netty 在互联网领域、大数据分布式计算领域、游戏行业、通信行业等获得了广泛的应用，一些业界著名的开源组件也基于 Netty 的 NIO 框架构建。</p>
<h2 id="2-Netty-高性能之道"><a href="#2-Netty-高性能之道" class="headerlink" title="2. Netty 高性能之道"></a>2. Netty 高性能之道</h2><h3 id="2-1-RPC-调用的性能模型分析"><a href="#2-1-RPC-调用的性能模型分析" class="headerlink" title="2.1. RPC 调用的性能模型分析"></a>2.1. RPC 调用的性能模型分析</h3><h4 id="2-1-1-传统-RPC-调用性能差的三宗罪"><a href="#2-1-1-传统-RPC-调用性能差的三宗罪" class="headerlink" title="2.1.1. 传统 RPC 调用性能差的三宗罪"></a><strong>2.1.1.</strong> 传统 RPC 调用性能差的三宗罪</h4><p>网络传输方式问题：传统的 RPC 框架或者基于 RMI 等方式的远程服务（过程）调用采用了同步阻塞 IO，当客户端的并发压力或者网络时延增大之后，同步阻塞 IO 会由于频繁的 wait 导致 IO 线程经常性的阻塞，由于线程无法高效的工作，IO 处理能力自然下降。</p>
<p>下面，我们通过 BIO 通信模型图看下 BIO 通信的弊端：</p>
<p><img src="http://static.cyblogs.com/8ca1bcf701494b7fe2751cf65686f6b0.png" alt="Netty系列之Netty高性能之道"></p>
<p>图 2-1 BIO 通信模型图</p>
<p>采用 BIO 通信模型的服务端，通常由一个独立的 Acceptor 线程负责监听客户端的连接，接收到客户端连接之后为客户端连接创建一个新的线程处理请求消息，处理完成之后，返回应答消息给客户端，线程销毁，这就是典型的一请求一应答模型。该架构最大的问题就是不具备弹性伸缩能力，当并发访问量增加后，服务端的线程个数和并发访问数成线性正比，由于线程是 JAVA 虚拟机非常宝贵的系统资源，当线程数膨胀之后，系统的性能急剧下降，随着并发量的继续增加，可能会发生句柄溢出、线程堆栈溢出等问题，并导致服务器最终宕机。</p>
<p>序列化方式问题：Java 序列化存在如下几个典型问题：</p>
<ol>
<li><p>Java 序列化机制是 Java 内部的一种对象编解码技术，无法跨语言使用；例如对于异构系统之间的对接，Java 序列化后的码流需要能够通过其它语言反序列化成原始对象（副本），目前很难支持；</p>
</li>
<li><p>相比于其它开源的序列化框架，Java 序列化后的码流太大，无论是网络传输还是持久化到磁盘，都会导致额外的资源占用；</p>
</li>
<li><p>序列化性能差（CPU 资源占用高）。</p>
</li>
</ol>
<p>线程模型问题：由于采用同步阻塞 IO，这会导致每个 TCP 连接都占用 1 个线程，由于线程资源是 JVM 虚拟机非常宝贵的资源，当 IO 读写阻塞导致线程无法及时释放时，会导致系统性能急剧下降，严重的甚至会导致虚拟机无法创建新的线程。</p>
<h4 id="2-1-2-高性能的三个主题"><a href="#2-1-2-高性能的三个主题" class="headerlink" title="2.1.2. 高性能的三个主题"></a>2.1.2. 高性能的三个主题</h4><ol>
<li><p>传输：用什么样的通道将数据发送给对方，BIO、NIO 或者 AIO，IO 模型在很大程度上决定了框架的性能。</p>
</li>
<li><p>协议：采用什么样的通信协议，HTTP 或者内部私有协议。协议的选择不同，性能模型也不同。相比于公有协议，内部私有协议的性能通常可以被设计的更优。</p>
</li>
<li><p>线程：数据报如何读取？读取之后的编解码在哪个线程进行，编解码后的消息如何派发，Reactor 线程模型的不同，对性能的影响也非常大。</p>
</li>
</ol>
<p><img src="http://static.cyblogs.com/ca8d3401818a753f5e4db89f5ccf208b.png" alt="Netty系列之Netty高性能之道"></p>
<p>图 2-2 RPC 调用性能三要素</p>
<h3 id="2-2-Netty-高性能之道"><a href="#2-2-Netty-高性能之道" class="headerlink" title="2.2. Netty 高性能之道"></a>2.2. Netty 高性能之道</h3><h4 id="2-2-1-异步非阻塞通信"><a href="#2-2-1-异步非阻塞通信" class="headerlink" title="2.2.1. 异步非阻塞通信"></a>2.2.1. 异步非阻塞通信</h4><p>在 IO 编程过程中，当需要同时处理多个客户端接入请求时，可以利用多线程或者 IO 多路复用技术进行处理。IO 多路复用技术通过把多个 IO 的阻塞复用到同一个 select 的阻塞上，从而使得系统在单线程的情况下可以同时处理多个客户端请求。与传统的多线程 &#x2F; 多进程模型比，I&#x2F;O 多路复用的最大优势是系统开销小，系统不需要创建新的额外进程或者线程，也不需要维护这些进程和线程的运行，降低了系统的维护工作量，节省了系统资源。</p>
<p>JDK1.4 提供了对非阻塞 IO（NIO）的支持，JDK1.5_update10 版本使用 epoll 替代了传统的 select&#x2F;poll，极大的提升了 NIO 通信的性能。</p>
<p>JDK NIO 通信模型如下所示：</p>
<p><img src="http://static.cyblogs.com/cd19b81ba8b3ce114cc8346f877c8d36.png" alt="Netty系列之Netty高性能之道"></p>
<p>图 2-3 NIO 的多路复用模型图</p>
<p>与 Socket 类和 ServerSocket 类相对应，NIO 也提供了 SocketChannel 和 ServerSocketChannel 两种不同的套接字通道实现。这两种新增的通道都支持阻塞和非阻塞两种模式。阻塞模式使用非常简单，但是性能和可靠性都不好，非阻塞模式正好相反。开发人员一般可以根据自己的需要来选择合适的模式，一般来说，低负载、低并发的应用程序可以选择同步阻塞 IO 以降低编程复杂度。但是对于高负载、高并发的网络应用，需要使用 NIO 的非阻塞模式进行开发。</p>
<p>Netty 架构按照 Reactor 模式设计和实现，它的服务端通信序列图如下：</p>
<p><img src="http://static.cyblogs.com/f93b86a561ec3b494e021251b1cd2997.png" alt="Netty系列之Netty高性能之道"></p>
<p>图 2-3 NIO 服务端通信序列图</p>
<p>客户端通信序列图如下：</p>
<p><img src="http://static.cyblogs.com/38d04bb5c140733668fccdd7a2e63955.png" alt="Netty系列之Netty高性能之道"></p>
<p>图 2-4 NIO 客户端通信序列图</p>
<p>Netty 的 IO 线程 NioEventLoop 由于聚合了多路复用器 Selector，可以同时并发处理成百上千个客户端 Channel，由于读写操作都是非阻塞的，这就可以充分提升 IO 线程的运行效率，避免由于频繁 IO 阻塞导致的线程挂起。另外，由于 Netty 采用了异步通信模式，一个 IO 线程可以并发处理 N 个客户端连接和读写操作，这从根本上解决了传统同步阻塞 IO 一连接一线程模型，架构的性能、弹性伸缩能力和可靠性都得到了极大的提升。</p>
<h4 id="2-2-2-零拷贝"><a href="#2-2-2-零拷贝" class="headerlink" title="2.2.2. 零拷贝"></a>2.2.2. 零拷贝</h4><p>很多用户都听说过 Netty 具有“零拷贝”功能，但是具体体现在哪里又说不清楚，本小节就详细对 Netty 的“零拷贝”功能进行讲解。</p>
<p>Netty 的“零拷贝”主要体现在如下三个方面：</p>
<ol>
<li><p>Netty 的接收和发送 ByteBuffer 采用 DIRECT BUFFERS，使用堆外直接内存进行 Socket 读写，不需要进行字节缓冲区的二次拷贝。如果使用传统的堆内存（HEAP BUFFERS）进行 Socket 读写，JVM 会将堆内存 Buffer 拷贝一份到直接内存中，然后才写入 Socket 中。相比于堆外直接内存，消息在发送过程中多了一次缓冲区的内存拷贝。</p>
</li>
<li><p>Netty 提供了组合 Buffer 对象，可以聚合多个 ByteBuffer 对象，用户可以像操作一个 Buffer 那样方便的对组合 Buffer 进行操作，避免了传统通过内存拷贝的方式将几个小 Buffer 合并成一个大的 Buffer。</p>
</li>
<li><p>Netty 的文件传输采用了 transferTo 方法，它可以直接将文件缓冲区的数据发送到目标 Channel，避免了传统通过循环 write 方式导致的内存拷贝问题。</p>
</li>
</ol>
<p>下面，我们对上述三种“零拷贝”进行说明，先看 Netty 接收 Buffer 的创建：</p>
<p><img src="http://static.cyblogs.com/d8a16823a5388d5294854b56e924c6a9.png" alt="Netty系列之Netty高性能之道"></p>
<p>图 2-5 异步消息读取“零拷贝”</p>
<p>每循环读取一次消息，就通过 ByteBufAllocator 的 ioBuffer 方法获取 ByteBuf 对象，下面继续看它的接口定义：</p>
<p><img src="http://static.cyblogs.com/02bad615aad4f63a9c320a2cd1a48c56.png" alt="Netty系列之Netty高性能之道"></p>
<p>图 2-6 ByteBufAllocator 通过 ioBuffer 分配堆外内存</p>
<p>当进行 Socket IO 读写的时候，为了避免从堆内存拷贝一份副本到直接内存，Netty 的 ByteBuf 分配器直接创建非堆内存避免缓冲区的二次拷贝，通过“零拷贝”来提升读写性能。</p>
<p>下面我们继续看第二种“零拷贝”的实现 CompositeByteBuf，它对外将多个 ByteBuf 封装成一个 ByteBuf，对外提供统一封装后的 ByteBuf 接口，它的类定义如下：</p>
<p><img src="http://static.cyblogs.com/2d1991a4e16f7e80228ea2631e867ad0.png" alt="Netty系列之Netty高性能之道"></p>
<p>图 2-7 CompositeByteBuf 类继承关系</p>
<p>通过继承关系我们可以看出 CompositeByteBuf 实际就是个 ByteBuf 的包装器，它将多个 ByteBuf 组合成一个集合，然后对外提供统一的 ByteBuf 接口，相关定义如下：</p>
<p><img src="http://static.cyblogs.com/06a1cd492e7c498b05fe1425f497cefe.png" alt="Netty系列之Netty高性能之道"></p>
<p>图 2-8 CompositeByteBuf 类定义</p>
<p>添加 ByteBuf，不需要做内存拷贝，相关代码如下：</p>
<p><img src="http://static.cyblogs.com/bf2a7f95922a4d60c595619f83219a4e.png" alt="Netty系列之Netty高性能之道"></p>
<p>图 2-9 新增 ByteBuf 的“零拷贝”</p>
<p>最后，我们看下文件传输的“零拷贝”：</p>
<p><img src="http://static.cyblogs.com/9be2e987db0dda83da570c667d927047.png" alt="Netty系列之Netty高性能之道"></p>
<p>图 2-10 文件传输“零拷贝”</p>
<p>Netty 文件传输 DefaultFileRegion 通过 transferTo 方法将文件发送到目标 Channel 中，下面重点看 FileChannel 的 transferTo 方法，它的 API DOC 说明如下：</p>
<p><img src="http://static.cyblogs.com/4efc573ec343f5ae4947aa5d729294c3.png" alt="Netty系列之Netty高性能之道"></p>
<p>图 2-11 文件传输 “零拷贝”</p>
<p>对于很多操作系统它直接将文件缓冲区的内容发送到目标 Channel 中，而不需要通过拷贝的方式，这是一种更加高效的传输方式，它实现了文件传输的“零拷贝”。</p>
<h4 id="2-2-3-内存池"><a href="#2-2-3-内存池" class="headerlink" title="2.2.3. 内存池"></a>2.2.3. 内存池</h4><p>随着 JVM 虚拟机和 JIT 即时编译技术的发展，对象的分配和回收是个非常轻量级的工作。但是对于缓冲区 Buffer，情况却稍有不同，特别是对于堆外直接内存的分配和回收，是一件耗时的操作。为了尽量重用缓冲区，Netty 提供了基于内存池的缓冲区重用机制。下面我们一起看下 Netty ByteBuf 的实现：</p>
<p><img src="http://static.cyblogs.com/0d9692e17bb3043beb02d33dbecac08c.png" alt="Netty系列之Netty高性能之道"></p>
<p>图 2-12 内存池 ByteBuf</p>
<p>Netty 提供了多种内存管理策略，通过在启动辅助类中配置相关参数，可以实现差异化的定制。</p>
<p>下面通过性能测试，我们看下基于内存池循环利用的 ByteBuf 和普通 ByteBuf 的性能差异。</p>
<p>用例一，使用内存池分配器创建直接内存缓冲区：</p>
<p><img src="http://static.cyblogs.com/8507ccdefc46002a1ad0b4ead8d7a0cd.png" alt="Netty系列之Netty高性能之道"></p>
<p>图 2-13 基于内存池的非堆内存缓冲区测试用例</p>
<p>用例二，使用非堆内存分配器创建的直接内存缓冲区：</p>
<p><img src="http://static.cyblogs.com/c65837b68656af7d15f18bbca2768e06.png" alt="Netty系列之Netty高性能之道"></p>
<p>图 2-14 基于非内存池创建的非堆内存缓冲区测试用例</p>
<p>各执行 300 万次，性能对比结果如下所示：</p>
<p><img src="http://static.cyblogs.com/b5851489d3fb28a6e323d839abbc89ec.png" alt="Netty系列之Netty高性能之道"></p>
<p>图 2-15 内存池和非内存池缓冲区写入性能对比</p>
<p>性能测试表明，采用内存池的 ByteBuf 相比于朝生夕灭的 ByteBuf，性能高 23 倍左右（性能数据与使用场景强相关）。</p>
<p>下面我们一起简单分析下 Netty 内存池的内存分配：</p>
<p><img src="http://static.cyblogs.com/ce56ef417f28d249fa7cc9a639693302.png" alt="Netty系列之Netty高性能之道"></p>
<p>图 2-16 AbstractByteBufAllocator 的缓冲区分配</p>
<p>继续看 newDirectBuffer 方法，我们发现它是一个抽象方法，由 AbstractByteBufAllocator 的子类负责具体实现，代码如下：</p>
<p><img src="http://static.cyblogs.com/030cc27df48180894970645a7fa2f25f.png" alt="Netty系列之Netty高性能之道"></p>
<p>图 2-17 newDirectBuffer 的不同实现</p>
<p>代码跳转到 PooledByteBufAllocator 的 newDirectBuffer 方法，从 Cache 中获取内存区域 PoolArena，调用它的 allocate 方法进行内存分配：</p>
<p><img src="http://static.cyblogs.com/fc924c121fcfe8db907cc4cb7355225e.png" alt="Netty系列之Netty高性能之道"></p>
<p>图 2-18 PooledByteBufAllocator 的内存分配</p>
<p>PoolArena 的 allocate 方法如下：</p>
<p><img src="http://static.cyblogs.com/d83ac0ed80161b86c8aaf5d0f742157f.png" alt="Netty系列之Netty高性能之道"></p>
<p>图 2-18 PoolArena 的缓冲区分配</p>
<p>我们重点分析 newByteBuf 的实现，它同样是个抽象方法，由子类 DirectArena 和 HeapArena 来实现不同类型的缓冲区分配，由于测试用例使用的是堆外内存，</p>
<p><img src="http://static.cyblogs.com/95c123255dbe919bdf44ee9fbcaa37fa.png" alt="Netty系列之Netty高性能之道"></p>
<p>图 2-19 PoolArena 的 newByteBuf 抽象方法</p>
<p>因此重点分析 DirectArena 的实现：如果没有开启使用 sun 的 unsafe，则</p>
<p><img src="http://static.cyblogs.com/2a86bca51226e567d0c7e13a5ab7a3fa.png" alt="Netty系列之Netty高性能之道"></p>
<p>图 2-20 DirectArena 的 newByteBuf 方法实现</p>
<p>执行 PooledDirectByteBuf 的 newInstance 方法，代码如下：</p>
<p><img src="http://static.cyblogs.com/f5580a2110cefcb8a6206080de95329b.png" alt="Netty系列之Netty高性能之道"></p>
<p>图 2-21 PooledDirectByteBuf 的 newInstance 方法实现</p>
<p>通过 RECYCLER 的 get 方法循环使用 ByteBuf 对象，如果是非内存池实现，则直接创建一个新的 ByteBuf 对象。从缓冲池中获取 ByteBuf 之后，调用 AbstractReferenceCountedByteBuf 的 setRefCnt 方法设置引用计数器，用于对象的引用计数和内存回收（类似 JVM 垃圾回收机制）。</p>
<h4 id="2-2-4-高效的-Reactor-线程模型"><a href="#2-2-4-高效的-Reactor-线程模型" class="headerlink" title="2.2.4. 高效的 Reactor 线程模型"></a>2.2.4. 高效的 Reactor 线程模型</h4><p>常用的 Reactor 线程模型有三种，分别如下：</p>
<ol>
<li><p>Reactor 单线程模型；</p>
</li>
<li><p>Reactor 多线程模型；</p>
</li>
<li><p>主从 Reactor 多线程模型</p>
</li>
</ol>
<p>Reactor 单线程模型，指的是所有的 IO 操作都在同一个 NIO 线程上面完成，NIO 线程的职责如下：</p>
<ol>
<li><p>作为 NIO 服务端，接收客户端的 TCP 连接；</p>
</li>
<li><p>作为 NIO 客户端，向服务端发起 TCP 连接；</p>
</li>
<li><p>读取通信对端的请求或者应答消息；</p>
</li>
<li><p>向通信对端发送消息请求或者应答消息。</p>
</li>
</ol>
<p>Reactor 单线程模型示意图如下所示：</p>
<p><img src="http://static.cyblogs.com/c9540842e8aa5c39a5c81633fcce4e50.png" alt="Netty系列之Netty高性能之道"></p>
<p>图 2-22 Reactor 单线程模型</p>
<p>由于 Reactor 模式使用的是异步非阻塞 IO，所有的 IO 操作都不会导致阻塞，理论上一个线程可以独立处理所有 IO 相关的操作。从架构层面看，一个 NIO 线程确实可以完成其承担的职责。例如，通过 Acceptor 接收客户端的 TCP 连接请求消息，链路建立成功之后，通过 Dispatch 将对应的 ByteBuffer 派发到指定的 Handler 上进行消息解码。用户 Handler 可以通过 NIO 线程将消息发送给客户端。</p>
<p>对于一些小容量应用场景，可以使用单线程模型。但是对于高负载、大并发的应用却不合适，主要原因如下：</p>
<ol>
<li><p>一个 NIO 线程同时处理成百上千的链路，性能上无法支撑，即便 NIO 线程的 CPU 负荷达到 100%，也无法满足海量消息的编码、解码、读取和发送；</p>
</li>
<li><p>当 NIO 线程负载过重之后，处理速度将变慢，这会导致大量客户端连接超时，超时之后往往会进行重发，这更加重了 NIO 线程的负载，最终会导致大量消息积压和处理超时，NIO 线程会成为系统的性能瓶颈；</p>
</li>
<li><p>可靠性问题：一旦 NIO 线程意外跑飞，或者进入死循环，会导致整个系统通信模块不可用，不能接收和处理外部消息，造成节点故障。</p>
</li>
</ol>
<p>为了解决这些问题，演进出了 Reactor 多线程模型，下面我们一起学习下 Reactor 多线程模型。</p>
<p>Rector 多线程模型与单线程模型最大的区别就是有一组 NIO 线程处理 IO 操作，它的原理图如下：</p>
<p><img src="http://static.cyblogs.com/db6a1485171d0dcf2647ebe679641830.png" alt="Netty系列之Netty高性能之道"></p>
<p>图 2-23 Reactor 多线程模型</p>
<p>Reactor 多线程模型的特点：</p>
<ol>
<li><p>有专门一个 NIO 线程 -Acceptor 线程用于监听服务端，接收客户端的 TCP 连接请求；</p>
</li>
<li><p>网络 IO 操作 - 读、写等由一个 NIO 线程池负责，线程池可以采用标准的 JDK 线程池实现，它包含一个任务队列和 N 个可用的线程，由这些 NIO 线程负责消息的读取、解码、编码和发送；</p>
</li>
<li><p>1 个 NIO 线程可以同时处理 N 条链路，但是 1 个链路只对应 1 个 NIO 线程，防止发生并发操作问题。</p>
</li>
</ol>
<p>在绝大多数场景下，Reactor 多线程模型都可以满足性能需求；但是，在极特殊应用场景中，一个 NIO 线程负责监听和处理所有的客户端连接可能会存在性能问题。例如百万客户端并发连接，或者服务端需要对客户端的握手消息进行安全认证，认证本身非常损耗性能。在这类场景下，单独一个 Acceptor 线程可能会存在性能不足问题，为了解决性能问题，产生了第三种 Reactor 线程模型 - 主从 Reactor 多线程模型。</p>
<p>主从 Reactor 线程模型的特点是：服务端用于接收客户端连接的不再是个 1 个单独的 NIO 线程，而是一个独立的 NIO 线程池。Acceptor 接收到客户端 TCP 连接请求处理完成后（可能包含接入认证等），将新创建的 SocketChannel 注册到 IO 线程池（sub reactor 线程池）的某个 IO 线程上，由它负责 SocketChannel 的读写和编解码工作。Acceptor 线程池仅仅只用于客户端的登陆、握手和安全认证，一旦链路建立成功，就将链路注册到后端 subReactor 线程池的 IO 线程上，由 IO 线程负责后续的 IO 操作。</p>
<p>它的线程模型如下图所示：</p>
<p><img src="http://static.cyblogs.com/13edd43992b0bc2c6f30ba7ac3eec7b3.png" alt="Netty系列之Netty高性能之道"></p>
<p>图 2-24 Reactor 主从多线程模型</p>
<p>利用主从 NIO 线程模型，可以解决 1 个服务端监听线程无法有效处理所有客户端连接的性能不足问题。因此，在 Netty 的官方 demo 中，推荐使用该线程模型。</p>
<p>事实上，Netty 的线程模型并非固定不变，通过在启动辅助类中创建不同的 EventLoopGroup 实例并通过适当的参数配置，就可以支持上述三种 Reactor 线程模型。正是因为 Netty 对 Reactor 线程模型的支持提供了灵活的定制能力，所以可以满足不同业务场景的性能诉求。</p>
<h4 id="2-2-5-无锁化的串行设计理念"><a href="#2-2-5-无锁化的串行设计理念" class="headerlink" title="2.2.5. 无锁化的串行设计理念"></a>2.2.5. 无锁化的串行设计理念</h4><p>在大多数场景下，并行多线程处理可以提升系统的并发性能。但是，如果对于共享资源的并发访问处理不当，会带来严重的锁竞争，这最终会导致性能的下降。为了尽可能的避免锁竞争带来的性能损耗，可以通过串行化设计，即消息的处理尽可能在同一个线程内完成，期间不进行线程切换，这样就避免了多线程竞争和同步锁。</p>
<p>为了尽可能提升性能，Netty 采用了串行无锁化设计，在 IO 线程内部进行串行操作，避免多线程竞争导致的性能下降。表面上看，串行化设计似乎 CPU 利用率不高，并发程度不够。但是，通过调整 NIO 线程池的线程参数，可以同时启动多个串行化的线程并行运行，这种局部无锁化的串行线程设计相比一个队列 - 多个工作线程模型性能更优。</p>
<p>Netty 的串行化设计工作原理图如下：</p>
<p><img src="http://static.cyblogs.com/152658879e750890cc2337c28554600b.png" alt="Netty系列之Netty高性能之道"></p>
<p>图 2-25 Netty 串行化工作原理图</p>
<p>Netty 的 NioEventLoop 读取到消息之后，直接调用 ChannelPipeline 的 fireChannelRead(Object msg)，只要用户不主动切换线程，一直会由 NioEventLoop 调用到用户的 Handler，期间不进行线程切换，这种串行化处理方式避免了多线程操作导致的锁的竞争，从性能角度看是最优的。</p>
<h4 id="2-2-6-高效的并发编程"><a href="#2-2-6-高效的并发编程" class="headerlink" title="2.2.6. 高效的并发编程"></a>2.2.6. 高效的并发编程</h4><p>Netty 的高效并发编程主要体现在如下几点：</p>
<ol>
<li><p>volatile 的大量、正确使用 ;</p>
</li>
<li><p>CAS 和原子类的广泛使用；</p>
</li>
<li><p>线程安全容器的使用；</p>
</li>
<li><p>通过读写锁提升并发性能。</p>
</li>
</ol>
<p>如果大家想了解 Netty 高效并发编程的细节，可以阅读之前我在微博分享的《多线程并发编程在 Netty 中的应用分析》，在这篇文章中对 Netty 的多线程技巧和应用进行了详细的介绍和分析。</p>
<h4 id="2-2-7-高性能的序列化框架"><a href="#2-2-7-高性能的序列化框架" class="headerlink" title="2.2.7. 高性能的序列化框架"></a>2.2.7. 高性能的序列化框架</h4><p>影响序列化性能的关键因素总结如下：</p>
<ol>
<li><p>序列化后的码流大小（网络带宽的占用）；</p>
</li>
<li><p>序列化 &amp; 反序列化的性能（CPU 资源占用）；</p>
</li>
<li><p>是否支持跨语言（异构系统的对接和开发语言切换）。</p>
</li>
</ol>
<p>Netty 默认提供了对 Google Protobuf 的支持，通过扩展 Netty 的编解码接口，用户可以实现其它的高性能序列化框架，例如 Thrift 的压缩二进制编解码框架。</p>
<p>下面我们一起看下不同序列化 &amp; 反序列化框架序列化后的字节数组对比：</p>
<p><img src="http://static.cyblogs.com/0ef6d5bf56e32e6073ea03a12a85fba9.png" alt="Netty系列之Netty高性能之道"></p>
<p>图 2-26 各序列化框架序列化码流大小对比</p>
<p>从上图可以看出，Protobuf 序列化后的码流只有 Java 序列化的 1&#x2F;4 左右。正是由于 Java 原生序列化性能表现太差，才催生出了各种高性能的开源序列化技术和框架（性能差只是其中的一个原因，还有跨语言、IDL 定义等其它因素）。</p>
<h4 id="2-2-8-灵活的-TCP-参数配置能力"><a href="#2-2-8-灵活的-TCP-参数配置能力" class="headerlink" title="2.2.8. 灵活的 TCP 参数配置能力"></a>2.2.8. 灵活的 TCP 参数配置能力</h4><p>合理设置 TCP 参数在某些场景下对于性能的提升可以起到显著的效果，例如 SO_RCVBUF 和 SO_SNDBUF。如果设置不当，对性能的影响是非常大的。下面我们总结下对性能影响比较大的几个配置项：</p>
<ol>
<li><p>SO_RCVBUF 和 SO_SNDBUF：通常建议值为 128K 或者 256K；</p>
</li>
<li><p>SO_TCPNODELAY：NAGLE 算法通过将缓冲区内的小封包自动相连，组成较大的封包，阻止大量小封包的发送阻塞网络，从而提高网络应用效率。但是对于时延敏感的应用场景需要关闭该优化算法；</p>
</li>
<li><p>软中断：如果 Linux 内核版本支持 RPS（2.6.35 以上版本），开启 RPS 后可以实现软中断，提升网络吞吐量。RPS 根据数据包的源地址，目的地址以及目的和源端口，计算出一个 hash 值，然后根据这个 hash 值来选择软中断运行的 cpu，从上层来看，也就是说将每个连接和 cpu 绑定，并通过这个 hash 值，来均衡软中断在多个 cpu 上，提升网络并行处理性能。</p>
</li>
</ol>
<p>Netty 在启动辅助类中可以灵活的配置 TCP 参数，满足不同的用户场景。相关配置接口定义如下：</p>
<p><img src="http://static.cyblogs.com/e470acd40eea18b5b067b181cbec5f68.png" alt="Netty系列之Netty高性能之道"></p>
<p>图 2-27 Netty 的 TCP 参数配置定义</p>
<h3 id="2-3-总结"><a href="#2-3-总结" class="headerlink" title="2.3. 总结"></a>2.3. 总结</h3><p>通过对 Netty 的架构和性能模型进行分析，我们发现 Netty 架构的高性能是被精心设计和实现的，得益于高质量的架构和代码，Netty 支持 10W TPS 的跨节点服务调用并不是件十分困难的事情。</p>
<h3 id="参考地址"><a href="#参考地址" class="headerlink" title="参考地址"></a>参考地址</h3><ul>
<li><a target="_blank" rel="noopener" href="https://www.infoq.cn/article/netty-high-performance/">https://www.infoq.cn/article/netty-high-performance/</a></li>
</ul>
<h3 id="读书笔记"><a href="#读书笔记" class="headerlink" title="读书笔记"></a>读书笔记</h3><p>链接:<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1vf2f4KRdpZlKkrBTReP-gA">https://pan.baidu.com/s/1vf2f4KRdpZlKkrBTReP-gA</a>  密码:yvoy</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.cyblogs.com/2020/02/28/2020/02/MySQL%E7%9A%84%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92%E4%B8%8E%E4%BB%A3%E4%BB%B7%E6%A8%A1%E5%9E%8B%E8%AF%A6%E7%BB%86%E8%A7%A3%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/vernonchen.jpg">
      <meta itemprop="name" content="Vernon">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简栈文化">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | 简栈文化">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/02/28/2020/02/MySQL%E7%9A%84%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92%E4%B8%8E%E4%BB%A3%E4%BB%B7%E6%A8%A1%E5%9E%8B%E8%AF%A6%E7%BB%86%E8%A7%A3%E6%9E%90/" class="post-title-link" itemprop="url">MySQL的执行计划与代价模型详细解析</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-02-28 00:00:00" itemprop="dateCreated datePublished" datetime="2020-02-28T00:00:00+08:00">2020-02-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-06-25 09:57:28" itemprop="dateModified" datetime="2025-06-25T09:57:28+08:00">2025-06-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h4><p>为了后续的沟通方便，在20200213的早上创建了一个**《简栈-Java技术交流群》**，也方便大家通过扫二维码积极的参与进来。</p>
<p><img src="http://static.cyblogs.com/%E7%AE%80%E6%A0%88-Java%E6%8A%80%E6%9C%AF%E4%BA%A4%E6%B5%81%E7%BE%A4.JPG" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;简栈-Java技术交流群.JPG"></p>
<p>如果是二维码已经过期，大家可以添加<strong>简栈文化-小助手</strong>的微信号（lastpass4u），然后让他拉大家进群进群。我们保持着小而美的精神，宁缺毋滥。</p>
<p><img src="http://static.cyblogs.com/%E7%AE%80%E6%A0%88%E6%96%87%E5%8C%96-%E5%B0%8F%E5%8A%A9%E6%89%8B.jpg" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;简栈文化-小助手.jpg"></p>
<p>然后早上群里就有人提了一个问题：</p>
<blockquote>
<p>执行计划里面的扫描函数跟执行时间不匹配，比如查询优化器发现，扫描a索引行数更多，所以更慢，因此优化器选择了索引b, 但实际上走b索引的时候比a更慢，走a索引大概是4秒左右，b是8秒。</p>
</blockquote>
<p>这个问题激发起了大家的讨论，有的人建议说：</p>
<blockquote>
<p>1、这种可以强制指定索引执行的吧</p>
<p>2、这个扫描行数都是预估的不一定准的，能操作shell的话执行analyse table看看。</p>
<p>3、看一下你的index，DDL，explain等等</p>
</blockquote>
<p>但提问者明显这些都是已经自己搞清楚了的，他关心的是底层的优化器成本规则等。这类我才意识到EXPLAIN出来的是结果，其实数据库底层本身是有优化器的，而最终选择谁，是否过索引等都是有它的规则的。这其中都涉及到效率与成本问题。</p>
<h4 id="Explain执行计划详解"><a href="#Explain执行计划详解" class="headerlink" title="Explain执行计划详解"></a>Explain执行计划详解</h4><p>使用<code>explain</code>关键字可以模拟优化器执行SQL查询语句，从而知道MySQL是如何处理你的SQL语句的，分析你的查询语句或是表结构的性能瓶颈。</p>
<p><strong>Explain执行计划包含的信息</strong></p>
<p>![<a target="_blank" rel="noopener" href="http://static.cyblogs.com/SouthEast">http://static.cyblogs.com/SouthEast</a> (6).png](<a target="_blank" rel="noopener" href="http://static.cyblogs.com/SouthEast">http://static.cyblogs.com/SouthEast</a> (6).png)</p>
<p>其中最重要的字段为：<code>id、type、key、rows、Extra</code>。</p>
<h5 id="id字段"><a href="#id字段" class="headerlink" title="id字段"></a>id字段</h5><p>select查询的序列号，包含一组数字，表示查询中执行select子句或操作表的顺序</p>
<ul>
<li>三种情况：<ul>
<li>1、id相同：执行顺序由上至下</li>
</ul>
</li>
</ul>
<p>![<a target="_blank" rel="noopener" href="http://static.cyblogs.com/SouthEast">http://static.cyblogs.com/SouthEast</a> (4).png](<a target="_blank" rel="noopener" href="http://static.cyblogs.com/SouthEast">http://static.cyblogs.com/SouthEast</a> (4).png)</p>
<ul>
<li>2、id不同：如果是子查询，id的序号会递增，id值越大优先级越高，越先被执行</li>
</ul>
<p>![<a target="_blank" rel="noopener" href="http://static.cyblogs.com/SouthEast">http://static.cyblogs.com/SouthEast</a> (8).png](<a target="_blank" rel="noopener" href="http://static.cyblogs.com/SouthEast">http://static.cyblogs.com/SouthEast</a> (8).png)</p>
<ul>
<li>3、id相同又不同（两种情况同时存在）：id如果相同，可以认为是一组，从上往下顺序执行；在所有组中，id值越大，优先级越高，越先执行</li>
</ul>
<p>![<a target="_blank" rel="noopener" href="http://static.cyblogs.com/SouthEast">http://static.cyblogs.com/SouthEast</a> (5).png](<a target="_blank" rel="noopener" href="http://static.cyblogs.com/SouthEast">http://static.cyblogs.com/SouthEast</a> (5).png)</p>
<h5 id="select-type字段"><a href="#select-type字段" class="headerlink" title="select_type字段"></a>select_type字段</h5><p>查询的类型，主要是用于区分普通查询、联合查询、子查询等复杂的查询</p>
<p>1、SIMPLE：简单的select查询，查询中不包含子查询或者union<br>2、PRIMARY：查询中包含任何复杂的子部分，最外层查询则被标记为primary<br>3、SUBQUERY：在select 或 where列表中包含了子查询<br>4、DERIVED：在from列表中包含的子查询被标记为derived（衍生），mysql或递归执行这些子查询，把结果放在零时表里<br>5、UNION：若第二个select出现在union之后，则被标记为union；若union包含在from子句的子查询中，外层select将被标记为derived<br>6、UNION RESULT：从union表获取结果的select</p>
<p>![<a target="_blank" rel="noopener" href="http://static.cyblogs.com/SouthEast">http://static.cyblogs.com/SouthEast</a> (9).png](<a target="_blank" rel="noopener" href="http://static.cyblogs.com/SouthEast">http://static.cyblogs.com/SouthEast</a> (9).png)</p>
<h5 id="type字段"><a href="#type字段" class="headerlink" title="type字段"></a>type字段</h5><p>访问类型，sql查询优化中一个很重要的指标，结果值从好到坏依次是：</p>
<p><strong>system</strong> &gt; <strong>const</strong> &gt; <strong>eq_ref</strong> &gt; <strong>ref</strong> &gt; <strong>fulltext</strong> &gt; <strong>ref_or_null</strong> &gt; <strong>index_merge</strong> &gt; <strong>unique_subquery</strong> &gt; <strong>index_subquery</strong> &gt; <strong>range</strong> &gt; <strong>index</strong> &gt; <strong>ALL</strong></p>
<p>一般来说，好的sql查询至少达到range级别，最好能达到ref</p>
<p>1、system：表只有一行记录（等于系统表），这是const类型的特例，平时不会出现，可以忽略不计</p>
<p>2、const：表示通过索引一次就找到了，const用于比较primary key 或者 unique索引。因为只需匹配一行数据，所有很快。如果将主键置于where列表中，mysql就能将该查询转换为一个const。</p>
<p><img src="http://static.cyblogs.com/SouthEast.png" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;SouthEast.png"></p>
<p>3、eq_ref：唯一性索引扫描，对于每个索引键，表中只有一条记录与之匹配。常见于主键 或 唯一索引扫描。</p>
<p>注意：ALL全表扫描的表记录最少的表如t1表</p>
<p>![<a target="_blank" rel="noopener" href="http://static.cyblogs.com/SouthEast">http://static.cyblogs.com/SouthEast</a> (2).png](<a target="_blank" rel="noopener" href="http://static.cyblogs.com/SouthEast">http://static.cyblogs.com/SouthEast</a> (2).png)</p>
<p>4、ref：非唯一性索引扫描，返回匹配某个单独值的所有行。本质是也是一种索引访问，它返回所有匹配某个单独值的行，然而他可能会找到多个符合条件的行，所以它应该属于查找和扫描的混合体</p>
<p>![<a target="_blank" rel="noopener" href="http://static.cyblogs.com/SouthEast">http://static.cyblogs.com/SouthEast</a> (3).png](<a target="_blank" rel="noopener" href="http://static.cyblogs.com/SouthEast">http://static.cyblogs.com/SouthEast</a> (3).png)</p>
<p>5、range：只检索给定范围的行，使用一个索引来选择行。key列显示使用了那个索引。一般就是在where语句中出现了bettween、&lt;、&gt;、in等的查询。这种索引列上的范围扫描比全索引扫描要好。只需要开始于某个点，结束于另一个点，不用扫描全部索引</p>
<p>![<a target="_blank" rel="noopener" href="http://static.cyblogs.com/SouthEast">http://static.cyblogs.com/SouthEast</a> (7).png](<a target="_blank" rel="noopener" href="http://static.cyblogs.com/SouthEast">http://static.cyblogs.com/SouthEast</a> (7).png)</p>
<p>6、index：Full Index Scan，index与ALL区别为index类型只遍历索引树。这通常为ALL块，应为索引文件通常比数据文件小。（Index与ALL虽然都是读全表，但index是从索引中读取，而ALL是从硬盘读取）</p>
<p>![<a target="_blank" rel="noopener" href="http://static.cyblogs.com/SouthEast">http://static.cyblogs.com/SouthEast</a> (1).png](<a target="_blank" rel="noopener" href="http://static.cyblogs.com/SouthEast">http://static.cyblogs.com/SouthEast</a> (1).png)</p>
<p>7、ALL：Full Table Scan，遍历全表以找到匹配的行</p>
<p>![<a target="_blank" rel="noopener" href="http://static.cyblogs.com/SouthEast">http://static.cyblogs.com/SouthEast</a> (10).png](<a target="_blank" rel="noopener" href="http://static.cyblogs.com/SouthEast">http://static.cyblogs.com/SouthEast</a> (10).png)</p>
<h5 id="possible-keys字段"><a href="#possible-keys字段" class="headerlink" title="possible_keys字段"></a>possible_keys字段</h5><p>查询涉及到的字段上存在索引，则该索引将被列出，但不一定被查询实际使用</p>
<h5 id="key字段"><a href="#key字段" class="headerlink" title="key字段"></a>key字段</h5><p>实际使用的索引，如果为NULL，则没有使用索引。<br>查询中如果使用了覆盖索引，则该索引仅出现在key列表中</p>
<p>![<a target="_blank" rel="noopener" href="http://static.cyblogs.com/SouthEast">http://static.cyblogs.com/SouthEast</a> (11).png](<a target="_blank" rel="noopener" href="http://static.cyblogs.com/SouthEast">http://static.cyblogs.com/SouthEast</a> (11).png)</p>
<p>![<a target="_blank" rel="noopener" href="http://static.cyblogs.com/SouthEast">http://static.cyblogs.com/SouthEast</a> (2).png](<a target="_blank" rel="noopener" href="http://static.cyblogs.com/SouthEast">http://static.cyblogs.com/SouthEast</a> (12).png)</p>
<h5 id="key-len字段"><a href="#key-len字段" class="headerlink" title="key_len字段"></a>key_len字段</h5><p>表示索引中使用的字节数，查询中使用的索引的长度（最大可能长度），并非实际使用长度，理论上长度越短越好。key_len是根据表定义计算而得的，不是通过表内检索出的</p>
<h5 id="ref字段"><a href="#ref字段" class="headerlink" title="ref字段"></a>ref字段</h5><p>显示索引的那一列被使用了，如果可能，是一个常量const。</p>
<h5 id="rows字段"><a href="#rows字段" class="headerlink" title="rows字段"></a>rows字段</h5><p>根据表统计信息及索引选用情况，大致估算出找到所需的记录所需要读取的行数</p>
<h5 id="Extra字段"><a href="#Extra字段" class="headerlink" title="Extra字段"></a>Extra字段</h5><p>不适合在其他字段中显示，但是十分重要的额外信息</p>
<h6 id="1、Using-filesort"><a href="#1、Using-filesort" class="headerlink" title="1、Using filesort"></a>1、Using filesort</h6><p>mysql对数据使用一个外部的索引排序，而不是按照表内的索引进行排序读取。也就是说mysql无法利用索引完成的排序操作成为“文件排序”</p>
<p>由于索引是先按email排序、再按address排序，所以查询时如果直接按address排序，索引就不能满足要求了，mysql内部必须再实现一次“文件排序”</p>
<p>![<a target="_blank" rel="noopener" href="http://static.cyblogs.com/SouthEast">http://static.cyblogs.com/SouthEast</a> (13).png](<a target="_blank" rel="noopener" href="http://static.cyblogs.com/SouthEast">http://static.cyblogs.com/SouthEast</a> (13).png)</p>
<h6 id="2、Using-temporary"><a href="#2、Using-temporary" class="headerlink" title="2、Using temporary"></a>2、Using temporary</h6><p>使用临时表保存中间结果，也就是说mysql在对查询结果排序时使用了临时表，常见于order by 和 group by</p>
<p>![<a target="_blank" rel="noopener" href="http://static.cyblogs.com/SouthEast">http://static.cyblogs.com/SouthEast</a> (14).png](<a target="_blank" rel="noopener" href="http://static.cyblogs.com/SouthEast">http://static.cyblogs.com/SouthEast</a> (14).png)</p>
<h6 id="3、Using-index"><a href="#3、Using-index" class="headerlink" title="3、Using index"></a>3、Using index</h6><p>表示相应的select操作中使用了覆盖索引（Covering Index），避免了访问表的数据行，效率高<br>如果同时出现Using where，表明索引被用来执行索引键值的查找（参考上图）<br>如果没用同时出现Using where，表明索引用来读取数据而非执行查找动作</p>
<p>覆盖索引（Covering Index）：也叫索引覆盖。就是select列表中的字段，只用从索引中就能获取，不必根据索引再次读取数据文件，换句话说查询列要被所建的索引覆盖。<br>注意：<br>a、如需使用覆盖索引，select列表中的字段只取出需要的列，不要使用select *<br>b、如果将所有字段都建索引会导致索引文件过大，反而降低crud性能</p>
<p>![<a target="_blank" rel="noopener" href="http://static.cyblogs.com/SouthEast">http://static.cyblogs.com/SouthEast</a> (15).png](<a target="_blank" rel="noopener" href="http://static.cyblogs.com/SouthEast">http://static.cyblogs.com/SouthEast</a> (15).png)</p>
<h6 id="4、Using-where"><a href="#4、Using-where" class="headerlink" title="4、Using where"></a>4、Using where</h6><p>使用了where过滤</p>
<h6 id="5、Using-join-buffer"><a href="#5、Using-join-buffer" class="headerlink" title="5、Using join buffer"></a>5、Using join buffer</h6><p>使用了链接缓存</p>
<h6 id="6、Impossible-WHERE"><a href="#6、Impossible-WHERE" class="headerlink" title="6、Impossible WHERE"></a>6、Impossible WHERE</h6><p>where子句的值总是false，不能用来获取任何元祖</p>
<h6 id="7、select-tables-optimized-away"><a href="#7、select-tables-optimized-away" class="headerlink" title="7、select tables optimized away"></a>7、select tables optimized away</h6><p>在没有group by子句的情况下，基于索引优化MIN&#x2F;MAX操作或者对于MyISAM存储引擎优化COUNT（*）操作，不必等到执行阶段在进行计算，查询执行计划生成的阶段即可完成优化</p>
<h6 id="8、distinct"><a href="#8、distinct" class="headerlink" title="8、distinct"></a>8、distinct</h6><p>优化distinct操作，在找到第一个匹配的元祖后即停止找同样值得动作</p>
<h4 id="优化器代价模型"><a href="#优化器代价模型" class="headerlink" title="优化器代价模型"></a>优化器代价模型</h4><h5 id="指标"><a href="#指标" class="headerlink" title="指标"></a>指标</h5><ol>
<li>代价模型：RBO(基于规则的优化)、CBO(基于成本的优化)</li>
<li>SQL的每一种执行路径，均可计算一个对应的执行代价，代价越小，执行效率越高</li>
</ol>
<h5 id="CBO方式成本的计算"><a href="#CBO方式成本的计算" class="headerlink" title="CBO方式成本的计算"></a>CBO方式成本的计算</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Total cost = CPU cost + IO cost</span><br></pre></td></tr></table></figure>

<h6 id="CPU-cost计算模型"><a href="#CPU-cost计算模型" class="headerlink" title="CPU cost计算模型"></a>CPU cost计算模型</h6><p>CPU cost &#x3D; rows&#x2F;5 + (rows&#x2F;10 if comparing key)</p>
<blockquote>
<p>CPU cost:</p>
<ol>
<li>MySQL上层，处理返回记录所花开销</li>
<li>CPU Cost&#x3D;records&#x2F;TIME_FOR_COMPARE&#x3D;Records&#x2F;5</li>
<li>每5条记录处的时间，作为1 Cost</li>
</ol>
</blockquote>
<h6 id="IO-cost计算模型"><a href="#IO-cost计算模型" class="headerlink" title="IO cost计算模型"></a>IO cost计算模型</h6><p>IO cost以聚集索引叶子节点的数量进行计算</p>
<blockquote>
<ul>
<li>全扫描<br>IO Cost &#x3D; table stat_clustered_index_size<br>聚簇索引page总数，一个page作为1 cost</li>
<li>范围扫描<br>IO Cost &#x3D; [(ranges+rows)&#x2F;total_rows]*全扫描IO Cost<br>聚簇索引范围扫描与返回记录成比率</li>
</ul>
<p>若需要回表，则IO cost以预估的记录数量进行计算，开销相当巨大</p>
<ul>
<li>二级索引之索引覆盖扫描<ul>
<li>索引覆盖扫描，减少返回聚簇索引的IO代价<br>keys_per_block&#x3D;(stats_block_size&#x2F;2)&#x2F;(key_info[keynr].key_lenth+ref_length+1)<br>stats_block_size&#x2F;2 &#x3D; 索引页半满</li>
<li>IO Cost：(records+keys_per_block-1)&#x2F;keys_per_block</li>
<li>计算range占用多少个二级索引页面，既为索引覆盖扫描的IO Cost</li>
</ul>
</li>
<li>二级索引之索引非覆盖扫描<ul>
<li>索引非覆盖扫描，需要回聚簇索引读取完整记录，增加IO代价</li>
<li>IO Cost &#x3D; （range+rows）</li>
<li>range:多少个范围<br>对于IN查询，就会转换为多个索引范围查询</li>
<li>row:为范围中一共有多少记录<br>由于每一条记录都需要返回聚簇索引，因此每一条记录都会产生1 Cost</li>
</ul>
</li>
</ul>
</blockquote>
<h5 id="Cost模型分析"><a href="#Cost模型分析" class="headerlink" title="Cost模型分析"></a>Cost模型分析</h5><ul>
<li>聚簇索引扫描代价为索引页面总数量</li>
<li>二级索引覆盖扫描代价较小</li>
<li>二级索引非覆盖扫描，代价巨大</li>
<li>Cost模型的计算，需要统计信息的支持<ul>
<li>stat_clustered_index_size</li>
<li>ranges</li>
<li>records&#x2F;rows</li>
<li>stats_block_size</li>
<li>key_info[keynr].key_length</li>
<li>rec_per_key</li>
<li>……</li>
</ul>
</li>
</ul>
<h5 id="实战如何看日志确定Cost的选择"><a href="#实战如何看日志确定Cost的选择" class="headerlink" title="实战如何看日志确定Cost的选择"></a>实战如何看日志确定Cost的选择</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> database lyj;</span><br><span class="line"><span class="keyword">create</span> database lyj;</span><br><span class="line">use lyj;</span><br><span class="line"></span><br><span class="line"><span class="keyword">create table</span> t1 (</span><br><span class="line">    c1 <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">not null</span> <span class="keyword">default</span> <span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">    c2 <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">default</span> <span class="keyword">null</span>,</span><br><span class="line">    c3 <span class="type">varchar</span>(<span class="number">64</span>) <span class="keyword">default</span> <span class="keyword">null</span>,</span><br><span class="line">    c4 <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">default</span> <span class="keyword">null</span>,</span><br><span class="line">    <span class="keyword">primary key</span> (c1),</span><br><span class="line">    key ind_c2 (c2),</span><br><span class="line">    key ind_c4 (c4));</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert into</span> t1 <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;A&#x27;</span>,<span class="number">10</span>);</span><br><span class="line"><span class="keyword">insert into</span> t1 <span class="keyword">values</span>(<span class="number">2</span>,<span class="string">&#x27;b&#x27;</span>,<span class="string">&#x27;B&#x27;</span>,<span class="number">20</span>);</span><br><span class="line"><span class="keyword">insert into</span> t1 <span class="keyword">values</span>(<span class="number">3</span>,<span class="string">&#x27;b&#x27;</span>,<span class="string">&#x27;BB&#x27;</span>,<span class="number">20</span>);</span><br><span class="line"><span class="keyword">insert into</span> t1 <span class="keyword">values</span>(<span class="number">4</span>,<span class="string">&#x27;b&#x27;</span>,<span class="string">&#x27;BBB&#x27;</span>,<span class="number">30</span>);</span><br><span class="line"><span class="keyword">insert into</span> t1 <span class="keyword">values</span>(<span class="number">5</span>,<span class="string">&#x27;b&#x27;</span>,<span class="string">&#x27;BBB&#x27;</span>,<span class="number">40</span>);</span><br><span class="line"><span class="keyword">insert into</span> t1 <span class="keyword">values</span>(<span class="number">6</span>,<span class="string">&#x27;c&#x27;</span>,<span class="string">&#x27;C&#x27;</span>,<span class="number">50</span>);</span><br><span class="line"><span class="keyword">insert into</span> t1 <span class="keyword">values</span>(<span class="number">7</span>,<span class="string">&#x27;d&#x27;</span>,<span class="string">&#x27;D&#x27;</span>,<span class="number">60</span>);</span><br><span class="line"><span class="keyword">commit</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t1;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+------+------+------+</span></span><br><span class="line"><span class="operator">|</span> c1 <span class="operator">|</span> c2   <span class="operator">|</span> c3   <span class="operator">|</span> c4   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+------+------+------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> a    <span class="operator">|</span> A    <span class="operator">|</span>   <span class="number">10</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">2</span> <span class="operator">|</span> b    <span class="operator">|</span> B    <span class="operator">|</span>   <span class="number">20</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">3</span> <span class="operator">|</span> b    <span class="operator">|</span> BB   <span class="operator">|</span>   <span class="number">20</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">4</span> <span class="operator">|</span> b    <span class="operator">|</span> BBB  <span class="operator">|</span>   <span class="number">30</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">5</span> <span class="operator">|</span> b    <span class="operator">|</span> BBB  <span class="operator">|</span>   <span class="number">40</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">6</span> <span class="operator">|</span> c    <span class="operator">|</span> C    <span class="operator">|</span>   <span class="number">50</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">7</span> <span class="operator">|</span> d    <span class="operator">|</span> D    <span class="operator">|</span>   <span class="number">60</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+------+------+------+</span></span><br></pre></td></tr></table></figure>

<p><strong>执行以下SQL为什么不走索引ind_c2？</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t1 <span class="keyword">where</span> c4<span class="operator">=</span><span class="number">20</span> <span class="keyword">and</span> c2<span class="operator">=</span><span class="string">&#x27;b&#x27;</span>\G;</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: t1</span><br><span class="line">         type: <span class="keyword">ref</span></span><br><span class="line">possible_keys: ind_c2,ind_c4,ind_c2_c4</span><br><span class="line">          key: ind_c4</span><br><span class="line">      key_len: <span class="number">5</span></span><br><span class="line">          <span class="keyword">ref</span>: const</span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">2</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">where</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span> optimizer_trace<span class="operator">=</span><span class="string">&#x27;enabled=on&#x27;</span>;</span><br><span class="line"><span class="keyword">set</span> optimizer_trace_max_mem_size<span class="operator">=</span><span class="number">1000000</span>;</span><br><span class="line"><span class="keyword">set</span> end_markers_in_json<span class="operator">=</span><span class="keyword">on</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t1 <span class="keyword">where</span> c4<span class="operator">=</span><span class="number">20</span> <span class="keyword">and</span> c2<span class="operator">=</span><span class="string">&#x27;b&#x27;</span>;</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> information_schema.optimizer_trace\G;</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">                            QUERY: <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t1 <span class="keyword">where</span> c4<span class="operator">=</span><span class="number">20</span> <span class="keyword">and</span> c2<span class="operator">=</span><span class="string">&#x27;b&#x27;</span></span><br><span class="line">                            TRACE: &#123;</span><br><span class="line">......</span><br><span class="line">                  &quot;potential_range_indices&quot;: [ # 列出备选索引</span><br><span class="line">                    &#123;</span><br><span class="line">                      &quot;index&quot;: &quot;PRIMARY&quot;, </span><br><span class="line">                      &quot;usable&quot;: <span class="literal">false</span>,         # 本行表明主键索引不可用</span><br><span class="line">                      &quot;cause&quot;: &quot;not_applicable&quot;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      &quot;index&quot;: &quot;ind_c2&quot;,</span><br><span class="line">                      &quot;usable&quot;: <span class="literal">true</span>,</span><br><span class="line">                      &quot;key_parts&quot;: [</span><br><span class="line">                        &quot;c2&quot;,</span><br><span class="line">                        &quot;c1&quot;</span><br><span class="line">                      ] <span class="comment">/* key_parts */</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      &quot;index&quot;: &quot;ind_c4&quot;,</span><br><span class="line">                      &quot;usable&quot;: <span class="literal">true</span>,</span><br><span class="line">                      &quot;key_parts&quot;: [</span><br><span class="line">                        &quot;c4&quot;,</span><br><span class="line">                        &quot;c1&quot;</span><br><span class="line">                      ] <span class="comment">/* key_parts */</span></span><br><span class="line">                    &#125;</span><br><span class="line">                  ] <span class="comment">/* potential_range_indices */</span>,</span><br><span class="line">                  &quot;setup_range_conditions&quot;: [</span><br><span class="line">                  ] <span class="comment">/* setup_range_conditions */</span>,</span><br><span class="line">                  &quot;group_index_range&quot;: &#123;</span><br><span class="line">                    &quot;chosen&quot;: <span class="literal">false</span>,</span><br><span class="line">                    &quot;cause&quot;: &quot;not_group_by_or_distinct&quot;</span><br><span class="line">                  &#125; <span class="comment">/* group_index_range */</span>,</span><br><span class="line">                  &quot;analyzing_range_alternatives&quot;: &#123;   # 开始计算每个索引做范围扫描的花费</span><br><span class="line">                    &quot;range_scan_alternatives&quot;: [</span><br><span class="line">                      &#123;</span><br><span class="line">                        &quot;index&quot;: &quot;ind_c2&quot;,</span><br><span class="line">                        &quot;ranges&quot;: [</span><br><span class="line">                          &quot;b &lt;= c2 &lt;= b&quot;</span><br><span class="line">                        ] <span class="comment">/* ranges */</span>,</span><br><span class="line">                        &quot;index_dives_for_eq_ranges&quot;: <span class="literal">true</span>,</span><br><span class="line">                        &quot;rowid_ordered&quot;: <span class="literal">true</span>,</span><br><span class="line">                        &quot;using_mrr&quot;: <span class="literal">false</span>,</span><br><span class="line">                        &quot;index_only&quot;: <span class="literal">false</span>,</span><br><span class="line">                        &quot;rows&quot;: <span class="number">4</span>,         # c2<span class="operator">=</span>b的结果有<span class="number">4</span>行</span><br><span class="line">                        &quot;cost&quot;: <span class="number">5.81</span>,</span><br><span class="line">                        &quot;chosen&quot;: <span class="literal">false</span>,   # 这个索引没有被选中，原因是cost</span><br><span class="line">                        &quot;cause&quot;: &quot;cost&quot;   </span><br><span class="line">                      &#125;,</span><br><span class="line">                      &#123;</span><br><span class="line">                        &quot;index&quot;: &quot;ind_c4&quot;,</span><br><span class="line">                        &quot;ranges&quot;: [</span><br><span class="line">                          &quot;20 &lt;= c4 &lt;= 20&quot;</span><br><span class="line">                        ] <span class="comment">/* ranges */</span>,</span><br><span class="line">                        &quot;index_dives_for_eq_ranges&quot;: <span class="literal">true</span>,</span><br><span class="line">                        &quot;rowid_ordered&quot;: <span class="literal">true</span>,</span><br><span class="line">                        &quot;using_mrr&quot;: <span class="literal">false</span>,</span><br><span class="line">                        &quot;index_only&quot;: <span class="literal">false</span>,</span><br><span class="line">                        &quot;rows&quot;: <span class="number">2</span>,</span><br><span class="line">                        &quot;cost&quot;: <span class="number">3.41</span>,</span><br><span class="line">                        &quot;chosen&quot;: <span class="literal">true</span>     # 这个索引的代价最小,被选中</span><br><span class="line">                      &#125;</span><br><span class="line">......</span><br><span class="line">                  &quot;chosen_range_access_summary&quot;: &#123;  # 总结：因为cost最小选择了ind_c4</span><br><span class="line">                    &quot;range_access_plan&quot;: &#123;</span><br><span class="line">                      &quot;type&quot;: &quot;range_scan&quot;,</span><br><span class="line">                      &quot;index&quot;: &quot;ind_c4&quot;,</span><br><span class="line">                      &quot;rows&quot;: <span class="number">2</span>,</span><br><span class="line">                      &quot;ranges&quot;: [</span><br><span class="line">                        &quot;20 &lt;= c4 &lt;= 20&quot;</span><br><span class="line">                      ] <span class="comment">/* ranges */</span></span><br><span class="line">                    &#125; <span class="comment">/* range_access_plan */</span>,</span><br><span class="line">                    &quot;rows_for_plan&quot;: <span class="number">2</span>,</span><br><span class="line">                    &quot;cost_for_plan&quot;: <span class="number">3.41</span>,</span><br><span class="line">                    &quot;chosen&quot;: <span class="literal">true</span></span><br><span class="line">                  &#125; <span class="comment">/* chosen_range_access_summary */</span></span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>因为ind_c4范围扫描的cost要小于ind_c2，所以索引不走ind_c2</p>
<p><strong>where条件中字段c2和c4换个位置，索引还是不走ind_c2？为什么？</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t1 <span class="keyword">where</span>  c2<span class="operator">=</span><span class="string">&#x27;b&#x27;</span> <span class="keyword">and</span> c4<span class="operator">=</span><span class="number">20</span>\G;</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: t1</span><br><span class="line">         type: <span class="keyword">ref</span></span><br><span class="line">possible_keys: ind_c2,ind_c4,ind_c2_c4</span><br><span class="line">          key: ind_c4</span><br><span class="line">      key_len: <span class="number">5</span></span><br><span class="line">          <span class="keyword">ref</span>: const</span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">2</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">where</span></span><br></pre></td></tr></table></figure>

<p>因为ind_c4范围扫描的cost要小于ind_c2，所以索引不走ind_c2，跟c2和c4的位置无关。验证方法同上。</p>
<p><strong>如下语句，换个条件c2&#x3D;’c’，为什么可以走索引ind_c2？</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t1 <span class="keyword">where</span> c2<span class="operator">=</span><span class="string">&#x27;c&#x27;</span> <span class="keyword">and</span> c4<span class="operator">=</span><span class="number">20</span>\G;</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: t1</span><br><span class="line">         type: <span class="keyword">ref</span></span><br><span class="line">possible_keys: ind_c2,ind_c4,ind_c2_c4</span><br><span class="line">          key: ind_c2</span><br><span class="line">      key_len: <span class="number">387</span></span><br><span class="line">          <span class="keyword">ref</span>: const</span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">1</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> index <span class="keyword">condition</span>; <span class="keyword">Using</span> <span class="keyword">where</span></span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> information_schema.optimizer_trace\G;</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">                            QUERY: <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t1 <span class="keyword">where</span> c2<span class="operator">=</span><span class="string">&#x27;c&#x27;</span> <span class="keyword">and</span> c4<span class="operator">=</span><span class="number">20</span></span><br><span class="line">                            TRACE: &#123;</span><br><span class="line">......</span><br><span class="line">                  &quot;analyzing_range_alternatives&quot;: &#123;</span><br><span class="line">                    &quot;range_scan_alternatives&quot;: [</span><br><span class="line">                      &#123;</span><br><span class="line">                        &quot;index&quot;: &quot;ind_c2&quot;,</span><br><span class="line">                        &quot;ranges&quot;: [</span><br><span class="line">                          &quot;c &lt;= c2 &lt;= c&quot;</span><br><span class="line">                        ] <span class="comment">/* ranges */</span>,</span><br><span class="line">                        &quot;index_dives_for_eq_ranges&quot;: <span class="literal">true</span>,</span><br><span class="line">                        &quot;rowid_ordered&quot;: <span class="literal">true</span>,</span><br><span class="line">                        &quot;using_mrr&quot;: <span class="literal">false</span>,</span><br><span class="line">                        &quot;index_only&quot;: <span class="literal">false</span>,</span><br><span class="line">                        &quot;rows&quot;: <span class="number">1</span>,           # c2<span class="operator">=</span>c 的结果集有<span class="number">1</span>行</span><br><span class="line">                        &quot;cost&quot;: <span class="number">2.21</span>,</span><br><span class="line">                        &quot;chosen&quot;: <span class="literal">true</span>       # 这个索引的代价最小,被选中</span><br><span class="line">                      &#125;,</span><br><span class="line">                      &#123;</span><br><span class="line">                        &quot;index&quot;: &quot;ind_c4&quot;,</span><br><span class="line">                        &quot;ranges&quot;: [</span><br><span class="line">                          &quot;20 &lt;= c4 &lt;= 20&quot;</span><br><span class="line">                        ] <span class="comment">/* ranges */</span>,</span><br><span class="line">                        &quot;index_dives_for_eq_ranges&quot;: <span class="literal">true</span>,</span><br><span class="line">                        &quot;rowid_ordered&quot;: <span class="literal">true</span>,</span><br><span class="line">                        &quot;using_mrr&quot;: <span class="literal">false</span>,</span><br><span class="line">                        &quot;index_only&quot;: <span class="literal">false</span>,</span><br><span class="line">                        &quot;rows&quot;: <span class="number">2</span>,</span><br><span class="line">                        &quot;cost&quot;: <span class="number">3.41</span>,</span><br><span class="line">                        &quot;chosen&quot;: <span class="literal">false</span>,   # 这个索引没有被选中，原因是cost</span><br><span class="line">                        &quot;cause&quot;: &quot;cost&quot;</span><br><span class="line">                      &#125;</span><br><span class="line">                  ......</span><br></pre></td></tr></table></figure>

<p><strong>创建复合索引</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER TABLE</span> t1 <span class="keyword">ADD</span> KEY ind_c2_c4(c2,c4);</span><br></pre></td></tr></table></figure>

<p><strong>下面语句为什么不走复合索引ind_c2_c4？</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t1 <span class="keyword">where</span>  c2<span class="operator">=</span><span class="string">&#x27;b&#x27;</span> <span class="keyword">and</span> c4<span class="operator">=</span><span class="number">20</span>\G;</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: t1</span><br><span class="line">         type: <span class="keyword">ref</span></span><br><span class="line">possible_keys: ind_c2,ind_c4,ind_c2_c4</span><br><span class="line">          key: ind_c4</span><br><span class="line">      key_len: <span class="number">5</span></span><br><span class="line">          <span class="keyword">ref</span>: const</span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">2</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">where</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span> optimizer_trace<span class="operator">=</span><span class="string">&#x27;enabled=on&#x27;</span>;</span><br><span class="line"><span class="keyword">set</span> optimizer_trace_max_mem_size<span class="operator">=</span><span class="number">1000000</span>;</span><br><span class="line"><span class="keyword">set</span> end_markers_in_json<span class="operator">=</span><span class="keyword">on</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t1 <span class="keyword">where</span>  c2<span class="operator">=</span><span class="string">&#x27;b&#x27;</span> <span class="keyword">and</span> c4<span class="operator">=</span><span class="number">20</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> information_schema.optimizer_trace\G;</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">                            QUERY: <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t1 <span class="keyword">where</span>  c2<span class="operator">=</span><span class="string">&#x27;b&#x27;</span> <span class="keyword">and</span> c4<span class="operator">=</span><span class="number">20</span></span><br><span class="line">                            TRACE: &#123;</span><br><span class="line">......</span><br><span class="line">                  &quot;potential_range_indices&quot;: [</span><br><span class="line">                    &#123;</span><br><span class="line">                      &quot;index&quot;: &quot;PRIMARY&quot;,</span><br><span class="line">                      &quot;usable&quot;: <span class="literal">false</span>,</span><br><span class="line">                      &quot;cause&quot;: &quot;not_applicable&quot;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      &quot;index&quot;: &quot;ind_c2&quot;,</span><br><span class="line">                      &quot;usable&quot;: <span class="literal">true</span>,</span><br><span class="line">                      &quot;key_parts&quot;: [</span><br><span class="line">                        &quot;c2&quot;,</span><br><span class="line">                        &quot;c1&quot;</span><br><span class="line">                      ] <span class="comment">/* key_parts */</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      &quot;index&quot;: &quot;ind_c4&quot;,</span><br><span class="line">                      &quot;usable&quot;: <span class="literal">true</span>,</span><br><span class="line">                      &quot;key_parts&quot;: [</span><br><span class="line">                        &quot;c4&quot;,</span><br><span class="line">                        &quot;c1&quot;</span><br><span class="line">                      ] <span class="comment">/* key_parts */</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      &quot;index&quot;: &quot;ind_c2_c4&quot;,</span><br><span class="line">                      &quot;usable&quot;: <span class="literal">true</span>,</span><br><span class="line">                      &quot;key_parts&quot;: [</span><br><span class="line">                        &quot;c2&quot;,</span><br><span class="line">                        &quot;c4&quot;,</span><br><span class="line">                        &quot;c1&quot;</span><br><span class="line">                      ] <span class="comment">/* key_parts */</span></span><br><span class="line">                    &#125;</span><br><span class="line">                  ] <span class="comment">/* potential_range_indices */</span>,</span><br><span class="line">                  &quot;setup_range_conditions&quot;: [</span><br><span class="line">                  ] <span class="comment">/* setup_range_conditions */</span>,</span><br><span class="line">                  &quot;group_index_range&quot;: &#123;</span><br><span class="line">                    &quot;chosen&quot;: <span class="literal">false</span>,</span><br><span class="line">                    &quot;cause&quot;: &quot;not_group_by_or_distinct&quot;</span><br><span class="line">                  &#125; <span class="comment">/* group_index_range */</span>,</span><br><span class="line">                  &quot;analyzing_range_alternatives&quot;: &#123;</span><br><span class="line">                    &quot;range_scan_alternatives&quot;: [</span><br><span class="line">                      &#123;</span><br><span class="line">                        &quot;index&quot;: &quot;ind_c2&quot;,</span><br><span class="line">                        &quot;ranges&quot;: [</span><br><span class="line">                          &quot;b &lt;= c2 &lt;= b&quot;</span><br><span class="line">                        ] <span class="comment">/* ranges */</span>,</span><br><span class="line">                        &quot;index_dives_for_eq_ranges&quot;: <span class="literal">true</span>,</span><br><span class="line">                        &quot;rowid_ordered&quot;: <span class="literal">true</span>,</span><br><span class="line">                        &quot;using_mrr&quot;: <span class="literal">false</span>,</span><br><span class="line">                        &quot;index_only&quot;: <span class="literal">false</span>,</span><br><span class="line">                        &quot;rows&quot;: <span class="number">4</span>,</span><br><span class="line">                        &quot;cost&quot;: <span class="number">5.81</span>,</span><br><span class="line">                        &quot;chosen&quot;: <span class="literal">false</span>,</span><br><span class="line">                        &quot;cause&quot;: &quot;cost&quot;</span><br><span class="line">                      &#125;,</span><br><span class="line">                      &#123;</span><br><span class="line">                        &quot;index&quot;: &quot;ind_c4&quot;,</span><br><span class="line">                        &quot;ranges&quot;: [</span><br><span class="line">                          &quot;20 &lt;= c4 &lt;= 20&quot;</span><br><span class="line">                        ] <span class="comment">/* ranges */</span>,</span><br><span class="line">                        &quot;index_dives_for_eq_ranges&quot;: <span class="literal">true</span>,</span><br><span class="line">                        &quot;rowid_ordered&quot;: <span class="literal">true</span>,</span><br><span class="line">                        &quot;using_mrr&quot;: <span class="literal">false</span>,</span><br><span class="line">                        &quot;index_only&quot;: <span class="literal">false</span>,</span><br><span class="line">                        &quot;rows&quot;: <span class="number">2</span>,</span><br><span class="line">                        &quot;cost&quot;: <span class="number">3.41</span>,</span><br><span class="line">                        &quot;chosen&quot;: <span class="literal">true</span></span><br><span class="line">                      &#125;,</span><br><span class="line">                      &#123;</span><br><span class="line">                        &quot;index&quot;: &quot;ind_c2_c4&quot;,</span><br><span class="line">                        &quot;ranges&quot;: [</span><br><span class="line">                          &quot;b &lt;= c2 &lt;= b AND 20 &lt;= c4 &lt;= 20&quot;</span><br><span class="line">                        ] <span class="comment">/* ranges */</span>,</span><br><span class="line">                        &quot;index_dives_for_eq_ranges&quot;: <span class="literal">true</span>,</span><br><span class="line">                        &quot;rowid_ordered&quot;: <span class="literal">true</span>,</span><br><span class="line">                        &quot;using_mrr&quot;: <span class="literal">false</span>,</span><br><span class="line">                        &quot;index_only&quot;: <span class="literal">false</span>,</span><br><span class="line">                        &quot;rows&quot;: <span class="number">2</span>,</span><br><span class="line">                        &quot;cost&quot;: <span class="number">3.41</span>,</span><br><span class="line">                        &quot;chosen&quot;: <span class="literal">false</span>,</span><br><span class="line">                        &quot;cause&quot;: &quot;cost&quot;</span><br><span class="line">                      &#125;</span><br><span class="line">......</span><br><span class="line">                  &quot;chosen_range_access_summary&quot;: &#123;</span><br><span class="line">                    &quot;range_access_plan&quot;: &#123;</span><br><span class="line">                      &quot;type&quot;: &quot;range_scan&quot;,</span><br><span class="line">                      &quot;index&quot;: &quot;ind_c4&quot;,</span><br><span class="line">                      &quot;rows&quot;: <span class="number">2</span>,</span><br><span class="line">                      &quot;ranges&quot;: [</span><br><span class="line">                        &quot;20 &lt;= c4 &lt;= 20&quot;</span><br><span class="line">                      ] <span class="comment">/* ranges */</span></span><br><span class="line">                    &#125; <span class="comment">/* range_access_plan */</span>,</span><br><span class="line">                    &quot;rows_for_plan&quot;: <span class="number">2</span>,</span><br><span class="line">                    &quot;cost_for_plan&quot;: <span class="number">3.41</span>,</span><br><span class="line">                    &quot;chosen&quot;: <span class="literal">true</span></span><br><span class="line">                  &#125; <span class="comment">/* chosen_range_access_summary */</span></span><br><span class="line">                &#125; <span class="comment">/* range_analysis */</span></span><br><span class="line">              &#125;</span><br><span class="line"> ......</span><br></pre></td></tr></table></figure>

<p>索引ind_c4和ind_c2_c4都是非覆盖扫描，而ind_c4和ind_c2_c4的cost是一样的，mysql会选择叶子块数量较少的那个索引，很明显ind_c4叶子块数量较少。</p>
<p><strong>下面语句为什么又可以走复合索引ind_c2_c4？</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> c2,c4 <span class="keyword">from</span> t1 <span class="keyword">where</span> c2<span class="operator">=</span><span class="string">&#x27;b&#x27;</span> <span class="keyword">and</span> c4<span class="operator">=</span><span class="number">20</span>\G;</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           id: <span class="number">1</span></span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        <span class="keyword">table</span>: t1</span><br><span class="line">         type: <span class="keyword">ref</span></span><br><span class="line">possible_keys: ind_c2,ind_c4,ind_c2_c4</span><br><span class="line">          key: ind_c2_c4</span><br><span class="line">      key_len: <span class="number">392</span></span><br><span class="line">          <span class="keyword">ref</span>: const,const</span><br><span class="line">         <span class="keyword">rows</span>: <span class="number">2</span></span><br><span class="line">        Extra: <span class="keyword">Using</span> <span class="keyword">where</span>; <span class="keyword">Using</span> index</span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span> optimizer_trace<span class="operator">=</span><span class="string">&#x27;enabled=on&#x27;</span>;</span><br><span class="line"><span class="keyword">set</span> optimizer_trace_max_mem_size<span class="operator">=</span><span class="number">1000000</span>;</span><br><span class="line"><span class="keyword">set</span> end_markers_in_json<span class="operator">=</span><span class="keyword">on</span>;</span><br><span class="line"><span class="keyword">select</span> c2,c4 <span class="keyword">from</span> t1 <span class="keyword">where</span> c2<span class="operator">=</span><span class="string">&#x27;b&#x27;</span> <span class="keyword">and</span> c4<span class="operator">=</span><span class="number">20</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> information_schema.optimizer_trace\G;</span><br><span class="line"></span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">                            QUERY: <span class="keyword">select</span> c2,c4 <span class="keyword">from</span> t1 <span class="keyword">where</span> c2<span class="operator">=</span><span class="string">&#x27;b&#x27;</span> <span class="keyword">and</span> c4<span class="operator">=</span><span class="number">20</span></span><br><span class="line">                            TRACE: &#123;</span><br><span class="line">......</span><br><span class="line">                  &quot;analyzing_range_alternatives&quot;: &#123;</span><br><span class="line">                    &quot;range_scan_alternatives&quot;: [</span><br><span class="line">                      &#123;</span><br><span class="line">                        &quot;index&quot;: &quot;ind_c2&quot;,</span><br><span class="line">                        &quot;ranges&quot;: [</span><br><span class="line">                          &quot;b &lt;= c2 &lt;= b&quot;</span><br><span class="line">                        ] <span class="comment">/* ranges */</span>,</span><br><span class="line">                        &quot;index_dives_for_eq_ranges&quot;: <span class="literal">true</span>,</span><br><span class="line">                        &quot;rowid_ordered&quot;: <span class="literal">true</span>,</span><br><span class="line">                        &quot;using_mrr&quot;: <span class="literal">false</span>,</span><br><span class="line">                        &quot;index_only&quot;: <span class="literal">false</span>,</span><br><span class="line">                        &quot;rows&quot;: <span class="number">4</span>,</span><br><span class="line">                        &quot;cost&quot;: <span class="number">5.81</span>,</span><br><span class="line">                        &quot;chosen&quot;: <span class="literal">false</span>,</span><br><span class="line">                        &quot;cause&quot;: &quot;cost&quot;</span><br><span class="line">                      &#125;,</span><br><span class="line">                      &#123;</span><br><span class="line">                        &quot;index&quot;: &quot;ind_c4&quot;,</span><br><span class="line">                        &quot;ranges&quot;: [</span><br><span class="line">                          &quot;20 &lt;= c4 &lt;= 20&quot;</span><br><span class="line">                        ] <span class="comment">/* ranges */</span>,</span><br><span class="line">                        &quot;index_dives_for_eq_ranges&quot;: <span class="literal">true</span>,</span><br><span class="line">                        &quot;rowid_ordered&quot;: <span class="literal">true</span>,</span><br><span class="line">                        &quot;using_mrr&quot;: <span class="literal">false</span>,</span><br><span class="line">                        &quot;index_only&quot;: <span class="literal">false</span>,</span><br><span class="line">                        &quot;rows&quot;: <span class="number">2</span>,</span><br><span class="line">                        &quot;cost&quot;: <span class="number">3.41</span>,</span><br><span class="line">                        &quot;chosen&quot;: <span class="literal">false</span>,</span><br><span class="line">                        &quot;cause&quot;: &quot;cost&quot;</span><br><span class="line">                      &#125;,</span><br><span class="line">                      &#123;</span><br><span class="line">                        &quot;index&quot;: &quot;ind_c2_c4&quot;,</span><br><span class="line">                        &quot;ranges&quot;: [</span><br><span class="line">                          &quot;b &lt;= c2 &lt;= b AND 20 &lt;= c4 &lt;= 20&quot;</span><br><span class="line">                        ] <span class="comment">/* ranges */</span>,</span><br><span class="line">                        &quot;index_dives_for_eq_ranges&quot;: <span class="literal">true</span>,</span><br><span class="line">                        &quot;rowid_ordered&quot;: <span class="literal">true</span>,</span><br><span class="line">                        &quot;using_mrr&quot;: <span class="literal">false</span>,</span><br><span class="line">                        &quot;index_only&quot;: <span class="literal">true</span>,    # 索引覆盖扫描</span><br><span class="line">                        &quot;rows&quot;: <span class="number">2</span>,</span><br><span class="line">                        &quot;cost&quot;: <span class="number">3.41</span>,</span><br><span class="line">                        &quot;chosen&quot;: <span class="literal">false</span>,</span><br><span class="line">                        &quot;cause&quot;: &quot;cost&quot;</span><br><span class="line">                      &#125;</span><br><span class="line">                    ] <span class="comment">/* range_scan_alternatives */</span>,</span><br><span class="line">                    &quot;analyzing_roworder_intersect&quot;: &#123;</span><br><span class="line">                      &quot;intersecting_indices&quot;: [</span><br><span class="line">                        &#123;</span><br><span class="line">                          &quot;index&quot;: &quot;ind_c2_c4&quot;,</span><br><span class="line">                          &quot;index_scan_cost&quot;: <span class="number">1.0476</span>,</span><br><span class="line">                          &quot;cumulated_index_scan_cost&quot;: <span class="number">1.0476</span>,</span><br><span class="line">                          &quot;disk_sweep_cost&quot;: <span class="number">0</span>,</span><br><span class="line">                          &quot;cumulated_total_cost&quot;: <span class="number">1.0476</span>,</span><br><span class="line">                          &quot;usable&quot;: <span class="literal">true</span>,</span><br><span class="line">                          &quot;matching_rows_now&quot;: <span class="number">2</span>,</span><br><span class="line">                          &quot;isect_covering_with_this_index&quot;: <span class="literal">true</span>,</span><br><span class="line">                          &quot;chosen&quot;: <span class="literal">true</span></span><br><span class="line">                        &#125;</span><br><span class="line">                      ] <span class="comment">/* intersecting_indices */</span>,</span><br><span class="line">                      &quot;clustered_pk&quot;: &#123;</span><br><span class="line">                        &quot;clustered_pk_added_to_intersect&quot;: <span class="literal">false</span>,</span><br><span class="line">                        &quot;cause&quot;: &quot;no_clustered_pk_index&quot;</span><br><span class="line">                      &#125; <span class="comment">/* clustered_pk */</span>,</span><br><span class="line">                      &quot;chosen&quot;: <span class="literal">false</span>,</span><br><span class="line">                      &quot;cause&quot;: &quot;too_few_indexes_to_merge&quot;</span><br><span class="line">                    &#125; <span class="comment">/* analyzing_roworder_intersect */</span></span><br><span class="line">                  &#125; <span class="comment">/* analyzing_range_alternatives */</span></span><br><span class="line">                &#125; <span class="comment">/* range_analysis */</span></span><br><span class="line">              &#125;</span><br><span class="line">            ] <span class="comment">/* rows_estimation */</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            &quot;considered_execution_plans&quot;: [</span><br><span class="line">              &#123;</span><br><span class="line">                &quot;plan_prefix&quot;: [</span><br><span class="line">                ] <span class="comment">/* plan_prefix */</span>,</span><br><span class="line">                &quot;table&quot;: &quot;`t1`&quot;,</span><br><span class="line">                &quot;best_access_path&quot;: &#123;</span><br><span class="line">                  &quot;considered_access_paths&quot;: [</span><br><span class="line">                    &#123;</span><br><span class="line">                      &quot;access_type&quot;: &quot;ref&quot;,</span><br><span class="line">                      &quot;index&quot;: &quot;ind_c2&quot;,</span><br><span class="line">                      &quot;rows&quot;: <span class="number">4</span>,</span><br><span class="line">                      &quot;cost&quot;: <span class="number">2.8</span>,</span><br><span class="line">                      &quot;chosen&quot;: <span class="literal">true</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      &quot;access_type&quot;: &quot;ref&quot;,</span><br><span class="line">                      &quot;index&quot;: &quot;ind_c4&quot;,</span><br><span class="line">                      &quot;rows&quot;: <span class="number">2</span>,</span><br><span class="line">                      &quot;cost&quot;: <span class="number">2.4</span>,</span><br><span class="line">                      &quot;chosen&quot;: <span class="literal">true</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      &quot;access_type&quot;: &quot;ref&quot;,</span><br><span class="line">                      &quot;index&quot;: &quot;ind_c2_c4&quot;,</span><br><span class="line">                      &quot;rows&quot;: <span class="number">2</span>,</span><br><span class="line">                      &quot;cost&quot;: <span class="number">1.4476</span>,</span><br><span class="line">                      &quot;chosen&quot;: <span class="literal">true</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      &quot;access_type&quot;: &quot;scan&quot;,</span><br><span class="line">                      &quot;cause&quot;: &quot;covering_index_better_than_full_scan&quot;,  </span><br><span class="line">                      &quot;chosen&quot;: <span class="literal">false</span></span><br><span class="line">                    &#125;</span><br><span class="line">                  ] <span class="comment">/* considered_access_paths */</span></span><br><span class="line">                &#125; <span class="comment">/* best_access_path */</span>,</span><br><span class="line">                &quot;cost_for_plan&quot;: <span class="number">1.4476</span>,</span><br><span class="line">                &quot;rows_for_plan&quot;: <span class="number">2</span>,</span><br><span class="line">                &quot;chosen&quot;: <span class="literal">true</span></span><br><span class="line">              &#125;</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>因为语中ind_c2_c4是索引覆盖扫描，不需要回表，代价较小。</p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>**我们看执行计划（Explain）仅仅只是结果，而看代价模型（Cost）才是过程。**如果我们真的想了解数据库是如何优化我们的SQL或者真的是如何执行的，需要深入深入的理解底层才行。</p>
<h4 id="参考地址"><a href="#参考地址" class="headerlink" title="参考地址"></a>参考地址</h4><ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/gua___gua/article/details/50819629">https://blog.csdn.net/gua___gua/article/details/50819629</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/qingsong3333/article/details/77170831">https://blog.csdn.net/qingsong3333/article/details/77170831</a></li>
<li><a target="_blank" rel="noopener" href="https://keithlan.github.io/2015/07/14/mysql_group_order_limit/">https://keithlan.github.io/2015/07/14/mysql_group_order_limit/</a></li>
<li>[<a target="_blank" rel="noopener" href="http://dbase.cc/2017/10/24/mysql/MySQL-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0/09-MySQL-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">http://dbase.cc/2017/10/24/mysql/MySQL-性能优化最佳实践课程学习/09-MySQL-性能优化最佳实践</a> &#x2F;](<a target="_blank" rel="noopener" href="http://dbase.cc/2017/10/24/mysql/MySQL-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E8%AF%BE%E7%A8%8B%E5%AD%A6%E4%B9%A0/09-MySQL-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">http://dbase.cc/2017/10/24/mysql/MySQL-性能优化最佳实践课程学习/09-MySQL-性能优化最佳实践</a> &#x2F;)</li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/wuseyukui/article/details/71512793">https://blog.csdn.net/wuseyukui/article/details/71512793</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.cyblogs.com/2020/02/28/2020/02/Spring%20Bean%E5%88%9D%E5%A7%8B%E5%8C%96%E8%BF%87%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/vernonchen.jpg">
      <meta itemprop="name" content="Vernon">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简栈文化">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | 简栈文化">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/02/28/2020/02/Spring%20Bean%E5%88%9D%E5%A7%8B%E5%8C%96%E8%BF%87%E7%A8%8B/" class="post-title-link" itemprop="url">Spring Bean初始化过程</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-02-28 00:00:00" itemprop="dateCreated datePublished" datetime="2020-02-28T00:00:00+08:00">2020-02-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-06-25 09:57:28" itemprop="dateModified" datetime="2025-06-25T09:57:28+08:00">2025-06-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Spring/" itemprop="url" rel="index"><span itemprop="name">Spring</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="init-method方法"><a href="#init-method方法" class="headerlink" title="init-method方法"></a>init-method方法</h4><p><code>init-method</code>方法，初始化<code>bean</code>的时候执行，可以针对某个具体的<code>bean</code>进行配置。<code>init-method</code>需要在<code>applicationContext.xml</code>配置文档中<code>bean</code>的定义里头写明。例如：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;TestBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;nju.software.xkxt.util.TestBean&quot;</span> <span class="attr">init-method</span>=<span class="string">&quot;init&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这样，当<code>TestBean</code>在初始化的时候会执行<code>TestBean</code>中定义的<code>init</code>方法。</p>
<h4 id="afterPropertiesSet方法"><a href="#afterPropertiesSet方法" class="headerlink" title="afterPropertiesSet方法"></a>afterPropertiesSet方法</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">InitializingBean</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Invoked by the containing &#123;<span class="doctag">@code</span> BeanFactory&#125; after it has set all bean properties</span></span><br><span class="line"><span class="comment">	 * and satisfied &#123;<span class="doctag">@link</span> BeanFactoryAware&#125;, &#123;<span class="doctag">@code</span> ApplicationContextAware&#125; etc.</span></span><br><span class="line"><span class="comment">	 * &lt;p&gt;This method allows the bean instance to perform validation of its overall</span></span><br><span class="line"><span class="comment">	 * configuration and final initialization when all bean properties have been set.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> Exception in the event of misconfiguration (such as failure to set an</span></span><br><span class="line"><span class="comment">	 * essential property) or if initialization fails for any other reason</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>afterPropertiesSet</code>方法，初始化<code>bean</code>的时候执行，可以针对某个具体的<code>bean</code>进行配置。afterPropertiesSet 必须实现 <code>InitializingBean</code>接口。实现 <code>InitializingBean</code>接口必须实现<code>afterPropertiesSet</code>方法。</p>
<h4 id="BeanPostProcessor类"><a href="#BeanPostProcessor类" class="headerlink" title="BeanPostProcessor类"></a>BeanPostProcessor类</h4><p><code>BeanPostProcessor</code>，针对所有<code>Spring</code>上下文中所有的<code>bean</code>，可以在配置文档<code>applicationContext.xml</code>中配置一个<code>BeanPostProcessor</code>，然后对所有的<code>bean</code>进行一个初始化之前和之后的代理。<code>BeanPostProcessor</code>接口中有两个方法： <code>postProcessBeforeInitialization</code>和<code>postProcessAfterInitialization</code>。 <code>postProcessBeforeInitialization</code>方法在<code>bean</code>初始化之前执行， <code>postProcessAfterInitialization</code>方法在<code>bean</code>初始化之后执行。</p>
<h5 id="前置后置处理器"><a href="#前置后置处理器" class="headerlink" title="前置后置处理器"></a>前置后置处理器</h5><p>Spirng中<code>BeanPostProcessor</code>和<code>InstantiationAwareBeanPostProcessorAdapter</code>两个接口都可以实现对<code>bean</code>前置后置处理的效果，那这次先讲解一下<code>BeanPostProcessor</code>处理器的使用</p>
<p>先看一下<code>BeanPostProcessor</code>接口的源码，它定义了两个方法，一个在<code>bean</code>初始化之前，一个在<code>bean</code>初始化之后</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BeanPostProcessor</span> &#123;</span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="keyword">default</span> Object <span class="title function_">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="keyword">default</span> Object <span class="title function_">postProcessAfterInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下面，我们来实现这个类，测试一下<code>Spring</code>中的前置后置处理器吧</p>
<p>首先是<code>pom.xml</code>,增加<code>Spring</code>相关的依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.myspring<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>myspring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>jar<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>myspring<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.apache.org<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.8.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Spring 5.0 核心工具包 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.0.7.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Spring 5.0 Bean管理工具包 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-beans<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.0.7.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Spring 5.0 context管理工具包 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.0.7.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Spring 5.0 aop支持包 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-aop<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.0.7.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>定义一个测试接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BaseService</span> &#123;</span><br><span class="line">    String <span class="title function_">doSomething</span><span class="params">()</span>;</span><br><span class="line">    String <span class="title function_">eat</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>定义接口实现类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ISomeService</span> <span class="keyword">implements</span> <span class="title class_">BaseService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">doSomething</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 增强效果：返回内容全部大写</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Hello i am kxm&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">eat</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;eat food&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实现<code>BeanPostProcessor</code>接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyBeanPostProcessor</span> <span class="keyword">implements</span> <span class="title class_">BeanPostProcessor</span>  &#123;</span><br><span class="line">    <span class="comment">// 前置处理器</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">beanClass</span> <span class="operator">=</span> bean.getClass();</span><br><span class="line">        <span class="keyword">if</span> (beanClass == ISomeService.class) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;bean 对象初始化之前······&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 后置处理器 --- 此处具体的实现用的是Java中的动态代理</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">postProcessAfterInitialization</span><span class="params">(<span class="keyword">final</span> Object beanInstance, String beanName)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">        <span class="comment">// 为当前 bean 对象注册监控代理对象，负责增强 bean 对象方法的能力</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">beanClass</span> <span class="operator">=</span> beanInstance.getClass();</span><br><span class="line">        <span class="keyword">if</span> (beanClass == ISomeService.class) &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">proxy</span> <span class="operator">=</span> Proxy.newProxyInstance(beanInstance.getClass().getClassLoader(),beanInstance.getClass().getInterfaces(), <span class="keyword">new</span> <span class="title class_">InvocationHandler</span>() &#123;</span><br><span class="line">                <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;ISomeService 中的 doSome() 被拦截了···&quot;</span>);</span><br><span class="line">                    <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> (String) method.invoke(beanInstance, args);</span><br><span class="line">                    <span class="keyword">return</span> result.toUpperCase(); </span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);     </span><br><span class="line">            <span class="keyword">return</span> proxy;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> beanInstance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Spring</code>的配置文件如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 注册 bean：被监控的实现类 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;iSomeService&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.my.spring.beanprocessor.ISomeService&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 注册代理实现类 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;com.my.spring.beanprocessor.MyBeanPostProcessor&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>测试类如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestBeanPostProcessor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * BeanPostProcessor 前置后置处理器</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">ApplicationContext</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring_config.xml&quot;</span>);</span><br><span class="line">        <span class="type">BaseService</span> <span class="variable">serviceObj</span> <span class="operator">=</span> (BaseService) factory.getBean(<span class="string">&quot;iSomeService&quot;</span>);</span><br><span class="line">        System.out.println(serviceObj.doSomething());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试结果截图：</p>
<p><img src="https://img-blog.csdn.net/20180924211535371?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MDgzNDQ2NA==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70" alt="https:&#x2F;&#x2F;img-blog.csdn.net&#x2F;20180924211535371?watermark&#x2F;2&#x2F;text&#x2F;aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MDgzNDQ2NA&#x3D;&#x3D;&#x2F;font&#x2F;5a6L5L2T&#x2F;fontsize&#x2F;400&#x2F;fill&#x2F;I0JBQkFCMA&#x3D;&#x3D;&#x2F;dissolve&#x2F;70"></p>
<p>可以观察到，我们明明在代码中对于<code>doSomething</code>方法定义的是小写，但是通过后置处理器，拦截了原本的方法，而是通过动态代理的方式把方法的结果进行了一定程度的改变，这就是<code>Spring</code>中的前置后置处理器—-<code>BeanPostProcessor</code>。</p>
<p>总之，<code>afterPropertiesSet</code> 和<code>init-method</code>之间的执行顺序是<code>afterPropertiesSet</code> 先执行，<code>init-method</code> 后执行。从<code>BeanPostProcessor</code>的作用，可以看出最先执行的是<code>postProcessBeforeInitialization</code>，然后<code>afterPropertiesSet</code>，然后是<code>init-method</code>，然后是<code>postProcessAfterInitialization</code>。</p>
<h4 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h4><ul>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/twelve-eleven/p/8080038.html">https://www.cnblogs.com/twelve-eleven/p/8080038.html</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_40834464/article/details/82832173">https://blog.csdn.net/weixin_40834464/article/details/82832173</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.cyblogs.com/2020/02/28/2020/02/Refresh%E6%96%B9%E6%B3%95%E5%88%B0%E5%BA%95%E5%B9%B2%E4%BA%86%E5%95%A5%EF%BC%9F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/vernonchen.jpg">
      <meta itemprop="name" content="Vernon">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简栈文化">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | 简栈文化">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/02/28/2020/02/Refresh%E6%96%B9%E6%B3%95%E5%88%B0%E5%BA%95%E5%B9%B2%E4%BA%86%E5%95%A5%EF%BC%9F/" class="post-title-link" itemprop="url">Refresh方法到底干了啥？</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-02-28 00:00:00" itemprop="dateCreated datePublished" datetime="2020-02-28T00:00:00+08:00">2020-02-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-06-25 09:57:28" itemprop="dateModified" datetime="2025-06-25T09:57:28+08:00">2025-06-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Spring/" itemprop="url" rel="index"><span itemprop="name">Spring</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>作者：吃饭睡觉撸代码</p>
<p>来源：<a target="_blank" rel="noopener" href="https://fangjian0423.github.io/2017/05/10/springboot-context-refresh/">https://fangjian0423.github.io/2017/05/10/springboot-context-refresh/</a></p>
<h4 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h4><p>Spring容器创建之后，会调用它的refresh方法，refresh的时候会做很多事情：比如完成配置类的解析、各种BeanFactoryPostProcessor和BeanPostProcessor的注册、国际化配置的初始化、web内置容器的构造等等。</p>
<p>我们来分析一下这个refresh过程。</p>
<p>还是以web程序为例，那么对应的Spring容器为AnnotationConfigEmbeddedWebApplicationContext。它的refresh方法调用了父类AbstractApplicationContext的refresh方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">refresh</span><span class="params">()</span> <span class="keyword">throws</span> BeansException, IllegalStateException &#123;</span><br><span class="line">  <span class="comment">// refresh过程只能一个线程处理，不允许并发执行</span></span><br><span class="line">  <span class="keyword">synchronized</span> (<span class="built_in">this</span>.startupShutdownMonitor) &#123;</span><br><span class="line">    prepareRefresh();</span><br><span class="line">    <span class="type">ConfigurableListableBeanFactory</span> <span class="variable">beanFactory</span> <span class="operator">=</span> obtainFreshBeanFactory();</span><br><span class="line">    prepareBeanFactory(beanFactory);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      postProcessBeanFactory(beanFactory);</span><br><span class="line">      invokeBeanFactoryPostProcessors(beanFactory);</span><br><span class="line">      registerBeanPostProcessors(beanFactory);</span><br><span class="line">      initMessageSource();</span><br><span class="line">      initApplicationEventMulticaster();</span><br><span class="line">      onRefresh();</span><br><span class="line">      registerListeners();</span><br><span class="line">      finishBeanFactoryInitialization(beanFactory);</span><br><span class="line">      finishRefresh();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (BeansException ex) &#123;</span><br><span class="line">      <span class="keyword">if</span> (logger.isWarnEnabled()) &#123;</span><br><span class="line">        logger.warn(<span class="string">&quot;Exception encountered during context initialization - &quot;</span> +</span><br><span class="line">            <span class="string">&quot;cancelling refresh attempt: &quot;</span> + ex);</span><br><span class="line">      &#125;</span><br><span class="line">      destroyBeans();</span><br><span class="line">      cancelRefresh(ex);</span><br><span class="line">      <span class="keyword">throw</span> ex;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">finally</span> &#123;</span><br><span class="line">      resetCommonCaches();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="prepareRefresh方法"><a href="#prepareRefresh方法" class="headerlink" title="prepareRefresh方法"></a>prepareRefresh方法</h4><p>表示在真正做refresh操作之前需要准备做的事情：</p>
<ol>
<li>设置Spring容器的启动时间，撤销关闭状态，开启活跃状态。</li>
<li>初始化属性源信息(Property)</li>
<li>验证环境信息里一些必须存在的属性</li>
</ol>
<h4 id="prepareBeanFactory方法"><a href="#prepareBeanFactory方法" class="headerlink" title="prepareBeanFactory方法"></a>prepareBeanFactory方法</h4><p>从Spring容器获取BeanFactory(Spring Bean容器)并进行相关的设置为后续的使用做准备：</p>
<ol>
<li>设置classloader(用于加载bean)，设置表达式解析器(解析bean定义中的一些表达式)，添加属性编辑注册器(注册属性编辑器)</li>
<li>添加ApplicationContextAwareProcessor这个BeanPostProcessor。取消ResourceLoaderAware、ApplicationEventPublisherAware、MessageSourceAware、ApplicationContextAware、EnvironmentAware这5个接口的自动注入。因为ApplicationContextAwareProcessor把这5个接口的实现工作做了</li>
<li>设置特殊的类型对应的bean。BeanFactory对应刚刚获取的BeanFactory；ResourceLoader、ApplicationEventPublisher、ApplicationContext这3个接口对应的bean都设置为当前的Spring容器</li>
<li>注入一些其它信息的bean，比如environment、systemProperties等</li>
</ol>
<h4 id="postProcessBeanFactory方法"><a href="#postProcessBeanFactory方法" class="headerlink" title="postProcessBeanFactory方法"></a>postProcessBeanFactory方法</h4><p>BeanFactory设置之后再进行后续的一些BeanFactory操作。</p>
<p>不同的Spring容器做不同的操作。比如GenericWebApplicationContext容器会在BeanFactory中添加ServletContextAwareProcessor用于处理ServletContextAware类型的bean初始化的时候调用setServletContext或者setServletConfig方法(跟ApplicationContextAwareProcessor原理一样)。</p>
<p>AnnotationConfigEmbeddedWebApplicationContext对应的postProcessBeanFactory方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> &#123;</span><br><span class="line">  <span class="comment">// 调用父类EmbeddedWebApplicationContext的实现</span></span><br><span class="line">  <span class="built_in">super</span>.postProcessBeanFactory(beanFactory);</span><br><span class="line">  <span class="comment">// 查看basePackages属性，如果设置了会使用ClassPathBeanDefinitionScanner去扫描basePackages包下的bean并注册</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">this</span>.basePackages != <span class="literal">null</span> &amp;&amp; <span class="built_in">this</span>.basePackages.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">this</span>.scanner.scan(<span class="built_in">this</span>.basePackages);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 查看annotatedClasses属性，如果设置了会使用AnnotatedBeanDefinitionReader去注册这些bean</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">this</span>.annotatedClasses != <span class="literal">null</span> &amp;&amp; <span class="built_in">this</span>.annotatedClasses.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">this</span>.reader.register(<span class="built_in">this</span>.annotatedClasses);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>父类EmbeddedWebApplicationContext的实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> &#123;</span><br><span class="line">  beanFactory.addBeanPostProcessor(</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">WebApplicationContextServletContextAwareProcessor</span>(<span class="built_in">this</span>));</span><br><span class="line">  beanFactory.ignoreDependencyInterface(ServletContextAware.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="invokeBeanFactoryPostProcessors方法"><a href="#invokeBeanFactoryPostProcessors方法" class="headerlink" title="invokeBeanFactoryPostProcessors方法"></a>invokeBeanFactoryPostProcessors方法</h4><p>在Spring容器中找出实现了BeanFactoryPostProcessor接口的processor并执行。Spring容器会委托给PostProcessorRegistrationDelegate的invokeBeanFactoryPostProcessors方法执行。</p>
<p>介绍两个接口：</p>
<ol>
<li>BeanFactoryPostProcessor：用来修改Spring容器中已经存在的bean的定义，使用ConfigurableListableBeanFactory对bean进行处理</li>
<li>BeanDefinitionRegistryPostProcessor：继承BeanFactoryPostProcessor，作用跟BeanFactoryPostProcessor一样，只不过是使用BeanDefinitionRegistry对bean进行处理</li>
</ol>
<p>基于web程序的Spring容器AnnotationConfigEmbeddedWebApplicationContext构造的时候，会初始化内部属性AnnotatedBeanDefinitionReader reader，这个reader构造的时候会在BeanFactory中注册一些post processor，包括BeanPostProcessor和BeanFactoryPostProcessor(比如ConfigurationClassPostProcessor、AutowiredAnnotationBeanPostProcessor)：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AnnotationConfigUtils.registerAnnotationConfigProcessors(<span class="built_in">this</span>.registry);</span><br></pre></td></tr></table></figure>

<p>invokeBeanFactoryPostProcessors方法处理BeanFactoryPostProcessor的逻辑如下：</p>
<p>从Spring容器中找出BeanDefinitionRegistryPostProcessor类型的bean(这些processor是在容器刚创建的时候通过构造AnnotatedBeanDefinitionReader的时候注册到容器中的)，然后按照优先级分别执行，优先级的逻辑如下：</p>
<ol>
<li>实现PriorityOrdered接口的BeanDefinitionRegistryPostProcessor先全部找出来，然后排序后依次执行</li>
<li>实现Ordered接口的BeanDefinitionRegistryPostProcessor找出来，然后排序后依次执行</li>
<li>没有实现PriorityOrdered和Ordered接口的BeanDefinitionRegistryPostProcessor找出来执行并依次执行</li>
</ol>
<p>接下来从Spring容器内查找BeanFactoryPostProcessor接口的实现类，然后执行(如果processor已经执行过，则忽略)，这里的查找规则跟上面查找BeanDefinitionRegistryPostProcessor一样，先找PriorityOrdered，然后是Ordered，最后是两者都没。</p>
<p>这里需要说明的是ConfigurationClassPostProcessor这个processor是优先级最高的被执行的processor(实现了PriorityOrdered接口)。这个ConfigurationClassPostProcessor会去BeanFactory中找出所有有@Configuration注解的bean，然后使用ConfigurationClassParser去解析这个类。ConfigurationClassParser内部有个Map&lt;ConfigurationClass, ConfigurationClass&gt;类型的configurationClasses属性用于保存解析的类，ConfigurationClass是一个对要解析的配置类的封装，内部存储了配置类的注解信息、被@Bean注解修饰的方法、@ImportResource注解修饰的信息、ImportBeanDefinitionRegistrar等都存储在这个封装类中。</p>
<p>这里ConfigurationClassPostProcessor最先被处理还有另外一个原因是如果程序中有自定义的BeanFactoryPostProcessor，那么这个PostProcessor首先得通过ConfigurationClassPostProcessor被解析出来，然后才能被Spring容器找到并执行。(ConfigurationClassPostProcessor不先执行的话，这个Processor是不会被解析的，不会被解析的话也就不会执行了)。</p>
<p>在我们的程序中，只有主类RefreshContextApplication有@Configuration注解(@SpringBootApplication注解带有@Configuration注解)，所以这个配置类会被ConfigurationClassParser解析。解析过程如下：</p>
<ol>
<li>处理@PropertySources注解：进行一些配置信息的解析</li>
<li>处理@ComponentScan注解：使用ComponentScanAnnotationParser扫描basePackage下的需要解析的类(@SpringBootApplication注解也包括了@ComponentScan注解，只不过basePackages是空的，空的话会去获取当前@Configuration修饰的类所在的包)，并注册到BeanFactory中(这个时候bean并没有进行实例化，而是进行了注册。具体的实例化在finishBeanFactoryInitialization方法中执行)。对于扫描出来的类，递归解析</li>
<li>处理@Import注解：先递归找出所有的注解，然后再过滤出只有@Import注解的类，得到@Import注解的值。比如查找@SpringBootApplication注解的@Import注解数据的话，首先发现@SpringBootApplication不是一个@Import注解，然后递归调用修饰了@SpringBootApplication的注解，发现有个@EnableAutoConfiguration注解，再次递归发现被@Import(EnableAutoConfigurationImportSelector.class)修饰，还有@AutoConfigurationPackage注解修饰，再次递归@AutoConfigurationPackage注解，发现被@Import(AutoConfigurationPackages.Registrar.class)注解修饰，所以@SpringBootApplication注解对应的@Import注解有2个，分别是@Import(AutoConfigurationPackages.Registrar.class)和@Import(EnableAutoConfigurationImportSelector.class)。找出所有的@Import注解之后，开始处理逻辑：<ol>
<li>遍历这些@Import注解内部的属性类集合</li>
<li>如果这个类是个ImportSelector接口的实现类，实例化这个ImportSelector，如果这个类也是DeferredImportSelector接口的实现类，那么加入ConfigurationClassParser的deferredImportSelectors属性中让第6步处理。否则调用ImportSelector的selectImports方法得到需要Import的类，然后对这些类递归做@Import注解的处理</li>
<li>如果这个类是ImportBeanDefinitionRegistrar接口的实现类，设置到配置类的importBeanDefinitionRegistrars属性中</li>
<li>其它情况下把这个类入队到ConfigurationClassParser的importStack(队列)属性中，然后把这个类当成是@Configuration注解修饰的类递归重头开始解析这个类</li>
</ol>
</li>
<li>处理@ImportResource注解：获取@ImportResource注解的locations属性，得到资源文件的地址信息。然后遍历这些资源文件并把它们添加到配置类的importedResources属性中</li>
<li>处理@Bean注解：获取被@Bean注解修饰的方法，然后添加到配置类的beanMethods属性中</li>
<li>处理DeferredImportSelector：处理第3步@Import注解产生的DeferredImportSelector，进行selectImports方法的调用找出需要import的类，然后再调用第3步相同的处理逻辑处理</li>
</ol>
<p>这里@SpringBootApplication注解被@EnableAutoConfiguration修饰，@EnableAutoConfiguration注解被@Import(EnableAutoConfigurationImportSelector.class)修饰，所以在第3步会找出这个@Import修饰的类EnableAutoConfigurationImportSelector，这个类刚好实现了DeferredImportSelector接口，接着就会在第6步被执行。第6步selectImport得到的类就是自动化配置类。</p>
<p>EnableAutoConfigurationImportSelector的selectImport方法会在spring.factories文件中找出key为EnableAutoConfiguration对应的值，有81个，这81个就是所谓的自动化配置类(XXXAutoConfiguration)。</p>
<p>ConfigurationClassParser解析完成之后，被解析出来的类会放到configurationClasses属性中。然后使用ConfigurationClassBeanDefinitionReader去解析这些类。</p>
<p>这个时候这些bean只是被加载到了Spring容器中。下面这段代码是ConfigurationClassBeanDefinitionReader的解析bean过程：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">loadBeanDefinitions</span><span class="params">(Set&lt;ConfigurationClass&gt; configurationModel)</span> &#123;</span><br><span class="line">  <span class="type">TrackedConditionEvaluator</span> <span class="variable">trackedConditionEvaluator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TrackedConditionEvaluator</span>();</span><br><span class="line">  <span class="keyword">for</span> (ConfigurationClass configClass : configurationModel) &#123;</span><br><span class="line">    <span class="comment">// 对每一个配置类，调用loadBeanDefinitionsForConfigurationClass方法</span></span><br><span class="line">    loadBeanDefinitionsForConfigurationClass(configClass, trackedConditionEvaluator);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">loadBeanDefinitionsForConfigurationClass</span><span class="params">(ConfigurationClass configClass,</span></span><br><span class="line"><span class="params">    TrackedConditionEvaluator trackedConditionEvaluator)</span> &#123;</span><br><span class="line">  <span class="comment">// 使用条件注解判断是否需要跳过这个配置类</span></span><br><span class="line">  <span class="keyword">if</span> (trackedConditionEvaluator.shouldSkip(configClass)) &#123;</span><br><span class="line">    <span class="comment">// 跳过配置类的话在Spring容器中移除bean的注册</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">beanName</span> <span class="operator">=</span> configClass.getBeanName();</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.hasLength(beanName) &amp;&amp; <span class="built_in">this</span>.registry.containsBeanDefinition(beanName)) &#123;</span><br><span class="line">      <span class="built_in">this</span>.registry.removeBeanDefinition(beanName);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">this</span>.importRegistry.removeImportingClassFor(configClass.getMetadata().getClassName());</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (configClass.isImported()) &#123;</span><br><span class="line">    <span class="comment">// 如果自身是被@Import注释所import的，注册自己</span></span><br><span class="line">    registerBeanDefinitionForImportedConfigurationClass(configClass);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 注册方法中被@Bean注解修饰的bean</span></span><br><span class="line">  <span class="keyword">for</span> (BeanMethod beanMethod : configClass.getBeanMethods()) &#123;</span><br><span class="line">    loadBeanDefinitionsForBeanMethod(beanMethod);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 注册@ImportResource注解注释的资源文件中的bean</span></span><br><span class="line">  loadBeanDefinitionsFromImportedResources(configClass.getImportedResources());</span><br><span class="line">  <span class="comment">// 注册@Import注解中的ImportBeanDefinitionRegistrar接口的registerBeanDefinitions</span></span><br><span class="line">  loadBeanDefinitionsFromRegistrars(configClass.getImportBeanDefinitionRegistrars());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>invokeBeanFactoryPostProcessors方法总结来说就是从Spring容器中找出BeanDefinitionRegistryPostProcessor和BeanFactoryPostProcessor接口的实现类并按照一定的规则顺序进行执行。 其中ConfigurationClassPostProcessor这个BeanDefinitionRegistryPostProcessor优先级最高，它会对项目中的@Configuration注解修饰的类(@Component、@ComponentScan、@Import、@ImportResource修饰的类也会被处理)进行解析，解析完成之后把这些bean注册到BeanFactory中。需要注意的是这个时候注册进来的bean还没有实例化。</p>
<p>下面这图就是对ConfigurationClassPostProcessor后置器的总结：</p>
<p><a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/fangjian0423/blogimages/master/images/configuration-annotation-process.png"><img src="https://raw.githubusercontent.com/fangjian0423/blogimages/master/images/configuration-annotation-process.png" alt="img"></a></p>
<h4 id="registerBeanPostProcessors方法"><a href="#registerBeanPostProcessors方法" class="headerlink" title="registerBeanPostProcessors方法"></a>registerBeanPostProcessors方法</h4><p>从Spring容器中找出的BeanPostProcessor接口的bean，并设置到BeanFactory的属性中。之后bean被实例化的时候会调用这个BeanPostProcessor。</p>
<p>该方法委托给了PostProcessorRegistrationDelegate类的registerBeanPostProcessors方法执行。这里的过程跟invokeBeanFactoryPostProcessors类似：</p>
<ol>
<li>先找出实现了PriorityOrdered接口的BeanPostProcessor并排序后加到BeanFactory的BeanPostProcessor集合中</li>
<li>找出实现了Ordered接口的BeanPostProcessor并排序后加到BeanFactory的BeanPostProcessor集合中</li>
<li>没有实现PriorityOrdered和Ordered接口的BeanPostProcessor加到BeanFactory的BeanPostProcessor集合中</li>
</ol>
<p>这些已经存在的BeanPostProcessor在postProcessBeanFactory方法中已经说明，都是由AnnotationConfigUtils的registerAnnotationConfigProcessors方法注册的。这些BeanPostProcessor包括有AutowiredAnnotationBeanPostProcessor(处理被@Autowired注解修饰的bean并注入)、RequiredAnnotationBeanPostProcessor(处理被@Required注解修饰的方法)、CommonAnnotationBeanPostProcessor(处理@PreDestroy、@PostConstruct、@Resource等多个注解的作用)等。</p>
<p>如果是自定义的BeanPostProcessor，已经被ConfigurationClassPostProcessor注册到容器内。</p>
<p>这些BeanPostProcessor会在这个方法内被实例化(通过调用BeanFactory的getBean方法，如果没有找到实例化的类，就会去实例化)。</p>
<h4 id="initMessageSource方法"><a href="#initMessageSource方法" class="headerlink" title="initMessageSource方法"></a>initMessageSource方法</h4><p>在Spring容器中初始化一些国际化相关的属性。</p>
<h4 id="initApplicationEventMulticaster方法"><a href="#initApplicationEventMulticaster方法" class="headerlink" title="initApplicationEventMulticaster方法"></a>initApplicationEventMulticaster方法</h4><p>在Spring容器中初始化事件广播器，事件广播器用于事件的发布。</p>
<p>在<a target="_blank" rel="noopener" href="http://fangjian0423.github.io/2017/04/30/springboot-startup-analysis/">SpringBoot源码分析之SpringBoot的启动过程</a>中分析过，EventPublishingRunListener这个SpringApplicationRunListener会监听事件，其中发生contextPrepared事件的时候EventPublishingRunListener会把事件广播器注入到BeanFactory中。</p>
<p>所以initApplicationEventMulticaster不再需要再次注册，只需要拿出BeanFactory中的事件广播器然后设置到Spring容器的属性中即可。如果没有使用SpringBoot的话，Spring容器得需要自己初始化事件广播器。</p>
<h4 id="onRefresh方法"><a href="#onRefresh方法" class="headerlink" title="onRefresh方法"></a>onRefresh方法</h4><p>一个模板方法，不同的Spring容器做不同的事情。</p>
<p>比如web程序的容器AnnotationConfigEmbeddedWebApplicationContext中会调用createEmbeddedServletContainer方法去创建内置的Servlet容器。</p>
<p>目前SpringBoot只支持3种内置的Servlet容器：</p>
<ol>
<li>Tomcat</li>
<li>Jetty</li>
<li>Undertow</li>
</ol>
<h4 id="registerListeners方法"><a href="#registerListeners方法" class="headerlink" title="registerListeners方法"></a>registerListeners方法</h4><p>把Spring容器内的时间监听器和BeanFactory中的时间监听器都添加的事件广播器中。</p>
<p>然后如果存在early event的话，广播出去。</p>
<h4 id="finishBeanFactoryInitialization方法"><a href="#finishBeanFactoryInitialization方法" class="headerlink" title="finishBeanFactoryInitialization方法"></a>finishBeanFactoryInitialization方法</h4><p>实例化BeanFactory中已经被注册但是未实例化的所有实例(懒加载的不需要实例化)。</p>
<p>比如invokeBeanFactoryPostProcessors方法中根据各种注解解析出来的类，在这个时候都会被初始化。</p>
<p>实例化的过程各种BeanPostProcessor开始起作用。</p>
<h4 id="finishRefresh方法"><a href="#finishRefresh方法" class="headerlink" title="finishRefresh方法"></a>finishRefresh方法</h4><p>refresh做完之后需要做的其他事情。</p>
<ol>
<li>初始化生命周期处理器，并设置到Spring容器中(LifecycleProcessor)</li>
<li>调用生命周期处理器的onRefresh方法，这个方法会找出Spring容器中实现了SmartLifecycle接口的类并进行start方法的调用</li>
<li>发布ContextRefreshedEvent事件告知对应的ApplicationListener进行响应的操作</li>
<li>调用LiveBeansView的registerApplicationContext方法：如果设置了JMX相关的属性，则就调用该方法</li>
<li>发布EmbeddedServletContainerInitializedEvent事件告知对应的ApplicationListener进行响应的操作</li>
</ol>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>Spring容器的refresh过程就是上述11个方法的介绍。内容还是非常多的，本文也只是说了个大概，像bean的实例化过程没有具体去分析，这方面的内容以后会看情况去做分析。</p>
<p>这篇文章也是为之后的文章比如内置Servlet容器的创建启动、条件注解的使用等打下基础。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.cyblogs.com/2020/02/28/2020/02/Shadowsocks%E8%87%AA%E5%AE%9A%E4%B9%89PAC%E8%A7%84%E5%88%99/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/vernonchen.jpg">
      <meta itemprop="name" content="Vernon">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简栈文化">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | 简栈文化">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/02/28/2020/02/Shadowsocks%E8%87%AA%E5%AE%9A%E4%B9%89PAC%E8%A7%84%E5%88%99/" class="post-title-link" itemprop="url">Shadowsocks自定义PAC规则</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-02-28 00:00:00" itemprop="dateCreated datePublished" datetime="2020-02-28T00:00:00+08:00">2020-02-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-06-25 09:56:28" itemprop="dateModified" datetime="2025-06-25T09:56:28+08:00">2025-06-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Shadowsocks/" itemprop="url" rel="index"><span itemprop="name">Shadowsocks</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="Shadowsocks-PAC规则"><a href="#Shadowsocks-PAC规则" class="headerlink" title="Shadowsocks PAC规则"></a>Shadowsocks PAC规则</h4><p>ShadowSocks默认使用GFWList规则和使用adblock plus的引擎。要想自己添加自定义的用户规则，最好熟悉一下其规则：</p>
<p>中文版：<a target="_blank" rel="noopener" href="https://adblockplus.org/zh_CN/filters">Adblock Plus过滤规则</a></p>
<p>自定义代理规则的设置语法与GFWlist相同，语法规则如下：</p>
<ul>
<li>通配符支持。<ul>
<li>比如 <code>*.example.com/*</code></li>
<li>实际书写时可省略 <code>*</code> ， 如<code>.example.com/</code> 和 <code>*.example.com/*</code> 效果一样</li>
</ul>
</li>
<li>正则表达式支持。<ul>
<li>以 <code>\</code> 开始和结束， 如 <code>\[\w]+:\/\/example.com\</code></li>
</ul>
</li>
<li>例外规则 <code>@@</code><ul>
<li>如 <code>@@*.example.com/*</code> 满足 <code>@@</code> 后规则的地址不使用代理</li>
</ul>
</li>
<li>匹配地址开始和结尾 <code>|</code><ul>
<li>如 <code>|http://example.com</code> 、 <code>example.com|</code> 分别表示以 <code>http://example.com</code> 开始和以 <code>example.com</code> 结束的地址</li>
</ul>
</li>
<li>||<code>标记</code><ul>
<li>如 <code>||example.com</code> 则 <code>http://example.com</code> 、<code>https://example.com</code> 、 <code>ftp://example.com</code> 等地址址满足条件。</li>
</ul>
</li>
<li>注释 <code>!</code><ul>
<li>如 <code>!我是注释</code></li>
</ul>
</li>
<li>分隔符^<ul>
<li>表示除了字母、数字或者 _ - . % 之外的任何字符。如 <code>http://example.com^</code> ，<code>http://example.com/</code> 和 <code>http://example.com:8000/</code> 均满足条件，而 <code>http://example.com.ar/</code> 不满足条件。</li>
</ul>
</li>
</ul>
<h4 id="什么是PAC"><a href="#什么是PAC" class="headerlink" title="什么是PAC"></a>什么是PAC</h4><ul>
<li>维基百科摘录的关于PAC的解释：<ul>
<li>代理自动配置（英语：Proxy auto-config，简称PAC）是一种网页浏览器技术，用于定义浏览器该如何自动选择适当的代理服务器来访问一个网址。</li>
<li>一个PAC文件包含一个JavaScript形式的函数<code>FindProxyForURL(url, host)</code>。</li>
<li>这个函数返回一个包含一个或多个访问规则的字符串。</li>
<li>用户代理根据这些规则适用一个特定的代理其或者直接访问。</li>
<li>当一个代理服务器无法响应的时候，多个访问规则提供了其他的后备访问方法。</li>
<li>浏览器在访问其他页面以前，首先访问这个PAC文件。</li>
<li>PAC文件中的URL可能是手工配置的，也可能是是通过网页的网络代理自发现协议（Web Proxy Autodiscovery Protocol）自动配置的。</li>
</ul>
</li>
<li>源自网络的图解：</li>
</ul>
<p><img src="http://static.cyblogs.com/PAC.png" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;PAC.png"></p>
<p>简单说来，PAC就是一种配置规则，它能让你的浏览器智能判断哪些网站走代理，哪些不需要走代理。</p>
<h4 id="pac-txt"><a href="#pac-txt" class="headerlink" title="pac.txt"></a>pac.txt</h4><p>shadowsocks 目录下有一个 pac.txt 文件，而pac.txt这个文件是可以使用在线PAC或通过本地的GWFlist去更新的。所以并不建议用户自定义的规则直接加在pac.txt上面。</p>
<p><img src="http://static.cyblogs.com/ShadowSocks_PAC.jpg" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;ShadowSocks_PAC.jpg"></p>
<p>打开 pac.txt 文件，可以看到头部是如下内容：</p>
<p><img src="http://static.cyblogs.com/ShadowSocks_PAC01.jpg" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;ShadowSocks_PAC01.jpg"></p>
<p>可以看出pac配置文件使用的是JavaScript语法，里面定义了一个变量rules，是一个JSon数组格式的数据类型，数组里面存放的是各种URL的通配符。</p>
<p>那么在pac模式下，如果当访问符合这个数组里面任意一个URL通配符的网址时，系统会走代理，反之直连。比如访问谷歌搜索首页时，会走代理，而访问百度、新浪等国内网站则会选择直连方式。</p>
<h4 id="PAC脚本"><a href="#PAC脚本" class="headerlink" title="PAC脚本"></a>PAC脚本</h4><ul>
<li>PAC，一个自动代理配置脚本，包含了很多使用 JavaScript 编写的规则，它能够决定网络流量走默认通道还是代理服务器通道，控制的流量类型包括：HTTP、HTTPS 和 FTP。</li>
<li>一段 JavaScript 脚本：</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">FindProxyForURL</span>(<span class="params">url, host</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;DIRECT&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面就是一个最简洁的 PAC 文件，意思是所有流量都直接进入互联网，不走代理。</p>
<h4 id="PAC的优势"><a href="#PAC的优势" class="headerlink" title="PAC的优势"></a>PAC的优势</h4><p>PAC自动代理属于智能判断模式，相比全局代理，它的优点有：</p>
<ul>
<li>不影响国内网站的访问速度，防止无意义的绕路；</li>
<li>节省Shadowsocks服务的流量，节省服务器资源；</li>
<li>控制方便。</li>
<li>自动容灾。</li>
</ul>
<h4 id="PAC-语法和函数"><a href="#PAC-语法和函数" class="headerlink" title="PAC 语法和函数"></a>PAC 语法和函数</h4><p>PAC不但使用在ShadowSocks上很方便，实际上它也可以配合其它代理服务端（如Squid），运用在浏览器上，不过需要你去弄懂它的语法和函数。</p>
<p>url 字段表示浏览器地址栏输入的待访问地址，host 为该地址对应的 hostname，return 语句有三种指令：</p>
<ul>
<li>DIRECT，表示无代理直接连接</li>
<li>PROXY host:port，表示走host:port 的 proxy 服务</li>
<li>SOCKS host:port，表示走host:port 的 socks 服务</li>
</ul>
<p>而返回的接口可以是多个代理串联：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="string">&quot;PROXY 222.20.74.89:8800; SOCKS 222.20.74.89:8899; DIRECT&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>上面代理的意思是，默认走<code>222.20.74.89:8800</code> 的 proxy 服务；如果代理挂了或者超时，则走 <code>222.20.74.89:8899</code>的 socks 代理；如果 socks 也挂了，则无代理直接连接。</p>
<p>从这里可以看出 PAC 的一大优势：自动容灾。</p>
<p>PAC 提供了几个内置的函数，下面一一介绍下：</p>
<p><strong>dnsDomainIs</strong></p>
<p>类似于 &#x3D;&#x3D;，但是对大小写不敏感，</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="title function_">dnsDomainIs</span>(host, <span class="string">&quot;google.com&quot;</span>) || </span><br><span class="line">    <span class="title function_">dnsDomainIs</span>(host, <span class="string">&quot;www.google.com&quot;</span>)) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;DIRECT&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>shExpMatch</strong></p>
<p>Shell 正则匹配，* 匹配用的比较多，可以是*.<a target="_blank" rel="noopener" href="http://example.com/">http://example.com</a>，也可以是下面这样：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="title function_">shExpMatch</span>(host, <span class="string">&quot;vpn.domain.com&quot;</span>) ||</span><br><span class="line">    <span class="title function_">shExpMatch</span>(url, <span class="string">&quot;http://abcdomain.com/folder/*&quot;</span>)) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;DIRECT&quot;</span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>isInNet</strong></p>
<p>判断是否在网段内容，比如 10.1.0.0 这个网段，10.1.1.0 就在网段中，</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="title function_">isInNet</span>(<span class="title function_">dnsResolve</span>(host), <span class="string">&quot;172.16.0.0&quot;</span>, <span class="string">&quot;255.240.0.0&quot;</span>)) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;DIRECT&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>myIpAddress</strong></p>
<p>返回主机的 IP，</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="title function_">isInNet</span>(<span class="title function_">myIpAddress</span>(), <span class="string">&quot;10.10.1.0&quot;</span>, <span class="string">&quot;255.255.255.0&quot;</span>)) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;PROXY 10.10.5.1:8080&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>dnsResolve</strong></p>
<p>通过 DNS 查询主机 ip，</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="title function_">isInNet</span>(<span class="title function_">dnsResolve</span>(host), <span class="string">&quot;10.0.0.0&quot;</span>, <span class="string">&quot;255.0.0.0&quot;</span>) ||</span><br><span class="line">    <span class="title function_">isInNet</span>(<span class="title function_">dnsResolve</span>(host), <span class="string">&quot;172.16.0.0&quot;</span>,  <span class="string">&quot;255.240.0.0&quot;</span>) ||</span><br><span class="line">    <span class="title function_">isInNet</span>(<span class="title function_">dnsResolve</span>(host), <span class="string">&quot;192.168.0.0&quot;</span>, <span class="string">&quot;255.255.0.0&quot;</span>) ||</span><br><span class="line">    <span class="title function_">isInNet</span>(<span class="title function_">dnsResolve</span>(host), <span class="string">&quot;127.0.0.0&quot;</span>, <span class="string">&quot;255.255.255.0&quot;</span>)) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;DIRECT&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>isPlainHostName</strong></p>
<p>判断是否为诸如barret&#x2F;，server-name&#x2F; 这样的主机名。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="title function_">isPlainHostName</span>(host)) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;DIRECT&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>isResolvable</strong></p>
<p>判断主机是否可访问。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="title function_">isResolvable</span>(host)) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;PROXY proxy1.example.com:8080&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>dnsDomainLevels</strong></p>
<p>返回是几级域名，比如 dnsDomainLevels 返回的结果就是 1。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="title function_">dnsDomainLevels</span>(host) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;PROXY proxy1.example.com:8080&quot;</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;DIRECT&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>weekdayRange</strong></p>
<p>周一到周五</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="title function_">weekdayRange</span>(<span class="string">&quot;MON&quot;</span>, <span class="string">&quot;FRI&quot;</span>)) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;PROXY proxy1.example.com:8080&quot;</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;DIRECT&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>dateRange</strong></p>
<p>一月到五月</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="title function_">dateRange</span>(<span class="string">&quot;JAN&quot;</span>, <span class="string">&quot;MAR&quot;</span>))  &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;PROXY proxy1.example.com:8080&quot;</span>;  </span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;DIRECT&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>timeRange</strong></p>
<p>八点到十八点，</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="title function_">timeRange</span>(<span class="number">8</span>, <span class="number">18</span>)) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;PROXY proxy1.example.com:8080&quot;</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;DIRECT&quot;</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>alert</strong></p>
<p>这个弹窗警报信息函数可以用来配合浏览器的控制台进行调试</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">resolved_host = <span class="title function_">dnsResolve</span>(host);</span><br><span class="line"><span class="title function_">alert</span>(resolved_host);</span><br></pre></td></tr></table></figure>

<h4 id="PAC-文件的安装和注意事项"><a href="#PAC-文件的安装和注意事项" class="headerlink" title="PAC 文件的安装和注意事项"></a>PAC 文件的安装和注意事项</h4><p>在 Windows 系统中，通过<code>「Internet选项 -&gt; 连接 -&gt; 局域网设置 -&gt; 使用自动配置脚本」</code>可以找到配置处，下方的地址栏填写 PAC 文件的 URI，这个 URI 可以是本地资源路径(<code>file:///</code>)，也可以是网络资源路径。</p>
<p>Chrome 中可以在<code>「chrome://settings/ -&gt; 显示高级设置 -&gt; 更改代理服务器设置」</code>中找到 PAC 填写地址。</p>
<p><strong>需要注意的几点：</strong></p>
<ul>
<li>PAC 文件被访问时，返回的文件类型（Content-Type）应该为：<code>application/x-ns-proxy-autoconfig</code>，当然，如果你不写，一般浏览器也能够自动辨别。</li>
<li><code>FindProxyByUrl(url, host)</code>中的 host 在上述函数对比时无需转换成小写，对大小写不敏感。</li>
<li>没必要对 <code>dnsResolve(host)</code>的结果做缓存，DNS 在解析的时候会将结果缓存到系统中。</li>
</ul>
<h4 id="PAC文件及user-rule文件的语法规则"><a href="#PAC文件及user-rule文件的语法规则" class="headerlink" title="PAC文件及user-rule文件的语法规则"></a>PAC文件及user-rule文件的语法规则</h4><p>当一个网站被墙，如何添加到PAC里面让其能够正常访问呢？以MDN web doc这个网站为例，在Shadowsocks里面，可以有如下两个方式：</p>
<h5 id="1-添加到-pac-txt-文件中"><a href="#1-添加到-pac-txt-文件中" class="headerlink" title="1. 添加到 pac.txt 文件中"></a>1. 添加到 <code>pac.txt</code> 文件中</h5><p>编辑 <code>pac.txt</code> 文件，模仿里面的一些URL通配符，在rules（中括号）列表中再添加一个，例如<code>&quot;||developer.mozilla.org^&quot;,</code> ，注意不要忘记了 <code>,</code> 半角逗号，当然如果你是在最后添加的就可以不加半角逗号。这样配置下来就是所有 <code>developer.mozilla.org</code>域名下的网址都将走Shadowsocks代理。</p>
<p><img src="https://www.tielemao.com/wp-content/uploads/2018/05/ShadowSocks_PAC02.jpg?imageView2/2/w/1280/format/jpg/interlace/1/q/100" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;hotlink.jpg"></p>
<h5 id="2-添加到-user-rule-txt-文件中（推荐）"><a href="#2-添加到-user-rule-txt-文件中（推荐）" class="headerlink" title="2. 添加到 user-rule.txt 文件中（推荐）"></a>2. 添加到 <code>user-rule.txt</code> 文件中（推荐）</h5><p>编辑 <code>user-rule.txt</code> 文件，这里和 <code>pac.txt</code> 文件语法不完全相同，user-rule文件中，每一行表示一个URL通配符，但是通配符语法类似。例如添加一行<code>||developer.mozilla.org^</code> ，然后记得右键shadowsocks小飞机图标-PAC-从GFWList更新本地PAC。</p>
<p>推荐使用添加到user-rule.txt的这种自定义用户规则的方法，因为pac文件里的规则是有可能被在线更新掉的。</p>
<p><img src="http://static.cyblogs.com/3vjn79vf2uit5prto2asqoa39s.png" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;3vjn79vf2uit5prto2asqoa39s.png"></p>
<p>注意末尾不要忘记 ^ 符号，意思是要么在这个符号的地方结束，要么后面跟着?,&#x2F;等符号。</p>
<h4 id="参考地址"><a href="#参考地址" class="headerlink" title="参考地址"></a>参考地址</h4><ul>
<li><a target="_blank" rel="noopener" href="https://fuyiyi.imdo.co/articles/2018/09/30/1538314978887.html">https://fuyiyi.imdo.co/articles/2018/09/30/1538314978887.html</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.cyblogs.com/2020/02/28/2020/02/Tomcat%E6%98%AF%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E5%BC%82%E6%AD%A5Servlet%E7%9A%84/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/vernonchen.jpg">
      <meta itemprop="name" content="Vernon">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简栈文化">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | 简栈文化">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/02/28/2020/02/Tomcat%E6%98%AF%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E5%BC%82%E6%AD%A5Servlet%E7%9A%84/" class="post-title-link" itemprop="url">Tomcat是如何实现异步Servlet的</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-02-28 00:00:00" itemprop="dateCreated datePublished" datetime="2020-02-28T00:00:00+08:00">2020-02-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-06-25 09:57:28" itemprop="dateModified" datetime="2025-06-25T09:57:28+08:00">2025-06-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Tomcat/" itemprop="url" rel="index"><span itemprop="name">Tomcat</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h4><p>通过我之前的Tomcat系列文章，相信看我博客的同学对Tomcat应该有一个比较清晰的了解了，在前几篇博客我们讨论了Tomcat在SpringBoot框架中是如何启动的，讨论了Tomcat的内部组件是如何设计以及请求是如何流转的，那么我们这篇博客聊聊Tomcat的异步Servlet，Tomcat是如何实现异步Servlet的以及异步Servlet的使用场景。</p>
<h4 id="手撸一个异步的Servlet"><a href="#手撸一个异步的Servlet" class="headerlink" title="手撸一个异步的Servlet"></a>手撸一个异步的Servlet</h4><p>我们直接借助SpringBoot框架来实现一个Servlet,这里只展示Servlet代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@WebServlet(urlPatterns = &quot;/async&quot;,asyncSupported = true)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AsyncServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span>Executors.newSingleThreadExecutor();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">     <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="comment">//开启异步,获取异步上下文</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">AsyncContext</span> <span class="variable">ctx</span> <span class="operator">=</span> req.startAsync();</span><br><span class="line">        <span class="comment">// 提交线程池异步执行</span></span><br><span class="line">        executorService.execute(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    log.info(<span class="string">&quot;async Service 准备执行了&quot;</span>);</span><br><span class="line">                    <span class="comment">//模拟耗时任务</span></span><br><span class="line">                    Thread.sleep(<span class="number">10000L</span>);</span><br><span class="line">                    ctx.getResponse().getWriter().print(<span class="string">&quot;async servlet&quot;</span>);</span><br><span class="line">                    log.info(<span class="string">&quot;async Service 执行了&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//最后执行完成后完成回调。</span></span><br><span class="line">                ctx.complete();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>上面的代码实现了一个异步的Servlet,实现了<code>doGet</code>方法注意在SpringBoot中使用需要再启动类加上<code>@ServletComponentScan</code>注解来扫描Servlet。既然代码写好了，我们来看看实际运行效果。</p>
<p><img src="https://github.com/kinglaw1204/blogImage/blob/master/Tomcat%E8%A7%A3%E6%9E%90/%E5%BC%82%E6%AD%A5Servlet/async%20Servlet%20result.png?raw=true" alt="img"></p>
<p>我们发送一个请求后，看到页面有响应，同时，看到请求时间花费了10.05s,那么我们这个Servlet算是能正常运行啦。有同学肯定会问，这不是异步servlet吗？你的响应时间并没有加快，有什么用呢？对，我们的响应时间并不能加快，还是会取决于我们的业务逻辑，但是我们的异步servlet请求后，依赖于业务的异步执行，我们可以立即返回，也就是说，Tomcat的线程可以立即回收，默认情况下，Tomcat的核心线程是<strong>10</strong>，最大线程数是<strong>200</strong>,我们能及时回收线程，也就意味着我们能处理更多的请求，能够增加我们的吞吐量，这也是异步Servlet的主要作用。</p>
<h4 id="异步Servlet的内部原理"><a href="#异步Servlet的内部原理" class="headerlink" title="异步Servlet的内部原理"></a>异步Servlet的内部原理</h4><p>了解完异步Servlet的作用后，我们来看看，Tomcat是如何是先异步Servlet的。其实上面的代码，主要核心逻辑就两部分，<code>final AsyncContext ctx = req.startAsync()</code>和<code> ctx.complete()</code>那我们来看看他们究竟做了什么？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> AsyncContext <span class="title function_">startAsync</span><span class="params">(ServletRequest request,</span></span><br><span class="line"><span class="params">         ServletResponse response)</span> &#123;</span><br><span class="line">     <span class="keyword">if</span> (!isAsyncSupported()) &#123;</span><br><span class="line">         <span class="type">IllegalStateException</span> <span class="variable">ise</span> <span class="operator">=</span></span><br><span class="line">                 <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(sm.getString(<span class="string">&quot;request.asyncNotSupported&quot;</span>));</span><br><span class="line">         log.warn(sm.getString(<span class="string">&quot;coyoteRequest.noAsync&quot;</span>,</span><br><span class="line">                 StringUtils.join(getNonAsyncClassNames())), ise);</span><br><span class="line">         <span class="keyword">throw</span> ise;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (asyncContext == <span class="literal">null</span>) &#123;</span><br><span class="line">         asyncContext = <span class="keyword">new</span> <span class="title class_">AsyncContextImpl</span>(<span class="built_in">this</span>);</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     asyncContext.setStarted(getContext(), request, response,</span><br><span class="line">             request==getRequest() &amp;&amp; response==getResponse().getResponse());</span><br><span class="line">     asyncContext.setTimeout(getConnector().getAsyncTimeout());</span><br><span class="line"></span><br><span class="line">     <span class="keyword">return</span> asyncContext;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>我们发现<code>req.startAsync()</code>只是保存了一个异步上下文，同时设置一些基础信息，比如<code>Timeout</code>,顺便提一下，这里设置的默认超时时间是<strong>30S</strong>，如果你的异步处理逻辑超过<strong>30S</strong>,此时执行<code>ctx.complete()</code>就会抛出IllegalStateException 异常。</p>
<p>我们来看看<code>ctx.complete()</code>的逻辑</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">complete</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">            logDebug(<span class="string">&quot;complete   &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        check();</span><br><span class="line">        request.getCoyoteRequest().action(ActionCode.ASYNC_COMPLETE, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//类：AbstractProcessor </span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">action</span><span class="params">(ActionCode actionCode, Object param)</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> ASYNC_COMPLETE: &#123;</span><br><span class="line">            clearDispatches();</span><br><span class="line">            <span class="keyword">if</span> (asyncStateMachine.asyncComplete()) &#123;</span><br><span class="line">                processSocketEvent(SocketEvent.OPEN_READ, <span class="literal">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125; </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//类：AbstractProcessor </span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">processSocketEvent</span><span class="params">(SocketEvent event, <span class="type">boolean</span> dispatch)</span> &#123;</span><br><span class="line">        SocketWrapperBase&lt;?&gt; socketWrapper = getSocketWrapper();</span><br><span class="line">        <span class="keyword">if</span> (socketWrapper != <span class="literal">null</span>) &#123;</span><br><span class="line">            socketWrapper.processSocket(event, dispatch);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//类：AbstractEndpoint</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">processSocket</span><span class="params">(SocketWrapperBase&lt;S&gt; socketWrapper,</span></span><br><span class="line"><span class="params">            SocketEvent event, <span class="type">boolean</span> dispatch)</span> &#123;</span><br><span class="line">        <span class="comment">//省略部分代码</span></span><br><span class="line">            SocketProcessorBase&lt;S&gt; sc = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (processorCache != <span class="literal">null</span>) &#123;</span><br><span class="line">                sc = processorCache.pop();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (sc == <span class="literal">null</span>) &#123;</span><br><span class="line">                sc = createSocketProcessor(socketWrapper, event);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                sc.reset(socketWrapper, event);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">Executor</span> <span class="variable">executor</span> <span class="operator">=</span> getExecutor();</span><br><span class="line">            <span class="keyword">if</span> (dispatch &amp;&amp; executor != <span class="literal">null</span>) &#123;</span><br><span class="line">                executor.execute(sc);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                sc.run();</span><br><span class="line">            &#125;</span><br><span class="line">   </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>所以，这里最终会调用<code>AbstractEndpoint</code>的<code>processSocket</code>方法，之前看过我前面博客的同学应该有印象，<code>EndPoint</code>是用来接受和处理请求的，接下来就会交给<code>Processor</code>去进行协议处理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">类：AbstractProcessorLight</span><br><span class="line"><span class="keyword">public</span> SocketState <span class="title function_">process</span><span class="params">(SocketWrapperBase&lt;?&gt; socketWrapper, SocketEvent status)</span></span><br><span class="line">            <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">//省略部分diam</span></span><br><span class="line">        <span class="type">SocketState</span> <span class="variable">state</span> <span class="operator">=</span> SocketState.CLOSED;</span><br><span class="line">        Iterator&lt;DispatchType&gt; dispatches = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (dispatches != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">DispatchType</span> <span class="variable">nextDispatch</span> <span class="operator">=</span> dispatches.next();</span><br><span class="line">                state = dispatch(nextDispatch.getSocketStatus());</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (status == SocketEvent.DISCONNECT) &#123;</span><br><span class="line">            </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isAsync() || isUpgrade() || state == SocketState.ASYNC_END) &#123;</span><br><span class="line">                state = dispatch(status);</span><br><span class="line">                <span class="keyword">if</span> (state == SocketState.OPEN) &#123;</span><br><span class="line">                    state = service(socketWrapper);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (status == SocketEvent.OPEN_WRITE) &#123;</span><br><span class="line">                state = SocketState.LONG;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (status == SocketEvent.OPEN_READ)&#123;</span><br><span class="line">                state = service(socketWrapper);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                state = SocketState.CLOSED;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">while</span> (state == SocketState.ASYNC_END ||</span><br><span class="line">                dispatches != <span class="literal">null</span> &amp;&amp; state != SocketState.CLOSED);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> state;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这部分是重点，<code>AbstractProcessorLight</code>会根据<code>SocketEvent</code>的状态来判断是不是要去调用<code>service(socketWrapper)</code>,该方法最终会去调用到容器，从而完成业务逻辑的调用，我们这个请求是执行完成后调用的，肯定不能进容器了，不然就是死循环了，这里通过<code>isAsync() </code>判断，就会进入<code>dispatch(status)</code>,最终会调用<code>CoyoteAdapter</code>的<code>asyncDispatch</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">asyncDispatch</span><span class="params">(org.apache.coyote.Request req, org.apache.coyote.Response res,</span></span><br><span class="line"><span class="params">            SocketEvent status)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//省略部分代码</span></span><br><span class="line">        <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> (Request) req.getNote(ADAPTER_NOTES);</span><br><span class="line">        <span class="type">Response</span> <span class="variable">response</span> <span class="operator">=</span> (Response) res.getNote(ADAPTER_NOTES);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="type">AsyncContextImpl</span> <span class="variable">asyncConImpl</span> <span class="operator">=</span> request.getAsyncContextInternal();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!request.isAsync()) &#123;</span><br><span class="line">                response.setSuspended(<span class="literal">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (status==SocketEvent.TIMEOUT) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!asyncConImpl.timeout()) &#123;</span><br><span class="line">                    asyncConImpl.setErrorState(<span class="literal">null</span>, <span class="literal">false</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (status==SocketEvent.ERROR) &#123;</span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!request.isAsyncDispatching() &amp;&amp; request.isAsync()) &#123;</span><br><span class="line">                <span class="type">WriteListener</span> <span class="variable">writeListener</span> <span class="operator">=</span> res.getWriteListener();</span><br><span class="line">                <span class="type">ReadListener</span> <span class="variable">readListener</span> <span class="operator">=</span> req.getReadListener();</span><br><span class="line">                <span class="keyword">if</span> (writeListener != <span class="literal">null</span> &amp;&amp; status == SocketEvent.OPEN_WRITE) &#123;</span><br><span class="line">                    <span class="type">ClassLoader</span> <span class="variable">oldCL</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        oldCL = request.getContext().bind(<span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">                        res.onWritePossible();<span class="comment">//这里执行浏览器响应，写入数据</span></span><br><span class="line">                        <span class="keyword">if</span> (request.isFinished() &amp;&amp; req.sendAllDataReadEvent() &amp;&amp;</span><br><span class="line">                                readListener != <span class="literal">null</span>) &#123;</span><br><span class="line">                            readListener.onAllDataRead();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                       </span><br><span class="line">                    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                        request.getContext().unbind(<span class="literal">false</span>, oldCL);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; </span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//这里判断异步正在进行，说明这不是一个完成方法的回调，是一个正常异步请求，继续调用容器。</span></span><br><span class="line">            <span class="keyword">if</span> (request.isAsyncDispatching()) &#123;</span><br><span class="line">                connector.getService().getContainer().getPipeline().getFirst().invoke(</span><br><span class="line">                        request, response);</span><br><span class="line">                <span class="type">Throwable</span> <span class="variable">t</span> <span class="operator">=</span> (Throwable) request.getAttribute(RequestDispatcher.ERROR_EXCEPTION);</span><br><span class="line">                <span class="keyword">if</span> (t != <span class="literal">null</span>) &#123;</span><br><span class="line">                    asyncConImpl.setErrorState(t, <span class="literal">true</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//注意，这里，如果超时或者出错，request.isAsync()会返回false，这里是为了尽快的输出错误给客户端。</span></span><br><span class="line">            <span class="keyword">if</span> (!request.isAsync()) &#123;</span><br><span class="line">                <span class="comment">//这里也是输出逻辑</span></span><br><span class="line">                request.finishRequest();</span><br><span class="line">                response.finishResponse();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//销毁request和response</span></span><br><span class="line">            <span class="keyword">if</span> (!success || !request.isAsync()) &#123;</span><br><span class="line">                updateWrapperErrorCount(request, response);</span><br><span class="line">                request.recycle();</span><br><span class="line">                response.recycle();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> success;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>上面的代码就是<code>ctx.complete()</code>执行最终的方法了（当然省略了很多细节），完成了数据的输出，最终输出到浏览器。</p>
<p>这里有同学可能会说，我知道异步执行完后，调用<code>ctx.complete()</code>会输出到浏览器，但是，第一次doGet请求执行完成后，Tomcat是怎么知道不用返回到客户端的呢？关键代码在<code>CoyoteAdapter</code>中的<code>service</code>方法，部分代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">postParseSuccess = postParseRequest(req, request, res, response);</span><br><span class="line">          <span class="comment">//省略部分代码</span></span><br><span class="line">          <span class="keyword">if</span> (postParseSuccess) &#123;</span><br><span class="line">              request.setAsyncSupported(</span><br><span class="line">                      connector.getService().getContainer().getPipeline().isAsyncSupported());</span><br><span class="line">              connector.getService().getContainer().getPipeline().getFirst().invoke(</span><br><span class="line">                      request, response);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (request.isAsync()) &#123;</span><br><span class="line">              async = <span class="literal">true</span>;</span><br><span class="line">             &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">             <span class="comment">//输出数据到客户端</span></span><br><span class="line">              request.finishRequest();</span><br><span class="line">              response.finishResponse();</span><br><span class="line">          <span class="keyword">if</span> (!async) &#123;</span><br><span class="line">              updateWrapperErrorCount(request, response);</span><br><span class="line">              <span class="comment">//销毁request和response</span></span><br><span class="line">              request.recycle();</span><br><span class="line">              response.recycle();</span><br><span class="line">          &#125;</span><br></pre></td></tr></table></figure>

<p>这部分代码在调用完<code>Servlet</code>后，会通过<code>request.isAsync()</code>来判断是否是异步请求，如果是异步请求，就设置<code> async = true</code>。如果是非异步请求就执行输出数据到客户端逻辑，同时销毁<code>request</code>和<code>response</code>。这里就完成了请求结束后不响应客户端的操作。</p>
<h4 id="为什么说Spring-Boot的-EnableAsync注解不是异步Servlet"><a href="#为什么说Spring-Boot的-EnableAsync注解不是异步Servlet" class="headerlink" title="为什么说Spring Boot的@EnableAsync注解不是异步Servlet"></a>为什么说Spring Boot的@EnableAsync注解不是异步Servlet</h4><p>因为之前准备写本篇文章的时候就查询过很多资料，发现很多资料写SpringBoot异步编程都是依赖于<code>@EnableAsync</code>注解，然后在<code>Controller</code>用多线程来完成业务逻辑，最后汇总结果，完成返回输出。这里拿一个掘金大佬的文章来举例《<a target="_blank" rel="noopener" href="https://juejin.im/post/5d9e7cfa6fb9a04e1f12ec02">新手也能看懂的 SpringBoot 异步编程指南</a>》，这篇文章写得很通俗易懂，非常不错，从业务层面来说，确实是异步编程，但是有一个问题，抛开业务的并行处理来说，针对整个请求来说，并不是异步的，也就是说不能立即释放Tomcat的线程，从而不能达到异步Servlet的效果。这里我参考上文也写了一个demo，我们来验证下，为什么它不是异步的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> TestService service;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            log.info(<span class="string">&quot;testAsynch Start&quot;</span>);</span><br><span class="line">            CompletableFuture&lt;String&gt; test1 = service.test1();</span><br><span class="line">            CompletableFuture&lt;String&gt; test2 = service.test2();</span><br><span class="line">            CompletableFuture&lt;String&gt; test3 = service.test3();</span><br><span class="line">            CompletableFuture.allOf(test1, test2, test3);</span><br><span class="line">            log.info(<span class="string">&quot;test1=====&quot;</span> + test1.get());</span><br><span class="line">            log.info(<span class="string">&quot;test2=====&quot;</span> + test2.get());</span><br><span class="line">            log.info(<span class="string">&quot;test3=====&quot;</span> + test3.get());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ExecutionException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestService</span> &#123;</span><br><span class="line">    <span class="meta">@Async(&quot;asyncExecutor&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> CompletableFuture&lt;String&gt; <span class="title function_">test1</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        Thread.sleep(<span class="number">3000L</span>);</span><br><span class="line">        <span class="keyword">return</span> CompletableFuture.completedFuture(<span class="string">&quot;test1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Async(&quot;asyncExecutor&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> CompletableFuture&lt;String&gt; <span class="title function_">test2</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        Thread.sleep(<span class="number">3000L</span>);</span><br><span class="line">        <span class="keyword">return</span> CompletableFuture.completedFuture(<span class="string">&quot;test2&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Async(&quot;asyncExecutor&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> CompletableFuture&lt;String&gt; <span class="title function_">test3</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        Thread.sleep(<span class="number">3000L</span>);</span><br><span class="line">        <span class="keyword">return</span> CompletableFuture.completedFuture(<span class="string">&quot;test3&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableAsync</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TomcatdebugApplication</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(TomcatdebugApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = &quot;asyncExecutor&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Executor <span class="title function_">asyncExecutor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ThreadPoolTaskExecutor</span> <span class="variable">executor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolTaskExecutor</span>();</span><br><span class="line">        executor.setCorePoolSize(<span class="number">3</span>);</span><br><span class="line">        executor.setMaxPoolSize(<span class="number">3</span>);</span><br><span class="line">        executor.setQueueCapacity(<span class="number">100</span>);</span><br><span class="line">        executor.setThreadNamePrefix(<span class="string">&quot;AsynchThread-&quot;</span>);</span><br><span class="line">        executor.initialize();</span><br><span class="line">        <span class="keyword">return</span> executor;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这里我运行下，看看效果</p>
<p><img src="https://github.com/kinglaw1204/blogImage/blob/master/Tomcat%E8%A7%A3%E6%9E%90/%E5%BC%82%E6%AD%A5Servlet/Spring%20boot%20%E5%BC%82%E6%AD%A51.gif?raw=true" alt="img"></p>
<p>这里我请求之后，在调用容器执行业务逻辑之前打了一个断点，然后在返回之后的同样打了一个断点，在<code>Controller</code>执行完之后，请求才回到了<code>CoyoteAdapter</code>中，并且判断<code>request.isAsync()</code>,根据图中看到，是为<code>false</code>,那么接下来就会执行<code> request.finishRequest()</code>和<code>response.finishResponse()</code> 来执行响应的结束，并销毁请求和响应体。很有趣的事情是，我实验的时候发现，在执行<code>request.isAsync()</code>之前，浏览器的页面上已经出现了响应体，这是SpringBoot框架已经通过<code>StringHttpMessageConverter</code>类中的<code>writeInternal</code>方法已经进行输出了。</p>
<p><strong>以上分析的核心逻辑就是</strong>，Tomcat的线程执行<code>CoyoteAdapter</code>调用容器后，必须要等到请求返回，然后再判断是否是异步请求，再处理请求，然后执行完毕后，线程才能进行回收。而我一最开始的异步Servlet例子，执行完doGet方法后，就会立即返回，也就是会直接到<code>request.isAsync()</code>的逻辑，然后整个线程的逻辑执行完毕，线程被回收。</p>
<h4 id="聊聊异步Servlet的使用场景"><a href="#聊聊异步Servlet的使用场景" class="headerlink" title="聊聊异步Servlet的使用场景"></a>聊聊异步Servlet的使用场景</h4><p>分析了这么多，那么异步Servlet的使用场景有哪些呢？其实我们只要抓住一点就可以分析了，就是异步Servlet提高了系统的吞吐量，可以接受更多的请求。假设web系统中Tomcat的线程不够用了，大量请求在等待，而此时Web系统应用层面的优化已经不能再优化了，也就是无法缩短业务逻辑的响应时间了，这个时候，如果想让减少用户的等待时间，提高吞吐量，可以尝试下使用异步Servlet。</p>
<p><strong>举一个实际的例子</strong>：比如做一个短信系统，短信系统对实时性要求很高，所以要求等待时间尽可能短，而发送功能我们实际上是委托运营商去发送的，也就是说我们要调用接口，假设并发量很高，那么这个时候业务系统调用我们的发送短信功能，就有可能把我们的Tomcat线程池用完，剩下的请求就会在队列中等待，那这个时候，短信的延时就上去了，为了解决这个问题，我们可以引入异步Servlet,接受更多的短信发送请求，从而减少短信的延时。</p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>这篇文章我从手写一个异步Servlet来开始，分析了异步Servlet的作用，以及Tomcat内部是如何实现异步Servlet的，然后我也根据互联网上流行的SpringBoot异步编程来进行说明，其在Tomcat内部并不是一个异步的Servlet。最后，我谈到了异步Servlet的使用场景，分析了什么情况下可以尝试异步Servlet。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.cyblogs.com/2020/02/28/2020/02/Zookeeper%20Leader%E9%80%89%E4%B8%BE%E7%AE%97%E6%B3%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/vernonchen.jpg">
      <meta itemprop="name" content="Vernon">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简栈文化">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | 简栈文化">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/02/28/2020/02/Zookeeper%20Leader%E9%80%89%E4%B8%BE%E7%AE%97%E6%B3%95/" class="post-title-link" itemprop="url">Zookeeper Leader选举算法</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-02-28 00:00:00" itemprop="dateCreated datePublished" datetime="2020-02-28T00:00:00+08:00">2020-02-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-06-25 09:57:28" itemprop="dateModified" datetime="2025-06-25T09:57:28+08:00">2025-06-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Zookeeper/" itemprop="url" rel="index"><span itemprop="name">Zookeeper</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>当Leader崩溃或者Leader失去大多数的Follower，这时候zk进入恢复模式，恢复模式需要重新选举出一个新的Leader，让所有的Server都恢复到一个正确的状态。Zookeeper中Leader的选举采用了三种算法：</p>
<ul>
<li>LeaderElection</li>
<li>FastLeaderElection</li>
<li>AuthFastLeaderElection</li>
</ul>
<p>并且在配置文件中是可配置的，对应的配置项为electionAlg。</p>
<h4 id="背景知识"><a href="#背景知识" class="headerlink" title="背景知识"></a>背景知识</h4><p>Zookeeper Server的状态可分为四种：</p>
<ul>
<li>LOOKING：寻找Leader</li>
<li>LEADING：Leader状态，对应的节点为Leader。</li>
<li>FOLLOWING：Follower状态，对应的节点为Follower。</li>
<li>OBSERVING：Observer状态，对应节点为Observer，该节点不参与Leader选举。</li>
</ul>
<p>成为Leader的必要条件： Leader要具有最高的zxid；当集群的规模是n时，集群中大多数的机器（至少n&#x2F;2+1）得到响应并follow选出的Leader。</p>
<p>心跳机制：Leader与Follower利用PING来感知对方的是否存活，当Leader无法相应PING时，将重新发起Leader选举。</p>
<h4 id="术语"><a href="#术语" class="headerlink" title="术语"></a>术语</h4><p><strong>zxid</strong>：zookeeper transaction id, 每个改变Zookeeper状态的操作都会形成一个对应的zxid，并记录到transaction log中。 这个值越大，表示更新越新。</p>
<p><strong>electionEpoch&#x2F;logicalclock</strong>：逻辑时钟，用来判断是否为同一次选举。每调用一次选举函数，logicalclock自增1，并且在选举过程中如果遇到election比当前logicalclock大的值，就更新本地logicalclock的值。</p>
<p><strong>peerEpoch</strong>: 表示节点的Epoch。</p>
<h4 id="LeaderElection选举算法"><a href="#LeaderElection选举算法" class="headerlink" title="LeaderElection选举算法"></a>LeaderElection选举算法</h4><p>LeaderElection是Fast Paxos最简单的一种实现，每个Server启动以后都询问其它的Server它要投票给谁，收到所有Server回复以后，就计算出zxid最大的哪个Server，并将这个Server相关信息设置成下一次要投票的Server。该算法于Zookeeper 3.4以后的版本废弃。</p>
<p>选举算法流程如下：</p>
<ol>
<li>选举线程首先向所有Server发起一次询问(包括自己)；</li>
<li>选举线程收到回复后，验证是否是自己发起的询问(验证xid是否一致)，然后获取对方的id(myid)，并存储到当前询问对象列表中，最后获取对方提议的leader相关信息(id,zxid)，并将这些信息存储到当次选举的投票记录表中；</li>
<li>收到所有Server回复以后，就计算出zxid最大的那个Server，并将这个Server相关信息设置成下一次要投票的Server；</li>
<li>线程将当前zxid最大的Server设置为当前Server要推荐的Leader，如果此时获胜的Server获得多数Server票数， 设置当前推荐的leader为获胜的Server，将根据获胜的Server相关信息设置自己的状态，否则，继续这个过程，直到leader被选举出来。</li>
</ol>
<p><a target="_blank" rel="noopener" href="http://www.yidooo.net/images/leader_election.jpg"><img src="http://www.yidooo.net/images/leader_election.jpg" alt="leader-election"></a></p>
<p>通过流程分析我们可以得出：要使Leader获得多数Server的支持，则Server总数必须是奇数2n+1，且存活的Server的数目不得少于n+1.</p>
<p>异常问题的处理：</p>
<ol>
<li>选举过程中，Server的加入<br>当一个Server启动时它都会发起一次选举，此时由选举线程发起相关流程，那么每个 Serve r都会获得当前zxi d最大的哪个Serve r是谁，如果当次最大的Serve r没有获得n&#x2F;2+1 个票数，那么下一次投票时，他将向zxid最大的Server投票，重复以上流程，最后一定能选举出一个Leader。</li>
<li>选举过程中，Server的退出<br>只要保证n&#x2F;2+1个Server存活就没有任何问题，如果少于n&#x2F;2+1个Server 存活就没办法选出Leader。</li>
<li>选举过程中，Leader死亡<br>当选举出Leader以后，此时每个Server应该是什么状态(FLLOWING)都已经确定，此时由于Leader已经死亡我们就不管它，其它的Fllower按正常的流程继续下去，当完成这个流程以后，所有的Fllower都会向Leader发送Ping消息，如果无法ping通，就改变自己的状为(FLLOWING &#x3D;&#x3D;&gt; LOOKING)，发起新的一轮选举。</li>
<li>选举完成以后，Leader死亡<br>处理过程同上。</li>
<li>双主问题<br>Leader的选举是保证只产生一个公认的Leader的，而且Follower重新选举与旧Leader恢复并退出基本上是同时发生的，当Follower无法ping同Leader是就认为Leader已经出问题开始重新选举，Leader收到Follower的ping没有达到半数以上则要退出Leader重新选举。</li>
</ol>
<h4 id="FastLeaderElection选举算法"><a href="#FastLeaderElection选举算法" class="headerlink" title="FastLeaderElection选举算法"></a>FastLeaderElection选举算法</h4><p>由于LeaderElection收敛速度较慢，所以Zookeeper引入了FastLeaderElection选举算法，FastLeaderElection也成了Zookeeper默认的Leader选举算法。</p>
<p>FastLeaderElection是标准的Fast Paxos的实现，它首先向所有Server提议自己要成为leader，当其它Server收到提议以后，解决 epoch 和 zxid 的冲突，并接受对方的提议，然后向对方发送接受提议完成的消息。FastLeaderElection算法通过异步的通信方式来收集其它节点的选票，同时在分析选票时又根据投票者的当前状态来作不同的处理，以加快Leader的选举进程。</p>
<h4 id="算法流程"><a href="#算法流程" class="headerlink" title="算法流程"></a>算法流程</h4><h5 id="数据恢复阶段"><a href="#数据恢复阶段" class="headerlink" title="数据恢复阶段"></a>数据恢复阶段</h5><p>每个ZooKeeper Server读取当前磁盘的数据（transaction log），获取最大的zxid。</p>
<h5 id="发送选票"><a href="#发送选票" class="headerlink" title="发送选票"></a>发送选票</h5><p>每个参与投票的ZooKeeper Server向其他Server发送自己所推荐的Leader，这个协议中包括几部分数据：</p>
<ul>
<li>所推举的Leader id。在初始阶段，第一次投票所有Server都推举自己为Leader。</li>
<li>本机的最大zxid值。这个值越大，说明该Server的数据越新。</li>
<li>logicalclock。这个值从0开始递增，每次选举对应一个值，即在同一次选举中，这个值是一致的。这个值越大说明选举进程越新。</li>
<li>本机的所处状态。包括LOOKING，FOLLOWING，OBSERVING，LEADING。</li>
</ul>
<h4 id="处理选票"><a href="#处理选票" class="headerlink" title="处理选票"></a>处理选票</h4><p>每台Server将自己的数据发送给其他Server之后，同样也要接受其他Server的选票，并做一下处理。</p>
<h5 id="如果Sender的状态是LOOKING"><a href="#如果Sender的状态是LOOKING" class="headerlink" title="如果Sender的状态是LOOKING"></a>如果Sender的状态是LOOKING</h5><ul>
<li>如果发送过来的logicalclock大于目前的logicalclock。说明这是更新的一次选举，需要更新本机的logicalclock，同事清空已经收集到的选票，因为这些数据已经不再有效。然后判断是否需要更新自己的选举情况。首先判断zxid，zxid大者胜出；如果相同比较leader id，大者胜出。</li>
<li>如果发送过来的logicalclock小于于目前的logicalclock。说明对方处于一个比较早的选举进程，只需要将本机的数据发送过去即可。</li>
<li>如果发送过来的logicalclock等于目前的logicalclock。根据收到的zxid和leader id更新选票，然后广播出去。</li>
</ul>
<p>当Server处理完选票后，可能需要对Server的状态进行更新：</p>
<ul>
<li>判断服务器是否已经收集到所有的服务器的选举状态。如果是根据选举结果设置自己的角色（FOLLOWING or LEADER），然后退出选举。</li>
<li>如果没有收到没有所有服务器的选举状态，也可以判断一下根据以上过程之后更新的选举Leader是不是得到了超过半数以上服务器的支持。如果是，那么尝试在200ms内接收下数据，如果没有心数据到来说明大家已经认同这个结果。这时，设置角色然后退出选举。</li>
</ul>
<h5 id="如果Sender的状态是FOLLOWING或者LEADER"><a href="#如果Sender的状态是FOLLOWING或者LEADER" class="headerlink" title="如果Sender的状态是FOLLOWING或者LEADER"></a>如果Sender的状态是FOLLOWING或者LEADER</h5><ul>
<li>如果LogicalClock相同，将数据保存早recvset，如果Sender宣称自己是Leader，那么判断是不是半数以上的服务器都选举它，如果是设置角色并退出选举。</li>
<li>否则，这是一条与当前LogicalClock不符合的消息，说明在另一个选举过程中已经有了选举结果，于是将该选举结果加入到OutOfElection集合中，根据OutOfElection来判断是否可以结束选举，如果可以也是保存LogicalClock，更新角色，退出选举。</li>
</ul>
<p><a target="_blank" rel="noopener" href="http://www.yidooo.net/images/fast_leader_election.png"><img src="http://www.yidooo.net/images/fast_leader_election.png" alt="fast-leader-election"></a></p>
<h4 id="具体实现"><a href="#具体实现" class="headerlink" title="具体实现"></a>具体实现</h4><h5 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h5><p>本地消息结构：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">static public class Notification &#123;</span><br><span class="line">long leader;  //所推荐的Server id</span><br><span class="line"></span><br><span class="line">long zxid;      //所推荐的Server的zxid(zookeeper transtion id)</span><br><span class="line"></span><br><span class="line">long epoch;   //描述leader是否变化(每一个Server启动时都有一个logicalclock，初始值为0)</span><br><span class="line"></span><br><span class="line">QuorumPeer.ServerState state;   //发送者当前的状态</span><br><span class="line">InetSocketAddress addr;            //发送者的ip地址</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>网络消息结构：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">static public class ToSend &#123;</span><br><span class="line"></span><br><span class="line">int type;        //消息类型</span><br><span class="line">long leader;  //Server id</span><br><span class="line">long zxid;     //Server的zxid</span><br><span class="line">long epoch;  //Server的epoch</span><br><span class="line">QuorumPeer.ServerState state; //Server的state</span><br><span class="line">long tag;      //消息编号</span><br><span class="line"></span><br><span class="line">InetSocketAddress addr;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="线程处理"><a href="#线程处理" class="headerlink" title="线程处理"></a>线程处理</h5><p>每个Server都一个接收线程池和一个发送线程池, 在没有发起选举时，这两个线程池处于阻塞状态，直到有消息到来时才解除阻塞并处理消息，同时每个Server都有一个选举线程(可以发起选举的线程担任)。</p>
<ul>
<li>接收线程的处理<br>notification: 首先检测当前Server上所被推荐的zxid,epoch是否合法(currentServer.epoch &lt;&#x3D; currentMsg.epoch &amp;&amp; (currentMsg.zxid &gt; currentServer.zxid || (currentMsg.zxid &#x3D;&#x3D; currentServer.zxid &amp;&amp; currentMsg.id &gt; currentServer.id))) 如果不合法就用消息中的zxid,epoch,id更新当前Server所被推荐的值，此时将收到的消息转换成Notification消息放入接收队列中，将向对方发送ack消息。<br>ack: 将消息编号放入ack队列中，检测对方的状态是否是LOOKING状态，如果不是说明此时已经有Leader已经被选出来，将接收到的消息转发成Notification消息放入接收对队列</li>
<li>发送线程池的处理<br>notification: 将要发送的消息由Notification消息转换成ToSend消息，然后发送对方，并等待对方的回复,如果在等待结束没有收到对方法回复，重做三次,如果重做次还是没有收到对方的回复时检测当前的选举(epoch)是否已经改变，如果没有改变，将消息再次放入发送队列中，一直重复直到有Leader选出或者收到对方回复为止。<br>ack: 主要将自己相关信息发送给对方</li>
<li>选举线程的处理<br>首先自己的epoch加1，然后生成notification消息,并将消息放入发送队列中，系统中配置有几个Server就生成几条消息，保证每个Server都能收到此消息,如果当前Server的状态是LOOKING就一直循环检查接收队列是否有消息，如果有消息，根据消息中对方的状态进行相应的处理。</li>
</ul>
<h4 id="AuthFastLeaderElection选举算法"><a href="#AuthFastLeaderElection选举算法" class="headerlink" title="AuthFastLeaderElection选举算法"></a>AuthFastLeaderElection选举算法</h4><p>AuthFastLeaderElection算法同FastLeaderElection算法基本一致，只是在消息中加入了认证信息，该算法在最新的Zookeeper中也建议弃用。</p>
<h4 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h4><p>下面看一个Leader选举的例子以加深对Leader选举算法的理解。</p>
<ol>
<li>服务器1启动,此时只有它一台服务器启动了,它发出去的报没有任何响应,所以它的选举状态一直是LOOKING状态.</li>
<li>服务器2启动,它与最开始启动的服务器1进行通信,互相交换自己的选举结果,由于两者都没有历史数据,所以id值较大的服务器2胜出,但是由于没有达到超过半数以上的服务器都同意选举它(这个例子中的半数以上是3),所以服务器1,2还是继续保持LOOKING状态.</li>
<li>服务器3启动,根据前面的理论分析,服务器3成为服务器1,2,3中的Leader,而与上面不同的是,此时有三台服务器选举了它,所以它成为了这次选举的Leader.</li>
<li>服务器4启动,根据前面的分析,理论上服务器4应该是服务器1,2,3,4中最大的,但是由于前面已经有半数以上的服务器选举了服务器3,所以它只能是Follower.</li>
<li>服务器5启动,同4一样,Follower.</li>
</ol>
<h4 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h4><ul>
<li><a target="_blank" rel="noopener" href="http://www.yidooo.net/2014/10/18/zookeeper-leader-election.html">http://www.yidooo.net/2014/10/18/zookeeper-leader-election.html</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.cyblogs.com/2020/02/28/2020/02/Zookeeper%20%E4%B8%80%E8%87%B4%E6%80%A7%E5%8D%8F%E8%AE%AEZab/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/vernonchen.jpg">
      <meta itemprop="name" content="Vernon">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简栈文化">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | 简栈文化">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/02/28/2020/02/Zookeeper%20%E4%B8%80%E8%87%B4%E6%80%A7%E5%8D%8F%E8%AE%AEZab/" class="post-title-link" itemprop="url">Zookeeper 一致性协议Zab</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-02-28 00:00:00" itemprop="dateCreated datePublished" datetime="2020-02-28T00:00:00+08:00">2020-02-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-06-25 09:57:28" itemprop="dateModified" datetime="2025-06-25T09:57:28+08:00">2025-06-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Zookeeper/" itemprop="url" rel="index"><span itemprop="name">Zookeeper</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Zookeeper使用了一种称为Zab（Zookeeper Atomic Broadcast）的协议作为其一致性的核心。Zab协议是Paxos协议的一种变形，下面将展示一些协议的核心内容。</p>
<p>考虑到Zookeeper的主要操作数据状态，为了保证一致性，Zookeeper提出了两个安全属性：</p>
<ul>
<li>全序（Total Order）：如果消息A在消息B之前发送，则所有Server应该看到相同结果。</li>
<li>因果顺序（Causal Order）：如果消息A在消息B之前发生（A导致了B），并且一起发送，则消息A始终在消息B之前被执行。</li>
</ul>
<p>为了保证上述两个安全属性，Zookeeper使用了TCP协议和Leader。通过使用TCP协议保证了消息的全序的特性（先发先到），通过Leader解决了因果顺序(先到Leader先执行)。因为有了Leader，Zookeeper的架构就变成为：Master-Slave模式，但在该模式中Master（Leader）会Crash，因此，Zookeeper引入Leader选举算法，以保证系统的健壮性。</p>
<p>当Zookeeper Server收到写操作，Follower会将其转发给Leader，由Leader执行操作。Client可以直接从Follower上读取数据，如果需要读取最新数据，则需要从Leader节点读取，Zookeeper设计的读写比大致为2：1。</p>
<p>Leader执行写操作可以简化为一个两段式提交的transaction：</p>
<ol>
<li>Leader发送proposal给所有的Follower。</li>
<li>收到proposal后，Follower回复ACK给Leader，接受Leader的proposal.</li>
<li>当Leader收到大多数的Follower的ACK后，将commit其proposal。</li>
</ol>
<p><a target="_blank" rel="noopener" href="http://www.yidooo.net/images/broadcast.png"><img src="http://www.yidooo.net/images/broadcast.png" alt="broadcast"></a></p>
<p>在这个过程中，proposal的确认不需要所有节点都同意，如果有2n+1个节点，那么只要有n个节点同意即可，也就是说Zookeeper允许n个节点down掉。任何两个多数派必然有交集，在Leader切换（Leader down）时，这些交集依然保持着最新的系统状态。如果集群节点个数少于n+1个时，Zookeeper将无法进行同步，也就无法继续工作。</p>
<h4 id="Zab与Paxos"><a href="#Zab与Paxos" class="headerlink" title="Zab与Paxos"></a>Zab与Paxos</h4><p>Zab的作者认为Zab与paxos并不相同，只所以没有采用Paxos是因为Paxos保证不了全序顺序：</p>
<blockquote>
<p>Because multiple leaders can propose a value for a given instance two problems arise.<br>First, proposals can conflict. Paxos uses ballots to detect and resolve conflicting proposals.<br>Second, it is not enough to know that a given instance number has been committed, processes must also be able to figure out which value has been committed.</p>
</blockquote>
<p>举个例子。假设一开始Paxos系统中的Leader是P1，他发起了两个事务{t1, v1}（表示序号为t1的事务要写的值是v1）和{t2, v2}，过程中Leader挂了。新来个Leader是P2，他发起了事务{t1, v1’}。而后又来个新Leader是P3，他汇总了一下，得出最终的执行序列{t1, v1’}和{t2, v2}。</p>
<p>这样的序列为什么不能满足ZooKeeper的需求呢？ZooKeeper是一个树形结构，很多操作都要先检查才能确定能不能执行，比如P1的事务t1可能是创建节点“&#x2F;a”，t2可能是创建节点“&#x2F;a&#x2F;aa”，只有先创建了父节点“&#x2F;a”，才能创建子节点“&#x2F;a&#x2F;aa”。而P2所发起的事务t1可能变成了创建“&#x2F;b”。这样P3汇总后的序列是先创建“&#x2F;b”再创建“&#x2F;a&#x2F;aa”，由于“&#x2F;a”还没建，创建“a&#x2F;aa”就搞不定了。</p>
<p>为了保证这一点，ZAB要保证同一个leader的发起的事务要按顺序被apply，同时还要保证只有先前的leader的所有事务都被apply之后，新选的leader才能在发起事务。</p>
<h4 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h4><ul>
<li><a target="_blank" rel="noopener" href="http://www.yidooo.net/2014/10/22/zab.html">http://www.yidooo.net/2014/10/22/zab.html</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.cyblogs.com/2020/02/27/2020/02/JVM%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-%E5%86%85%E5%AD%98%E7%89%A9%E7%90%86%E7%BB%93%E6%9E%84&%E7%B1%BB%E5%8A%A0%E8%BD%BD/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/vernonchen.jpg">
      <meta itemprop="name" content="Vernon">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简栈文化">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | 简栈文化">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/02/27/2020/02/JVM%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-%E5%86%85%E5%AD%98%E7%89%A9%E7%90%86%E7%BB%93%E6%9E%84&%E7%B1%BB%E5%8A%A0%E8%BD%BD/" class="post-title-link" itemprop="url">JVM深入理解-内存物理结构&类加载</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-02-27 00:00:00" itemprop="dateCreated datePublished" datetime="2020-02-27T00:00:00+08:00">2020-02-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-06-25 09:57:28" itemprop="dateModified" datetime="2025-06-25T09:57:28+08:00">2025-06-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h5 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h5><p>对于JVM这块儿的知识，我估计大部分的都是只有在需要面试的时候才会拿出来复习一下，然后就又放下来。也是因为这块儿是<code>Java</code>最底层的部分，非常难懂。其实如果真的说认真、细心的去撸一下，了解透彻，应该就不会那么容易忘记。</p>
<p>今天的主要目的也是根据<code>Oracle</code>的官方文档来一步一步的理解与学习，并且用用一些<code>demo</code>来验证理论。</p>
<h5 id="Java虚拟机内存结构"><a href="#Java虚拟机内存结构" class="headerlink" title="Java虚拟机内存结构"></a>Java虚拟机内存结构</h5><p>我们先来看一下<code>JVM</code>一个大概的物理结构图（请注意，不叫内存模型）：</p>
<p><img src="http://static.cyblogs.com/QQ%E6%88%AA%E5%9B%BE20191121231823.png" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;QQ截图20191121231823.png"></p>
<h6 id="堆的划分"><a href="#堆的划分" class="headerlink" title="堆的划分"></a>堆的划分</h6><p>我们首先看一下官方地址对于运行时数据区域的一个划分：<a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/specs/jvms/se8/html/index.html">https://docs.oracle.com/javase/specs/jvms/se8/html/index.html</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-2.html#jvms-2.5">2.5. Run-Time Data Areas</a></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-2.html#jvms-2.5.1">2.5.1. The <code>pc</code> Register</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-2.html#jvms-2.5.2">2.5.2. Java Virtual Machine Stacks</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-2.html#jvms-2.5.3">2.5.3. Heap</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-2.html#jvms-2.5.4">2.5.4. Method Area</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-2.html#jvms-2.5.5">2.5.5. Run-Time Constant Pool</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-2.html#jvms-2.5.6">2.5.6. Native Method Stacks</a></li>
</ul>
<h6 id="堆"><a href="#堆" class="headerlink" title="堆"></a>堆</h6><p>堆存放：对象、数组 （官方证明： The heap is the run-time data area from which memory for all class instances and arrays is allocated. ）</p>
<h6 id="方法区"><a href="#方法区" class="headerlink" title="方法区"></a>方法区</h6><p>方法区存放：静态成员变量、常量、类的信息、常量池 （官方证明： It stores per-class structures such as the run-time constant pool, field and method data, and the code for methods and constructors, including the special methods (<a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-2.html#jvms-2.9">§2.9</a>) used in class and instance initialization and interface initialization.）</p>
<h6 id="Java虚拟机栈"><a href="#Java虚拟机栈" class="headerlink" title="Java虚拟机栈"></a>Java虚拟机栈</h6><p>然后我们看一段代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 方法一</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">a</span><span class="params">()</span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;this is a methd&quot;</span>);</span><br><span class="line">    b();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 方法二</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">b</span><span class="params">()</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;this is b methd&quot;</span>);</span><br><span class="line">    c();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 方法三</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">c</span><span class="params">()</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;this is c methd&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>简单画一个方法压栈与出栈的过程：</p>
<p><img src="http://static.cyblogs.com/WX20200130-133454@2x.png" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;WX20200130-133454@2x.png"></p>
<p>其实在这就可以看到，因为有相互调用的情况，这里利用栈的原理（FILO&#x3D;frist in last out）。</p>
<ul>
<li>先<code>a()</code>入栈发现调用了<code>b()</code>，<code>b()</code>入栈发现调用<code>c()</code>；</li>
<li><code>c()</code>执行完毕出栈，然后<code>b()</code>出栈，最后<code>c()</code>方法出栈；</li>
</ul>
<p>如果一直压栈的话，如果是无穷的递归会怎么办？所以栈是需要规定深度的，对应的就是栈的大小-Xss来控制的，如果是超过大小是会<code>OOM</code>的。</p>
<blockquote>
<p>The following exceptional conditions are associated with native method stacks:</p>
<ul>
<li>If the computation in a thread requires a larger native method stack than is permitted, the Java Virtual Machine throws a <code>StackOverflowError</code>.</li>
<li>If native method stacks can be dynamically expanded and native method stack expansion is attempted but insufficient memory can be made available, or if insufficient memory can be made available to create the initial native method stack for a new thread, the Java Virtual Machine throws an <code>OutOfMemoryError</code>.</li>
</ul>
</blockquote>
<h6 id="本地方法栈"><a href="#本地方法栈" class="headerlink" title="本地方法栈"></a>本地方法栈</h6><p>执行本地方法，<code>native</code>方法属于C的方法。 （官方证明：An implementation of the Java Virtual Machine may use conventional stacks, colloquially called “C stacks,” to support <code>native</code> methods (methods written in a language other than the Java programming language).）</p>
<h6 id="程序计数器"><a href="#程序计数器" class="headerlink" title="程序计数器"></a>程序计数器</h6><p>因为在多线程的情况下，CPU通过轮询来去提高执行效率，线程之间会进行切换。如果从离开到下一次再进来，一定要知道上一次的一个状态。所以它应该是来干这件事情的。</p>
<p>（官方证明：The Java Virtual Machine can support many threads of execution at once (JLS §17). Each Java Virtual Machine thread has its own <code>pc</code> (program counter) register. ）</p>
<h5 id="类加载过程"><a href="#类加载过程" class="headerlink" title="类加载过程"></a>类加载过程</h5><p>类从被加载到虚拟机内存中开始，到卸载出内存为止，它的整个生命周期包括：加载、验证、准备、解析、初始化、使用和卸载七个阶段。其中类加载的过程包括了加载、验证、准备、解析、初始化五个阶段。在这五个阶段中，加载、验证、准备和初始化这四个阶段发生的顺序是确定的，而解析阶段则不一定，它在某些情况下可以在初始化阶段之后开始，这是为了支持Java语言的运行时绑定（也成为动态绑定或晚期绑定）。</p>
<p><img src="http://static.cyblogs.com/WX20200130-123334@2x.png" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;WX20200130-123334@2x.png"></p>
<h6 id="加载"><a href="#加载" class="headerlink" title="加载"></a>加载</h6><p>加载时类加载过程的第一个阶段，在加载阶段，虚拟机需要完成以下三件事情：</p>
<ul>
<li><p>1、通过一个类的全限定名来获取其定义的二进制字节流。</p>
</li>
<li><p>2、将这个字节流所代表的静态存储结构转化为方法区的运行时数据结构。</p>
</li>
<li><p>3、在Java堆中生成一个代表这个类的java.lang.Class对象，作为对方法区中这些数据的访问入口。</p>
</li>
</ul>
<p>注意，这里第1条中的二进制字节流并不只是单纯地从Class文件中获取，比如它还可以从Jar包中获取、从网络中获取（最典型的应用便是Applet）、由其他文件生成（JSP应用）等。这里也就是Java的开放之处，给程序员更多的选择。</p>
<p>说到加载，不得不提到类加载器，下面就具体讲述下类加载器。</p>
<p>类加载器虽然只用于实现类的加载动作，但它在<code>Java</code>程序中起到的作用却远远不限于类的加载阶段。对于任意一个类，都需要由它的类加载器和这个类本身一同确定其在就<code>Java</code>虚拟机中的唯一性，也就是说，即使两个类来源于同一个<code>Class</code>文件，只要加载它们的类加载器不同，那这两个类就必定不相等。这里的“相等”包括了代表类的<code>Class</code>对象的<code>equals()、isAssignableFrom()、isInstance()</code>等方法的返回结果，也包括了使用<code>instanceof</code>关键字对对象所属关系的判定结果。</p>
<p><img src="http://static.cyblogs.com/%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8.jpg" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;类加载器.jpg"></p>
<ul>
<li>启动类加载器：<code>Bootstrap ClassLoader</code>，它负责加载存放在<code>JDK\jre\lib</code>(JDK代表<code>JDK</code>的安装目录，下同)下，或被<code>-Xbootclasspath</code>参数指定的路径中的，并且能被虚拟机识别的类库（如<code>rt.jar</code>，所有的java.*开头的类均被<code>Bootstrap ClassLoader</code>加载）。启动类加载器是无法被Java程序直接引用的。</li>
<li>扩展类加载器：<code>Extension ClassLoader</code>，该加载器由<code>sun.misc.Launcher$ExtClassLoader</code>实现，它负责加载<code>JDK\jre\lib\ext</code>目录中，或者由<code>java.ext.dirs</code>系统变量指定的路径中的所有类库（如javax.*开头的类），开发者可以直接使用扩展类加载器。</li>
<li>应用程序类加载器：<code>Application ClassLoader</code>，该类加载器由<code>sun.misc.Launcher$AppClassLoader</code>来实现，它负责加载用户类路径（<code>ClassPath</code>）所指定的类，开发者可以直接使用该类加载器，如果应用程序中没有自定义过自己的类加载器，一般情况下这个就是程序中默认的类加载器。</li>
</ul>
<p>这种层次关系称为类加载器的双亲委派模型。我们把每一层上面的类加载器叫做当前层类加载器的父加载器，当然，它们之间的父子关系并不是通过继承关系来实现的，而是使用组合关系来复用父加载器中的代码。</p>
<h6 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h6><p>验证的目的是为了确保Class文件中的字节流包含的信息符合当前虚拟机的要求，而且不会危害虚拟机自身的安全。不同的虚拟机对类验证的实现可能会有所不同，但大致都会完成以下四个阶段的验证：文件格式的验证、元数据的验证、字节码验证和符号引用验证。</p>
<ul>
<li>文件格式的验证：验证字节流是否符合Class文件格式的规范，并且能被当前版本的虚拟机处理，该验证的主要目的是保证输入的字节流能正确地解析并存储于方法区之内。经过该阶段的验证后，字节流才会进入内存的方法区中进行存储，后面的三个验证都是基于方法区的存储结构进行的。</li>
<li>元数据验证：对类的元数据信息进行语义校验（其实就是对类中的各数据类型进行语法校验），保证不存在不符合Java语法规范的元数据信息。</li>
<li>字节码验证：该阶段验证的主要工作是进行数据流和控制流分析，对类的方法体进行校验分析，以保证被校验的类的方法在运行时不会做出危害虚拟机安全的行为。</li>
<li>符号引用验证：这是最后一个阶段的验证，它发生在虚拟机将符号引用转化为直接引用的时候（解析阶段中发生该转化，后面会有讲解），主要是对类自身以外的信息（常量池中的各种符号引用）进行匹配性的校验。</li>
</ul>
<h6 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h6><p>准备阶段是正式为类变量分配内存并设置类变量初始值的阶段，这些内存都将在方法区中分配。对于该阶段有以下几点需要注意：</p>
<ul>
<li>1、这时候进行内存分配的仅包括类变量（static），而不包括实例变量，实例变量会在对象实例化时随着对象一块分配在Java堆中。</li>
<li>2、这里所设置的初始值通常情况下是数据类型默认的零值（如0、0L、null、false等），而不是被在Java代码中被显式地赋予的值。</li>
</ul>
<h6 id="解析"><a href="#解析" class="headerlink" title="解析"></a>解析</h6><p>解析阶段是虚拟机将常量池中的符号引用转化为直接引用的过程。这里需要对编译后的字节码文件结构有一个深入了解才能明白。</p>
<p>符号引用（Symbolic Reference）：符号引用以一组符号来描述所引用的目标，符号引用可以是任何形式的字面量，符号引用与虚拟机实现的内存布局无关，引用的目标并不一定已经在内存中。</p>
<p>直接引用（Direct Reference）：直接引用可以是直接指向目标的指针、相对偏移量或是一个能间接定位到目标的句柄。直接引用是与虚拟机实现的内存布局相关的，同一个符号引用在不同的虚拟机实例上翻译出来的直接引用一般都不相同，如果有了直接引用，那引用的目标必定已经在内存中存在。</p>
<p>1、类或接口的解析：判断所要转化成的直接引用是对数组类型，还是普通的对象类型的引用，从而进行不同的解析。</p>
<p>2、字段解析：对字段进行解析时，会先在本类中查找是否包含有简单名称和字段描述符都与目标相匹配的字段，如果有，则查找结束；如果没有，则会按照继承关系从上往下递归搜索该类所实现的各个接口和它们的父接口，还没有，则按照继承关系从上往下递归搜索其父类，直至查找结束，查找流程如下：</p>
<p>本类 → 接口 → 父接口 → …→ 父类 → 祖父类→… 我们看一段代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.vernon.test.classloader;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created with vernon-test</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>:</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: chenyuan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>: 2020/1/30</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@time</span>: 11:40 AM</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Super</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">m</span> <span class="operator">=</span> <span class="number">11</span>;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;执行了super类静态语句块&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">package</span> com.vernon.test.classloader;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created with vernon-test</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>:</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: chenyuan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>: 2020/1/30</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@time</span>: 11:40 AM</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Super</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">m</span> <span class="operator">=</span> <span class="number">11</span>;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;执行了super类静态语句块&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">package</span> com.vernon.test.classloader;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created with vernon-test</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>:</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: chenyuan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>: 2020/1/30</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@time</span>: 11:44 AM</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Child</span> <span class="keyword">extends</span> <span class="title class_">Father</span>&#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;执行了子类静态语句块&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">package</span> com.vernon.test.classloader;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created with vernon-test</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>:</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: chenyuan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>: 2020/1/30</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@time</span>: 11:27 AM</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClassLoaderCase</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        System.out.println(Child.m);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行结果如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Connected to the target VM, address: &#x27;127.0.0.1:62747&#x27;, transport: &#x27;socket&#x27;</span><br><span class="line">执行了super类静态语句块</span><br><span class="line">执行了父类静态语句块</span><br><span class="line">33</span><br><span class="line">Disconnected from the target VM, address: &#x27;127.0.0.1:62747&#x27;, transport: &#x27;socket&#x27;</span><br></pre></td></tr></table></figure>

<h6 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h6><p>初始化是类加载过程的最后一步，到了此阶段，才真正开始执行类中定义的Java程序代码。在准备阶段，类变量已经被赋过一次系统要求的初始值，而在初始化阶段，则是根据程序员通过程序指定的主观计划去初始化类变量和其他资源，或者可以从另一个角度来表达：初始化阶段是执行类构造器<code>&lt;clinit&gt;()</code>方法的过程。<br>   这里简单说明下<code>&lt;clinit&gt;()</code>方法的执行规则:<br>    1、<code>&lt;clinit&gt;()</code>方法是由编译器自动收集类中的所有类变量的赋值动作和静态语句块中的语句合并产生的，编译器收集的顺序是由语句在源文件中出现的顺序所决定的，静态语句块中只能访问到定义在静态语句块之前的变量，定义在它之后的变量，在前面的静态语句中可以赋值，但是不能访问。<br>    2、<code>&lt;clinit&gt;()</code>方法与实例构造器<code>&lt;init&gt;()</code>方法（类的构造函数）不同，它不需要显式地调用父类构造器，虚拟机会保证在子类的<code>&lt;clinit&gt;()</code>方法执行之前，父类的<code>&lt;clinit&gt;()</code>方法已经执行完毕。因此，在虚拟机中第一个被执行的<code>&lt;clinit&gt;()</code>方法的类肯定是<code>java.lang.Object。</code><br>    3、<code>&lt;clinit&gt;()</code>方法对于类或接口来说并不是必须的，如果一个类中没有静态语句块，也没有对类变量的赋值操作，那么编译器可以不为这个类生成<code>&lt;clinit&gt;()</code>方法。<br>    4、接口中不能使用静态语句块，但仍然有类变量（final static）初始化的赋值操作，因此接口与类一样会生成<code>&lt;clinit&gt;()</code>方法。但是接口鱼类不同的是：执行接口的<code>&lt;clinit&gt;()</code>方法不需要先执行父接口的<code>&lt;clinit&gt;()</code>方法，只有当父接口中定义的变量被使用时，父接口才会被初始化。另外，接口的实现类在初始化时也一样不会执行接口的<code>&lt;clinit&gt;()</code>方法。<br>    5、虚拟机会保证一个类的<code>&lt;clinit&gt;()</code>方法在多线程环境中被正确地加锁和同步，如果多个线程同时去初始化一个类，那么只会有一个线程去执行这个类的<code>&lt;clinit&gt;()</code>方法，其他线程都需要阻塞等待，直到活动线程执行<code>&lt;clinit&gt;()</code>方法完毕。如果在一个类的<code>&lt;clinit&gt;()</code>方法中有耗时很长的操作，那就可能造成多个线程阻塞，在实际应用中这种阻塞往往是很隐蔽的。</p>
<h5 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h5><p>类加载这块儿部分其实是非常重要的知识点，它让我们了解到Java的开放、包容以及一个类是如何被加载、被分配的。其中这也是为什么说Java是一次编译，到底执行的原因，其中包含了字节码部分，还有如何做一些字节码增强的技术，后续还有对于GC部分的知识。总之，越往基础越是重要！</p>
<h5 id="参考地址"><a href="#参考地址" class="headerlink" title="参考地址"></a>参考地址</h5><ul>
<li><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/specs/jvms/se8/html/index.html">https://docs.oracle.com/javase/specs/jvms/se8/html/index.html</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/">https://docs.oracle.com/javase/8/</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.im/post/5a810b0e5188257a5c606a85">https://juejin.im/post/5a810b0e5188257a5c606a85</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/ns_code/article/details/17881581">https://blog.csdn.net/ns_code/article/details/17881581</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.cyblogs.com/2020/02/26/2020/02/JVM%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/vernonchen.jpg">
      <meta itemprop="name" content="Vernon">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简栈文化">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | 简栈文化">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/02/26/2020/02/JVM%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/" class="post-title-link" itemprop="url">JVM深入理解-垃圾回收</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-02-26 00:00:00" itemprop="dateCreated datePublished" datetime="2020-02-26T00:00:00+08:00">2020-02-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-06-25 09:57:28" itemprop="dateModified" datetime="2025-06-25T09:57:28+08:00">2025-06-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h4><p>最近线上出现了JVM 频繁FGC的问题，查询了很多GC相关的资料，做了一些整理翻译。文章比较长可以收藏后慢慢阅读。</p>
<h4 id="一、什么是垃圾回收？-Garbage-Collection"><a href="#一、什么是垃圾回收？-Garbage-Collection" class="headerlink" title="一、什么是垃圾回收？(Garbage Collection)"></a>一、什么是垃圾回收？(Garbage Collection)</h4><p>一个垃圾回收器有一下三个职责</p>
<ul>
<li>分配内存</li>
<li>确保有引用的对象能够在内存中保留。</li>
<li>能够在正在执行的代码环境中回收已经死亡对象的内存。</li>
</ul>
<p>这里提到的<code>有引用</code>是指存活的对象,后面会提到一些算法用来判断对象是否存活。不在有引用的对象将被认为是死亡的，也就是常说的垃圾<code>garbage</code>。找到并释放这些垃圾对象占用的空间的过程就被称作是垃圾回收<code>garbage collection</code>。</p>
<p>垃圾回收可以解决很多内存分配的问题，但并不意味这全部。 比如：你可以不断地创建对象并保持对它们的引用直到没有可用的内存分配。垃圾回收本身就是一项非常复杂和消耗资源的过程。</p>
<h4 id="二、理想的垃圾收集器需要哪些特性？"><a href="#二、理想的垃圾收集器需要哪些特性？" class="headerlink" title="二、理想的垃圾收集器需要哪些特性？"></a>二、理想的垃圾收集器需要哪些特性？</h4><ol>
<li>垃圾收集器必须是安全和全面的。这就意味着，存活的对象绝对不能被释放，相反垃圾对象在很少的垃圾回收循环里必须被回收。</li>
<li>垃圾回收必须是高效的，不允许出现正在运行的程序长时间暂停。</li>
<li>内存碎片整理，垃圾被收集以后内存会存在很多不连续的内存碎片，可能导致大对象无法分配到足够连续的内存。</li>
<li>扩展性，在多处理器系统、多线程应用中，内存分配和垃圾收集不能成为性能瓶颈。</li>
</ol>
<h4 id="三、设计选择"><a href="#三、设计选择" class="headerlink" title="三、设计选择"></a>三、设计选择</h4><p>在设计一款垃圾收集器时，有一些选择可供选择：</p>
<ul>
<li>串行 vs 并行</li>
</ul>
<p>串行收集，即使在多cpu环境中也是单线程处理垃圾收集工作。当使用并行收集时，垃圾收集任务就会被分为几子任务由不同的线程的执行，不仅仅是在多CPU环境中使用，在单核的系统中也可以使用，只是收集效果可能比使用串行效率还低。所以再单核的环境下尽量使用串行收集。</p>
<ul>
<li>并发 vs 暂停（stop-the-word）</li>
</ul>
<p>并发是指垃圾收集线程和应用线程同时执行，并发和<code>stop-the-word</code>并不是互斥的，在一个执行一次垃圾收集的过程中两种情况都可能存在。例如<code>CMS</code>、<code>G1</code>垃圾搜集器。并发式GC会并发执行其垃圾收集任务，但是，可能也会有一些步骤需要以<code>stop-the-world</code>方法执行，导致应用程序暂停。与并发式<code>GC</code>相比，<code>Stop-the-world</code>式的GC更简单.</p>
<ul>
<li>整理 vs 不整理 vs 复制</li>
</ul>
<p>这个描述的主要是垃圾被收集以后，对内存碎片的处理方式。</p>
<p>整理、不整理，垃圾回收以后是否将存活的对象统一移动到一个地方。整理后的内存空间方便后续的对象分配内存，但是更消耗资源和时间，而不整理效率更高存在内存碎片的风险。</p>
<p>复制，首先将内存分割成两块一样大小的区域，垃圾收集后会将存活的对象拷贝到另一块不同的内存区域。这样做的好处是，拷贝后，源内存区域可以作为一块空的、立即可用的区域对待，方便后续的内存分配，但是这种方法的缺点是需要用额外的时间、空间来拷贝对象。</p>
<h4 id="四、对象是否存活？"><a href="#四、对象是否存活？" class="headerlink" title="四、对象是否存活？"></a>四、对象是否存活？</h4><p><code>JVM</code>要对回收一个对象必须知道这个对象是否存活，即是否有有效的引用？介绍几种判断对象是否死亡的算法。</p>
<ol>
<li><p>引用计数法 给对象添加一个引用计数器，每次引用到它时引用计数器加一，当引用失效时引用计时器减一。当引用计数器为0时即表示当前对象可以被回收。 这个算法实现简单、判定效率也很高，但是无法处理循环引用的问题，即 A 对象引用了 B， B 对象也引用了 A，那么A、B都有引用，他们的应用计数都为一，但实际他们是可以被回收的。</p>
</li>
<li><p>可达性分析算法 算法规定了一些称为<code>GC Root</code>的根对象，当对象没有引用链到达这些<code>GC Root</code>时就被判定为可回收的对象。</p>
<p><img src="http://static.cyblogs.com/WX20200131-153715@2x.png" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;WX20200131-153715@2x.png"></p>
</li>
</ol>
<h4 id="五、分代收集算法"><a href="#五、分代收集算法" class="headerlink" title="五、分代收集算法"></a>五、分代收集算法</h4><p>当使用称为分代收集的技术时，内存将被分为不同的几代，即，会将对象按其年龄分别存储在不同的对象池中。例如，目前最广泛使用的是分代是将对象分为年轻代对象和老年代对象。</p>
<p>在分代内存管理中，使用不同算法对不同代的对象执行垃圾收集的工作，每种算法都是基于对某代对象的特性进行优化的。考虑到应用程序可以是用包括Java在内的不同的程序语言编写，分代垃圾收集使用了称为 弱代理论（weak generational hypothesis）的方法，具体描述如下：</p>
<p>大多数分配了内存的对象并不会存活太长时间，在处于年轻代时就会死掉； 很少有对象会从老年代变成年轻代。 年轻代对象的垃圾收集相对频繁一些，同时会也更有效率，更快一些，因为年轻代对象所占用的内存通常较小，也比较容易确定哪些对象是已经无法再被引用的。</p>
<p>当某些对象经过几次年轻代垃圾收集后依然存活，则这些对象会被 提升（promoted）到老年代。典型情况下，老年代所占用的内存会比年轻代大，而且还会随时渐渐慢慢增大。这样的结果是，对老年代的垃圾收集就不能频繁进行，而且执行时间也会长很多。</p>
<p><img src="http://static.cyblogs.com/WX20200131-153928@2x.png" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;WX20200131-153928@2x.png"></p>
<p>选择年轻代的垃圾收集算法时会更看重执行速度，因为年轻代的垃圾收集工作会频繁执行。另一方面，管理老年代的算法则更注重空间效率，因为老年代会占用堆中的大部分空间，这要求算法必须要处理好垃圾收集的工作，尽量降低堆中的垃圾内存的密度。</p>
<h4 id="六、HotSpot-分代收集"><a href="#六、HotSpot-分代收集" class="headerlink" title="六、HotSpot 分代收集"></a>六、HotSpot 分代收集</h4><p>主要介绍几种常见的垃圾收集器<code>串行收集器（Serial Collector）</code>、<code>并行垃圾收集器（Parallel Collector）</code>、<code>并行整理收集器（Parallel Compacting Collector）</code>、<code>并发标记清理垃圾收集器（Concurrent Mark-Sweep，CMS）</code>、<code>Garbage-First (G1)</code> 图中有连线的表示可以组合使用。</p>
<p><img src="http://static.cyblogs.com/WX20200131-154328@2x.png" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;WX20200131-154328@2x.png"></p>
<h5 id="6-1-HotSpot中的代的划分"><a href="#6-1-HotSpot中的代的划分" class="headerlink" title="6.1 HotSpot中的代的划分"></a>6.1 HotSpot中的代的划分</h5><p>在Java HotSpot虚拟机中，内存被分为3代：年轻代、老年代和永生代(java8已经取消永久代)。大多数对象最初都是分配在年轻代内存中的，年轻代中对象经过几次垃圾收集后还存活的，会被转到老年代。一些体积比较大的对象在创建的时候可能就会在老年代中。 在年轻代中包含三个分区，一个 Eden区和两个 Survivor区(FROM、TO)，如图所示。大部分对象最初是分配在Eden区中的（但是，如前面所述，一些较大的对象可能会直接分配在老年代中）。Survivor始终保持一个区域为空，当经过一定次数（<code>-XX:MaxTenuringThreshold=n</code>来指定默认值为15）的年轻代GC后依然存活的对象可以被晋升到老年代。</p>
<p><img src="http://static.cyblogs.com/WX20200131-154416@2x.png" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;WX20200131-154416@2x.png"></p>
<h5 id="6-2-垃圾收集分类"><a href="#6-2-垃圾收集分类" class="headerlink" title="6.2 垃圾收集分类"></a>6.2 垃圾收集分类</h5><p>当年轻代被填满时，开始执行年轻代的垃圾收集（<code>minor collection</code>）。当老年代被填满时，也会执行老年代垃圾收集（<code>full GC</code>，<code>major collection</code>），一般来说，年轻代GC会先执行，执行多次young GC 会触发<code>FGC</code>，当然这不是绝对的，因为大对象会直接分配到老年代，当老年代的分配的内存不足时就可能触发频繁的<code>FGC</code>。目前除了<code>CMS</code>收集器外，在执行<code>FGC</code>的时候都会对整个堆进行垃圾收集。</p>
<h5 id="6-3-串行收集器（Serial-Collector）"><a href="#6-3-串行收集器（Serial-Collector）" class="headerlink" title="6.3 串行收集器（Serial Collector）"></a>6.3 串行收集器（Serial Collector）</h5><p>使用串行收集器，年轻代和老年代的垃圾收集工作会串行完成（在单一CPU系统上），这时是stop-the-world模式的。即，当执行垃圾收集工作时，应用程序必须停止运行。</p>
<h6 id="6-3-1-使用串行收集器的年轻代垃圾收集"><a href="#6-3-1-使用串行收集器的年轻代垃圾收集" class="headerlink" title="6.3.1 使用串行收集器的年轻代垃圾收集"></a>6.3.1 使用串行收集器的年轻代垃圾收集</h6><p>图3展示了使用串行收集器的年轻代垃圾收集的执行过程。<code>Eden</code>和<code>Survivor FROM</code>区存活的对象会被拷贝到初始为空的另一个Survivor区（图中标识为To的区）中，这其中，那些体积过大以至于<code>Survivor</code>区装不下的对象会被直接拷贝到老年代中。相对于已经被拷贝到To区的对象，源<code>Survivor</code>区（图中标识为From的区）中的存活对象仍然比较年轻，而被拷贝到老年代中对象则相对年纪大一些。</p>
<p><img src="http://static.cyblogs.com/WX20200131-154513@2x.png" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;WX20200131-154513@2x.png"></p>
<p>在年轻代垃圾收集完成后，Eden区和From区会被清空，只有To区会继续持有存活的对象。此时，From区和To区在逻辑上交换，To区变成From区，原From区变成To区，如图4所示。</p>
<p><img src="http://static.cyblogs.com/WX20200131-154558@2x.png" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;WX20200131-154558@2x.png"></p>
<h6 id="6-3-2-使用串行收集器的老年代垃圾收集"><a href="#6-3-2-使用串行收集器的老年代垃圾收集" class="headerlink" title="6.3.2 使用串行收集器的老年代垃圾收集"></a>6.3.2 使用串行收集器的老年代垃圾收集</h6><p>对于串行收集器，老年代和永生代会在进行垃圾收集时使用标记-清理-整理（Mark-Sweep-Compact）算法。在标记阶段，收集器会标识哪些对象是live状态的。清理阶段会跨代清理，标识垃圾对象。然后，收集器执行整理（sliding compaction），将存活对象移动到老年代内存空间的起始部分（永生代中情况于此类似），这样在老年代内存空间的尾部会产生一个大的连续空间。如图5所示。这种整理可以使用碰撞指针完成。</p>
<p><img src="http://static.cyblogs.com/WX20200131-154708@2x.png" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;WX20200131-154708@2x.png"></p>
<h6 id="6-3-3-什么时候使用串行垃圾收集器"><a href="#6-3-3-什么时候使用串行垃圾收集器" class="headerlink" title="6.3.3 什么时候使用串行垃圾收集器"></a>6.3.3 什么时候使用串行垃圾收集器</h6><p>大多数运行在客户机上的应用程序会选择使用并行垃圾收集器，因为这些应用程序对低暂停时间并没有较高的要求。对于当今的硬件来说，串行垃圾收集器已经可以有效的管理许多具有64M堆的重要应用程序，并且执行一次完整垃圾收集也不会超过半秒钟。</p>
<h6 id="6-3-4-选择串行垃圾收集器"><a href="#6-3-4-选择串行垃圾收集器" class="headerlink" title="6.3.4 选择串行垃圾收集器"></a>6.3.4 选择串行垃圾收集器</h6><p>在J2SE 5.0的发行版中，在非服务器类使用的机器上，默认选择的是串行垃圾收集器。在其他类型使用的机器上，可以通过添加参数 -XX:+UseSerialGC来显式的使用串行垃圾收集器。</p>
<h5 id="6-4-并行垃圾收集器（Parallel-Collector）"><a href="#6-4-并行垃圾收集器（Parallel-Collector）" class="headerlink" title="6.4 并行垃圾收集器（Parallel Collector）"></a>6.4 并行垃圾收集器（Parallel Collector）</h5><p>当前，很多的Java应用程序都跑在具有较大物理内存和多CPU的机器上。并行垃圾收集器，也称为吞吐量垃圾收集器，被用于垃圾收集工作。该收集器可以充分的利用多CPU的特点，避免一个CPU执行垃圾收集，其他CPU空闲的状态发生。</p>
<h6 id="6-4-1-使用并行垃圾收集器的年轻代垃圾收集"><a href="#6-4-1-使用并行垃圾收集器的年轻代垃圾收集" class="headerlink" title="6.4.1 使用并行垃圾收集器的年轻代垃圾收集"></a>6.4.1 使用并行垃圾收集器的年轻代垃圾收集</h6><p>这里，对年轻代的并行垃圾收集使用的串行垃圾收集算法的并行版本。它仍然会stop-the-world，拷贝对象，但执行垃圾收集时是使用多CPU并行进行的，减少了垃圾收集的时间损耗，提高了应用程序的吞吐量。图6展示了串行垃圾收集器和并行垃圾收集器对年轻代进行垃圾收集时的区别。</p>
<p><img src="http://static.cyblogs.com/WX20200131-154849@2x.png" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;WX20200131-154849@2x.png"></p>
<h6 id="6-4-2-使用并行垃圾收集器的老年代垃圾收集"><a href="#6-4-2-使用并行垃圾收集器的老年代垃圾收集" class="headerlink" title="6.4.2 使用并行垃圾收集器的老年代垃圾收集"></a>6.4.2 使用并行垃圾收集器的老年代垃圾收集</h6><p>老年代中的并行垃圾收集使用了与串行垃圾收集器相同的串行 标记-清理-整理（mark-sweep-compact）算法。</p>
<h6 id="6-4-3-什么时候使用并行垃圾收集器"><a href="#6-4-3-什么时候使用并行垃圾收集器" class="headerlink" title="6.4.3 什么时候使用并行垃圾收集器"></a>6.4.3 什么时候使用并行垃圾收集器</h6><p>当应用程序运行在具有多个CPU上，对暂停时间没有特别高的要求时，使用并行垃圾收集器会有较好的效果，因为虽不频繁，但可能时间会很长的老年代垃圾收集仍然会发生。例如，那些执行批量处理、订单处理、工资支付、科学计算的应用程序更适合使用并行垃圾收集。</p>
<p>可能你会想用并行整理垃圾收集器（会在下一节介绍）来替代并行收集器，因为前者对所有代执行垃圾收集，而后者指对年轻代执行垃圾收集。</p>
<h6 id="6-4-4-选择并行垃圾收集器"><a href="#6-4-4-选择并行垃圾收集器" class="headerlink" title="6.4.4 选择并行垃圾收集器"></a>6.4.4 选择并行垃圾收集器</h6><p>在J2SE 5.0的发行版中，若应用程序是运行在服务器类的机器上，则会默认使用并行垃圾收集器。在其他机器上，可以通过 -XX:+UseParallelGC参数来显式启用并行垃圾收集器。</p>
<h5 id="6-5-并行整理整理收集器（Parallel-Compacting-Collector）"><a href="#6-5-并行整理整理收集器（Parallel-Compacting-Collector）" class="headerlink" title="6.5 并行整理整理收集器（Parallel Compacting Collector）"></a>6.5 并行整理整理收集器（Parallel Compacting Collector）</h5><p>并行整理垃圾收集器是在J2SE 5.0 update 6中被引入的，其与并行垃圾收集器的区别在于，并行整理垃圾收集器使用了新的算法对老年代进行垃圾收集。注意，最终，并行整理垃圾收集器会取代并行垃圾收集器。</p>
<h6 id="6-5-1-使用并行整理垃圾收集器的年轻代垃圾收集"><a href="#6-5-1-使用并行整理垃圾收集器的年轻代垃圾收集" class="headerlink" title="6.5.1 使用并行整理垃圾收集器的年轻代垃圾收集"></a>6.5.1 使用并行整理垃圾收集器的年轻代垃圾收集</h6><p>年轻代中，并行整理垃圾收集器使用了与并行垃圾收集器相同的垃圾收集算法。</p>
<h6 id="6-5-2-使用并行整理垃圾收集器的老年代垃圾收集"><a href="#6-5-2-使用并行整理垃圾收集器的老年代垃圾收集" class="headerlink" title="6.5.2 使用并行整理垃圾收集器的老年代垃圾收集"></a>6.5.2 使用并行整理垃圾收集器的老年代垃圾收集</h6><p>当使用并行整理垃圾收集时，老年代和永生代会使用<code>stop-the-world</code>的方式执行垃圾收集，大多数的并行模式都会使用移动整理（sliding compaction）。垃圾收集分为三个阶段。首先，将每一个代从逻辑上分为固定大小的区域。</p>
<p>在 标记阶段（mark phase），应用程序代码可以直接到达的live对象的初始集合会被划分到各个垃圾收集线程中，然后，所有的live对象会被并行标记。若一个对象被标记为live，则会更新该对象所在的区域中与该对象的大小和位置相关的数据。</p>
<p>在 总结阶段（summary phase）会对区域，而非单独的对象进行操作。由于之前的垃圾收集执行了整理，每一代的左侧部分的对象密度会较高，包含了大部分live对象。这些对象密度较高的区域被恢复为可用后，就不值得再花时间去整理了。所以，在总结阶段要做的第一件事是从最左端对象开始检查每个区域的live对象密度，直到找到了一个恢复其本区域和恢复其右侧的空间的开销都比较小时停止。找到的区域的左侧所有区域被称为dense prefix，不会再有对象被移动到这些区域里了。这个区域后侧的区域会被整理，清除所有已死的空间（清理垃圾对象占用的空间）。总结阶段会计算并保存每个整理后的区域中对象的新地址。注意，在当前实现中，总结阶段是串行的；当然总结阶段也可以实现为并行的，但相对于性能总结阶段的并行不及标记整理阶段来得重要。</p>
<p>在 整理阶段（compaction phase），垃圾收集线程使用总结阶段收集到的数据决定哪些区域课余填充数据，然后各个线程独立的将数据拷贝到这些区域中。这样就产生了一个底端对象密度大，连一端是一个很大的空区域块的堆。</p>
<h6 id="6-5-3-什么时候使用并行整理垃圾收集器"><a href="#6-5-3-什么时候使用并行整理垃圾收集器" class="headerlink" title="6.5.3 什么时候使用并行整理垃圾收集器"></a>6.5.3 什么时候使用并行整理垃圾收集器</h6><p>相对于并行垃圾收集器，使用并行整理垃圾收集器对那些运行在多CPU的应用程序更有好处。此外，老年代垃圾收集的并行操作可以减少应用程序的暂停时间，对于那些对暂停时间有较高要求的应用程序来说，并行整理垃圾程序比并行垃圾收集更加适用。并行整理垃圾收集程序可能并不适用于那些与其他很多应用程序并存于一台机器的应用程序上，这种情况下，没有一个应用程序可以独占所有的CPU。在这样的机器上，需要考虑减少执行垃圾收集的线程数（使用-XX:ParallelGCThreads&#x3D;n命令行选项），或者使用另一种垃圾收集器。</p>
<h6 id="5-5-4-选择并行整理垃圾收集选项"><a href="#5-5-4-选择并行整理垃圾收集选项" class="headerlink" title="5.5.4 选择并行整理垃圾收集选项"></a>5.5.4 选择并行整理垃圾收集选项</h6><p>若你想使用并行整理垃圾收集器，你必须显式指定-XX:+UseParallelOldGC命令行选项。</p>
<h5 id="6-6-并发标记清理（Concurrent-Mark-Sweep，CMS）垃圾收集器"><a href="#6-6-并发标记清理（Concurrent-Mark-Sweep，CMS）垃圾收集器" class="headerlink" title="6.6 并发标记清理（Concurrent Mark-Sweep，CMS）垃圾收集器"></a>6.6 并发标记清理（Concurrent Mark-Sweep，CMS）垃圾收集器</h5><p>对于很多应用程序来说，点到点的吞吐量并不如快速响应来的重要。典型情况下，年轻代的垃圾收集并不会引起较长时间的暂停。但是，老年代的垃圾收集，虽不频繁，却可能引起长时间的暂停，特别是使用了较大的堆的时候。为了应付这种情况，HotSpot JVM使用了CMS垃圾收集器，也称为低延迟（low-latency）垃圾收集器。</p>
<h6 id="6-6-1-使用CMS垃圾收集器的年轻代垃圾收集"><a href="#6-6-1-使用CMS垃圾收集器的年轻代垃圾收集" class="headerlink" title="6.6.1 使用CMS垃圾收集器的年轻代垃圾收集"></a>6.6.1 使用CMS垃圾收集器的年轻代垃圾收集</h6><p>CMS垃圾收集器只对老年代进行收集，年轻代实际默认使用<code>ParNewGC</code>（一种年轻代的并行垃圾收集器）收集。</p>
<h6 id="6-6-2-使用CMS垃圾收集器的老年代垃圾收集"><a href="#6-6-2-使用CMS垃圾收集器的老年代垃圾收集" class="headerlink" title="6.6.2 使用CMS垃圾收集器的老年代垃圾收集"></a>6.6.2 使用CMS垃圾收集器的老年代垃圾收集</h6><p>大部分老年代的垃圾收集使用了<code>CMS</code>垃圾收集器，垃圾收集工作是与应用程序的执行并发进行的。</p>
<table>
<thead>
<tr>
<th>过程</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>初始标记</td>
<td>标记老年代的存活对象，也可能包括年轻代的存活对象。暂停应用线程<code>stop-the world</code></td>
</tr>
<tr>
<td>并发标记</td>
<td>和应用程序一起执行，标记应用程序运行过程中产生的存活的对象。</td>
</tr>
<tr>
<td>重标记</td>
<td>标记由于应用程序更新导致遗漏的对象，暂停应用线程<code>stop-the world</code></td>
</tr>
<tr>
<td>并发清理</td>
<td>清理没有被标记的对象，不会进行内存整理，可能导致内存碎片问题。</td>
</tr>
<tr>
<td>复位</td>
<td>清理数据等待下一次收集执行。</td>
</tr>
</tbody></table>
<p>图7展示了使用串行化的标记清理垃圾收集器和使用CMS垃圾收集器对老年代进行垃圾收集的区别。</p>
<p><img src="http://static.cyblogs.com/WX20200131-155134@2x.png" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;WX20200131-155134@2x.png"></p>
<p>不进行内存空间整理节省了时间，但是可用空间不再是连续的了，垃圾收集也不能简单的使用指针指向下一次可用来为对象分配内存的地址了。相反，这种情况下，需要使用可用空间列表。即，会创建一个指向未分配区域的列表，每次为对象分配内存时，会从列表中找到一个合适大小的内存区域来为新对象分配内存。这样做的结果是，老年代上的内存的分配比简单实用碰撞指针分配内存消耗大。这也会增加年轻代垃圾收集的额外负担，因为老年代中的大部分对象是在新生代垃圾收集的时候从新生代提升为老年代的。</p>
<p><strong>使用CMS垃圾收集器的另一个缺点是它所需要的对空间比其他垃圾收集器大</strong>。在标记阶段，应用程序可以继续运行，可以继续分配内存，潜在的可能会持续的增大老年代的内存使用。此外，尽管垃圾收集器保证会在标记阶段标记出所有的live对象，但是在此阶段中，某些对象可能会变成垃圾对象，这些对象不会被回收，直到下一次垃圾收集执行。这些对象成为 浮动垃圾对象（floating garbage）。</p>
<p>最后，由于没有使用整理，会造成内存碎片的产生。为了解决这个问题，CMS垃圾收集器会跟踪常用对象的大小，预估可能的内存需要，可能会差分或合并内存块来满足需要。</p>
<p>与其他的垃圾收集器不同，当老年代被填满后，CMS垃圾收集器并不会对老年代进行垃圾收集。相反，它会在老年代被填满之前就执行垃圾收集工作。否则这就与串行或并行垃圾收集器一样会造成应用程序长时间地暂停。为了避免这种情况，CMS垃圾收集器会基于统计数字来来定执行垃圾收集工作的时间，这个统计数字涵盖了前几次垃圾收集的执行时间和老年代中新增内存分配的速率。当老年代中内存占用率超过了称为初始占用率的阀值后，会启动CMS垃圾收集器进行垃圾收集。初始占用率可以通过命令行选项<code>-XX:CMSInitiatingOccupancyFraction=n</code>进行设置，其中n是老年代占用率的百分比的值，默认为68。</p>
<p>总体来看，与平行垃圾收集器相比，CMS减少了执行老年代垃圾收集时应用暂停的时间，但却增加了新生代垃圾收集时应用暂停的时间、降低了吞吐量而且需要占用更大的堆空间。</p>
<h4 id="七、G1-收集器"><a href="#七、G1-收集器" class="headerlink" title="七、G1 收集器"></a>七、G1 收集器</h4><p>G1最为新一代的垃圾回收器，设计之初就是为了取代<code>CMS</code>的。具备以下优点：</p>
<ul>
<li>并发执行垃圾收集</li>
<li>很短的时间进行内存整理</li>
<li>GC的暂停时间可控</li>
<li>不需要牺牲吞吐量</li>
<li>不需要占用额外的java堆空间 什么需要使用G1收集器呢？</li>
<li>频繁的FGC</li>
<li>对象分配率或提升的速率差异很大。</li>
<li>无法接受过长的GC暂停和内存整理时间</li>
</ul>
<p>G1收集器和之前垃圾收集器拥有完全不同的内存结构，虽然从逻辑上也存在年轻代、老年代，但是物理空间上不在连续而是散列在内存中的一个个<code>regions</code>。内存空间分割成很多个相互独立的空间，被乘称作<code>regions</code>。当<code>jvm</code>启动时<code>regins</code>的大小就被确定了。jvm会创建大概2000个regions,每个region的大小在1M~32M之间。内存结构如下图：</p>
<p><img src="http://static.cyblogs.com/WX20200131-155507@2x.png" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;WX20200131-155507@2x.png"></p>
<h5 id="7-1-使用G1进行年轻代收集"><a href="#7-1-使用G1进行年轻代收集" class="headerlink" title="7.1 使用G1进行年轻代收集"></a>7.1 使用G1进行年轻代收集</h5><p>当年轻代GC被触发时，Eden中存活的对象将会被复制或者移动<code>evacuated</code>到幸存区的<code>regions</code>，在幸存复制的次数到达阈值的存活对象将会晋升到老年区。这个过程也是一个Stop-the-world 暂停。eden和survivor的大小将会在下一次年轻代GC前重新计算。</p>
<p><img src="http://static.cyblogs.com/WX20200131-155627@2x.png" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;WX20200131-155627@2x.png"></p>
<p>总而言之，G1在年轻代的手机行为包括以下几点：</p>
<ul>
<li><p>1、内存被分割成相互独立的大小相等的regions。 </p>
</li>
<li><p>2、年轻代散列在整个内存空间中，这样做的好处是当需要重新分配年轻代大小时会非常方便。 </p>
</li>
<li><p>3、stop-the-word 暂停所有线程。</p>
</li>
<li><p>4、实际上也是并行回收算法，多线程并行收集。 </p>
</li>
<li><p>5、存活的对象将被复制到新的 survivor或老年代 regions。</p>
</li>
</ul>
<h5 id="7-2-使用G1进行老年代收集"><a href="#7-2-使用G1进行老年代收集" class="headerlink" title="7.2 使用G1进行老年代收集"></a>7.2 使用G1进行老年代收集</h5><table>
<thead>
<tr>
<th>过程</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>初始标记</td>
<td><code>stop-the world</code> 通常伴随在年轻代GC后面，标记有被老年代对象关联的幸存区 regions</td>
</tr>
<tr>
<td>扫描根 Regions</td>
<td>和应用线程并发执行，扫描幸存区regions</td>
</tr>
<tr>
<td>并发标记</td>
<td>并发标记整个堆存活的对象</td>
</tr>
<tr>
<td>重标记</td>
<td>完成整个堆的存活对象标记，使用<code>snapshot-at-the-beginning (SATB)</code>算法标记存活对象，该算法比CMS中使用的更快。<code>stop-the-word</code></td>
</tr>
<tr>
<td>并行清理</td>
<td>并行清理死亡的的对象，返回空的regoins到可用列表。</td>
</tr>
<tr>
<td>复制</td>
<td>复制存活的对象到新的regions,<code>This can be done with young generation regions which are logged as [GC pause (young)]. Or both young and old generation regions which are logged as [GC Pause (mixed)].</code></td>
</tr>
</tbody></table>
<h5 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h5><p>1、不要指定年轻代大小 <code>-Xmn</code>,G1每次垃圾收集结束后都会从新计算并设置年轻代的大小，将会影响全局的暂停时间 2、响应时间配置 <code>-XX:MaxGCPauseMillis=</code> 3、如何解决清理 or 复制失败问题，通过增加<code>-XX:G1ReservePercent=n</code>配置预留空间的大小，防止<code>Evacuation Failure</code>,默认值是10.也可以使用<code>-XX:ConcGCThreads=n</code>增加并发标记的线程数来解决</p>
<h4 id="八、相关命令"><a href="#八、相关命令" class="headerlink" title="八、相关命令"></a>八、相关命令</h4><p>选择垃圾回收</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-XX:+UseSerialGC            串行垃圾收集器</span><br><span class="line">-XX:+UseParallelGC          并行垃圾收集器</span><br><span class="line">-XX:+UseParallelOldGC       并行整理垃圾收集器</span><br><span class="line">-XX:+UseConcMarkSweepGC	    并发标记清理（CMS）垃圾收集年轻代默认使用-XX:+ParNewGC</span><br><span class="line">-XX:+UserG1GC</span><br></pre></td></tr></table></figure>

<p>查看垃圾收集日志</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-XX:+PrintGC                </span><br><span class="line">-XX:+PrintGCDetails     </span><br><span class="line">-XX:+PrintGCTimeStamps      </span><br></pre></td></tr></table></figure>

<p>对大小配置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">-Xmsn                           堆最小值</span><br><span class="line">-Xmxn                           堆最大值</span><br><span class="line">-Xmn                            年轻代大小</span><br><span class="line">-XX:NewRatio=n	                年清代比例 Client_JVM=<span class="number">2</span> Server_JVM=<span class="number">8</span>     </span><br><span class="line">-XX:SurvivorRatio=n	            幸存去比例</span><br><span class="line">-XX:MaxPermSize=n               依赖于不同平台的实现永生代的最大值(java <span class="number">8</span> 以后启用)。</span><br></pre></td></tr></table></figure>

<p>G1可用的配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">-XX:+UseG1GC	Use the Garbage First (G1) Collector</span><br><span class="line">-XX:MaxGCPauseMillis=n	Sets a target for the maximum GC pause time. This is a soft goal, and the JVM will make its best effort to achieve it.</span><br><span class="line">-XX:InitiatingHeapOccupancyPercent=n	Percentage of the (entire) heap occupancy to start a concurrent GC cycle. It is used by GCs that trigger a concurrent GC cycle based on the occupancy of the entire heap, not just one of the generations (e.g., G1). A value of 0 denotes &#x27;do constant GC cycles&#x27;. The default value is 45.</span><br><span class="line">-XX:NewRatio=n	Ratio of new/old generation sizes. The default value is 2.</span><br><span class="line">-XX:SurvivorRatio=n	Ratio of eden/survivor space size. The default value is 8.</span><br><span class="line">-XX:MaxTenuringThreshold=n	Maximum value for tenuring threshold. The default value is 15.</span><br><span class="line">-XX:ParallelGCThreads=n	Sets the number of threads used during parallel phases of the garbage collectors. The default value varies with the platform on which the JVM is running.</span><br><span class="line">-XX:ConcGCThreads=n	Number of threads concurrent garbage collectors will use. The default value varies with the platform on which the JVM is running.</span><br><span class="line">-XX:G1ReservePercent=n	Sets the amount of heap that is reserved as a false ceiling to reduce the possibility of promotion failure. The default value is 10.</span><br><span class="line">-XX:G1HeapRegionSize=n</span><br></pre></td></tr></table></figure>

<h4 id="九、参考"><a href="#九、参考" class="headerlink" title="九、参考"></a>九、参考</h4><ul>
<li><p><a target="_blank" rel="noopener" href="http://www.oracle.com/technetwork/tutorials/tutorials-1876574.html">Getting Started with the G1 Garbage Collector</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="http://www.oracle.com/technetwork/java/javase/memorymanagement-whitepaper-150215.pdf">Memory Management in the Java HotSpot™ Virtual Machine</a></p>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="上一页" aria-label="上一页" href="/page/8/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><span class="page-number current">9</span><a class="page-number" href="/page/10/">10</a><span class="space">&hellip;</span><a class="page-number" href="/page/15/">15</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/page/10/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Vernon</span>
  </div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
    <a target="_blank" href="https://beian.miit.gov.cn">粤ICP备2025433887号</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
