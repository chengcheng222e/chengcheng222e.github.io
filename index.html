<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"www.cyblogs.com","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.23.1","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js" defer></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="简栈文化">
<meta property="og:url" content="http://www.cyblogs.com/index.html">
<meta property="og:site_name" content="简栈文化">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Vernon">
<meta property="article:tag" content="Java">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://www.cyblogs.com/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>简栈文化</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  






  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="简栈文化" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">简栈文化</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">Java技术人的成长之路~</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Vernon"
      src="/images/vernonchen.jpg">
  <p class="site-author-name" itemprop="name">Vernon</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">149</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">66</span>
        <span class="site-state-item-name">分类</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">87</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/chengcheng222e" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;chengcheng222e" rel="noopener me" target="_blank"><i class="github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:chengcheng222e@gmail.com" title="E-Mail → mailto:chengcheng222e@gmail.com" rel="noopener me" target="_blank"><i class="envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.cyblogs.com/2021/12/04/2021/12/%E6%95%B0%E6%8D%AE%E5%BA%93%E9%81%87%E5%88%B0%E4%BA%86%E6%AD%BB%E9%94%81%EF%BC%8C%E4%BD%A0%E8%AF%A5%E5%A6%82%E4%BD%95%E6%8E%92%E6%9F%A5%EF%BC%9F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/vernonchen.jpg">
      <meta itemprop="name" content="Vernon">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简栈文化">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | 简栈文化">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/12/04/2021/12/%E6%95%B0%E6%8D%AE%E5%BA%93%E9%81%87%E5%88%B0%E4%BA%86%E6%AD%BB%E9%94%81%EF%BC%8C%E4%BD%A0%E8%AF%A5%E5%A6%82%E4%BD%95%E6%8E%92%E6%9F%A5%EF%BC%9F/" class="post-title-link" itemprop="url">数据库遇到了死锁，你该如何排查？</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-12-04 00:00:00" itemprop="dateCreated datePublished" datetime="2021-12-04T00:00:00+08:00">2021-12-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-06-25 10:05:09" itemprop="dateModified" datetime="2025-06-25T10:05:09+08:00">2025-06-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h4><p>前段时间做了很多慢<code>SQL</code>的优化工作，这周刚好又被反馈服务出现了死锁导致了业务报错。看了一下云数据库的告警日志，发现出现了比较多的<code>事务未提交</code>、<code>死锁</code>、<code>等待行锁</code>的严重警告。都是一些棘手的运维工作，涉及到业务流程的梳理、SQL的优化等工作。</p>
<p>今天趁这个机会，我们一起看下如何去分析这些问题，主要看下等待行锁、死锁。</p>
<h4 id="数据库有哪几种锁？"><a href="#数据库有哪几种锁？" class="headerlink" title="数据库有哪几种锁？"></a>数据库有哪几种锁？</h4><p>每次说数据库锁，感觉一大堆。其实如果按照一定的纬度去整理下，还是比较清晰的。如图:</p>
<p><img src="http://static.cyblogs.com/202112041740552.png" alt="MySQL锁"></p>
<p>力度划分：表锁、页锁、行锁</p>
<p>算法划分：<code>Record Lock</code>、<code>Gap Lock</code>、<code>Next-key Lock</code></p>
<p>实现机制：乐观锁、悲观锁</p>
<p>兼容性：排它锁、共享锁、意向锁</p>
<p>每次说锁，其实也要跟它的隔离级别挂钩才行，其实都是为了去实现某一个功能才产生的。所以不可以一概而论，总之记住几个大的背景：</p>
<ul>
<li>不同的隔离级别才会有不同的锁，比如<code>RR</code>才会出现<code>Gap Lock</code>，因为要避免幻读的问题，所有要把它相邻的数据也要锁住。</li>
<li>锁是作用在索引上的，包含：聚簇索引、非聚簇索引</li>
</ul>
<h4 id="如何看日志？"><a href="#如何看日志？" class="headerlink" title="如何看日志？"></a>如何看日志？</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SET GLOBAL innodb_status_output=ON; -- 开启输出</span><br><span class="line">SET GLOBAL innodb_status_output_locks=ON; -- 开启锁信息输出</span><br><span class="line"></span><br><span class="line">SHOW ENGINE INNODB STATUS\G</span><br></pre></td></tr></table></figure>

<p>通过<code>SHOW ENGINE INNODB STATUS</code>可以看到锁的一些信息</p>
<p>先确定一下自己数据库的隔离级别信息，我现在数据库的版本是<code>8.0.26</code> 。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">如果是比较老的数据库</span><br><span class="line"><span class="keyword">select</span> @<span class="variable">@tx_isolation</span>;</span><br><span class="line"><span class="keyword">select</span> @<span class="variable">@global</span>.tx_isolation;</span><br><span class="line"></span><br><span class="line">ERROR <span class="number">1193</span> (HY000): <span class="literal">Unknown</span> <span class="keyword">system</span> variable <span class="string">&#x27;tx_isolation&#x27;</span> 如果报错，说明你的数据库比较新，需要采用新的查询语句。</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> VERSION();</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+</span></span><br><span class="line"><span class="operator">|</span> VERSION() <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">8.0</span><span class="number">.26</span>    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> @<span class="variable">@transaction_isolation</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------+</span></span><br><span class="line"><span class="operator">|</span> @<span class="variable">@transaction_isolation</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------+</span></span><br><span class="line"><span class="operator">|</span> REPEATABLE<span class="operator">-</span>READ         <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------------------------+</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> @<span class="variable">@session</span>.transaction_isolation;</span><br></pre></td></tr></table></figure>

<p>查看锁的情况</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 老版本</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> information_schema.innodb_locks;</span><br><span class="line"></span><br><span class="line"># 高版本</span><br><span class="line"><span class="keyword">SELECT</span> ENGINE_LOCK_ID, THREAD_ID, OBJECT_NAME, LOCK_TYPE, LOCK_MODE, LOCK_DATA</span><br><span class="line"><span class="keyword">FROM</span> performance_schema.data_locks;</span><br></pre></td></tr></table></figure>

<h4 id="等待行锁"><a href="#等待行锁" class="headerlink" title="等待行锁"></a>等待行锁</h4><p>这个问题也会比较常见，如果出现一个事务获取了锁，如果它不释放或者提交的话，那么后面的人就一直获取不到锁。如果获取锁的时间过长的话，后面的流程就会一直卡住。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 建表</span></span><br><span class="line"><span class="keyword">CREATE TABLE</span> `id_test_rr` (</span><br><span class="line">  `pk` <span class="type">int</span> <span class="keyword">NOT NULL</span>,</span><br><span class="line">  `id` <span class="type">int</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `name` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY KEY</span> (`pk`),</span><br><span class="line">  KEY `idx_id` (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8mb4_0900_ai_ci;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 准备数据</span></span><br><span class="line"><span class="keyword">INSERT INTO</span> id_test_rr <span class="keyword">values</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="string">&#x27;a&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT INTO</span> id_test_rr <span class="keyword">values</span>(<span class="number">2</span>, <span class="number">3</span>, <span class="string">&#x27;b&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT INTO</span> id_test_rr <span class="keyword">values</span>(<span class="number">3</span>, <span class="number">5</span>, <span class="string">&#x27;c&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT INTO</span> id_test_rr <span class="keyword">values</span>(<span class="number">4</span>, <span class="number">7</span>, <span class="string">&#x27;c&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT INTO</span> id_test_rr <span class="keyword">values</span>(<span class="number">5</span>, <span class="number">5</span>, <span class="string">&#x27;b&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>事务1：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">BEGIN</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">DELETE</span> <span class="keyword">FROM</span> id_test_rr <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">5</span>;</span><br><span class="line">Query OK, <span class="number">2</span> <span class="keyword">rows</span> affected (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure>

<p>这个时候不要提交事务，看一下现在加锁的情况。</p>
<p><img src="http://static.cyblogs.com/202112042132785.png" alt="image-20211204213254443"></p>
<ul>
<li>5，3 加了一把X锁</li>
<li>5，5加了一把X锁</li>
<li>3 主键加了一个X锁</li>
<li>5主键加了一个X锁</li>
<li>7，4加了GAP Lock，X，这里因为是RR，为防止幻读需要加GAP来保证。</li>
</ul>
<p>事务2：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">update</span> id_test_rr <span class="keyword">set</span> name <span class="operator">=</span> <span class="string">&#x27;x&#x27;</span> <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line">ERROR <span class="number">1205</span> (HY000): Lock wait timeout exceeded; try restarting transaction</span><br></pre></td></tr></table></figure>

<p><img src="http://static.cyblogs.com/202112042139313.png" alt="image-20211204213956251"></p>
<p>当事务1提交的时候，事务2马上就获取到了锁。</p>
<p><img src="http://static.cyblogs.com/202112042142127.png" alt="image-20211204214236092"></p>
<p>如何设置超时时间：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> variables <span class="keyword">like</span> <span class="string">&#x27;innodb_lock_wait_timeout&#x27;</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------+-------+</span></span><br><span class="line"><span class="operator">|</span>Variable_name            <span class="operator">|</span> <span class="keyword">Value</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------+-------+</span></span><br><span class="line"><span class="operator">|</span> innodb_lock_wait_timeout<span class="operator">|</span>  <span class="number">50</span>  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------------------------+-------+</span></span><br></pre></td></tr></table></figure>

<h4 id="死锁"><a href="#死锁" class="headerlink" title="死锁"></a>死锁</h4><h5 id="死锁产生的条件"><a href="#死锁产生的条件" class="headerlink" title="死锁产生的条件"></a>死锁产生的条件</h5><p>（1） 互斥条件：一个资源每次只能被一个进程使用。<br>（2）请求与保持条件：一个进程因请求资源而阻塞时，对已获得的资源保持不放。<br>（3）不剥夺条件：进程已获得的资源，在末使用完之前，不能强行剥夺。<br>（4）循环等待条件：若干进程之间形成一种头尾相接的循环等待资源关系。</p>
<p>其实，产生死锁的条件无非就是这4个条件，其实大学里学习操作系统的时候就有学习到过。解决死锁，也只需要让它们只要有一个条件不满足就可以了。</p>
<h5 id="死锁的过程分析"><a href="#死锁的过程分析" class="headerlink" title="死锁的过程分析"></a>死锁的过程分析</h5><p>建表语句</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE TABLE</span> t (i <span class="type">INT</span>) ENGINE <span class="operator">=</span> InnoDB;</span><br><span class="line"><span class="keyword">INSERT INTO</span> t (i) <span class="keyword">VALUES</span>(<span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<p>事务1：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">BEGIN</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> t <span class="keyword">WHERE</span> i <span class="operator">=</span> <span class="number">1</span> LOCK <span class="keyword">IN</span> SHARE MODE;</span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span> i    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="operator">|</span>    <span class="number">1</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<p><img src="http://static.cyblogs.com/202112042151484.png" alt="image-20211204215103399"></p>
<p>事务2：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">BEGIN</span>;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> t <span class="keyword">WHERE</span> i <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p><img src="http://static.cyblogs.com/202112042152847.png" alt="image-20211204215206747"></p>
<p>然后事务1继续进行删除操作</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">DELETE</span> <span class="keyword">FROM</span> t <span class="keyword">WHERE</span> i <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p><img src="http://static.cyblogs.com/202112042152228.png" alt="image-20211204215251156"></p>
<p>事务2报错了：<code>Deadlock found when trying to get lock;</code></p>
<p>死锁产生了！因为事务1需要锁X来删除行，而事务2拿着锁X并正在等待事务1释放锁S。看看2个事务的状态：</p>
<ul>
<li>事务1: 拿着锁S，等待着事务2释放锁X</li>
<li>事务2: 拿着锁X，等待着事务1释放锁S</li>
</ul>
<p><img src="http://static.cyblogs.com/202112042153307.png" alt="image-20211204215342270"></p>
<h4 id="参考地址"><a href="#参考地址" class="headerlink" title="参考地址"></a>参考地址</h4><ul>
<li><a target="_blank" rel="noopener" href="https://lotabout.me/2020/God-Damn-MySQL-Locks/">https://lotabout.me/2020/God-Damn-MySQL-Locks/</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/xiaoboluo768/p/5171425.html">https://www.cnblogs.com/xiaoboluo768/p/5171425.html</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/296545804">https://zhuanlan.zhihu.com/p/296545804</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_45437022/article/details/115448563">https://blog.csdn.net/weixin_45437022/article/details/115448563</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/my_life/articles/10219594.html">https://www.cnblogs.com/my_life/articles/10219594.html</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.cyblogs.com/2021/11/13/2021/11/MySql%E4%BA%8B%E5%8A%A1%E6%9C%AA%E6%8F%90%E4%BA%A4%E5%AF%BC%E8%87%B4%E9%94%81%E7%AD%89%E5%BE%85%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3%EF%BC%9F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/vernonchen.jpg">
      <meta itemprop="name" content="Vernon">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简栈文化">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | 简栈文化">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/11/13/2021/11/MySql%E4%BA%8B%E5%8A%A1%E6%9C%AA%E6%8F%90%E4%BA%A4%E5%AF%BC%E8%87%B4%E9%94%81%E7%AD%89%E5%BE%85%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3%EF%BC%9F/" class="post-title-link" itemprop="url">MySql事务未提交导致锁等待如何解决？</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-11-13 00:00:00" itemprop="dateCreated datePublished" datetime="2021-11-13T00:00:00+08:00">2021-11-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-06-25 10:05:09" itemprop="dateModified" datetime="2025-06-25T10:05:09+08:00">2025-06-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h4><p>我们来先看一个图，了解一下故(<strong>事</strong>)事(<strong>故</strong>)的背景：</p>
<p><img src="http://static.cyblogs.com/Jietu20211113-162059.jpg" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;Jietu20211113-162059.jpg"></p>
<p>有<code>2</code>个跑批任务，其实做的事情是同一件事情，都是为了跟下游系统保持数据的一致性。大任务是每个<code>2h</code>跑一次，小任务是每隔<code>10mins</code>跑一次。除了这<code>2</code>个定时任务以外，还有一个额外的监控任务来做类似的对账，如果发现出现对账不平，就会出现邮件&#x2F;短信告警到相关的责任上。</p>
<p>这是一个非常有特点的定时任务跑批任务+监控告警的场景了。</p>
<p>从上面的场景上看，我们可以得出一些结论：为了保证一致性写了大小Job来保证，并且还给出了监控告警，说明数据的重要性是比较强的。</p>
<p>某天，出现了频繁的告警提示，每<code>10</code>分钟就告警一次，而且内容没有发生变化，说明同步的<code>index</code>没有变化过。</p>
<h4 id="错误排查"><a href="#错误排查" class="headerlink" title="错误排查"></a>错误排查</h4><h5 id="任务有在正常的执行吗？"><a href="#任务有在正常的执行吗？" class="headerlink" title="任务有在正常的执行吗？"></a>任务有在正常的执行吗？</h5><p>第一反应肯定是在思考，我的大任务与小任务都有正常执行吗？因为之前的都是正常的。上午看了一下日志与进程发现有在跑，还跑除了多次任务，日志打印不明确，看不到具体分支的逻辑。总结一下问题点：</p>
<ul>
<li>任务很忌讳出现上一个任务没有跑完，下一个任务又继续开启一个新的任务，给服务器带来了不少的压力。一般如果对接了好的分布式调度能力，基本也很容易客服这个问题。</li>
<li>关键分支日志打印不明确，导致定位很难</li>
</ul>
<p>先修复上面<code>2</code>个问题，短时间对接一个新的分布式调度时间上不可能，只能简单的改<code>shell</code>脚本让其不执行。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">d=`date`</span><br><span class="line"></span><br><span class="line">count=`ps -ef |grep &#123;jobKeyword&#125; |grep -v grep | wc -l`</span><br><span class="line">if [ $count -lt 1 ]; then</span><br><span class="line">  echo &quot;$d : do &#123;jobKeyword&#125; . &quot; &gt;&gt; /data/&#123;projectName&#125;/sync.log</span><br><span class="line">  python xxxxx.py</span><br><span class="line">else</span><br><span class="line">  echo &quot;$d : &#123;jobKeyword&#125; no finished, this time do nothing. &quot; &gt;&gt; /data/&#123;projectName&#125;/sync.log</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<p>然后在重点的地方添加上日志，其实这些操作都是一些非常简单，但是可以带来明显效果的步骤。反正，我基本都是如此的去做的，你什么信息都拿不到，你根本无法入手。</p>
<p>部署上去后，发现每次在<code>insert into</code>一条数据的时候，日志就卡住了，结合代码确定，确定就是<code>insert into</code>的时候，数据库没有返回，而其他的表以及其他数据的都是可以正常操作的。</p>
<h5 id="出现了LOCK-WAIT"><a href="#出现了LOCK-WAIT" class="headerlink" title="出现了LOCK WAIT"></a>出现了LOCK WAIT</h5><p>第一反应，就是看下这条<code>SQL</code>现在是一个什么状态？我们可以利用<code>SHOW PROCESSLIST</code>看下</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> information_schema.PROCESSLIST t;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> information_schema.innodb_trx <span class="keyword">ORDER</span> <span class="keyword">BY</span> trx_started ;</span><br></pre></td></tr></table></figure>

<p>然后就发现该<code>SQL</code>语句的<code>trx_state=LOCK WAIT</code>，那说明没有获取到锁。那我们具体如何推断是谁没有释放锁了？</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">第1步:</span></span><br><span class="line">SELECT * FROM information_schema.innodb_locks ;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">第2步：1，2没有特别的先后顺序，之后为了确定trx_requested_lock_id以及是谁获取了锁lock_trx_id + local_data</span></span><br><span class="line">SELECT * FROM information_schema.innodb_trx t where t.trx_state = &#x27;LOCK WAIT&#x27;;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">第3步：找到对应的执行语句</span></span><br><span class="line">select * from information_schema.PROCESSLIST t where t.id = &#123;lock_trx_id&#125;</span><br></pre></td></tr></table></figure>

<p>可惜，那条语句已经是<code>sleep</code>的状态了，无法看到具体的<code>SQL</code>。在这里可以推断，就是有一条<code>SQL</code>在对数据<code>&#123;local_data&#125;</code>操作的时候获取了一把锁，但是因为事务未提交，导致后面的<code>SQL</code>再对<code>&#123;local_data&#125;</code>操作的时候要获取锁，无法获取到。理论上获取不到锁，一会儿也会释放掉报错出来。通过查询<code>innodb_lock_wait_timeout=7200</code>，默认值应该是<code>50</code>。</p>
<h5 id="解决掉问题"><a href="#解决掉问题" class="headerlink" title="解决掉问题"></a>解决掉问题</h5><p>到这一步就很明确了，就是让未提交事务的<code>SQL</code>结束掉，或者提交掉。此时只有<code>kill</code>掉这个进程的选项了。执行：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kill &#123;lock_trx_id&#125;;</span><br></pre></td></tr></table></figure>

<p>再执行就立马发现数据没有了，获取到了锁。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM information_schema.innodb_trx t where t.trx_state = &#x27;LOCK WAIT&#x27;;</span><br></pre></td></tr></table></figure>

<h5 id="总结一下"><a href="#总结一下" class="headerlink" title="总结一下"></a>总结一下</h5><ul>
<li><code>innodb_lock_wait_timeout</code> 设置不合理，时间太久了</li>
<li>出现获取不到锁的场景，需要告警到邮件、手机上来。</li>
<li>大任务与小任务的时间要搓开，出现这种情况也是对同一行数据进行X操作并且未释放锁导致的。把事务的时间搞短一点。可以每次都去获取连接，也不要一次连接执行很长时间。</li>
</ul>
<h4 id="实验性操作"><a href="#实验性操作" class="headerlink" title="实验性操作"></a>实验性操作</h4><p>就直接看脚本好了</p>
<p><img src="http://static.cyblogs.com/Jietu20211113-171928.jpg" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;Jietu20211113-171928.jpg"></p>
<p>当右边的事务对同一条数据进行X操作的时候，它是要获取锁的。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction</span><br></pre></td></tr></table></figure>

<p>这个时候可以去看下锁的表</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">select * from information_schema.innodb_locks;</span><br><span class="line">+-----------------+-------------+-----------+-----------+---------------+------------+------------+-----------+----------+-----------+</span><br><span class="line">|lock_id         | lock_trx_id | lock_mode| lock_type | lock_table    | lock_index| lock_space | lock_page | lock_rec | lock_data |</span><br><span class="line">+-----------------+-------------+-----------+-----------+---------------+------------+------------+-----------+----------+-----------+</span><br><span class="line">|757082:3279:3:2 | 757082      | X         | RECORD    | `test`.`test` | PRIMARY    |      3279 |         3 |       2 | 1         |</span><br><span class="line">|757081:3279:3:2 | 757081      | X         | RECORD    | `test`.`test` | PRIMARY    |      3279 |         3 |        2 | 1         |</span><br><span class="line">+-----------------+-------------+-----------+-----------+---------------+------------+------------+-----------+----------+-----------+</span><br><span class="line">2 rowsin set, 1 warning (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>查看一下设置的超时时间</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">show variables like &#x27;innodb_lock_wait_timeout&#x27;;</span><br><span class="line">+--------------------------+-------+</span><br><span class="line">|Variable_name            | Value |</span><br><span class="line">+--------------------------+-------+</span><br><span class="line">| innodb_lock_wait_timeout|  50  |</span><br><span class="line">+--------------------------+-------+</span><br></pre></td></tr></table></figure>

<p>看关于事务的描述</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> engine innodb status</span><br></pre></td></tr></table></figure>

<p>查看当前的事务</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> processlist;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-----------------+-----------+--------------------+---------+--------+------------------------+------------------+</span></span><br><span class="line"><span class="operator">|</span> Id <span class="operator">|</span> <span class="keyword">User</span>            <span class="operator">|</span> Host      <span class="operator">|</span> db                 <span class="operator">|</span> Command <span class="operator">|</span> <span class="type">Time</span>   <span class="operator">|</span> State                  <span class="operator">|</span> Info             <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-----------------+-----------+--------------------+---------+--------+------------------------+------------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">5</span> <span class="operator">|</span> event_scheduler <span class="operator">|</span> localhost <span class="operator">|</span> <span class="keyword">NULL</span>               <span class="operator">|</span> Daemon  <span class="operator">|</span> <span class="number">286110</span> <span class="operator">|</span> Waiting <span class="keyword">on</span> <span class="keyword">empty</span> queue <span class="operator">|</span> <span class="keyword">NULL</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">8</span> <span class="operator">|</span> root            <span class="operator">|</span> localhost <span class="operator">|</span> test               <span class="operator">|</span> Sleep   <span class="operator">|</span>    <span class="number">956</span> <span class="operator">|</span>                        <span class="operator">|</span> <span class="keyword">NULL</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">9</span> <span class="operator">|</span> root            <span class="operator">|</span> localhost <span class="operator">|</span> test               <span class="operator">|</span> Sleep   <span class="operator">|</span>    <span class="number">754</span> <span class="operator">|</span>                        <span class="operator">|</span> <span class="keyword">NULL</span>             <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">10</span> <span class="operator">|</span> root            <span class="operator">|</span> localhost <span class="operator">|</span> information_schema <span class="operator">|</span> Query   <span class="operator">|</span>      <span class="number">0</span> <span class="operator">|</span> init                   <span class="operator">|</span> <span class="keyword">show</span> processlist <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-----------------+-----------+--------------------+---------+--------+------------------------+------------------+</span></span><br><span class="line"><span class="number">4</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure>

<h4 id="参考地址"><a href="#参考地址" class="headerlink" title="参考地址"></a>参考地址</h4><ul>
<li><a target="_blank" rel="noopener" href="https://blog.51cto.com/corasql/1923427">https://blog.51cto.com/corasql/1923427</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.cyblogs.com/2021/11/06/2021/11/%E5%A6%82%E4%BD%95%E5%8F%8D%E7%BC%96%E8%AF%91%E4%B8%80%E4%B8%AADocker%E9%95%9C%E5%83%8F%E8%BF%98%E5%8E%9FDockerfile%EF%BC%9F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/vernonchen.jpg">
      <meta itemprop="name" content="Vernon">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简栈文化">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | 简栈文化">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/11/06/2021/11/%E5%A6%82%E4%BD%95%E5%8F%8D%E7%BC%96%E8%AF%91%E4%B8%80%E4%B8%AADocker%E9%95%9C%E5%83%8F%E8%BF%98%E5%8E%9FDockerfile%EF%BC%9F/" class="post-title-link" itemprop="url">如何反编译一个Docker镜像还原Dockerfile？</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-11-06 00:00:00" itemprop="dateCreated datePublished" datetime="2021-11-06T00:00:00+08:00">2021-11-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-06-25 10:05:09" itemprop="dateModified" datetime="2025-06-25T10:05:09+08:00">2025-06-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Docker/" itemprop="url" rel="index"><span itemprop="name">Docker</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h4><p>现在对于一个开发来说，<code>Docker</code>应该是再熟悉不过了。还记得在2013<del>2014左右的时候，听说多最多的就是<code>Cloud Foundry</code>，那个时候就一直在说云的事情。后面<code>Docker</code>就绝杀了它</del> </p>
<p>那它帮我们解决了一个什么问题了？面试的时候也许会问到。</p>
<p>在很久以前，我们开发代码，估计最蛋疼的事情就是发布版本了。我还记得在房多多的时候(2014~2016)左右，每次发布几个开发围绕在运维的身边，有时候运维忙不过来，开发就直接在运维的电脑上开始<code>VIM</code>干活了，修改若干配置。由于多环境的原因，我们无法保证每个环境都是一样的。</p>
<ul>
<li>可能你的操作系统不同，导致打包、发布的脚本不同</li>
<li>环境不同，没有很好的配置管理，你的代码有不同的写法</li>
<li>特别是跟操作系统相关的那些参数，可能瞬间就会带来性能问题</li>
</ul>
<p>那么<code>Docker</code>就可以把我们的操作系统、代码、脚本等都一起打包成一个<code>Image</code>，就可以保证只要是运行同一个<code>Image</code>，我们的所有内容都是一样的。就不会出现，我在测试环境跑的好好的，一到生产连启动都成问题。</p>
<h4 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h4><p>现在一般一个<code>POD</code>就只跑一个进程，<code>DevOps</code>会根据我们的发布流水线自动的将一个项目进行打包、发布，整套的<code>CI</code>、CD做的是行云流水。但是，每个项目<code>ROOT</code>下都会需要一个叫<code>Dockerfile</code>的文件。但偏偏有一些历史项目，没有<code>Dockerfile</code>文件，只有一个<code>Run</code>的容器再跑，真的是非常惊悚。<code>docker rm [OPTIONS] CONTAINER [CONTAINER...]</code>,就<code>GAME OVER</code>了。</p>
<h4 id="怎么办？"><a href="#怎么办？" class="headerlink" title="怎么办？"></a>怎么办？</h4><h5 id="方法1：以当前容器作为基础镜像"><a href="#方法1：以当前容器作为基础镜像" class="headerlink" title="方法1：以当前容器作为基础镜像"></a>方法1：以当前容器作为基础镜像</h5><p>真的，什么也不想。先保个底，把你当前的容器打包成一个镜像推送到仓库里去，哪天有以外或者说需要基于它做一些事情的时候才有可能。比如：你要本地也部署一份代码来<code>debug</code>。</p>
<p>一般都是私有的仓库，会需要输入用户名与密码</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ docker login &#123;仓库地址&#125;</span><br><span class="line">Username: chenyuan</span><br><span class="line">Password:</span><br><span class="line">Login Succeeded</span><br></pre></td></tr></table></figure>

<p>然后，将镜像打包推送到私有仓库去</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker commit -a &quot;name&quot; -m &quot;小陈来拯救你&quot; 706e502e8693 &#123;镜像地址&#125;:&#123;tag&#125;</span><br><span class="line"></span><br><span class="line">docker push &#123;镜像地址&#125;:&#123;tag&#125;</span><br><span class="line"></span><br><span class="line">docker pull &#123;镜像地址&#125;:&#123;tag&#125;</span><br></pre></td></tr></table></figure>

<p>但是这样子的问题在于，我们无法知道环境依赖了哪些模块，如果需要重新再部署一套，我为了保证环境的干净又需要删除哪些东西。就是无法知道增加与减少哪些东西，也就会导致环境存在不一致性，失去了我们的初衷。</p>
<h5 id="方法2：从运行的容器中复制"><a href="#方法2：从运行的容器中复制" class="headerlink" title="方法2：从运行的容器中复制"></a>方法2：从运行的容器中复制</h5><p>先把镜像跑起来，然后从运行起来的容器中复制文件出来，复制命令如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">从容器复制文件或目录到宿主机器</span></span><br><span class="line">docker cp 6619ff360cce:/opt/h2-data/pkslow ./</span><br><span class="line">docker cp 6619ff360cce:/opt/h2-data/pkslow/pkslow.txt ./</span><br></pre></td></tr></table></figure>

<p>第一种方法并不是万能的，因为有些镜像过于简单，少了许多基础命令，以至于无法复制文件，也无法进入<code>shell</code>环境。其次，要运行起来再操作，也有点占用资源，比较麻烦。</p>
<h5 id="方法3：解压镜像tar文件（推荐）"><a href="#方法3：解压镜像tar文件（推荐）" class="headerlink" title="方法3：解压镜像tar文件（推荐）"></a>方法3：解压镜像tar文件（推荐）</h5><p>此方法就是相当于反编译，拿到当时打镜像时候你做的详细操作。比较麻烦，但是是最靠谱的，最具有操作性的。</p>
<p>先将镜像保存为tar文件，命令如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker save -o &#123;name&#125;.tar &#123;镜像地址&#125;:&#123;tag&#125;</span><br></pre></td></tr></table></figure>

<p>下载后就会有一个tar包在本地，然后就解压出来。可以看一下<code>manifest.json</code>文件的内容</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;Config&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dca33100e3683d6fb4d56a4c142ccccc1c113f061454a64bc07c852fe068ea1d.json&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;RepoTags&quot;</span><span class="punctuation">:</span></span><br><span class="line">        <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;&#123;镜像地址&#125;:&#123;tag&#125;&quot;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Layers&quot;</span><span class="punctuation">:</span></span><br><span class="line">        <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;216168069a5195a9424b3a73a62bda39e4d5f8dcae2f7149a336c2e29beeb06b/layer.tar&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;4b0e1f4bede4cef5dee11aff78ff89f543dc62eb02306db1b96d896b101e069d/layer.tar&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;3fe7f20416fdd4958cc18b6fb0d28881147246c32677d102a431c31bf12288f7/layer.tar&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;84c1758c9c15f83d8aa4e1ad13c2918aea80f802f01d19eeb2f7c6e1897d7160/layer.tar&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;31bf0d828ecc19f178d8337e1c22a030984e9185e805b48ea911bd866730af2f/layer.tar&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;7b30e9a6f195343744ca82c66d31b61771e8d6502a271ad60deb1fa1103e83ca/layer.tar&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;522ee848bbd06c6e4dad8d5200b83c9197ccce717fb09687b435190d287f6829/layer.tar&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;a64965663d7c30ed09d35f05439dcfb6247f030df0d72a0e78f54fb6ae5a8c74/layer.tar&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;a93f0f89669c097497a3e3de7aeffebeba2838f180e4f13844be55fe124885ae/layer.tar&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;fd69896888f7361654ed0e27ed2634311b6707dd20706487e33e24f32bb23ebe/layer.tar&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;69c55c418aba5b8fb5239b4e8b092e02100f4ec49dae8ded9cc0a161b21884d7/layer.tar&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;5ef51ffa437403d5d33a40208c3781ea84a93f53947e5d7fad086092667bd3b1/layer.tar&quot;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<p>图片是解压后的效果，里面都会存在一个<code>layer.tar</code>，这里再解压就是当时打镜像时候的一些资源文件。</p>
<p><img src="http://static.cyblogs.com/image-20210928200049751.png" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;image-20210928200049751.png"></p>
<p><img src="http://static.cyblogs.com/image-20210928200334841.png" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;image-20210928200334841.png"></p>
<p>红色的部分就是我们想要的内容。再辛苦一点，把自己想要的东西整理出来。描述的比较轻描淡写，任何事情只要手动去做一遍，就会理解与记住。</p>
<h4 id="参考地址"><a href="#参考地址" class="headerlink" title="参考地址"></a>参考地址</h4><ul>
<li><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000040213872?sort=newest">https://segmentfault.com/a/1190000040213872?sort=newest</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.cyblogs.com/2021/10/30/2021/10/%E5%A6%82%E4%BD%95%E5%88%A9%E7%94%A8k8s%E7%9A%84label%E4%B8%8Eingress%E5%81%9A%E8%93%9D%E7%BB%BF%E5%8F%91%E5%B8%83%EF%BC%9F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/vernonchen.jpg">
      <meta itemprop="name" content="Vernon">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简栈文化">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | 简栈文化">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/10/30/2021/10/%E5%A6%82%E4%BD%95%E5%88%A9%E7%94%A8k8s%E7%9A%84label%E4%B8%8Eingress%E5%81%9A%E8%93%9D%E7%BB%BF%E5%8F%91%E5%B8%83%EF%BC%9F/" class="post-title-link" itemprop="url">如何利用k8s的label与ingress做蓝绿发布？</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-10-30 00:00:00" itemprop="dateCreated datePublished" datetime="2021-10-30T00:00:00+08:00">2021-10-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-06-25 10:05:09" itemprop="dateModified" datetime="2025-06-25T10:05:09+08:00">2025-06-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h4><p>之前在思考双活&#x2F;多活架构的时候，其实对于蓝绿发布是有一些了解的，也梳理过在底层存储是一份，服务是多份的模式有做过深入的分析。但那个时候对于<code>Kubernetes</code>的了解还不是很熟悉，是通过传统的方式来考量的。</p>
<p>因为现在的互联网公司基本都是上云了，我们也必须对于<code>Kubernetes</code>那一整套要有比较深入、熟悉的运用才能真的提高我们的效率。先聊一下，我为什么需要利用灰度+蓝绿发布的模式来去做？</p>
<p>现在有一个比较老的项目，应该在10年+，每天请求量大概在1.5亿+，峰值的<code>QPS</code>在6000&#x2F;s，存在着比较多性能问题。现在需要在它上面新增一个服务，为了后面优化做准备，比如：请求的分流、限流、熔断、日志的上报与监控（新）、统一编译处理，特殊报文转换等。也就是说，只要你新增加了一层，你才有可能更好的去做更多的事情。</p>
<p>那么我们需要达到一些什么的基础条件了？</p>
<ul>
<li>服务流量比较大，我们需要对新服务的可靠性需要验证，需要灰度先了解</li>
<li>因为存在慢查询，不能在滚动发布中，导致请求还未执行完毕，就被k8s kill掉了，业务会感知到502</li>
</ul>
<p>如果是你？针对于这2个基础的要求，你会如何去思考的你架构方案呢？</p>
<h4 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h4><p>新增服务的思考：</p>
<ul>
<li>它的性能必须要强、服务稳定。一个服务的性能好不好，其实跟它的：<code>I/O</code>模型、线程模型、数据结构、算法等息息相关。比如：你在思考<code>Redis</code>单线程为什么快的时候？应该就很能get到这里的点了。解决这个问题，我们选择了<code>Go</code>语言来开发（当然，最熟悉的语言风险最小），为了保证性能，也是做了2轮非常细致的压测。</li>
<li>发布过程中不能因为kill掉服务导致请求<code>502</code>。如果说我在发布的过程中，我把滚动这一步省略掉，直接先准备好一份最新的，验证可以后，我一刀直接把流量引导最新服务上，老的服务也不会断掉，这是否就可以达到效果了？</li>
</ul>
<h4 id="方案设计"><a href="#方案设计" class="headerlink" title="方案设计"></a>方案设计</h4><p>下面是我画的一个架构图，方便大家的理解，一共是3条路线：</p>
<p><img src="http://static.cyblogs.com/%E5%A6%82%E4%BD%95%E5%88%A9%E7%94%A8k8s%E7%9A%84label%E4%B8%8Eingress%E5%81%9A%E8%93%9D%E7%BB%BF%E5%8F%91%E5%B8%83_%E6%9E%B6%E6%9E%84%E5%9B%BE02.jpg" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;如何利用k8s的label与ingress做蓝绿发布_架构图02.jpg"></p>
<h5 id="路线1：原始的路线"><a href="#路线1：原始的路线" class="headerlink" title="路线1：原始的路线"></a>路线1：原始的路线</h5><ul>
<li><code>Ingress</code> → <code>Service:server-read</code> → <code>StatefulSet:server-g3-read + server-g3-read-gray</code>，整条链路是通过<code>ingress</code>的指向与<code>selector</code>的标签：<code>k8s-app:server-read</code>。</li>
</ul>
<h5 id="路线2：灰度方案"><a href="#路线2：灰度方案" class="headerlink" title="路线2：灰度方案"></a>路线2：灰度方案</h5><h6 id="服务正常"><a href="#服务正常" class="headerlink" title="服务正常"></a>服务正常</h6><p>就是我只能让一少部分的流量进入到新的服务(2%~10%，支持慢慢调整，其实就是pod的数量占比)。</p>
<ul>
<li><code>2%</code>的概率走的路径：<code>Ingress</code> → <code>Service:server-gateway-read01</code> → <code>StatefulSet:server-gateway-read01</code> → <code>注册中心获取负载地址</code> → <code>Service:server-read</code> → <code>StatefulSet:server-g3-read + server-g3-read-gray</code>，整条链路是通过<code>ingress</code>的指向与<code>selector</code>的标签：<code>server-app:server-gateway-read01</code></li>
<li><code>98%</code>的概率还是走的路线1</li>
</ul>
<h6 id="服务异常解决方案"><a href="#服务异常解决方案" class="headerlink" title="服务异常解决方案"></a>服务异常解决方案</h6><ul>
<li>因为这个流量是通过节点数来控制的，如果发生异常，可以把灰度节点的POD数量调整为0</li>
<li>还可以从ingress的地址切换到线路1的原始方案。这一招永远生效，因为一整套label标签依然存在。</li>
</ul>
<h5 id="路线3：蓝绿路线"><a href="#路线3：蓝绿路线" class="headerlink" title="路线3：蓝绿路线"></a>路线3：蓝绿路线</h5><h6 id="服务正常-1"><a href="#服务正常-1" class="headerlink" title="服务正常"></a>服务正常</h6><ul>
<li>100%的流量全部走灰度方案的。即：<code>Ingress</code> → <code>Service:server-gateway-read01</code> → <code>StatefulSet:server-gateway-read01</code> → <code>注册中心获取负载地址</code> → <code>Service:server-read</code> → <code>StatefulSet:server-g3-read + server-g3-read-gray</code>。但是它的<code>selector</code>的标签：<code>server-app:server-gateway-read02</code></li>
</ul>
<h6 id="服务异常解决方案-1"><a href="#服务异常解决方案-1" class="headerlink" title="服务异常解决方案"></a>服务异常解决方案</h6><ul>
<li>直接切换ingress地址到线路1或者是线路2都可以</li>
</ul>
<h4 id="最终的方案"><a href="#最终的方案" class="headerlink" title="最终的方案"></a>最终的方案</h4><p>后面如果长期稳定后，方案2其实就没有必要再继续灰度了，直接就替换成线路3了。相当于是一个蓝绿+主备的模式了。优缺点非常的明显：</p>
<ul>
<li>优点：解决了重启中可能出现的中断问题，其实也可以通过一些 <code>Graceful Shutdown</code>优化。</li>
<li>缺点：就是发布的一瞬间，你是需要多出一倍的机器来支撑服务的。</li>
</ul>
<p>再温馨提示一下，因为做了蓝绿发布，我们的系统对应的配置中心应该也最好是要分开的。系统之间要避免蓝色通过与绿色通道之间的交叉访问等问题。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.cyblogs.com/2021/10/23/2021/10/%E5%A6%82%E4%BD%95%E5%88%A9%E7%94%A8wrk%E4%B8%8EJmeter%E5%81%9A%E6%80%A7%E8%83%BD%E5%8E%8B%E6%B5%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/vernonchen.jpg">
      <meta itemprop="name" content="Vernon">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简栈文化">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | 简栈文化">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/10/23/2021/10/%E5%A6%82%E4%BD%95%E5%88%A9%E7%94%A8wrk%E4%B8%8EJmeter%E5%81%9A%E6%80%A7%E8%83%BD%E5%8E%8B%E6%B5%8B/" class="post-title-link" itemprop="url">如何利用wrk与Jmeter做性能压测</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-10-23 00:00:00" itemprop="dateCreated datePublished" datetime="2021-10-23T00:00:00+08:00">2021-10-23</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-06-25 10:05:09" itemprop="dateModified" datetime="2025-06-25T10:05:09+08:00">2025-06-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%80%A7%E8%83%BD%E5%8E%8B%E6%B5%8B/" itemprop="url" rel="index"><span itemprop="name">性能压测</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>我们在新做项目的时候，需要对我们的服务有有一些性能指标，比如：<code>SLA</code>（需要达到多少个9）、<code>QPS</code>、<code>TPS</code>等。因为这些量化的数字让我们更加的了解我们的系统。</p>
<p>我们如何压测？其实个人觉得有2种场景。</p>
<p><strong>第一种</strong>：是我们明确的知道目标，看我们通过大量的并发看我们是否有达到。如果没有达到，我们需要通过水平扩容、性能优化等让其达到。</p>
<p><strong>第二种</strong>：是我们不知道目标，通过压测可以知道一个固定配置下的单机单服务的最大性能，让我们对它有一个彻底的认识。为后面的目标做更多的铺垫与准备，或者跟行业水平对比，看看差距有多少。</p>
<h4 id="如何用wrk进行压测？"><a href="#如何用wrk进行压测？" class="headerlink" title="如何用wrk进行压测？"></a>如何用wrk进行压测？</h4><p>Github地址:<a target="_blank" rel="noopener" href="https://github.com/wg/wrk%EF%BC%8C%E8%AF%A5%E9%A1%B9%E7%9B%AE%E4%B9%9F%E6%98%AF%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE%EF%BC%8C%E5%85%B3%E6%B3%A8%E7%9A%84%E4%BA%BA%E8%BF%98%E4%B8%8D%E5%B0%91%EF%BC%8C%E6%9C%8930.4K%E3%80%82%E5%92%A8%E8%AF%A2%E4%BA%86%E4%B8%80%E4%B8%8B%E8%BA%AB%E8%BE%B9%E7%9A%84%E5%90%8C%E4%BA%8B%EF%BC%8C%E4%BD%BF%E7%94%A8%E5%AE%83%E7%9A%84%E4%BA%BA%E8%BF%98%E4%B8%8D%E5%B0%91%E3%80%82%E4%B8%BB%E8%A6%81%E7%9A%84%E8%AF%AD%E8%A8%80%E7%9A%84%E6%98%AFC%E8%AF%AD%E8%A8%80%E3%80%82">https://github.com/wg/wrk，该项目也是开源项目，关注的人还不少，有30.4K。咨询了一下身边的同事，使用它的人还不少。主要的语言的是C语言。</a></p>
<p><img src="http://static.cyblogs.com/Jietu20211023-153923.jpg" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;Jietu20211023-153923.jpg"></p>
<h5 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/wg/wrk</span><br><span class="line"></span><br><span class="line">make</span><br><span class="line"></span><br><span class="line">-- 拷贝wrk到bin</span><br><span class="line">cp wrk /usr/sbin/wrk</span><br></pre></td></tr></table></figure>

<h5 id="压测脚本"><a href="#压测脚本" class="headerlink" title="压测脚本"></a>压测脚本</h5><p><strong>压测脚本press.sh</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">bf=0i</span><br><span class="line">rm ./report_mock.$&#123;1&#125;.txt 2&gt; /dev/null</span><br><span class="line">for k in 10; do</span><br><span class="line">    bf=`expr $&#123;k&#125; \* 100`</span><br><span class="line">    for len in 512k; do</span><br><span class="line">        echo &quot;start length $&#123;len&#125;&quot; &gt;&gt; ./report_mock.$&#123;1&#125;.txt</span><br><span class="line">        ./wrk  -c$&#123;bf&#125; -t16 -d3m --timeout 2m --latency -s ./post_$&#123;len&#125;.lua http://$&#123;1&#125;/press/$&#123;len&#125; &gt;&gt; ./report_mock.$&#123;1&#125;.txt</span><br><span class="line">        echo &quot;----------------------------------------------------&quot; &gt;&gt; ./report_mock.$&#123;1&#125;.txt</span><br><span class="line">    done</span><br><span class="line">    sleep 10</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<p><strong>Lua脚本post_512.lua</strong></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wrk.method = <span class="string">&quot;POST&quot;</span></span><br><span class="line">wrk.body = <span class="string">&#x27;&#123;&quot;key&quot;:&quot;value&quot;&#125;&#x27;</span></span><br><span class="line">wrk.headers[<span class="string">&quot;Content-Type&quot;</span>] = <span class="string">&quot;application/json&quot;</span></span><br><span class="line">wrk.headers[<span class="string">&quot;X-Forwarded-For&quot;</span>] = <span class="string">&quot;6.6.6.6&quot;</span></span><br></pre></td></tr></table></figure>

<p>这里是一个通用脚本，大致的含义是：</p>
<ul>
<li>删除掉原来生成的文件</li>
<li>循环10次，其实也就是从并发数从100~1000依次进行压测</li>
<li>返回的报文大小控制在512K，这个可以为根据你的Request去匹配你的Response。</li>
<li>-t16：启动16个线程</li>
<li>-d3m：也测时间是3mins</li>
<li>–timeout：2m  超时时间是2mins  </li>
<li>post_${len}.lua：就是构造512K返回的Request参数对应的lua脚本</li>
<li>report_mock.${1}.txt：结果会append到该文件中去</li>
<li>${1}：就是你要向哪个服务器发起请求的host+port</li>
</ul>
<p>总结一下，这些时间需要根据自己的服务器性能去调整，有可能压测出来的数据就是空的，因为超时了未返回Response。</p>
<h5 id="参数解析"><a href="#参数解析" class="headerlink" title="参数解析"></a>参数解析</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">使用方法: wrk &lt;选项&gt; &lt;被测HTTP服务的URL&gt;                            </span><br><span class="line">  Options:                                            </span><br><span class="line">    -c, --connections &lt;N&gt;  跟服务器建立并保持的TCP连接数量  </span><br><span class="line">    -d, --duration    &lt;T&gt;  压测时间           </span><br><span class="line">    -t, --threads     &lt;N&gt;  使用多少个线程进行压测   </span><br><span class="line">                                                      </span><br><span class="line">    -s, --script      &lt;S&gt;  指定Lua脚本路径       </span><br><span class="line">    -H, --header      &lt;H&gt;  为每一个HTTP请求添加HTTP头      </span><br><span class="line">        --latency          在压测结束后，打印延迟统计信息   </span><br><span class="line">        --timeout     &lt;T&gt;  超时时间     </span><br><span class="line">    -v, --version          打印正在使用的wrk的详细版本信息</span><br><span class="line">                                                      </span><br><span class="line">  &lt;N&gt;代表数字参数，支持国际单位 (1k, 1M, 1G)</span><br><span class="line">  &lt;T&gt;代表时间参数，支持时间单位 (2s, 2m, 2h)</span><br></pre></td></tr></table></figure>

<h5 id="执行的结果"><a href="#执行的结果" class="headerlink" title="执行的结果"></a>执行的结果</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">start length 512k</span><br><span class="line">Running 3m test @ http://&#123;ip+port&#125;/press/512k # &#123;ip+port&#125;是你自己的</span><br><span class="line">  16 threads and 1000 connections</span><br><span class="line">  Thread Stats   Avg      Stdev     Max   +/- Stdev</span><br><span class="line">    Latency   145.17ms  942.97ms   0.86m    98.34%</span><br><span class="line">    Req/Sec     1.39k   114.27     3.58k    70.07%</span><br><span class="line">  Latency Distribution</span><br><span class="line">     50%   36.58ms</span><br><span class="line">     75%   48.78ms</span><br><span class="line">     90%  185.51ms</span><br><span class="line">     99%    1.78s </span><br><span class="line">  3994727 requests in 3.00m, 65.25GB read</span><br><span class="line">  Non-2xx or 3xx responses: 3863495</span><br><span class="line">Requests/sec:  22181.33</span><br><span class="line">Transfer/sec:    371.00MB</span><br></pre></td></tr></table></figure>

<p>会给一个分布非常的好：50%、75%、90%、99%。</p>
<p>但是如果说这么看大量的数据不够直观，这里再提供一个一个python脚本来解析里面的值。使其能把这些日志的重要的信息提取出来：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> math</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ms</span>(<span class="params">fr</span>):</span><br><span class="line">    fr = fr.lower()</span><br><span class="line">    <span class="keyword">if</span> fr[-<span class="number">2</span>:] == <span class="string">&#x27;ms&#x27;</span>:</span><br><span class="line">        to = <span class="built_in">float</span>(fr[:-<span class="number">2</span>])</span><br><span class="line">    <span class="keyword">elif</span> fr[-<span class="number">1</span>:] == <span class="string">&#x27;s&#x27;</span>:</span><br><span class="line">        to = <span class="built_in">float</span>(fr[:-<span class="number">1</span>]) * <span class="number">1000</span></span><br><span class="line">    <span class="keyword">elif</span> fr[-<span class="number">1</span>] == <span class="string">&#x27;m&#x27;</span>:</span><br><span class="line">        to = <span class="built_in">float</span>(fr[:-<span class="number">1</span>]) * <span class="number">1000</span> * <span class="number">60</span></span><br><span class="line">    <span class="keyword">return</span> to</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">mb</span>(<span class="params">fr</span>):</span><br><span class="line">    fr = fr.lower()</span><br><span class="line">    <span class="keyword">if</span> fr[-<span class="number">2</span>:] == <span class="string">&#x27;gb&#x27;</span>:</span><br><span class="line">        to = <span class="built_in">float</span>(fr[:-<span class="number">2</span>]) * <span class="number">1000</span></span><br><span class="line">    <span class="keyword">elif</span> fr[-<span class="number">2</span>:] == <span class="string">&#x27;mb&#x27;</span>:</span><br><span class="line">        to = <span class="built_in">float</span>(fr[:-<span class="number">2</span>])</span><br><span class="line">    <span class="keyword">elif</span> fr[-<span class="number">2</span>:] == <span class="string">&#x27;kb&#x27;</span>:</span><br><span class="line">        to = <span class="built_in">float</span>(fr[:-<span class="number">2</span>]) / <span class="number">1000</span></span><br><span class="line">    <span class="keyword">elif</span> fr[-<span class="number">1</span>] == <span class="string">&#x27;b&#x27;</span>:</span><br><span class="line">        to = <span class="built_in">float</span>(fr[:-<span class="number">1</span>]) / <span class="number">1000</span> / <span class="number">1000</span></span><br><span class="line">    <span class="keyword">elif</span> fr[-<span class="number">1</span>] == <span class="string">&#x27;k&#x27;</span>:</span><br><span class="line">        to = <span class="built_in">float</span>(fr[:-<span class="number">1</span>]) / <span class="number">1000</span></span><br><span class="line">    <span class="keyword">elif</span> fr[-<span class="number">1</span>] == <span class="string">&#x27;m&#x27;</span>:</span><br><span class="line">        to = <span class="built_in">float</span>(fr[:-<span class="number">1</span>])</span><br><span class="line">    <span class="keyword">return</span> to</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parse_one</span>(<span class="params">one</span>):</span><br><span class="line">    ret = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> l <span class="keyword">in</span> one.split(<span class="string">&#x27;\n&#x27;</span>):</span><br><span class="line">        <span class="keyword">if</span> l.find(<span class="string">&#x27;test @ http://&#x27;</span>) &gt; <span class="number">0</span>:</span><br><span class="line">            ret[<span class="string">&#x27;host&#x27;</span>] = l.split(<span class="string">&#x27;://&#x27;</span>)[<span class="number">1</span>].split(<span class="string">&#x27;/&#x27;</span>)[<span class="number">0</span>].strip()</span><br><span class="line">        <span class="keyword">elif</span> l.find(<span class="string">&#x27;start length&#x27;</span>) == <span class="number">0</span>:</span><br><span class="line">            ret[<span class="string">&#x27;size&#x27;</span>] = l.split(<span class="string">&#x27; &#x27;</span>)[-<span class="number">1</span>].strip()</span><br><span class="line">        <span class="keyword">elif</span> l.find(<span class="string">&#x27;threads and&#x27;</span>) &gt; <span class="number">0</span>:</span><br><span class="line">            ret[<span class="string">&#x27;threads&#x27;</span>] = <span class="built_in">int</span>(l.split(<span class="string">&#x27;threads and&#x27;</span>)[<span class="number">0</span>].strip())</span><br><span class="line">            ret[<span class="string">&#x27;conns&#x27;</span>] = <span class="built_in">int</span>(l.split(<span class="string">&#x27;threads and&#x27;</span>)[<span class="number">1</span>].split(<span class="string">&#x27;connections&#x27;</span>)[<span class="number">0</span>].strip())</span><br><span class="line">        <span class="keyword">elif</span> l.find(<span class="string">&#x27;    Latency&#x27;</span>) == <span class="number">0</span>:</span><br><span class="line">            ret[<span class="string">&#x27;l_avg&#x27;</span>] = ms(l[<span class="built_in">len</span>(<span class="string">&#x27;    Latency&#x27;</span>):].lstrip().split(<span class="string">&#x27; &#x27;</span>)[<span class="number">0</span>])</span><br><span class="line">        <span class="keyword">elif</span> l.find(<span class="string">&#x27;     50%&#x27;</span>) == <span class="number">0</span>:</span><br><span class="line">            ret[<span class="string">&#x27;l_50&#x27;</span>] = ms(l[<span class="built_in">len</span>(<span class="string">&#x27;     50%&#x27;</span>):].strip())</span><br><span class="line">        <span class="keyword">elif</span> l.find(<span class="string">&#x27;     90%&#x27;</span>) == <span class="number">0</span>:</span><br><span class="line">            ret[<span class="string">&#x27;l_90&#x27;</span>] = ms(l[<span class="built_in">len</span>(<span class="string">&#x27;     90%&#x27;</span>):].strip())</span><br><span class="line">        <span class="keyword">elif</span> l.find(<span class="string">&#x27;     99%&#x27;</span>) == <span class="number">0</span>:</span><br><span class="line">            ret[<span class="string">&#x27;l_99&#x27;</span>] = ms(l[<span class="built_in">len</span>(<span class="string">&#x27;     99%&#x27;</span>):].strip())</span><br><span class="line">        <span class="keyword">elif</span> l.find(<span class="string">&#x27;Requests/sec:&#x27;</span>) == <span class="number">0</span>:</span><br><span class="line">            ret[<span class="string">&#x27;qps&#x27;</span>] = <span class="built_in">float</span>(l[<span class="built_in">len</span>(<span class="string">&#x27;Requests/sec:&#x27;</span>):].strip())</span><br><span class="line">        <span class="keyword">elif</span> l.find(<span class="string">&#x27;Transfer/sec:&#x27;</span>) == <span class="number">0</span>:</span><br><span class="line">            ret[<span class="string">&#x27;mbps&#x27;</span>] = mb(l[<span class="built_in">len</span>(<span class="string">&#x27;Transfer/sec:&#x27;</span>):].strip())</span><br><span class="line">    <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;/Users/chenyuan/Desktop/report_mock.127.0.0.1.txt&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="built_in">all</span> = f.read().strip()</span><br><span class="line">    out = []</span><br><span class="line">    <span class="keyword">for</span> one <span class="keyword">in</span> <span class="built_in">all</span>.split(<span class="string">&#x27;----------------------------------------------------\n&#x27;</span>):</span><br><span class="line">        r = parse_one(one)</span><br><span class="line">        out.append((r[<span class="string">&#x27;host&#x27;</span>], r[<span class="string">&#x27;size&#x27;</span>], r[<span class="string">&#x27;conns&#x27;</span>], r[<span class="string">&#x27;l_avg&#x27;</span>], r[<span class="string">&#x27;l_50&#x27;</span>], r[<span class="string">&#x27;l_90&#x27;</span>], r[<span class="string">&#x27;l_99&#x27;</span>], r[<span class="string">&#x27;qps&#x27;</span>], r[<span class="string">&#x27;mbps&#x27;</span>]))</span><br><span class="line">    out.sort()</span><br><span class="line">    <span class="keyword">for</span> o <span class="keyword">in</span> out:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;\t&#x27;</span>.join([<span class="built_in">str</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> o]))</span><br></pre></td></tr></table></figure>

<p>最终你可以再在文本里面利用列操作的方式，将内容归整到Excel中去。你就可以很好的汇报与分享给他人了~</p>
<p><img src="http://static.cyblogs.com/Jietu20211023-160325.jpg" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;Jietu20211023-160325.jpg"></p>
<h4 id="如何利用Jmeter进行压测？"><a href="#如何利用Jmeter进行压测？" class="headerlink" title="如何利用Jmeter进行压测？"></a>如何利用Jmeter进行压测？</h4><h5 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h5><p>Apache JMeter是Apache组织开发的基于Java的压力测试工具。用于对软件做压力测试，它最初被设计用于Web应用测试，但后来扩展到其他测试领域。 它可以用于测试静态和动态资源，例如静态文件、Java 小服务程序、CGI 脚本、Java 对象、数据库、FTP 服务器， 等等。JMeter 可以用于对服务器、网络或对象模拟巨大的负载，来自不同压力类别下测试它们的强度和分析整体性能。另外，JMeter能够对应用程序做功能&#x2F;回归测试，通过创建带有断言的脚本来验证你的程序返回了你期望的结果。为了最大限度的灵活性，JMeter允许使用正则表达式创建断言。</p>
<p>Apache jmeter 可以用于对静态的和动态的资源（文件，Servlet，Perl脚本，java 对象，数据库和查询，FTP服务器等等）的性能进行测试。它可以用于对服务器、网络或对象模拟繁重的负载来测试它们的强度或分析不同压力类型下的整体性能。你可以使用它做性能的图形分析或在大并发负载测试你的服务器&#x2F;脚本&#x2F;对象。</p>
<p>Jmeter也是在进行压测中使用场景很多的软件，图形界面操作起来非常的友好。简单的写一个Demo流程出来。</p>
<h5 id="下载安装"><a href="#下载安装" class="headerlink" title="下载安装"></a>下载安装</h5><p>官网：<a target="_blank" rel="noopener" href="http://jmeter.apache.org/download_jmeter.cgi">http://jmeter.apache.org/download_jmeter.cgi</a> </p>
<p><img src="http://static.cyblogs.com/Jietu20211023-160918.jpg" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;Jietu20211023-160918.jpg"></p>
<p>下载解压完毕后大概的一个目录结构，可以把bin配置到path中就可以直接通过jmeter密令激活软件了。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">➜  jmeter pwd</span><br><span class="line">/Users/chenyuan/Tools/jmeter</span><br><span class="line">➜  jmeter ll</span><br><span class="line">total 64</span><br><span class="line">-rw-rw-r--@   1 chenyuan  staff    15K  1  2  1970 LICENSE</span><br><span class="line">-rw-rw-r--@   1 chenyuan  staff   167B  1  2  1970 NOTICE</span><br><span class="line">-rw-rw-r--@   1 chenyuan  staff   9.6K  1  2  1970 README.md</span><br><span class="line">drwxrwxr-x@  43 chenyuan  staff   1.3K  1  2  1970 bin</span><br><span class="line">drwxr-xr-x@   6 chenyuan  staff   192B  1  2  1970 docs</span><br><span class="line">drwxrwxr-x@  22 chenyuan  staff   704B  1  2  1970 extras</span><br><span class="line">drwxrwxr-x@ 104 chenyuan  staff   3.3K  1  2  1970 lib</span><br><span class="line">drwxrwxr-x@ 104 chenyuan  staff   3.3K  1  2  1970 licenses</span><br><span class="line">drwxr-xr-x@  19 chenyuan  staff   608B  1  2  1970 printable_docs</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">我这里直接运行，最好配置PATH，后续更加的方便</span></span><br><span class="line">➜  jmeter ./bin/jmeter</span><br><span class="line">================================================================================</span><br><span class="line">Don&#x27;t use GUI mode for load testing !, only for Test creation and Test debugging.</span><br><span class="line">For load testing, use CLI Mode (was NON GUI):</span><br><span class="line">   jmeter -n -t [jmx file] -l [results file] -e -o [Path to web report folder]</span><br><span class="line">&amp; increase Java Heap to meet your test requirements:</span><br><span class="line">   Modify current env variable HEAP=&quot;-Xms1g -Xmx1g -XX:MaxMetaspaceSize=256m&quot; in the jmeter batch file</span><br><span class="line">Check : https://jmeter.apache.org/usermanual/best-practices.html</span><br><span class="line">================================================================================</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">就这代表已经启动了，运行期间不要终端命令框。</span></span><br></pre></td></tr></table></figure>

<h5 id="创建测试"><a href="#创建测试" class="headerlink" title="创建测试"></a>创建测试</h5><p>先看一张整体的图吧，对它有一个比较整体的认识：</p>
<p><img src="http://static.cyblogs.com/Jietu20211023-161956.jpg" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;Jietu20211023-161956.jpg"></p>
<p>我们可以按照<a target="_blank" rel="noopener" href="https://www.cnblogs.com/stulzq/p/8971531.html">https://www.cnblogs.com/stulzq/p/8971531.html</a> 的步骤一步的去做。我这里就不做太多重复的介绍。因为相对比wrk来的简单。</p>
<p>最后可以点击运行来跑单测，一般我们会调整线程数的大小、发送的频率来进行压测看结果。</p>
<p><img src="http://static.cyblogs.com/Jietu20211023-162302.jpg" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;Jietu20211023-162302.jpg"></p>
<p>我们在断言的地方是可以做很多的事情的，因为什么样的结果是正确的，什么样的结果是失败的。获取需要从Response中、Header里截取一些关键的key与value来做逻辑。这些可以通过编写脚本来去做到，那就算相对高阶一点的操作了。后续可以继续深入一下~ </p>
<p>最后可以在汇总报告里可以看出来我们的一个性能情况，SLA的比例等。</p>
<p>作为一名后端开发，对自己写出来的服务进行一个非常全面的性能压测是很有必要的。对于系统的一个QPS、TPS、SLA这些数字应该随口就能说出来。哪些地方存在性能瓶颈？然后再去找相应的方案去优化掉。很多时候，性能可能就会是一个最大的风险，它会导致我们的服务整体的瘫痪、不可用。这些很有可能就跟我们的KPI、奖金挂钩~</p>
<h4 id="参考地址"><a href="#参考地址" class="headerlink" title="参考地址"></a>参考地址</h4><ul>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/aa76ffd6d894">https://www.jianshu.com/p/aa76ffd6d894</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/stulzq/p/8971531.html">https://www.cnblogs.com/stulzq/p/8971531.html</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.cyblogs.com/2021/10/15/2021/10/%E3%80%90go%E5%AD%A6%E4%B9%A0%E3%80%91%E5%9C%B0%E5%9D%80%E7%AC%A6&%E4%B8%8E%E6%8C%87%E9%92%88*%E7%9A%84%E5%B7%AE%E5%88%AB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/vernonchen.jpg">
      <meta itemprop="name" content="Vernon">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简栈文化">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | 简栈文化">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/10/15/2021/10/%E3%80%90go%E5%AD%A6%E4%B9%A0%E3%80%91%E5%9C%B0%E5%9D%80%E7%AC%A6&%E4%B8%8E%E6%8C%87%E9%92%88*%E7%9A%84%E5%B7%AE%E5%88%AB/" class="post-title-link" itemprop="url">【go学习】地址符&与指针*的差别</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-10-15 00:00:00" itemprop="dateCreated datePublished" datetime="2021-10-15T00:00:00+08:00">2021-10-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-06-25 10:05:09" itemprop="dateModified" datetime="2025-06-25T10:05:09+08:00">2025-06-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Go/" itemprop="url" rel="index"><span itemprop="name">Go</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h4><p>项目中开始用<code>Go</code>，最近写了一下<code>Demo</code>，发现语法还是非常好用，大部分比<code>Java</code>还是简洁很多，也有一些很细节的约定。比如：</p>
<ul>
<li>字母大小写控制是全包还是本包内访问</li>
<li>变量定义了就一定要使用，否则就会编译不通过等等</li>
</ul>
<p>更好的就是方法可以返回多个值，这个跟<code>Java</code>比较就是减少很多的封装。因为<code>Go</code>的线程模型特点，用来写一些需要高并发、高性能的项目还是非常好的。所以，趁这个机会也好好的深入了解下。现在也是把<code>Python</code>、<code>PHP</code>、<code>Go</code>等都学习一遍，每种语言都有它的优缺点，其实都还挺不错的。</p>
<p>针对于<code>Go</code>语言里：<code>&amp;</code>与<code>*</code>的区别，什么时候该用什么做一个总结。</p>
<h4 id="指针"><a href="#指针" class="headerlink" title="指针"></a>指针</h4><p>我们经常会听到别人说<code>Go</code>是值传递，某某某是引用传递，某某某是指针传递，等等各种各样的说法。</p>
<p>那么首先他们的区别是什么呢？什么是指针？指针其实也是一个变量，只不过这个变量里面存的不是<code>int</code>，<code>float</code>，<code>struct</code>，而是一个地址<code>address</code>，然后在这个<code>address</code>上所存储的数据可以通过指针来被阅读到。</p>
<p><code>OK</code>，指针变量存储的是一个地址，地址从哪里来的？那就得问一个变量的地址怎么取得呢？在变量前面加上一个&amp;符号就行。</p>
<p>好的，指针变量存储了这个地址了，那这个地址所存储的值怎么被阅读到呢？也就是指针所指向的值怎么拿到呢？在指针变量前面加上一个<code>*</code>符号就行。</p>
<p>怎么修改指针所指向的数据呢？在前面加上<code>*</code>符号之后再赋一个新的值就可以了。</p>
<p>我们来看一个栗子：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	a := <span class="string">&quot;vernonchen&quot;</span></span><br><span class="line">	b := &amp;a</span><br><span class="line"></span><br><span class="line">	fmt.Println(<span class="string">&quot;a的值&quot;</span>, a)</span><br><span class="line">	fmt.Println(<span class="string">&quot;a的地址&quot;</span>, b)</span><br><span class="line">	fmt.Println(<span class="string">&quot;b的值&quot;</span>, b)</span><br><span class="line">	fmt.Println(<span class="string">&quot;b的指针指向&quot;</span>, *b)</span><br><span class="line"></span><br><span class="line">	*b = <span class="string">&quot;not vernonchen&quot;</span></span><br><span class="line">	fmt.Println(<span class="string">&quot;修改后，b的指针指向&quot;</span>, *b)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行输出的结果是</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">a的值 vernonchen</span><br><span class="line">a的地址 0xc00008e1e0 // 使用的是b</span><br><span class="line">b的值 0xc00008e1e0</span><br><span class="line">b的指针指向 vernonchen //使用的是指针</span><br><span class="line">修改后，b的指针指向 not vernonchen // 重新指向新的值</span><br></pre></td></tr></table></figure>

<h4 id="指针的作用"><a href="#指针的作用" class="headerlink" title="指针的作用"></a>指针的作用</h4><p>为什么要有指针这个东西？它有什么关键性的作用呢？</p>
<p>我们来看下面这段代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">	userName <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">modify</span><span class="params">(user User)</span></span> &#123;</span><br><span class="line">	user.userName = <span class="string">&quot;vernonchen2222&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">modifyWithPoint</span><span class="params">(user *User)</span></span> &#123;</span><br><span class="line">	user.userName = <span class="string">&quot;vernonchen3333&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	user := User&#123;userName: <span class="string">&quot;vernonchen&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">	fmt.Println(<span class="string">&quot;userName = &quot;</span>, user.userName)</span><br><span class="line"></span><br><span class="line">	modify(user)</span><br><span class="line"></span><br><span class="line">	fmt.Println(<span class="string">&quot;userName = &quot;</span>, user.userName)</span><br><span class="line"></span><br><span class="line">	modifyWithPoint(&amp;user)</span><br><span class="line"></span><br><span class="line">	fmt.Println(<span class="string">&quot;userName = &quot;</span>, user.userName)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行完后，输出的结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">userName =  vernonchen</span><br><span class="line">userName =  vernonchen // 没有被替换</span><br><span class="line">userName =  vernonchen3333 // 被替换</span><br></pre></td></tr></table></figure>

<p>所以指针的作用:</p>
<ol>
<li><p>指针不但可以帮助函数内部修改外部变量的值，还可以帮助我们在任何地方修改其所指向数据的值；</p>
</li>
<li><p>传递指针参数可以节省拷贝大结构体的内存开销；</p>
</li>
</ol>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><ul>
<li>指针也是变量，只不过存储的是地址</li>
<li>通过指针可以去修改其指向数据的值</li>
<li>指针可以帮助我们在任何地方修改其所指向数据的值</li>
<li>传递指针参数可以节省拷贝大结构体的内存开销</li>
</ul>
<h4 id="参考地址"><a href="#参考地址" class="headerlink" title="参考地址"></a>参考地址</h4><ul>
<li><a target="_blank" rel="noopener" href="https://studygolang.com/articles/32103">https://studygolang.com/articles/32103</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.cyblogs.com/2021/09/15/2021/09/pt-online-schema-change%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/vernonchen.jpg">
      <meta itemprop="name" content="Vernon">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简栈文化">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | 简栈文化">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/09/15/2021/09/pt-online-schema-change%E4%BD%BF%E7%94%A8/" class="post-title-link" itemprop="url">pt-online-schema-change使用</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-09-15 00:00:00" itemprop="dateCreated datePublished" datetime="2021-09-15T00:00:00+08:00">2021-09-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-06-25 10:05:09" itemprop="dateModified" datetime="2025-06-25T10:05:09+08:00">2025-06-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">数据库</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h4><p>如果说你的数据量并发量不大，或者你的数据量很少没有到千万级别，也许<code>pt-osc</code>、<code>gh-osc</code>，online-ddl这些工具都用不着。但是，如果你的数据量很大，数据又很热。如果你没有这些工具，你可能无法完成对一个数据库新增一个字段或者任何一个简单的<code>DDL</code>语句。</p>
<p>简单的分析一下，为了保证数据一致性问题，我们在哪儿都会遇到锁的问题，锁是用来保证顺序性的。谁先拥有锁，谁就可以先执行。锁也会存在力度问题，它跟你要做的一件事情息息相关，我们也会在性能上去做取舍，所有就好了行锁、表锁等。</p>
<h4 id="Waiting-for-table-metadata-lock"><a href="#Waiting-for-table-metadata-lock" class="headerlink" title="Waiting for table metadata lock"></a>Waiting for table metadata lock</h4><p>说一下我遇到的这个场景，数据量数据大概在800W左右，但是表非常的热，长事务也很多。当我要对一个表新增字段的时候，这个时候如果你经验不够足，可能就会“量成大祸”。一般在做<code>DDL</code>会出现：Waiting for table metadata lock。</p>
<p>如果长时间获取不到锁的话，就出现一个可怕的情况：</p>
<ul>
<li>如果前面的事务未提交，当前是获取不到锁，就不可以执行<code>DDL</code>语句</li>
<li>在<code>DDL</code>语句未执行之前，后面的请求全部是被hold住的</li>
</ul>
<p>这样子就会导致一前一后同时夹击，导致整个业务不可用。那么出现Waiting for table metadata lock可能是由哪些原因导致的？</p>
<h6 id="场景一：长事物运行，阻塞DDL，继而阻塞所有同表的后续操作"><a href="#场景一：长事物运行，阻塞DDL，继而阻塞所有同表的后续操作" class="headerlink" title="场景一：长事物运行，阻塞DDL，继而阻塞所有同表的后续操作"></a>场景一：长事物运行，阻塞DDL，继而阻塞所有同表的后续操作</h6><p>通过<code>show processlist</code>可以看到<code>TableA</code>上有正在进行的操作（包括读），此时alter table语句无法获取到<code>metadata</code> 独占锁，会进行等待。</p>
<p>这是最基本的一种情形，这个和<code>mysql 5.6</code>中的<code>online ddl</code>并不冲突。一般<code>alter table</code>的操作过程中，在<code>after create</code>步骤会获取<code>metadata</code> 独占锁，当进行到<code>altering table</code>的过程时（通常是最花时间的步骤），对该表的读写都可以正常进行，这就是<code>online ddl</code>的表现，并不会像之前在整个<code>alter table</code>过程中阻塞写入。（当然，也并不是所有类型的alter操作都能online的，具体可以参见官方手册：<a target="_blank" rel="noopener" href="http://dev.mysql.com/doc/refman/5.6/en/innodb-create-index-overview.html%EF%BC%89">http://dev.mysql.com/doc/refman/5.6/en/innodb-create-index-overview.html）</a><br><strong>处理方法：</strong> kill 掉 DDL所在的session.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 找出所有执行时间超过 <span class="number">5</span> 分钟的线程，拼凑出 kill 语句，方便后面查杀</span><br><span class="line"><span class="keyword">select</span> concat(<span class="string">&#x27;kill &#x27;</span>, id, <span class="string">&#x27;;&#x27;</span>)</span><br><span class="line"><span class="keyword">from</span> information_schema.processlist</span><br><span class="line"><span class="keyword">where</span> Command <span class="operator">!=</span> <span class="string">&#x27;Sleep&#x27;</span> <span class="keyword">AND</span> COMMAND <span class="operator">!=</span> <span class="string">&#x27;Binlog Dump GTID&#x27;</span> <span class="keyword">AND</span> COMMAND <span class="operator">!=</span> <span class="string">&#x27;Binlog Dump&#x27;</span></span><br><span class="line">  <span class="keyword">and</span> <span class="type">Time</span> <span class="operator">&gt;</span> <span class="number">300</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> <span class="type">Time</span> <span class="keyword">desc</span>;</span><br></pre></td></tr></table></figure>

<h6 id="场景二：未提交事物，阻塞DDL，继而阻塞所有同表的后续操作"><a href="#场景二：未提交事物，阻塞DDL，继而阻塞所有同表的后续操作" class="headerlink" title="场景二：未提交事物，阻塞DDL，继而阻塞所有同表的后续操作"></a>场景二：未提交事物，阻塞DDL，继而阻塞所有同表的后续操作</h6><p>通过<code>show processlist</code>看不到<code>TableA</code>上有任何操作，但实际上存在有未提交的事务，可以在 <strong>information_schema.innodb_trx</strong>中查看到。在事务没有完成之前，TableA上的锁不会释放，<code>alter table</code>同样获取不到<code>metadata</code>的独占锁。</p>
<p>处理方法：通过 <code>select * from information_schema.innodb_trx\G</code>, 找到未提交事物的<code>sid</code>, 然后 <code>kill</code> 掉，让其回滚。</p>
<h6 id="场景三：显示事务失败未提交"><a href="#场景三：显示事务失败未提交" class="headerlink" title="场景三：显示事务失败未提交"></a>场景三：显示事务失败未提交</h6><p>通过<code>show processlist</code>看不到<code>TableA</code>上有任何操作，在<code>information_schema.innodb_trx</code>中也没有任何进行中的事务。这很可能是因为在一个显式的事务中，对<code>TableA</code>进行了一个失败的操作（比如查询了一个不存在的字段），这时事务没有开始，但是失败语句获取到的锁依然有效，没有释放。从<code>performance_schema.events_statements_current</code>表中可以查到失败的语句。</p>
<p>官方手册上对此的说明如下：</p>
<p>If the server acquires metadata locks for a statement that is syntactically valid but fails during execution, it does not release the locks early. Lock release is still deferred to the end of the transaction because the failed statement is written to the binary log and the locks protect log consistency.</p>
<p>也就是说除了语法错误，其他错误语句获取到的锁在这个事务提交或回滚之前，仍然不会释放掉。because the failed statement is written to the binary log and the locks protect log consistency 但是解释这一行为的原因很难理解，因为错误的语句根本不会被记录到二进制日志。</p>
<p>**处理方法：**通过performance_schema.events_statements_current找到其sid, kill 掉该session. 也可以 <code>kill</code> 掉<code>DDL</code>所在的<code>session</code>.</p>
<p>上述是手动操作，毕竟是一个比手速的过程，而且也不能保证保证100%，还需要经常的kill进程才行。</p>
<h4 id="gt-osc使用"><a href="#gt-osc使用" class="headerlink" title="gt-osc使用"></a>gt-osc使用</h4><p>请看参考地址，对于一些online ddl工具研究后，对gt-osc做了一个初步的使用。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pt-online-schema-change --host=xxx -uxxx -pxxx \</span><br><span class="line">--alter &quot;add xxx int(1) NOT NULL DEFAULT &#x27;0&#x27;  COMMENT &#x27;xxx&#x27;, add xxx varchar(10) NOT NULL DEFAULT &#x27;0&#x27;  COMMENT &#x27;xxx&#x27; , lock=none&quot;  D=xxx,t=&#x27;xxx&#x27; \</span><br><span class="line">--execute \</span><br><span class="line">--print \</span><br><span class="line">--statistics \</span><br><span class="line">--no-check-alter</span><br></pre></td></tr></table></figure>

<p>执行后其实它做了这些工作，具体如下：</p>
<ol>
<li>相关环境参数检查</li>
<li>检查该表格是否存在</li>
<li>show create table xxx</li>
<li>create table _xxx_new</li>
<li>alter table _xxx_new</li>
<li>创建删除触发器 pt_osc_db_table_name_del </li>
<li>创建更新触发器 pt_osc_db_table_name_upd</li>
<li>创建插入触发器 pt_osc_db_table_name_ins</li>
<li>按块拷贝数据到新表，拷贝过程对数据行持有S锁</li>
<li>analyze 新表</li>
<li>rename 表名，RENAME TABLE <code>db</code>.<code>table_name</code> TO <code>db</code>.<code>_table_name_old</code>, <code>db</code>.<code>_table_name_new</code> TO <code>db</code>.<code>table_name</code></li>
<li>删除旧表</li>
<li>删除新表上的删除、更新、插入 触发器</li>
</ol>
<p>可以去看一下网站的说明：<a target="_blank" rel="noopener" href="https://www.percona.com/blog/2019/06/07/how-pt-online-schema-change-handles-foreign-keys/">https://www.percona.com/blog/2019/06/07/how-pt-online-schema-change-handles-foreign-keys/</a></p>
<p><img src="http://static.cyblogs.com/Jietu20211018-000822.jpg" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;Jietu20211018-000822.jpg"></p>
<h4 id="参考地址"><a href="#参考地址" class="headerlink" title="参考地址"></a>参考地址</h4><ul>
<li><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1500170">https://cloud.tencent.com/developer/article/1500170</a></li>
<li><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1508051">https://cloud.tencent.com/developer/article/1508051</a></li>
<li><a target="_blank" rel="noopener" href="https://huangzhw.github.io/2018/09/20/mysql-online-ddl/#%E5%B0%8F%E7%BB%93">https://huangzhw.github.io/2018/09/20/mysql-online-ddl/#%E5%B0%8F%E7%BB%93</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/digdeep/p/4892953.html">https://www.cnblogs.com/digdeep/p/4892953.html</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.cyblogs.com/2021/04/15/2021/04/%E6%89%B9%E9%87%8F%E6%93%8D%E4%BD%9C%E8%84%9A%E6%9C%AC%E8%AE%A9%E4%BD%A05mins%E6%90%9E%E5%AE%9A%E5%8F%91%E7%89%88/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/vernonchen.jpg">
      <meta itemprop="name" content="Vernon">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简栈文化">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | 简栈文化">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/04/15/2021/04/%E6%89%B9%E9%87%8F%E6%93%8D%E4%BD%9C%E8%84%9A%E6%9C%AC%E8%AE%A9%E4%BD%A05mins%E6%90%9E%E5%AE%9A%E5%8F%91%E7%89%88/" class="post-title-link" itemprop="url">批量操作脚本让你5mins搞定发版</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-04-15 00:00:00" itemprop="dateCreated datePublished" datetime="2021-04-15T00:00:00+08:00">2021-04-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-06-25 10:05:09" itemprop="dateModified" datetime="2025-06-25T10:05:09+08:00">2025-06-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Git/" itemprop="url" rel="index"><span itemprop="name">Git</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="代码分支管理"><a href="#代码分支管理" class="headerlink" title="代码分支管理"></a>代码分支管理</h4><p>大家在做微服务拆分后，难免会导致<code>Application</code>项目以及一些二房包的数量加剧，<code>10+</code>个项目我想应该是很容易的超过。然后这些细粒度的拆分后就会导致发布版本时候的麻烦。</p>
<p>展示一下现阶段我们的一个<code>git</code>的分支流程图，仅供参考。</p>
<p><img src="http://static.cyblogs.com/git_flow_publish_20210415.jpg" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;git_flow_publish_20210415.jpg"></p>
<p>简单说明一下：</p>
<ul>
<li><code>dev</code>环境每次都是从<code>master</code>拉取一个分支，取名为<code>dev-&#123;发布日期&#125;-&#123;sequenceId&#125;</code>，<code>sequenceId</code>从<code>01</code>开始叠加，避免一个版本需要反复拉取多次。</li>
<li>到了<code>test</code>阶段，也是为了收敛（前期严格一点）。提测的时候代码需要合并到<code>test</code>分支来。</li>
<li>到<code>UAT</code>阶段，还是需要从<code>master</code>拉取分支，如果出现要重新拉取分支的情况下，还是严格拉取<code>master</code>分支的代码。主要是为了与<code>master</code>保持一致，避免把别人的覆盖掉。取名为<code>release-&#123;发布日期&#125;-&#123;sequenceId&#125;</code>，规则同上。</li>
<li>上生产后，验证完毕后需要把代码合并到<code>master</code>分支，并且打包<code>tag</code>。</li>
</ul>
<p>但是在这个过程中，需要有拉取新分支，合并分支，批量删除分支，打<code>tag</code>等等繁琐的操作，项目一多如果有一个批量脚本就更好了。下面我就列举一些平时使用最多的几个，仅供参考：</p>
<h4 id="批量脚本"><a href="#批量脚本" class="headerlink" title="批量脚本"></a>批量脚本</h4><h5 id="01-批量拉取新分支"><a href="#01-批量拉取新分支" class="headerlink" title="01-批量拉取新分支"></a>01-批量拉取新分支</h5><p>比如一个新的迭代要开始了，就需要从<code>master</code>拉取<code>dev</code>分支。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">! /bin/bash</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">目录空间</span></span><br><span class="line">HOME_DIR=&quot;/Users/chenyuan&quot;</span><br><span class="line">WORK_DIR=$HOME_DIR&quot;/Workspaces/xxx&quot; // 替换为你的工作目录</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">过滤目录</span></span><br><span class="line">EXCLUDE_DIR_OR_FILE=(&quot;cr-test-demo&quot; &quot;git_batch_co_brach.sh&quot; &quot;git_batch_co_push_remote.sh&quot; &quot;git_batch_co_merge_push_remote.sh&quot;)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">分支名字</span></span><br><span class="line">OLD_BR_NAME=&quot;$1&quot;</span><br><span class="line">NEW_BR_NAME=&quot;$2&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">校验参数</span></span><br><span class="line">if [ -f $OLD_BR_NAME ]; then</span><br><span class="line">    echo &quot;Please input your old branch name.&quot;</span><br><span class="line">    exit 0</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">if [ -f $NEW_BR_NAME ]; then</span><br><span class="line">    echo &quot;Please input your new branch name.&quot;</span><br><span class="line">    exit 0</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">切换到某个分支</span></span><br><span class="line">function gitCheckoutBrachAndPushRemote() &#123;</span><br><span class="line">    echo &quot;-------- $1 --------&quot;</span><br><span class="line">    cd &quot;$1&quot;</span><br><span class="line">    pwd</span><br><span class="line">    git checkout $OLD_BR_NAME</span><br><span class="line">	git fetch</span><br><span class="line">	git pull</span><br><span class="line">	git checkout -b $NEW_BR_NAME $OLD_BR_NAME</span><br><span class="line">	git push --set-upstream origin $NEW_BR_NAME</span><br><span class="line">	echo &quot;success push branch &quot; $NEW_BR_NAME &quot; to remote&quot;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># get all folder in &quot;$WORK_DIR&quot;</span></span></span><br><span class="line">for i in `ls &quot;$WORK_DIR&quot;`;do</span><br><span class="line">    cd &quot;$WORK_DIR&quot;</span><br><span class="line">    if [[ -d $i ]] &amp;&amp; [[ ! &quot;$&#123;EXCLUDE_DIR_OR_FILE[@]&#125;&quot;  =~ &quot;$&#123;i&#125;&quot; ]];then</span><br><span class="line">        gitCheckoutBrachAndPushRemote &quot;$i&quot;</span><br><span class="line">    fi</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<p>具体使用，比如以<code>master</code>为基础拉取一个新分支</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./git_batch_co_push_remote.sh master dev-20210419-01</span><br></pre></td></tr></table></figure>

<h5 id="02-批量切换分支"><a href="#02-批量切换分支" class="headerlink" title="02-批量切换分支"></a>02-批量切换分支</h5><p>做不同的需求时候，需要来回的切换分支。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">! /bin/bash</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">目录空间</span></span><br><span class="line">HOME_DIR=&quot;/Users/chenyuan&quot;</span><br><span class="line">WORK_DIR=$HOME_DIR&quot;/Workspaces/xxx&quot; // 替换为你的工作目录</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">过滤目录</span></span><br><span class="line">EXCLUDE_DIR_OR_FILE=(&quot;cr-test-demo&quot; &quot;git_batch_co_brach.sh&quot; &quot;git_batch_co_push_remote.sh&quot; &quot;git_batch_co_merge_push_remote.sh&quot;)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">分支名字</span></span><br><span class="line">BR_NAME=&quot;$1&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">校验参数</span></span><br><span class="line">if [ -f $BR_NAME ]; then</span><br><span class="line">    echo &quot;Please input your branch name.&quot;</span><br><span class="line">    exit 0</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">切换到某个分支</span></span><br><span class="line">function gitCheckoutBrach() &#123;</span><br><span class="line">    cd &quot;$1&quot;</span><br><span class="line">    pwd</span><br><span class="line">    git fetch</span><br><span class="line">	git checkout $BR_NAME</span><br><span class="line">	echo &quot;success checkout to &quot; $BR_NAME</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># get all folder in &quot;$WORK_DIR&quot;</span></span></span><br><span class="line">for i in `ls &quot;$WORK_DIR&quot;`;do</span><br><span class="line">    cd &quot;$WORK_DIR&quot;</span><br><span class="line">    if [[ -d $i ]] &amp;&amp; [[ ! &quot;$&#123;EXCLUDE_DIR_OR_FILE[@]&#125;&quot;  =~ &quot;$&#123;i&#125;&quot; ]];then</span><br><span class="line">        gitCheckoutBrach &quot;$i&quot;</span><br><span class="line">    fi</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<p>具体的使用，先切换成<code>master</code>分支。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./git_batch_co_brach.sh dev-20210412-01 </span><br></pre></td></tr></table></figure>

<h5 id="03-批量删除远程分支"><a href="#03-批量删除远程分支" class="headerlink" title="03-批量删除远程分支"></a>03-批量删除远程分支</h5><p>有时候不小心写错了分支名字，或者分支太多，需要删除批量删除远程分支</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">! /bin/bash</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">目录空间</span></span><br><span class="line">HOME_DIR=&quot;/Users/chenyuan&quot;</span><br><span class="line">WORK_DIR=$HOME_DIR&quot;/Workspaces/xxx&quot; // 替换为你的工作目录</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">过滤目录</span></span><br><span class="line">EXCLUDE_DIR_OR_FILE=(&quot;cr-test-demo&quot; &quot;git_batch_co_brach.sh&quot; &quot;git_batch_co_push_remote.sh&quot; &quot;git_batch_co_merge_push_remote.sh&quot;)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">分支名字</span></span><br><span class="line">BR_NAME=&quot;$1&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">校验参数</span></span><br><span class="line">if [ -f $BR_NAME ]; then</span><br><span class="line">    echo &quot;Please input your branch name.&quot;</span><br><span class="line">    exit 0</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">切换到某个分支</span></span><br><span class="line">function doSomething() &#123;</span><br><span class="line">    cd &quot;$1&quot;</span><br><span class="line">    pwd</span><br><span class="line">    git fetch</span><br><span class="line">	git push origin --delete $BR_NAME</span><br><span class="line">	echo &quot;success delete remote branch: &quot; $BR_NAME</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># get all folder in &quot;$WORK_DIR&quot;</span></span></span><br><span class="line">for i in `ls &quot;$WORK_DIR&quot;`;do</span><br><span class="line">    cd &quot;$WORK_DIR&quot;</span><br><span class="line">    if [[ -d $i ]] &amp;&amp; [[ ! &quot;$&#123;EXCLUDE_DIR_OR_FILE[@]&#125;&quot;  =~ &quot;$&#123;i&#125;&quot; ]];then</span><br><span class="line">        doSomething &quot;$i&quot;</span><br><span class="line">    fi</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<p>具体的使用</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./git_batch_delete_remote.sh dev-20210412-01</span><br></pre></td></tr></table></figure>

<p>结果就是可以把远程分支<code>dev-20210412-01</code>一次性全部删除掉。</p>
<h5 id="04-批量合并分支代码"><a href="#04-批量合并分支代码" class="headerlink" title="04-批量合并分支代码"></a>04-批量合并分支代码</h5><p>从一个环境到另外也跟环境，就需要大量的<code>merge</code>操作。其实<code>Git</code>的<code>merge</code>操作比SVN的要好很多。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">! /bin/bash</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">目录空间</span></span><br><span class="line">HOME_DIR=&quot;/Users/chenyuan&quot;</span><br><span class="line">WORK_DIR=$HOME_DIR&quot;/Workspaces/xxx&quot; // 替换为你的工作目录</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">过滤目录</span></span><br><span class="line">EXCLUDE_DIR_OR_FILE=(&quot;cr-test-demo&quot; &quot;git_batch_co_brach.sh&quot; &quot;git_batch_co_push_remote.sh&quot; &quot;git_batch_co_merge_push_remote.sh&quot;)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">分支名字</span></span><br><span class="line">BR_NAME=&quot;$1&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">校验参数</span></span><br><span class="line">if [ -f $BR_NAME ]; then</span><br><span class="line">    echo &quot;Please input your branch name.&quot;</span><br><span class="line">    exit 0</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">切换到某个分支</span></span><br><span class="line">function gitCheckoutBrach() &#123;</span><br><span class="line">    cd &quot;$1&quot;</span><br><span class="line">    pwd</span><br><span class="line">    git merge $BR_NAME</span><br><span class="line">    git push</span><br><span class="line">    echo &quot;success merge from branch&quot; $BR_NAME &quot; and push remote&quot;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># get all folder in &quot;$WORK_DIR&quot;</span></span></span><br><span class="line">for i in `ls &quot;$WORK_DIR&quot;`;do</span><br><span class="line">    cd &quot;$WORK_DIR&quot;</span><br><span class="line">    if [[ -d $i ]] &amp;&amp; [[ ! &quot;$&#123;EXCLUDE_DIR_OR_FILE[@]&#125;&quot;  =~ &quot;$&#123;i&#125;&quot; ]];then</span><br><span class="line">        gitCheckoutBrach &quot;$i&quot;</span><br><span class="line">    fi</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<p>具体使用，记得要先更新相关的代码哦~ </p>
<p>比如是从<code>dev</code>合并到<code>test</code>，那么先更新对应的代码，然后<code>co</code>到test的目录去。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./git_batch_co_merge_push_remote.sh dev-20210412-01</span><br></pre></td></tr></table></figure>

<h5 id="05-批量给分支打tag"><a href="#05-批量给分支打tag" class="headerlink" title="05-批量给分支打tag"></a>05-批量给分支打tag</h5><p>比如我们的流程是在上生产后为master打一个新的tag</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">! /bin/bash</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">目录空间</span></span><br><span class="line">HOME_DIR=&quot;/Users/chenyuan&quot;</span><br><span class="line">WORK_DIR=$HOME_DIR&quot;/Workspaces/xxx&quot; // 替换为你的工作目录</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">过滤目录</span></span><br><span class="line">EXCLUDE_DIR_OR_FILE=(&quot;cr-test-demo&quot; &quot;git_batch_co_brach.sh&quot; &quot;git_batch_co_push_remote.sh&quot; &quot;git_batch_co_merge_push_remote.sh&quot;)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">分支名字</span></span><br><span class="line">TAG_NAME=$1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">校验参数</span></span><br><span class="line">if [ -f $TAG_NAME ]; then</span><br><span class="line">    echo &quot;Please input your tag name.&quot;</span><br><span class="line">    exit 0</span><br><span class="line">fi</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">切换到某个分支</span></span><br><span class="line">function doSomething() &#123;</span><br><span class="line">    cd &quot;$1&quot;</span><br><span class="line">    pwd</span><br><span class="line">    git fetch</span><br><span class="line">	git checkout master</span><br><span class="line">    git tag -a $TAG_NAME -m &quot;创建分支$TAG_NAME&quot;</span><br><span class="line">	echo &quot;success create tag &quot; $TAG_NAME</span><br><span class="line">    git push origin --tags</span><br><span class="line">    echo &quot;success push tag to remote&quot; $TAG_NAME</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># get all folder in &quot;$WORK_DIR&quot;</span></span></span><br><span class="line">for i in `ls &quot;$WORK_DIR&quot;`;do</span><br><span class="line">    cd &quot;$WORK_DIR&quot;</span><br><span class="line">    if [[ -d $i ]] &amp;&amp; [[ ! &quot;$&#123;EXCLUDE_DIR_OR_FILE[@]&#125;&quot;  =~ &quot;$&#123;i&#125;&quot; ]];then</span><br><span class="line">        doSomething &quot;$i&quot;</span><br><span class="line">    fi</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<p>具体使用，首先切换为<code>master</code>分支。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./git_batch_tag_push.sh v1.0.0</span><br></pre></td></tr></table></figure>

<h5 id="06-批量mvn打包"><a href="#06-批量mvn打包" class="headerlink" title="06-批量mvn打包"></a>06-批量mvn打包</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">! /bin/bash</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">目录空间</span></span><br><span class="line">HOME_DIR=&quot;/Users/chenyuan&quot;</span><br><span class="line">WORK_DIR=$HOME_DIR&quot;/Workspaces/xxx&quot; // 替换为你的工作目录</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">需要deploy的工程</span></span><br><span class="line">NEED_DEPLOY_DIR_OR_FILE=(&quot;xxxx&quot;) // 这里添加你要打包的项目名称，空格分开</span><br><span class="line"> </span><br><span class="line"><span class="meta prompt_"> </span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># get all folder in &quot;$WORK_DIR&quot;</span></span></span><br><span class="line">for i in &quot;$&#123;NEED_DEPLOY_DIR_OR_FILE[@]&#125;&quot;;do</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="built_in">cd</span> <span class="string">&quot;<span class="variable">$WORK_DIR</span>&quot;</span></span></span><br><span class="line">echo &quot;$WORK_DIR/$i&quot;;</span><br><span class="line">cd &quot;$WORK_DIR/$i&quot;;</span><br><span class="line">git pull</span><br><span class="line">mvn install deploy -Dpmd.skip=true -Dcheckstyle.skip=true -Dmaven.test.skip=true</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<p>具体使用</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./git_batch_deploy_snapshot.sh</span><br></pre></td></tr></table></figure>

<p>上面的这些脚本也是因为当时自己要发布版本，总共写脚本花费了<code>20~30mins</code>的时候，发布时间也才<code>30mins</code>。如果那天我不写这个脚本，业务我每次都要花费<code>60+mins</code>去做，而且其他不熟悉的人做发布的时候肯定会花费更多的时间。开发就应该把那些重复的事情标准化与产品化。能够真的做到可持续~ </p>
<h4 id="参考地址"><a href="#参考地址" class="headerlink" title="参考地址"></a>参考地址</h4><ul>
<li>推荐一本书《持续交付2.0》，地址：<a target="_blank" rel="noopener" href="https://item.jd.com/12512514.html">https://item.jd.com/12512514.html</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.cyblogs.com/2021/03/29/2021/03/0-1%E8%83%8C%E5%8C%85%E9%97%AE%E9%A2%98Knapsack%20Problem/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/vernonchen.jpg">
      <meta itemprop="name" content="Vernon">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简栈文化">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | 简栈文化">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/03/29/2021/03/0-1%E8%83%8C%E5%8C%85%E9%97%AE%E9%A2%98Knapsack%20Problem/" class="post-title-link" itemprop="url">0-1背包问题Knapsack Problem</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-03-29 00:00:00" itemprop="dateCreated datePublished" datetime="2021-03-29T00:00:00+08:00">2021-03-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-06-25 10:05:09" itemprop="dateModified" datetime="2025-06-25T10:05:09+08:00">2025-06-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%AE%97%E6%B3%95/" itemprop="url" rel="index"><span itemprop="name">算法</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>背包问题<code>(Knapsack Problem, KP)</code>是<code>NP</code>完全问题，也是一类重要 的组合优化问题 ，在工业 、经济 、通信、金融与计算机 等领域的资 源分配 、 资金预算 、 投资决策 、 装载问题 、 整数规划 、 分布式系统 与密码系统中具有重要的理论和应用价值。</p>
<p><strong>通俗说法</strong></p>
<p>贼，夜入豪宅，可偷之物甚多，而负重能力有限，偷哪些才更加不枉此行？</p>
<p><strong>抽象说法</strong></p>
<p>给定一组多个（<img src="https://www.zhihu.com/equation?tex=n" alt="[公式]">）物品，每种物品都有自己的重量（<img src="https://www.zhihu.com/equation?tex=w_i" alt="[公式]">）和价值（<img src="https://www.zhihu.com/equation?tex=v_i" alt="[公式]">），在限定的总重量&#x2F;总容量（<img src="https://www.zhihu.com/equation?tex=C" alt="[公式]">）内，选择其中若干个（也即每种物品可以选0个或1个），设计选择方案使得物品的总价值最高。</p>
<p><strong>更加抽象的说法</strong></p>
<p>给定正整数<img src="https://www.zhihu.com/equation?tex=%5C%7B(w_i,v_i)%5C%7D_%7B1%5Cleq+i%5Cleq+n%7D" alt="[公式]">、给定正整数<img src="https://www.zhihu.com/equation?tex=C" alt="[公式]">，求解0-1规划问题：</p>
<p><img src="https://www.zhihu.com/equation?tex=%5Cmax+%5Csum_%7Bi=1%7D%5E%7Bn%7D%7Bx_iv_i%7D" alt="[公式]"> ， s.t. <img src="https://www.zhihu.com/equation?tex=%5Csum_%7Bi=1%7D%5E%7Bn%7D%7Bx_iw_i%7D%5Cleq+C" alt="[公式]"> ， <img src="https://www.zhihu.com/equation?tex=x_i%5Cin%5C%7B0,1%5C%7D" alt="[公式]"> 。</p>
<h4 id="0-1背包问题的递推关系"><a href="#0-1背包问题的递推关系" class="headerlink" title="0-1背包问题的递推关系"></a>0-1背包问题的递推关系</h4><p>定义子问题 <img src="https://www.zhihu.com/equation?tex=%5Cmathbf%7B%5Ctext%7BP(i,+W)%7D%7D" alt="[公式]"> 为：在前 <img src="https://www.zhihu.com/equation?tex=i" alt="[公式]"> 个物品中挑选总重量不超过 <img src="https://www.zhihu.com/equation?tex=W" alt="[公式]"> 的物品，每种物品至多只能挑选1个，使得总价值最大；这时的最优值记作 <img src="https://www.zhihu.com/equation?tex=m(i,W)" alt="[公式]"> ，其中 <img src="https://www.zhihu.com/equation?tex=1%5Cleq+i%5Cleq+n" alt="[公式]"> ， <img src="https://www.zhihu.com/equation?tex=1%5Cleq+W%5Cleq+C" alt="[公式]"> 。</p>
<p>考虑第 <img src="https://www.zhihu.com/equation?tex=i" alt="[公式]"> 个物品，无外乎两种可能：选，或者不选。</p>
<ul>
<li>不选的话，背包的容量不变，改变为问题 <img src="https://www.zhihu.com/equation?tex=%5Cmathbf%7B%7BP(i-1,+W)%7D%7D" alt="[公式]"> ；</li>
<li>选的话，背包的容量变小，改变为问题 <img src="https://www.zhihu.com/equation?tex=%5Cmathbf%7B%7BP(i-1,+W-w_i)%7D%7D" alt="[公式]"> 。</li>
</ul>
<p>最优方案就是比较这两种方案，哪个会更好些：</p>
<p><img src="https://www.zhihu.com/equation?tex=m(i,W)=%5Cmax%5C%7Bm(i-1,W),m(i-1,W-w_i)+v_i%5C%7D" alt="[公式]"> 。</p>
<p><img src="http://static.cyblogs.com/v2-1d8090c991ca13cee3cb43c027b72304_1440w.jpg" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;v2-1d8090c991ca13cee3cb43c027b72304_1440w.jpg"></p>
<p>得到</p>
<p><img src="https://www.zhihu.com/equation?tex=%5C%5Bm(i,W)=%5Cleft%5C%7B+%5Cbegin%7Barray%7D%7B*%7B55%7D%7Bl%7D%7D+0+&+%5Ctext%7Bif+%7D+i=%5Ctext%7B0%7D+%5C%5C+0+&+%5Ctext%7Bif+%7D+W=%5Ctext%7B0%7D+%5C%5C+m(i-1,W)+&+%5Ctext%7Bif+%7D%7Bw_i%3EW%7D+%5C%5C+%5Cmax+%5Cleft%5C%7B+m(i-1,W),%7B%7Bv%7D_%7Bi%7D%7D+m(i-1,W-%7B%7Bw%7D_%7Bi%7D%7D)+%5Cright%5C%7D+&+%5Ctext%7Botherwise%7D+%5C%5C+%5Cend%7Barray%7D+%5Cright.%5C%5D+" alt="[公式]"> 。</p>
<h4 id="“填二维表”的动态规划方法"><a href="#“填二维表”的动态规划方法" class="headerlink" title="“填二维表”的动态规划方法"></a>“填二维表”的动态规划方法</h4><p><img src="https://www.zhihu.com/equation?tex=m(i,W)=m(i-1,W-w_i)+v_i" alt="[公式]"> 时才会有“取第 <img src="https://www.zhihu.com/equation?tex=i" alt="[公式]"> 件物品”发生。</p>
<p>所以从表格右下角“往回看”如果是“垂直下降”就是发生了 <img src="https://www.zhihu.com/equation?tex=m(i,W)=m(i-1,W)" alt="[公式]"> ，而只有“走斜线”才是“取了”物品。</p>
<p><img src="http://static.cyblogs.com/v2-7bd4c72ec3b5f104e4db3c4aad98cc66_1440w.png" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;v2-7bd4c72ec3b5f104e4db3c4aad98cc66_1440w.png"></p>
<p>这个算法的复杂度就很容易算了——每一个格子都要填写数字，所以时间复杂度和空间复杂度都是 <img src="https://www.zhihu.com/equation?tex=%5COmega(nC)" alt="[公式]"> 。当” <img src="https://www.zhihu.com/equation?tex=C%3E2%5En" alt="[公式]"> “时（就不严谨地使用渐近分析的语言了），复杂度是 <img src="https://www.zhihu.com/equation?tex=%5COmega(n2%5En)" alt="[公式]"> 。</p>
<h4 id="手撕Java版本代码"><a href="#手撕Java版本代码" class="headerlink" title="手撕Java版本代码"></a>手撕Java版本代码</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cyblogs.algorithm;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created with leetcode-cn</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>: 0-1 背包问题</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: chenyuan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>: 2021/3/29</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@time</span>: 10:23</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Knapsack</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">N</span> <span class="operator">=</span> <span class="number">6</span>, W = <span class="number">21</span>;</span><br><span class="line">        <span class="comment">// 重量</span></span><br><span class="line">        <span class="type">int</span>[] w = &#123;<span class="number">0</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">9</span>&#125;;</span><br><span class="line">        <span class="comment">// 价值</span></span><br><span class="line">        <span class="type">int</span>[] v = &#123;<span class="number">0</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">8</span>, <span class="number">10</span>&#125;;</span><br><span class="line">        <span class="comment">// 重量 * 价值</span></span><br><span class="line">        <span class="type">int</span>[][] B = <span class="keyword">new</span> <span class="title class_">int</span>[N][W];</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> k,C;</span><br><span class="line">        <span class="keyword">for</span> (k = <span class="number">1</span>; k &lt; N; k++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (C = <span class="number">1</span>; C &lt; W; C++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (w[k] &gt; C) &#123;</span><br><span class="line">                    B[k][C] = B[k-<span class="number">1</span>][C];</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// 装进书包</span></span><br><span class="line">                    <span class="type">int</span> <span class="variable">value1</span> <span class="operator">=</span> B[k-<span class="number">1</span>][C-w[k]] + v[k];</span><br><span class="line">                    <span class="comment">// 不装进书包</span></span><br><span class="line">                    <span class="type">int</span> <span class="variable">value2</span> <span class="operator">=</span> B[k-<span class="number">1</span>][C];</span><br><span class="line">                    <span class="keyword">if</span> (value1 &gt; value2) &#123;</span><br><span class="line">                        B[k][C] = value1;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        B[k][C] = value2;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(B[<span class="number">5</span>][<span class="number">20</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后输出的结果是：26。</p>
<h4 id="参考地址"><a href="#参考地址" class="headerlink" title="参考地址"></a>参考地址</h4><ul>
<li><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1U5411s7d7?t=1899">https://www.bilibili.com/video/BV1U5411s7d7?t=1899</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/30959069">https://zhuanlan.zhihu.com/p/30959069</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://www.cyblogs.com/2021/03/28/2021/03/Linux%E5%91%BD%E4%BB%A4%20kill%20-9%20%E7%9A%84%E5%8E%9F%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/vernonchen.jpg">
      <meta itemprop="name" content="Vernon">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="简栈文化">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | 简栈文化">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/03/28/2021/03/Linux%E5%91%BD%E4%BB%A4%20kill%20-9%20%E7%9A%84%E5%8E%9F%E7%90%86/" class="post-title-link" itemprop="url">Linux命令 kill -9 的原理</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-03-28 00:00:00" itemprop="dateCreated datePublished" datetime="2021-03-28T00:00:00+08:00">2021-03-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-06-25 10:05:09" itemprop="dateModified" datetime="2025-06-25T10:05:09+08:00">2025-06-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h4><p>相信很多程序员对于 <code>Linux</code> 系统都不陌生，即使自己的日常开发机器不是 <code>Linux</code>，那么线上服务器也大部分都是的，所以，掌握常用的 <code>Linux</code> 命令也是程序员必备的技能。</p>
<p>但是，怕就怕很多人对于部分命令只是一知半解，使用不当就能导致线上故障。</p>
<p>前段时间，我们的线上应用报警，频繁 <code>FGC</code>，需要紧急处理问题，于是有同事去线上重启机器（正常程序应该是先采集堆 <code>dump</code>，然后再重启，方便排查是否存在内存泄露等问题）。</p>
<p>但是在重启过程中，同事发现正常的重启命令应用无反应，然后尝试使用 <code>kill</code> 命令 “杀” 掉 <code>Java</code> 进程，但是仍然无效。于是他私自决定使用 “<code>kill -9</code>“ 结束了进程的生命。</p>
<p>虽然应用进程被干掉了，但是随之而来带来了很多问题，首先是上游系统突然发生大量报警，对应开发找过来说调用我们的 <code>RPC</code> 服务无响应，频繁超时。</p>
<p>后来，我们又发现系统中存在部分脏数据，有些在同一个事务中需要完整更新的数据，只更新了一半…</p>
<p>为什么正常的 <code>kill</code> 无法 “杀掉” 进程，而 <code>kill -9</code> 就可以？为什么 <code>kill -9</code> 会引发这一连串连锁反应？正常的 <code>kill</code> 执行时，JVM 会如何处理的呢？</p>
<p>要搞清楚这些问题，我们要先从 <code>kill</code> 命令说起。</p>
<h4 id="kill-命令"><a href="#kill-命令" class="headerlink" title="kill 命令"></a>kill 命令</h4><p>我们都知道，想要在 <code>Linux</code> 中终止一个进程有两种方式，如果是前台进程可以使用 <code>Ctrl+C</code> 键进行终止；如果是后台进程，那么需要使用 <code>kill</code> 命令来终止。（其实 <code>Ctrl+C</code> 也是 <code>kill</code> 命令）</p>
<p><code>kill</code> 命令的格式是：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kill [参数] [进程号]</span><br><span class="line">如：</span><br><span class="line">kill 90124</span><br><span class="line">kill -9  90124</span><br></pre></td></tr></table></figure>

<p>其中 [参数] 是可选的，进程号可以通过 <code>jps/ps/pidof/pstree/top</code> 等工具获取。</p>
<p><code>kill</code> 的命令参数有以下几种：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">-l 信号，若果不加信号的编号参数，则使用“-l”参数会列出全部的信号名称</span><br><span class="line"></span><br><span class="line">-a 当处理当前进程时，不限制命令名和进程号的对应关系</span><br><span class="line"></span><br><span class="line">-p 指定kill 命令只打印相关进程的进程号，而不发送任何信号</span><br><span class="line"></span><br><span class="line">-s 指定发送信号</span><br><span class="line"></span><br><span class="line">-u 指定用户</span><br></pre></td></tr></table></figure>

<p>通常情况下，我们使用的 <code>- l</code>(信号) 的时候比较多，如我们前文提到的 <code>kill -9</code> 中的 <code>9</code> 就是信号。</p>
<p>信号如果没有指定的话，默认会发出终止信号 (<code>15</code>)。常用的信号如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">HUP 1 终端断线</span><br><span class="line"></span><br><span class="line">INT 2 中断（同 Ctrl + C）</span><br><span class="line"></span><br><span class="line">QUIT 3 退出（同 Ctrl + \）</span><br><span class="line"></span><br><span class="line">TERM 15 终止</span><br><span class="line"></span><br><span class="line">KILL 9 强制终止</span><br><span class="line"></span><br><span class="line">CONT 18 继续（与STOP相反， fg/bg命令）</span><br><span class="line"></span><br><span class="line">STOP 19 暂停（同 Ctrl + Z）</span><br></pre></td></tr></table></figure>

<p>比较常用的就是<code>强制终止信号：9</code> 和<code>终止信号：15</code>，另外，<code>中断信号：2</code> 其实就是我们前文提到的 <code>Ctrl + C</code> 结束前台进程。</p>
<p>那么，<code>kill -9</code> 和 <code>kill -15</code> 到底有什么区别呢？该如何选择呢？</p>
<h4 id="kill-9-和-kill-15-的区别"><a href="#kill-9-和-kill-15-的区别" class="headerlink" title="kill -9 和 kill -15 的区别"></a>kill -9 和 kill -15 的区别</h4><p><code>kill</code> 命令默认的信号就是 <code>15</code>，首先来说一下这个默认的 <code>kill -15</code> 信号。</p>
<p>当使用 <code>kill -15</code> 时，系统会发送一个 <code>SIGTERM</code> 的信号给对应的程序。当程序接收到该信号后，具体要如何处理是自己可以决定的。</p>
<p>这时候，应用程序可以选择：</p>
<ul>
<li>1、立即停止程序</li>
<li>2、释放响应资源后停止程序</li>
<li>3、忽略该信号，继续执行程序</li>
</ul>
<p>因为 <code>kill -15</code> 信号只是通知对应的进程要进行 “安全、干净的退出”，程序接到信号之后，退出前一般会进行一些 “准备工作”，如资源释放、临时文件清理等等，如果准备工作做完了，再进行程序的终止。</p>
<p>但是，如果在 “准备工作” 进行过程中，遇到阻塞或者其他问题导致无法成功，那么应用程序可以选择忽略该终止信号。</p>
<p>这也就是为什么我们有的时候使用 <code>kill</code> 命令是没办法 “杀死” 应用的原因，因为默认的 <code>kill</code> 信号是 <code>SIGTERM（15）</code>，而 <code>SIGTERM（15）</code>的信号是可以被阻塞和忽略的。</p>
<p>和 <code>kill -15</code> 相比，<code>kill -9</code> 就相对强硬一点，系统会发出 SIGKILL 信号，他要求接收到该信号的程序应该立即结束运行，不能被阻塞或者忽略。</p>
<p>所以，相比于 <code>kill -15</code> 命令，<code>kill -9</code> 在执行时，应用程序是没有时间进行 “准备工作” 的，所以这通常会带来一些副作用，数据丢失或者终端无法恢复到正常状态等。</p>
<h4 id="Java-是如何处理-SIGTERM（15）"><a href="#Java-是如何处理-SIGTERM（15）" class="headerlink" title="Java 是如何处理 SIGTERM（15）"></a>Java 是如何处理 SIGTERM（15）</h4><p>我们都知道，在 <code>Linux</code> 中，<code>Java</code> 应用是作为一个独立进程运行的，<code>Java</code> 程序的终止运行是基于 <code>JVM</code> 的关闭实现的，JVM 关闭方式分为 3 种：</p>
<ul>
<li>正常关闭：当最后一个非守护线程结束或者调用了 <code>System.exit</code> 或者通过其他特定平台的方法关闭（接收到 <code>SIGINT（2）</code>、<code>SIGTERM</code>（15）信号等）</li>
<li>强制关闭：通过调用 <code>Runtime.halt</code> 方法或者是在操作系统中强制 <code>kill</code>（接收到 <code>SIGKILL（9）</code>信号)</li>
<li>异常关闭：运行中遇到 <code>RuntimeException</code> 异常等</li>
</ul>
<p><code>JVM</code> 进程在接收到 <code>kill -15</code> 信号通知的时候，是可以做一些清理动作的，比如删除临时文件等。</p>
<p>当然，开发者也是可以自定义做一些额外的事情的，比如让 <code>tomcat</code> 容器停止，让 <code>dubbo</code> 服务下线等。</p>
<p>而这种自定义 <code>JVM</code> 清理动作的方式，是通过 <code>JDK</code> 中提供的 <code>shutdown hook</code> 实现的。<code>JDK</code> 提供了 <code>Java.Runtime.addShutdownHook(Thread hook)</code> 方法，可以注册一个 JVM 关闭的钩子。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.cyblogs.thread;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created with leetcode-cn</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>:</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: chenyuan</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>: 2021/3/28</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@time</span>: 20:34</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShutdownHookCase</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">        Runtime.getRuntime().addShutdownHook(<span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;hook execute...&quot;</span>);</span><br><span class="line">        &#125;));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (flag) &#123;</span><br><span class="line">            <span class="comment">// app is runing</span></span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;main thread execute end...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行命令：</p>
<p><img src="http://static.cyblogs.com/Jietu20210328-204711.jpg" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;Jietu20210328-204711.jpg"></p>
<p>控制台输出内容：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hook execute...</span><br><span class="line">Process finished with exit code 143 (interrupted by signal 15: SIGTERM)</span><br></pre></td></tr></table></figure>

<p>可以看到，当我们使用 <code>kill</code>（默认 <code>kill -15</code>）关闭进程的时候，程序会先执行我注册的 <code>shutdownHook</code>，然后再退出，并且会给出一个提示：<code>interrupted by signal 15: SIGTERM</code></p>
<p>如果我们执行命令 <code>kill -9</code>：</p>
<p><img src="http://static.cyblogs.com/Jietu20210328-204851.jpg" alt="http:&#x2F;&#x2F;static.cyblogs.com&#x2F;Jietu20210328-204851.jpg"></p>
<p>控制台输出内容：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Process finished with exit code 137 (interrupted by signal 9: SIGKILL)</span><br></pre></td></tr></table></figure>

<p>可以看到，当我们使用 <code>kill -9</code> 强制关闭进程的时候，程序并没有执行 <code>shutdownHook</code>，而是直接退出了，并且会给出一个提示：<code>interrupted by signal 9: SIGKILL</code></p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p><code>kill</code> 命令用于终止 <code>Linux</code> 进程，默认情况下，如果不指定信号，<code>kill</code> 等价于 <code>kill -15</code>。</p>
<p><code>kill -15</code> 执行时，系统向对应的程序发送 <code>SIGTERM（15）</code>信号，该信号是可以被执行、阻塞和忽略的，所以应用程序接收到信号后，可以做一些准备工作，再进行程序终止。</p>
<p>有的时候，<code>kill -15</code> 无法终止程序，因为他可能被忽略，这时候可以使用 <code>kill -9</code>，系统会发出 <code>SIGKILL（9）</code>信号，该信号不允许忽略和阻塞，所以应用程序会立即终止。</p>
<p>这也会带来很多副作用，如数据丢失等，所以，在非必要时，不要使用 <code>kill -9</code> 命令，尤其是那些 <code>web</code> 应用、提供 <code>RPC</code> 服务、执行定时任务、包含长事务等应用中，因为 <code>kill -9</code> 没给 <code>spring</code> 容器、<code>tomcat</code> 服务器、<code>dubbo</code> 服务、流程引擎、状态机等足够的时间进行收尾。</p>
<h4 id="参考地址"><a href="#参考地址" class="headerlink" title="参考地址"></a>参考地址</h4><ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/windforce828/article/details/106119445">https://blog.csdn.net/windforce828/article/details/106119445</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/15/">15</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Vernon</span>
  </div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
    <a target="_blank" href="https://beian.miit.gov.cn">粤ICP备2025433887号</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
